cscope 15 $HOME/workspace/KC30S/system/core/adb -q 0000002552 0000406493
	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb.cpp

17 
	#TRACE_TAG
 
TRACE_ADB


	)

19 
	~"sysd•s.h
"

20 
	~"adb.h
"

22 
	~<ùy³.h
>

23 
	~<”ºo.h
>

24 
	~<¡d¬g.h
>

25 
	~<¡ddef.h
>

26 
	~<¡dšt.h
>

27 
	~<¡dio.h
>

28 
	~<¡dlib.h
>

29 
	~<¡ršg.h
>

30 
	~<sys/time.h
>

31 
	~<time.h
>

33 
	~<¡ršg
>

35 
	~<ba£/¡ršg´štf.h
>

36 
	~<ba£/¡ršgs.h
>

38 
	~"adb_auth.h
"

39 
	~"adb_io.h
"

40 
	~"adb_li¡’”s.h
"

41 
	~"Œª¥Üt.h
"

43 
	#ARRAY_SIZE
(
a
è(×è/ (×)[0]))

	)

45 #ià!
ADB_HOST


46 
	~<cuts/´İ”t›s.h
>

47 
	~<sys/ÿ·b™y.h
>

48 
	~<sys/mouÁ.h
>

51 
ADB_MUTEX_DEFINE
Ğ
D_lock
 );

53 
	gHOST
 = 0;

55 #ià!
ADB_HOST


56 cÚ¡ *
	gadb_deviû_bªÃr
 = "device";

59 
	$çl
(cÚ¡ *
fmt
, ...)

61 
va_li¡
 
­
;

62 
	`va_¡¬t
(
­
, 
fmt
);

63 
	`årštf
(
¡d”r
, "error: ");

64 
	`vårštf
(
¡d”r
, 
fmt
, 
­
);

65 
	`årštf
(
¡d”r
, "\n");

66 
	`va_’d
(
­
);

67 
	`ex™
(-1);

68 
	}
}

70 
	$çl_”ºo
(cÚ¡ *
fmt
, ...)

72 
va_li¡
 
­
;

73 
	`va_¡¬t
(
­
, 
fmt
);

74 
	`årštf
(
¡d”r
, "”rÜ: %s: ", 
	`¡»¼Ü
(
”ºo
));

75 
	`vårštf
(
¡d”r
, 
fmt
, 
­
);

76 
	`årštf
(
¡d”r
, "\n");

77 
	`va_’d
(
­
);

78 
	`ex™
(-1);

79 
	}
}

81 #ià!
ADB_HOST


82 
	$¡¬t_deviû_log
() {

83 
tm
 
now
;

84 
time_t
 
t
;

85 
	`tz£t
();

86 
	`time
(&
t
);

87 
	`loÿÉime_r
(&
t
, &
now
);

89 
time¡amp
[
PATH_MAX
];

90 
	`¡ráime
(
time¡amp
, Ñime¡amp), "%Y-%m-%d-%H-%M-%S", &
now
);

92 
¡d
::
¡ršg
 
·th
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("/d©a/adb/adb-%s-%d", 
time¡amp
, 
	`g‘pid
());

93 
fd
 = 
	`unix_İ’
(
·th
.
	`c_¡r
(), 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
 | 
O_CLOEXEC
, 0640);

94 ià(
fd
 == -1) {

99 
	`dup2
(
fd
, 
STDOUT_FILENO
);

100 
	`dup2
(
fd
, 
STDERR_FILENO
);

101 
	`årštf
(
¡d”r
, "---‡db s¹šg (pid %dè---\n", 
	`g‘pid
());

102 
	`adb_şo£
(
fd
);

103 
	}
}

106 
	gadb_Œaû_mask
;

108 
	g¡d
::
¡ršg
 
	$g‘_Œaû_£‰šg_äom_’v
() {

109 cÚ¡ * 
£‰šg
 = 
	`g‘’v
("ADB_TRACE");

110 ià(
£‰šg
 =ğ
nuÎ±r
) {

111 
£‰šg
 = "";

114  
¡d
::
	`¡ršg
(
£‰šg
);

115 
	}
}

117 #ià!
ADB_HOST


118 
	g¡d
::
¡ršg
 
	$g‘_Œaû_£‰šg_äom_´İ
() {

119 
buf
[
PROPERTY_VALUE_MAX
];

120 
	`´İ”ty_g‘
("³rsi¡.adb.Œaû_mask", 
buf
, "");

121  
¡d
::
	`¡ršg
(
buf
);

122 
	}
}

125 
	g¡d
::
¡ršg
 
	$g‘_Œaû_£‰šg
() {

126 #ià
ADB_HOST


127  
	`g‘_Œaû_£‰šg_äom_’v
();

129  
	`g‘_Œaû_£‰šg_äom_´İ
();

131 
	}
}

139 
	$adb_Œaû_š™
() {

140 cÚ¡ 
¡d
::
¡ršg
 
Œaû_£‰šg
 = 
	`g‘_Œaû_£‰šg
();

143 cÚ¡ * 
g
;

144 
æag
;

145 } 
gs
[] = {

148 { "adb", 
TRACE_ADB
 },

149 { "sock‘s", 
TRACE_SOCKETS
 },

150 { "·ck‘s", 
TRACE_PACKETS
 },

151 { "rwx", 
TRACE_RWX
 },

152 { "usb", 
TRACE_USB
 },

153 { "sync", 
TRACE_SYNC
 },

154 { "sysd•s", 
TRACE_SYSDEPS
 },

155 { "Œª¥Üt", 
TRACE_TRANSPORT
 },

156 { "jdwp", 
TRACE_JDWP
 },

157 { "£rviûs", 
TRACE_SERVICES
 },

158 { "auth", 
TRACE_AUTH
 },

159 { 
NULL
, 0 }

162 ià(
Œaû_£‰šg
.
	`em±y
()) {

167 cÚ¡ * 
p
 = 
Œaû_£‰šg
.
	`c_¡r
();

168 *
p
) {

169 
Ën
, 
gn
;

171 cÚ¡ * 
q
 = 
	`¡½brk
(
p
, " ,:;");

172 ià(
q
 =ğ
NULL
) {

173 
q
 = 
p
 + 
	`¡¾’
(p);

175 
Ën
 = 
q
 - 
p
;

177 
gn
 = 0; 
gs
[gn].
g
 !ğ
NULL
;agn++) {

178 
gËn
 = 
	`¡¾’
(
gs
[
gn
].
g
);

180 ià(
Ën
 =ğ
gËn
 && !
	`memcmp
(
gs
[
gn
].
g
, 
p
,†en)) {

181 
æag
 = 
gs
[
gn
].flag;

182 ià(
æag
 == 0) {

183 
adb_Œaû_mask
 = ~0;

186 
adb_Œaû_mask
 |ğ(1 << 
æag
);

190 
p
 = 
q
;

191 ià(*
p
)

192 
p
++;

195 #ià!
ADB_HOST


196 
	`¡¬t_deviû_log
();

198 
	}
}

200 
­ack‘
* 
	$g‘_­ack‘
()

202 
­ack‘
* 
p
 = 
»š‹½»t_ÿ¡
<­ack‘*>(
	`m®loc
((apacket)));

203 ià(
p
 =ğ
nuÎ±r
) {

204 
	`çl
("failedo‡llocate‡n‡packet");

207 
	`mem£t
(
p
, 0, (
­ack‘
è- 
MAX_PAYLOAD
);

208  
p
;

209 
	}
}

211 
	$put_­ack‘
(
­ack‘
 *
p
)

213 
	`ä“
(
p
);

214 
	}
}

216 
	$hªdË_Úlše
(
©¿n¥Üt
 *
t
)

218 
	`D
("adb: online\n");

219 
t
->
Úlše
 = 1;

220 
	}
}

222 
	$hªdË_ofæše
(
©¿n¥Üt
 *
t
)

224 
	`D
("adb: offline\n");

226 
t
->
Úlše
 = 0;

227 
	`run_Œª¥Üt_discÚÃùs
(
t
);

228 
	}
}

230 #ià
DEBUG_PACKETS


231 
	#DUMPMAX
 32

	)

232 
	$´št_·ck‘
(cÚ¡ *
Ïb–
, 
­ack‘
 *
p
)

234 *
g
;

235 *
x
;

236 
couÁ
;

238 
p
->
msg
.
commªd
){

239 
A_SYNC
: 
g
 = "SYNC"; ;

240 
A_CNXN
: 
g
 = "CNXN" ; ;

241 
A_OPEN
: 
g
 = "OPEN"; ;

242 
A_OKAY
: 
g
 = "OKAY"; ;

243 
A_CLSE
: 
g
 = "CLSE"; ;

244 
A_WRTE
: 
g
 = "WRTE"; ;

245 
A_AUTH
: 
g
 = "AUTH"; ;

246 : 
g
 = "????"; ;

249 
	`årštf
(
¡d”r
, "%s: %s %08x %08x %04x \"",

250 
Ïb–
, 
g
, 
p
->
msg
.
¬g0
,…->msg.
¬g1
,…->msg.
d©a_Ëngth
);

251 
couÁ
 = 
p
->
msg
.
d©a_Ëngth
;

252 
x
 = (*è
p
->
d©a
;

253 if(
couÁ
 > 
DUMPMAX
) {

254 
couÁ
 = 
DUMPMAX
;

255 
g
 = "\n";

257 
g
 = "\"\n";

259 
couÁ
-- > 0){

260 if((*
x
 >= ' ') && (*x < 127)) {

261 
	`åutc
(*
x
, 
¡d”r
);

263 
	`åutc
('.', 
¡d”r
);

265 
x
++;

267 
	`åuts
(
g
, 
¡d”r
);

268 
	}
}

271 
	$£nd_»ady
(
loÿl
, 
»mÙe
, 
©¿n¥Üt
 *
t
)

273 
	`D
("Calling send_ready \n");

274 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

275 
p
->
msg
.
commªd
 = 
A_OKAY
;

276 
p
->
msg
.
¬g0
 = 
loÿl
;

277 
p
->
msg
.
¬g1
 = 
»mÙe
;

278 
	`£nd_·ck‘
(
p
, 
t
);

279 
	}
}

281 
	$£nd_şo£
(
loÿl
, 
»mÙe
, 
©¿n¥Üt
 *
t
)

283 
	`D
("Calling send_close \n");

284 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

285 
p
->
msg
.
commªd
 = 
A_CLSE
;

286 
p
->
msg
.
¬g0
 = 
loÿl
;

287 
p
->
msg
.
¬g1
 = 
»mÙe
;

288 
	`£nd_·ck‘
(
p
, 
t
);

289 
	}
}

291 
size_t
 
	$fl_cÚÃù_d©a
(*
buf
, 
size_t
 
bufsize
)

293 #ià
ADB_HOST


294  
	`¢´štf
(
buf
, 
bufsize
, "host::") + 1;

296 cÚ¡ *
úxn_´İs
[] = {

301 cÚ¡ 
num_úxn_´İs
 = 
	`ARRAY_SIZE
(
úxn_´İs
);

302 
i
;

303 
size_t
 
»maššg
 = 
bufsize
;

304 
size_t
 
Ën
;

306 
Ën
 = 
	`¢´štf
(
buf
, 
»maššg
, "%s::", 
adb_deviû_bªÃr
);

307 
»maššg
 -ğ
Ën
;

308 
buf
 +ğ
Ën
;

309 
i
 = 0; i < 
num_úxn_´İs
; i++) {

310 
v®ue
[
PROPERTY_VALUE_MAX
];

311 
	`´İ”ty_g‘
(
úxn_´İs
[
i
], 
v®ue
, "");

312 
Ën
 = 
	`¢´štf
(
buf
, 
»maššg
, "%s=%s;", 
úxn_´İs
[
i
], 
v®ue
);

313 
»maššg
 -ğ
Ën
;

314 
buf
 +ğ
Ën
;

317  
bufsize
 - 
»maššg
 + 1;

319 
	}
}

321 
	$£nd_cÚÃù
(
©¿n¥Üt
 *
t
)

323 
	`D
("Calling send_connect \n");

324 
­ack‘
 *
ı
 = 
	`g‘_­ack‘
();

325 
ı
->
msg
.
commªd
 = 
A_CNXN
;

326 
ı
->
msg
.
¬g0
 = 
t
->
	`g‘_´ÙocŞ_v”siÚ
();

327 
ı
->
msg
.
¬g1
 = 
t
->
	`g‘_max_·ylßd
();

328 
ı
->
msg
.
d©a_Ëngth
 = 
	`fl_cÚÃù_d©a
((*)ı->
d©a
,

329 
MAX_PAYLOAD_V1
);

330 
	`£nd_·ck‘
(
ı
, 
t
);

331 
	}
}

337 
	$qu®_ov”wr™e
(** 
d¡
, cÚ¡ 
¡d
::
¡ršg
& 
¤c
) {

338 
	`ä“
(*
d¡
);

339 *
d¡
 = 
	`¡rdup
(
¤c
.
	`c_¡r
());

340 
	}
}

342 
	$·r£_bªÃr
(cÚ¡ * 
bªÃr
, 
©¿n¥Üt
* 
t
) {

343 
	`D
("·r£_bªÃr: %s\n", 
bªÃr
);

347 
¡d
::
veùÜ
<¡d::
¡ršg
> 
p›ûs
 = 
ªdroid
::
ba£
::
	`S¶™
(
bªÃr
, ":");

349 ià(
p›ûs
.
	`size
() > 2) {

350 cÚ¡ 
¡d
::
¡ršg
& 
´İs
 = 
p›ûs
[2];

351 auto& 
´İ
 : 
ªdroid
::
ba£
::
	`S¶™
(
´İs
, ";")) {

353 ià(
´İ
.
	`em±y
()) ;

355 
¡d
::
veùÜ
<¡d::
¡ršg
> 
key_v®ue
 = 
ªdroid
::
ba£
::
	`S¶™
(
´İ
, "=");

356 ià(
key_v®ue
.
	`size
() != 2) ;

358 cÚ¡ 
¡d
::
¡ršg
& 
key
 = 
key_v®ue
[0];

359 cÚ¡ 
¡d
::
¡ršg
& 
v®ue
 = 
key_v®ue
[1];

360 ià(
key
 == "ro.product.name") {

361 
	`qu®_ov”wr™e
(&
t
->
´oduù
, 
v®ue
);

362 } ià(
key
 == "ro.product.model") {

363 
	`qu®_ov”wr™e
(&
t
->
mod–
, 
v®ue
);

364 } ià(
key
 == "ro.product.device") {

365 
	`qu®_ov”wr™e
(&
t
->
deviû
, 
v®ue
);

370 cÚ¡ 
¡d
::
¡ršg
& 
ty³
 = 
p›ûs
[0];

371 ià(
ty³
 == "bootloader") {

372 
	`D
("setting connection_stateo CS_BOOTLOADER\n");

373 
t
->
cÚÃùiÚ_¡©e
 = 
CS_BOOTLOADER
;

374 
	`upd©e_Œª¥Üts
();

375 } ià(
ty³
 == "device") {

376 
	`D
("setting connection_stateo CS_DEVICE\n");

377 
t
->
cÚÃùiÚ_¡©e
 = 
CS_DEVICE
;

378 
	`upd©e_Œª¥Üts
();

379 } ià(
ty³
 == "recovery") {

380 
	`D
("setting connection_stateo CS_RECOVERY\n");

381 
t
->
cÚÃùiÚ_¡©e
 = 
CS_RECOVERY
;

382 
	`upd©e_Œª¥Üts
();

383 } ià(
ty³
 == "sideload") {

384 
	`D
("setting connection_stateo CS_SIDELOAD\n");

385 
t
->
cÚÃùiÚ_¡©e
 = 
CS_SIDELOAD
;

386 
	`upd©e_Œª¥Üts
();

388 
	`D
("setting connection_stateo CS_HOST\n");

389 
t
->
cÚÃùiÚ_¡©e
 = 
CS_HOST
;

391 
	}
}

393 
	$hªdË_·ck‘
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

395 
asock‘
 *
s
;

397 
	`D
("hªdË_·ck‘(è%c%c%c%c\n", ((*è(&(
p
->
msg
.
commªd
)))[0],

398 ((*è(&(
p
->
msg
.
commªd
)))[1],

399 ((*è(&(
p
->
msg
.
commªd
)))[2],

400 ((*è(&(
p
->
msg
.
commªd
)))[3]);

401 
	`´št_·ck‘
("»cv", 
p
);

403 
p
->
msg
.
commªd
){

404 
A_SYNC
:

405 if(
p
->
msg
.
¬g0
){

406 
	`£nd_·ck‘
(
p
, 
t
);

407 if(
HOST
è
	`£nd_cÚÃù
(
t
);

409 
t
->
cÚÃùiÚ_¡©e
 = 
CS_OFFLINE
;

410 
	`hªdË_ofæše
(
t
);

411 
	`£nd_·ck‘
(
p
, 
t
);

415 
A_CNXN
:

417 if(
t
->
cÚÃùiÚ_¡©e
 !ğ
CS_OFFLINE
) {

418 
t
->
cÚÃùiÚ_¡©e
 = 
CS_OFFLINE
;

419 
	`hªdË_ofæše
(
t
);

422 
t
->
	`upd©e_v”siÚ
(
p
->
msg
.
¬g0
,…->msg.
¬g1
);

423 
	`·r£_bªÃr
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
p
->
d©a
), 
t
);

425 ià(
HOST
 || !
auth_»quœed
) {

426 
	`hªdË_Úlše
(
t
);

427 ià(!
HOST
è
	`£nd_cÚÃù
(
t
);

429 
	`£nd_auth_»que¡
(
t
);

433 
A_AUTH
:

434 ià(
p
->
msg
.
¬g0
 =ğ
ADB_AUTH_TOKEN
) {

435 
t
->
cÚÃùiÚ_¡©e
 = 
CS_UNAUTHORIZED
;

436 
t
->
key
 = 
	`adb_auth_Ãxtkey
(t->key);

437 ià(
t
->
key
) {

438 
	`£nd_auth_»¥Ú£
(
p
->
d©a
,…->
msg
.
d©a_Ëngth
, 
t
);

441 
	`£nd_auth_publickey
(
t
);

443 } ià(
p
->
msg
.
¬g0
 =ğ
ADB_AUTH_SIGNATURE
) {

444 ià(
	`adb_auth_v”ify
(
t
->
tok’
, 
p
->
d©a
,…->
msg
.
d©a_Ëngth
)) {

445 
	`adb_auth_v”if›d
(
t
);

446 
t
->
çed_auth_©‹m±s
 = 0;

448 ià(
t
->
çed_auth_©‹m±s
++ > 10)

449 
	`adb_¦“p_ms
(1000);

450 
	`£nd_auth_»que¡
(
t
);

452 } ià(
p
->
msg
.
¬g0
 =ğ
ADB_AUTH_RSAPUBLICKEY
) {

453 
	`adb_auth_cÚfœm_key
(
p
->
d©a
,…->
msg
.
d©a_Ëngth
, 
t
);

457 
A_OPEN
:

458 ià(
t
->
Úlše
 && 
p
->
msg
.
¬g0
 !ğ0 &&…->msg.
¬g1
 == 0) {

459 *
Çme
 = (*è
p
->
d©a
;

460 
Çme
[
p
->
msg
.
d©a_Ëngth
 > 0 ?…->msg.data_length - 1 : 0] = 0;

461 
s
 = 
	`ü—‹_loÿl_£rviû_sock‘
(
Çme
);

462 if(
s
 == 0) {

463 
	`£nd_şo£
(0, 
p
->
msg
.
¬g0
, 
t
);

465 
s
->
³”
 = 
	`ü—‹_»mÙe_sock‘
(
p
->
msg
.
¬g0
, 
t
);

466 
s
->
³”
->peer = s;

467 
	`£nd_»ady
(
s
->
id
, s->
³”
->id, 
t
);

468 
s
->
	`»ady
(s);

473 
A_OKAY
:

474 ià(
t
->
Úlše
 && 
p
->
msg
.
¬g0
 !ğ0 &&…->msg.
¬g1
 != 0) {

475 if((
s
 = 
	`fšd_loÿl_sock‘
(
p
->
msg
.
¬g1
, 0))) {

476 if(
s
->
³”
 == 0) {

478 
s
->
³”
 = 
	`ü—‹_»mÙe_sock‘
(
p
->
msg
.
¬g0
, 
t
);

479 
s
->
³”
->peer = s;

480 
s
->
	`»ady
(s);

481 } ià(
s
->
³”
->
id
 =ğ
p
->
msg
.
¬g0
) {

483 
s
->
	`»ady
(s);

485 
	`D
("Invalid A_OKAY(%d,%d),ƒxpected A_OKAY(%d,%d) onransport %s\n",

486 
p
->
msg
.
¬g0
,…->msg.
¬g1
, 
s
->
³”
->
id
,…->msg.¬g1, 
t
->
£rŸl
);

492 
A_CLSE
:

493 ià(
t
->
Úlše
 && 
p
->
msg
.
¬g1
 != 0) {

494 if((
s
 = 
	`fšd_loÿl_sock‘
(
p
->
msg
.
¬g1
,…->msg.
¬g0
))) {

505 ià(
p
->
msg
.
¬g0
 =ğ0 && 
s
->
³”
 && s->³”->
Œª¥Üt
 !ğ
t
) {

506 
	`D
("Invalid A_CLSE(0, %u) fromransport %s,ƒxpectedransport %s\n",

507 
p
->
msg
.
¬g1
, 
t
->
£rŸl
, 
s
->
³”
->
Œª¥Üt
->serial);

509 
s
->
	`şo£
(s);

515 
A_WRTE
:

516 ià(
t
->
Úlše
 && 
p
->
msg
.
¬g0
 !ğ0 &&…->msg.
¬g1
 != 0) {

517 if((
s
 = 
	`fšd_loÿl_sock‘
(
p
->
msg
.
¬g1
,…->msg.
¬g0
))) {

518 
rid
 = 
p
->
msg
.
¬g0
;

519 
p
->
Ën
 =…->
msg
.
d©a_Ëngth
;

521 if(
s
->
	`’queue
(s, 
p
) == 0) {

522 
	`D
("Enqueuehe socket\n");

523 
	`£nd_»ady
(
s
->
id
, 
rid
, 
t
);

531 
	`´štf
("hªdË_·ck‘: wh© i %08x?!\n", 
p
->
msg
.
commªd
);

534 
	`put_­ack‘
(
p
);

535 
	}
}

537 #ià
ADB_HOST


539 
	$Ïunch_£rv”
(
£rv”_pÜt
)

541 #ià
	`defšed
(
_WIN32
)

546 
HANDLE
 
pe_»ad
, 
pe_wr™e
;

547 
HANDLE
 
¡dout_hªdË
, 
¡d”r_hªdË
;

548 
SECURITY_ATTRIBUTES
 
§
;

549 
STARTUPINFO
 
¡¬tup
;

550 
PROCESS_INFORMATION
 
pšfo
;

551 
´og¿m_·th
[ 
MAX_PATH
 ];

552 
»t
;

554 
§
.
nL’gth
 = (sa);

555 
§
.
ÍSecur™yDesütÜ
 = 
NULL
;

556 
§
.
bInh”™HªdË
 = 
TRUE
;

559 
»t
 = 
	`C»©ePe
Ğ&
pe_»ad
, &
pe_wr™e
, &
§
, 0 );

560 ià(!
»t
) {

561 
	`årštf
(
¡d”r
, "C»©ePe(èçu»,ƒ¼Ü %ld\n", 
	`G‘La¡E¼Ü
() );

565 
	`S‘HªdËInfÜm©iÚ
Ğ
pe_»ad
, 
HANDLE_FLAG_INHERIT
, 0 );

578 
¡dout_hªdË
 = 
	`G‘StdHªdË
Ğ
STD_OUTPUT_HANDLE
 );

579 
¡d”r_hªdË
 = 
	`G‘StdHªdË
Ğ
STD_ERROR_HANDLE
 );

580 ià(
¡dout_hªdË
 !ğ
INVALID_HANDLE_VALUE
) {

581 
	`S‘HªdËInfÜm©iÚ
Ğ
¡dout_hªdË
, 
HANDLE_FLAG_INHERIT
, 0 );

583 ià(
¡d”r_hªdË
 !ğ
INVALID_HANDLE_VALUE
) {

584 
	`S‘HªdËInfÜm©iÚ
Ğ
¡d”r_hªdË
, 
HANDLE_FLAG_INHERIT
, 0 );

587 
	`Z”oMemÜy
Ğ&
¡¬tup
, (startup) );

588 
¡¬tup
.
cb
 = (startup);

589 
¡¬tup
.
hStdIÅut
 = 
	`G‘StdHªdË
Ğ
STD_INPUT_HANDLE
 );

590 
¡¬tup
.
hStdOuut
 = 
pe_wr™e
;

591 
¡¬tup
.
hStdE¼Ü
 = 
	`G‘StdHªdË
Ğ
STD_ERROR_HANDLE
 );

592 
¡¬tup
.
dwFÏgs
 = 
STARTF_USESTDHANDLES
;

594 
	`Z”oMemÜy
Ğ&
pšfo
, (pinfo) );

597 
	`G‘ModuËFeName
Ğ
NULL
, 
´og¿m_·th
, (program_path) );

598 
¬gs
[64];

599 
	`¢´štf
(
¬gs
, ×rgs), "adb -P %d fÜk-£rv” s”v”", 
£rv”_pÜt
);

600 
»t
 = 
	`C»©eProûss
(

601 
´og¿m_·th
,

602 
¬gs
,

605 
NULL
,

606 
NULL
,

607 
TRUE
,

608 
DETACHED_PROCESS
,

609 
NULL
,

610 
NULL
,

611 &
¡¬tup
,

612 &
pšfo
 );

614 
	`Clo£HªdË
Ğ
pe_wr™e
 );

616 ià(!
»t
) {

617 
	`årštf
(
¡d”r
, "C»©eProûs çu»,ƒ¼Ü %ld\n", 
	`G‘La¡E¼Ü
() );

618 
	`Clo£HªdË
Ğ
pe_»ad
 );

622 
	`Clo£HªdË
Ğ
pšfo
.
hProûss
 );

623 
	`Clo£HªdË
Ğ
pšfo
.
hTh»ad
 );

627 
‹mp
[3];

628 
DWORD
 
couÁ
;

630 
»t
 = 
	`R—dFe
Ğ
pe_»ad
, 
‹mp
, 3, &
couÁ
, 
NULL
 );

631 
	`Clo£HªdË
Ğ
pe_»ad
 );

632 iàĞ!
»t
 ) {

633 
	`årštf
(
¡d”r
, "could‚Ù„—d ok from ADB S”v”,ƒ¼Ü = %ld\n", 
	`G‘La¡E¼Ü
() );

636 ià(
couÁ
 !ğ3 || 
‹mp
[0] != 'O' ||emp[1] != 'K' ||emp[2] != '\n') {

637 
	`årštf
(
¡d”r
, "ADB server didn't ACK\n" );

642 
·th
[
PATH_MAX
];

643 
fd
[2];

647 ià(
	`pe
(
fd
)) {

648 
	`årštf
(
¡d”r
, "pçed iÀÏunch_£rv”,ƒ¼no: %d\n", 
”ºo
);

651 
	`g‘_my_·th
(
·th
, 
PATH_MAX
);

652 
pid_t
 
pid
 = 
	`fÜk
();

653 if(
pid
 < 0)  -1;

655 ià(
pid
 == 0) {

660 
	`adb_şo£
(
fd
[0]);

661 
	`dup2
(
fd
[1], 
STDERR_FILENO
);

662 
	`adb_şo£
(
fd
[1]);

664 
¡r_pÜt
[30];

665 
	`¢´štf
(
¡r_pÜt
, (¡r_pÜt), "%d", 
£rv”_pÜt
);

667 
»suÉ
 = 
	`exeş
(
·th
, "adb", "-P", 
¡r_pÜt
, "fÜk-£rv”", "£rv”", 
NULL
);

669 
	`årštf
(
¡d”r
, "OOPS!ƒxeş„‘uºed %d,ƒ¼no: %d\n", 
»suÉ
, 
”ºo
);

673 
‹mp
[3];

675 
‹mp
[0] = 'A';emp[1] = 'B';emp[2] = 'C';

677 
	`adb_şo£
(
fd
[1]);

678 
»t
 = 
	`adb_»ad
(
fd
[0], 
‹mp
, 3);

679 
§ved_”ºo
 = 
”ºo
;

680 
	`adb_şo£
(
fd
[0]);

681 ià(
»t
 < 0) {

682 
	`årštf
(
¡d”r
, "could‚Ù„—d ok from ADB S”v”,ƒ¼nØğ%d\n", 
§ved_”ºo
);

685 ià(
»t
 !ğ3 || 
‹mp
[0] != 'O' ||emp[1] != 'K' ||emp[2] != '\n') {

686 
	`årštf
(
¡d”r
, "ADB server didn't ACK\n" );

690 
	`£tsid
();

694 
	}
}

700 
	$hªdË_fÜw¬d_»que¡
(cÚ¡ * 
£rviû
, 
Œª¥Üt_ty³
 
‰y³
, * 
£rŸl
, 
»¶y_fd
)

702 ià(!
	`¡rcmp
(
£rviû
, "list-forward")) {

704 
¡d
::
¡ršg
 
li¡’”s
 = 
	`fÜm©_li¡’”s
();

705 #ià
ADB_HOST


706 
	`S’dOkay
(
»¶y_fd
);

708 
	`S’dPrÙocŞSŒšg
(
»¶y_fd
, 
li¡’”s
);

712 ià(!
	`¡rcmp
(
£rviû
, "killforward-all")) {

713 
	`»move_®l_li¡’”s
();

714 #ià
ADB_HOST


716 
	`S’dOkay
(
»¶y_fd
);

718 
	`S’dOkay
(
»¶y_fd
);

722 ià(!
	`¡ºcmp
(
£rviû
, "forward:",8) ||

723 !
	`¡ºcmp
(
£rviû
, "killforward:",12)) {

724 *
loÿl
, *
»mÙe
;

725 
©¿n¥Üt
 *
Œª¥Üt
;

727 
ü—‹FÜw¬d
 = 
	`¡ºcmp
(
£rviû
, "kill", 4);

728 
no_»bšd
 = 0;

730 
loÿl
 = 
	`¡rchr
(
£rviû
, ':') + 1;

733 ià(
ü—‹FÜw¬d
 && !
	`¡ºcmp
(
loÿl
, "norebind:", 9)) {

734 
no_»bšd
 = 1;

735 
loÿl
 = 
	`¡rchr
(local, ':') + 1;

738 
»mÙe
 = 
	`¡rchr
(
loÿl
,';');

740 ià(
ü—‹FÜw¬d
) {

742 if(
»mÙe
 == 0) {

743 
	`S’dFa
(
»¶y_fd
, "malformed forward spec");

747 *
»mÙe
++ = 0;

748 if((
loÿl
[0] =ğ0è|| (
»mÙe
[0] == 0) || (remote[0] == '*')) {

749 
	`S’dFa
(
»¶y_fd
, "malformed forward spec");

754 ià(
loÿl
[0] == 0) {

755 
	`S’dFa
(
»¶y_fd
, "malformed forward spec");

760 
¡d
::
¡ršg
 
”rÜ_msg
;

761 
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
(
CS_ANY
, 
‰y³
, 
£rŸl
, &
”rÜ_msg
);

762 ià(!
Œª¥Üt
) {

763 
	`S’dFa
(
»¶y_fd
, 
”rÜ_msg
);

767 
š¡®l_¡©us_t
 
r
;

768 ià(
ü—‹FÜw¬d
) {

769 
r
 = 
	`š¡®l_li¡’”
(
loÿl
, 
»mÙe
, 
Œª¥Üt
, 
no_»bšd
);

771 
r
 = 
	`»move_li¡’”
(
loÿl
, 
Œª¥Üt
);

773 ià(
r
 =ğ
INSTALL_STATUS_OK
) {

774 #ià
ADB_HOST


776 
	`S’dOkay
(
»¶y_fd
);

778 
	`S’dOkay
(
»¶y_fd
);

782 
¡d
::
¡ršg
 
mes§ge
;

783 
r
) {

784 
INSTALL_STATUS_OK
: 
mes§ge
 = " "; ;

785 
INSTALL_STATUS_INTERNAL_ERROR
: 
mes§ge
 = "internalƒrror"; ;

786 
INSTALL_STATUS_CANNOT_BIND
:

787 
mes§ge
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("ÿÂÙ bšdØsock‘: %s", 
	`¡»¼Ü
(
”ºo
));

789 
INSTALL_STATUS_CANNOT_REBIND
:

790 
mes§ge
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("ÿÂÙ„ebšdƒxi¡šg sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

792 
INSTALL_STATUS_LISTENER_NOT_FOUND
: 
mes§ge
 = "listener‚ot found"; ;

794 
	`S’dFa
(
»¶y_fd
, 
mes§ge
);

798 
	}
}

800 
	$hªdË_ho¡_»que¡
(*
£rviû
, 
Œª¥Üt_ty³
 
‰y³
, * 
£rŸl
, 
»¶y_fd
, 
asock‘
 *
s
)

802 if(!
	`¡rcmp
(
£rviû
, "kill")) {

803 
	`årštf
(
¡d”r
,"adb server killed by„emote„equest\n");

804 
	`fæush
(
¡dout
);

805 
	`S’dOkay
(
»¶y_fd
);

806 
	`usb_ş—nup
();

807 
	`ex™
(0);

810 #ià
ADB_HOST


811 
©¿n¥Üt
 *
Œª¥Üt
 = 
NULL
;

816 ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt", 
	`¡¾’
("transport"))) {

817 
Œª¥Üt_ty³
 
ty³
 = 
kT¿n¥ÜtAny
;

819 ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt-usb", 
	`¡¾’
("transport-usb"))) {

820 
ty³
 = 
kT¿n¥ÜtUsb
;

821 } ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt-loÿl", 
	`¡¾’
("transport-local"))) {

822 
ty³
 = 
kT¿n¥ÜtLoÿl
;

823 } ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt-ªy", 
	`¡¾’
("transport-any"))) {

824 
ty³
 = 
kT¿n¥ÜtAny
;

825 } ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt:", 
	`¡¾’
("transport:"))) {

826 
£rviû
 +ğ
	`¡¾’
("transport:");

827 
£rŸl
 = 
£rviû
;

830 
¡d
::
¡ršg
 
”rÜ_msg
 = "unknown failure";

831 
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
(
CS_ANY
, 
ty³
, 
£rŸl
, &
”rÜ_msg
);

833 ià(
Œª¥Üt
) {

834 
s
->
Œª¥Üt
 =ransport;

835 
	`S’dOkay
(
»¶y_fd
);

837 
	`S’dFa
(
»¶y_fd
, 
”rÜ_msg
);

843 ià(!
	`¡ºcmp
(
£rviû
, "devices", 7)) {

844 
boŞ
 
lÚg_li¡šg
 = (
	`¡rcmp
(
£rviû
+7, "-l") == 0);

845 ià(
lÚg_li¡šg
 || 
£rviû
[7] == 0) {

846 
	`D
("Getting device†ist...\n");

847 
¡d
::
¡ršg
 
deviû_li¡
 = 
	`li¡_Œª¥Üts
(
lÚg_li¡šg
);

848 
	`D
("Sending device†ist...\n");

849 
	`S’dOkay
(
»¶y_fd
);

850 
	`S’dPrÙocŞSŒšg
(
»¶y_fd
, 
deviû_li¡
);

857 ià(!
	`¡ºcmp
(
£rviû
, "disconnect:", 11)) {

858 
bufãr
[4096];

859 
	`mem£t
(
bufãr
, 0, (buffer));

860 * 
£rŸl
 = 
£rviû
 + 11;

861 ià(
£rŸl
[0] == 0) {

863 
	`uÄegi¡”_®l_tı_Œª¥Üts
();

865 
ho¡buf
[100];

867 ià(!
	`¡rchr
(
£rŸl
, ':')) {

868 
	`¢´štf
(
ho¡buf
, (ho¡bufè- 1, "%s:5555", 
£rŸl
);

869 
£rŸl
 = 
ho¡buf
;

871 
©¿n¥Üt
 *
t
 = 
	`fšd_Œª¥Üt
(
£rŸl
);

873 ià(
t
) {

874 
	`uÄegi¡”_Œª¥Üt
(
t
);

876 
	`¢´štf
(
bufãr
, (bufãr), "NØsuch deviû %s", 
£rŸl
);

880 
	`S’dOkay
(
»¶y_fd
);

881 
	`S’dPrÙocŞSŒšg
(
»¶y_fd
, 
bufãr
);

886 ià(!
	`¡rcmp
(
£rviû
, "version")) {

887 
	`S’dOkay
(
»¶y_fd
);

888 
	`S’dPrÙocŞSŒšg
(
»¶y_fd
, 
ªdroid
::
ba£
::
	`SŒšgPrštf
("%04x", 
ADB_SERVER_VERSION
));

892 if(!
	`¡ºcmp
(
£rviû
,"g‘-£rŸÊo",
	`¡¾’
("get-serialno"))) {

893 cÚ¡ *
out
 = "unknown";

894 
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
(
CS_ANY
, 
‰y³
, 
£rŸl
, 
NULL
);

895 ià(
Œª¥Üt
 &&¿n¥Üt->
£rŸl
) {

896 
out
 = 
Œª¥Üt
->
£rŸl
;

898 
	`S’dOkay
(
»¶y_fd
);

899 
	`S’dPrÙocŞSŒšg
(
»¶y_fd
, 
out
);

902 if(!
	`¡ºcmp
(
£rviû
,"g‘-dev·th",
	`¡¾’
("get-devpath"))) {

903 cÚ¡ *
out
 = "unknown";

904 
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
(
CS_ANY
, 
‰y³
, 
£rŸl
, 
NULL
);

905 ià(
Œª¥Üt
 &&¿n¥Üt->
dev·th
) {

906 
out
 = 
Œª¥Üt
->
dev·th
;

908 
	`S’dOkay
(
»¶y_fd
);

909 
	`S’dPrÙocŞSŒšg
(
»¶y_fd
, 
out
);

913 ià(!
	`¡ºcmp
(
£rviû
,"emulator:",9)) {

914 
pÜt
 = 
	`©oi
(
£rviû
+9);

915 
	`loÿl_cÚÃù
(
pÜt
);

920 if(!
	`¡ºcmp
(
£rviû
,"g‘-¡©e",
	`¡¾’
("get-state"))) {

921 
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
(
CS_ANY
, 
‰y³
, 
£rŸl
, 
NULL
);

922 
	`S’dOkay
(
»¶y_fd
);

923 
	`S’dPrÙocŞSŒšg
(
»¶y_fd
, 
Œª¥Üt
->
	`cÚÃùiÚ_¡©e_Çme
());

928 
»t
 = 
	`hªdË_fÜw¬d_»que¡
(
£rviû
, 
‰y³
, 
£rŸl
, 
»¶y_fd
);

929 ià(
»t
 >= 0)

930  
»t
 - 1;

932 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb.h

17 #iâdeà
__ADB_H


18 
	#__ADB_H


	)

20 
	~<lim™s.h
>

21 
	~<sys/ty³s.h
>

23 
	~"adb_Œaû.h
"

24 
	~"fdev’t.h
"

26 
cÚ¡ex´
 
size_t
 
	gMAX_PAYLOAD_V1
 = 4 * 1024;

27 
cÚ¡ex´
 
size_t
 
	gMAX_PAYLOAD_V2
 = 256 * 1024;

28 
cÚ¡ex´
 
size_t
 
	gMAX_PAYLOAD
 = 
MAX_PAYLOAD_V2
;

30 
	#A_SYNC
 0x434e5953

	)

31 
	#A_CNXN
 0x4e584e43

	)

32 
	#A_OPEN
 0x4e45504f

	)

33 
	#A_OKAY
 0x59414b4f

	)

34 
	#A_CLSE
 0x45534c43

	)

35 
	#A_WRTE
 0x45545257

	)

36 
	#A_AUTH
 0x48545541

	)

39 
	#A_VERSION
 0x01000000

	)

42 
	#ADB_VERSION_MAJOR
 1

	)

43 
	#ADB_VERSION_MINOR
 0

	)

46 
	#ADB_SERVER_VERSION
 32

	)

48 
	g©¿n¥Üt
;

49 
	gusb_hªdË
;

51 
	sames§ge
 {

52 
	mcommªd
;

53 
	m¬g0
;

54 
	m¬g1
;

55 
	md©a_Ëngth
;

56 
	md©a_check
;

57 
	mmagic
;

60 
	s­ack‘


62 
­ack‘
 *
	mÃxt
;

64 
	mËn
;

65 *
	m±r
;

67 
ames§ge
 
	mmsg
;

68 
	md©a
[
MAX_PAYLOAD
];

75 
	sasock‘
 {

79 
asock‘
 *
	mÃxt
;

80 
asock‘
 *
	m´ev
;

84 
	mid
;

89 
	mşosšg
;

94 
	mex™_Ú_şo£
;

99 
asock‘
 *
	m³”
;

105 
fdev’t
 
	mfde
;

106 
	mfd
;

110 
­ack‘
 *
	mpkt_fœ¡
;

111 
­ack‘
 *
	mpkt_Ï¡
;

119 (*
	m’queue
)(
asock‘
 *
	ms
, 
­ack‘
 *
	mpkt
);

124 (*
	m»ady
)(
asock‘
 *
	ms
);

130 (*
	mshutdown
)(
asock‘
 *
	ms
);

136 (*
	mşo£
)(
asock‘
 *
	ms
);

139 
©¿n¥Üt
 *
	mŒª¥Üt
;

141 
size_t
 
g‘_max_·ylßd
() const;

150 
	sadiscÚÃù


152 (*
	mfunc
)(* 
	mİaque
, 
©¿n¥Üt
* 
	mt
);

153 * 
	mİaque
;

154 
adiscÚÃù
* 
	mÃxt
;

155 
adiscÚÃù
* 
	m´ev
;

168 
	eŒª¥Üt_ty³
 {

169 
	mkT¿n¥ÜtUsb
,

170 
	mkT¿n¥ÜtLoÿl
,

171 
	mkT¿n¥ÜtAny
,

172 
	mkT¿n¥ÜtHo¡
,

175 
	#TOKEN_SIZE
 20

	)

177 
	s©¿n¥Üt


179 
©¿n¥Üt
 *
	mÃxt
;

180 
©¿n¥Üt
 *
	m´ev
;

182 (*
	m»ad_äom_»mÙe
)(
­ack‘
 *
	mp
, 
©¿n¥Üt
 *
	mt
);

183 (*
	mwr™e_to_»mÙe
)(
­ack‘
 *
	mp
, 
©¿n¥Üt
 *
	mt
);

184 (*
	mşo£
)(
©¿n¥Üt
 *
	mt
);

185 (*
	mkick
)(
©¿n¥Üt
 *
	mt
);

187 
	mfd
;

188 
	mŒª¥Üt_sock‘
;

189 
fdev’t
 
	mŒª¥Üt_fde
;

190 
	m»f_couÁ
;

191 
	msync_tok’
;

192 
	mcÚÃùiÚ_¡©e
;

193 
	mÚlše
;

194 
Œª¥Üt_ty³
 
	mty³
;

197 
usb_hªdË
 *
	musb
;

198 
	msfd
;

201 *
	m£rŸl
;

202 *
	m´oduù
;

203 *
	mmod–
;

204 *
	mdeviû
;

205 *
	mdev·th
;

206 
	madb_pÜt
;

209 
	mkicked
;

210 
adiscÚÃù
 
	mdiscÚÃùs
;

212 *
	mkey
;

213 
	mtok’
[
TOKEN_SIZE
];

214 
fdev’t
 
	mauth_fde
;

215 
	mçed_auth_©‹m±s
;

217 cÚ¡ * 
cÚÃùiÚ_¡©e_Çme
() const;

219 
	m´ÙocŞ_v”siÚ
;

220 
size_t
 
	mmax_·ylßd
;

221 
upd©e_v”siÚ
(
v”siÚ
, 
size_t
 
·ylßd
);

222 
g‘_´ÙocŞ_v”siÚ
() const;

223 
size_t
 
g‘_max_·ylßd
() const;

236 
	s®i¡’”


238 
®i¡’”
 *
	mÃxt
;

239 
®i¡’”
 *
	m´ev
;

241 
fdev’t
 
	mfde
;

242 
	mfd
;

244 *
	mloÿl_Çme
;

245 *
	mcÚÃù_to
;

246 
©¿n¥Üt
 *
	mŒª¥Üt
;

247 
adiscÚÃù
 
	mdiscÚÃù
;

251 
´št_·ck‘
(cÚ¡ *
Ïb–
, 
­ack‘
 *
p
);

253 
asock‘
 *
fšd_loÿl_sock‘
(
loÿl_id
, 
»mÙe_id
);

254 
š¡®l_loÿl_sock‘
(
asock‘
 *
s
);

255 
»move_sock‘
(
asock‘
 *
s
);

256 
şo£_®l_sock‘s
(
©¿n¥Üt
 *
t
);

258 
asock‘
 *
ü—‹_loÿl_sock‘
(
fd
);

259 
asock‘
 *
ü—‹_loÿl_£rviû_sock‘
(cÚ¡ *
de¡š©iÚ
);

261 
asock‘
 *
ü—‹_»mÙe_sock‘
(
id
, 
©¿n¥Üt
 *
t
);

262 
cÚÃù_to_»mÙe
(
asock‘
 *
s
, cÚ¡ *
de¡š©iÚ
);

263 
cÚÃù_to_sm¬tsock‘
(
asock‘
 *
s
);

265 
çl
(cÚ¡ *
fmt
, ...);

266 
çl_”ºo
(cÚ¡ *
fmt
, ...);

268 
hªdË_·ck‘
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
);

270 
g‘_my_·th
(*
s
, 
size_t
 
maxL’
);

271 
Ïunch_£rv”
(
£rv”_pÜt
);

272 
adb_maš
(
is_d«mÚ
, 
£rv”_pÜt
);

275 #ià
ADB_HOST


276 
g‘_avaabË_loÿl_Œª¥Üt_šdex
();

278 
š™_sock‘_Œª¥Üt
(
©¿n¥Üt
 *
t
, 
s
, 
pÜt
, 
loÿl
);

279 
š™_usb_Œª¥Üt
(
©¿n¥Üt
 *
t
, 
usb_hªdË
 *
usb
, 
¡©e
);

281 #ià
ADB_HOST


282 
©¿n¥Üt
* 
fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt
(
adb_pÜt
);

285 
£rviû_to_fd
(cÚ¡ *
Çme
);

286 #ià
ADB_HOST


287 
asock‘
 *
ho¡_£rviû_to_sock‘
(cÚ¡ * 
Çme
, cÚ¡ *
£rŸl
);

290 #ià!
ADB_HOST


291 
š™_jdwp
();

292 
asock‘
* 
ü—‹_jdwp_£rviû_sock‘
();

293 
asock‘
* 
ü—‹_jdwp_Œack”_£rviû_sock‘
();

294 
ü—‹_jdwp_cÚÃùiÚ_fd
(
jdwp_pid
);

297 
hªdË_fÜw¬d_»que¡
(cÚ¡ * 
£rviû
, 
Œª¥Üt_ty³
 
‰y³
, * 
£rŸl
, 
»¶y_fd
);

299 #ià!
ADB_HOST


300 
äamebufãr_£rviû
(
fd
, *
cook›
);

301 
£t_v”™y_’abËd_¡©e_£rviû
(
fd
, * 
cook›
);

305 
­ack‘
 *
g‘_­ack‘
();

306 
put_­ack‘
(
­ack‘
 *
p
);

309 
	#DEBUG_PACKETS
 0

	)

311 #ià!
DEBUG_PACKETS


312 
	#´št_·ck‘
(
g
,
p
èdØ{} 0)

	)

315 
	#USE_KEDACOM_ADB_TOOLS
 1

	)

317 #ià
ADB_HOST_ON_TARGET


321 
	#DEFAULT_ADB_PORT
 5038

	)

323 #ià
USE_KEDACOM_ADB_TOOLS


324 
	#DEFAULT_ADB_PORT
 50371

	)

326 
	#DEFAULT_ADB_PORT
 5037

	)

330 
	#DEFAULT_ADB_LOCAL_TRANSPORT_PORT
 5555

	)

332 #ià
USE_KEDACOM_ADB_TOOLS


334 
	#KDB_CLASS
 0x“

	)

335 
	#KDB_SUBCLASS
 0x45

	)

336 
	#KDB_PROTOCOL
 0x5

	)

339 
	#ADB_CLASS
 0xff

	)

340 
	#ADB_SUBCLASS
 0x42

	)

341 
	#ADB_PROTOCOL
 0x1

	)

344 
loÿl_š™
(
pÜt
);

345 
loÿl_cÚÃù
(
pÜt
);

346 
loÿl_cÚÃù_¬b™¿ry_pÜts
(
cÚsŞe_pÜt
, 
adb_pÜt
);

349 
usb_š™
();

350 
usb_ş—nup
();

351 
usb_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
d©a
, 
Ën
);

352 
usb_»ad
(
usb_hªdË
 *
h
, *
d©a
, 
Ën
);

353 
usb_şo£
(
usb_hªdË
 *
h
);

354 
usb_kick
(
usb_hªdË
 *
h
);

357 #ià
ADB_HOST


358 
is_adb_š‹rçû
(
vid
, 
pid
, 
usb_şass
, 
usb_subşass
, 
usb_´ÙocŞ
);

361 
adb_commªdlše
(
¬gc
, cÚ¡ **
¬gv
);

363 
cÚÃùiÚ_¡©e
(
©¿n¥Üt
 *
t
);

365 
	#CS_ANY
 -1

	)

366 
	#CS_OFFLINE
 0

	)

367 
	#CS_BOOTLOADER
 1

	)

368 
	#CS_DEVICE
 2

	)

369 
	#CS_HOST
 3

	)

370 
	#CS_RECOVERY
 4

	)

371 
	#CS_NOPERM
 5

	)

372 
	#CS_SIDELOAD
 6

	)

373 
	#CS_UNAUTHORIZED
 7

	)

375 cÚ¡ *
adb_deviû_bªÃr
;

376 
HOST
;

377 
SHELL_EXIT_NOTIFY_FD
;

379 
	esub´oc_mode
 {

380 
	mSUBPROC_PTY
 = 0,

381 
	mSUBPROC_RAW
 = 1,

384 
	#CHUNK_SIZE
 (64*1024)

	)

386 #ià!
ADB_HOST


387 
	#USB_ADB_PATH
 "/dev/ªdroid_adb"

	)

389 
	#USB_FFS_ADB_PATH
 "/dev/usb-ffs/adb/"

	)

390 
	#USB_FFS_ADB_EP
(
x
è
USB_FFS_ADB_PATH
#x

	)

392 
	#USB_FFS_ADB_EP0
 
	`USB_FFS_ADB_EP
(
•0
)

	)

393 
	#USB_FFS_ADB_OUT
 
	`USB_FFS_ADB_EP
(
•1
)

	)

394 
	#USB_FFS_ADB_IN
 
	`USB_FFS_ADB_EP
(
•2
)

	)

397 
hªdË_ho¡_»que¡
(*
£rviû
, 
Œª¥Üt_ty³
 
‰y³
, * 
£rŸl
, 
»¶y_fd
, 
asock‘
 *
s
);

399 
hªdË_Úlše
(
©¿n¥Üt
 *
t
);

400 
hªdË_ofæše
(
©¿n¥Üt
 *
t
);

402 
£nd_cÚÃù
(
©¿n¥Üt
 *
t
);

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_auth.cpp

17 
	#TRACE_TAG
 
TRACE_ADB


	)

19 
	~"sysd•s.h
"

20 
	~"adb_auth.h
"

22 
	~<”ºo.h
>

23 
	~<¡dio.h
>

24 
	~<¡ršg.h
>

25 
	~<sys/ty³s.h
>

26 
	~<uni¡d.h
>

28 
	~"adb.h
"

29 
	~"Œª¥Üt.h
"

31 
boŞ
 
	gauth_»quœed
 = 
Œue
;

33 
	$£nd_auth_»que¡
(
©¿n¥Üt
 *
t
)

35 
	`D
("Calling send_auth_request\n");

36 
­ack‘
 *
p
;

37 
»t
;

39 
»t
 = 
	`adb_auth_g’”©e_tok’
(
t
->
tok’
, (t->token));

40 ià(
»t
 !ğ(
t
->
tok’
)) {

41 
	`D
("E¼Ü g’”©šgok’„‘=%d\n", 
»t
);

45 
p
 = 
	`g‘_­ack‘
();

46 
	`memıy
(
p
->
d©a
, 
t
->
tok’
, 
»t
);

47 
p
->
msg
.
commªd
 = 
A_AUTH
;

48 
p
->
msg
.
¬g0
 = 
ADB_AUTH_TOKEN
;

49 
p
->
msg
.
d©a_Ëngth
 = 
»t
;

50 
	`£nd_·ck‘
(
p
, 
t
);

51 
	}
}

53 
	$£nd_auth_»¥Ú£
(
ušt8_t
 *
tok’
, 
size_t
 
tok’_size
, 
©¿n¥Üt
 *
t
)

55 
	`D
("Calling send_auth_response\n");

56 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

57 
»t
;

59 
»t
 = 
	`adb_auth_sign
(
t
->
key
, 
tok’
, 
tok’_size
, 
p
->
d©a
);

60 ià(!
»t
) {

61 
	`D
("Error signingheoken\n");

62 
	`put_­ack‘
(
p
);

66 
p
->
msg
.
commªd
 = 
A_AUTH
;

67 
p
->
msg
.
¬g0
 = 
ADB_AUTH_SIGNATURE
;

68 
p
->
msg
.
d©a_Ëngth
 = 
»t
;

69 
	`£nd_·ck‘
(
p
, 
t
);

70 
	}
}

72 
	$£nd_auth_publickey
(
©¿n¥Üt
 *
t
)

74 
	`D
("Calling send_auth_publickey\n");

75 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

76 
»t
;

78 
»t
 = 
	`adb_auth_g‘_u£rkey
(
p
->
d©a
, 
MAX_PAYLOAD_V1
);

79 ià(!
»t
) {

80 
	`D
("Failedo get user…ublic key\n");

81 
	`put_­ack‘
(
p
);

85 
p
->
msg
.
commªd
 = 
A_AUTH
;

86 
p
->
msg
.
¬g0
 = 
ADB_AUTH_RSAPUBLICKEY
;

87 
p
->
msg
.
d©a_Ëngth
 = 
»t
;

88 
	`£nd_·ck‘
(
p
, 
t
);

89 
	}
}

91 
	$adb_auth_v”if›d
(
©¿n¥Üt
 *
t
)

93 
	`hªdË_Úlše
(
t
);

94 
	`£nd_cÚÃù
(
t
);

95 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_auth.h

17 #iâdeà
__ADB_AUTH_H


18 
	#__ADB_AUTH_H


	)

20 
	~"adb.h
"

22 
boŞ
 
auth_»quœed
;

24 
adb_auth_keyg’
(cÚ¡ * 
f’ame
);

25 
adb_auth_v”if›d
(
©¿n¥Üt
 *
t
);

27 
£nd_auth_»que¡
(
©¿n¥Üt
 *
t
);

28 
£nd_auth_»¥Ú£
(
ušt8_t
 *
tok’
, 
size_t
 
tok’_size
, 
©¿n¥Üt
 *
t
);

29 
£nd_auth_publickey
(
©¿n¥Üt
 *
t
);

33 
	#ADB_AUTH_TOKEN
 1

	)

35 
	#ADB_AUTH_SIGNATURE
 2

	)

36 
	#ADB_AUTH_RSAPUBLICKEY
 3

	)

38 #ià
ADB_HOST


40 
adb_auth_š™
();

41 
adb_auth_sign
(*
key
, cÚ¡ * 
tok’
, 
size_t
 
tok’_size
,

42 * 
sig
);

43 *
adb_auth_Ãxtkey
(*
cu¼’t
);

44 
adb_auth_g‘_u£rkey
(*
d©a
, 
size_t
 
Ën
);

46 
šlše
 
	$adb_auth_g’”©e_tok’
(*
tok’
, 
size_t
 
tok’_size
è{  0; 
	}
}

47 
šlše
 
	$adb_auth_v”ify
(*
tok’
, *
sig
, 
sigËn
è{  0; 
	}
}

48 
šlše
 
	$adb_auth_cÚfœm_key
(*
d©a
, 
size_t
 
Ën
, 
©¿n¥Üt
 *
t
è{ 
	}
}

52 
šlše
 
	$adb_auth_sign
(* 
key
, cÚ¡ * 
tok’
,

53 
size_t
 
tok’_size
, * 
sig
) {

55 
	}
}

56 
šlše
 *
	$adb_auth_Ãxtkey
(*
cu¼’t
è{  
NULL
; 
	}
}

57 
šlše
 
	$adb_auth_g‘_u£rkey
(*
d©a
, 
size_t
 
Ën
è{  0; 
	}
}

59 
adbd_auth_š™
();

60 
adbd_şÛxec_auth_sock‘
();

61 
adb_auth_g’”©e_tok’
(*
tok’
, 
size_t
 
tok’_size
);

62 
adb_auth_v”ify
(
ušt8_t
* 
tok’
, ušt8_t* 
sig
, 
sigËn
);

63 
adb_auth_cÚfœm_key
(*
d©a
, 
size_t
 
Ën
, 
©¿n¥Üt
 *
t
);

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_auth_client.cpp

17 
	#TRACE_TAG
 
TRACE_AUTH


	)

19 
	~"sysd•s.h
"

20 
	~"adb_auth.h
"

22 
	~<»sŞv.h
>

23 
	~<¡dio.h
>

24 
	~<¡ršg.h
>

26 
	~"cuts/li¡.h
"

27 
	~"cuts/sock‘s.h
"

28 
	~"mšüy±/r§.h
"

29 
	~"mšüy±/sha.h
"

31 
	~"adb.h
"

32 
	~"fdev’t.h
"

33 
	~"Œª¥Üt.h
"

35 
	sadb_public_key
 {

36 
li¡node
 
	mnode
;

37 
RSAPublicKey
 
	mkey
;

40 cÚ¡ *
	gkey_·ths
[] = {

43 
NULL


46 
fdev’t
 
	gli¡’”_fde
;

47 
	gäamewÜk_fd
 = -1;

49 
usb_discÚÃùed
(* 
unu£d
, 
©¿n¥Üt
* 
t
);

50 
adiscÚÃù
 
	gusb_discÚÃù
 = { 
usb_discÚÃùed
, 0, 0, 0 };

51 
©¿n¥Üt
* 
	gusb_Œª¥Üt
;

52 
boŞ
 
	gÃeds_»Œy
 = 
çl£
;

54 
	$»ad_keys
(cÚ¡ *
fe
, 
li¡node
 *
li¡
)

56 
FILE
 *
f
;

57 
buf
[
MAX_PAYLOAD_V1
];

58 *
£p
;

59 
»t
;

61 
f
 = 
	`fİ’
(
fe
, "re");

62 ià(!
f
) {

63 
	`D
("Cª'ˆİ’ '%s'\n", 
fe
);

67 
	`fg‘s
(
buf
, (buf), 
f
)) {

69 autØ
key
 = 
»š‹½»t_ÿ¡
<
adb_public_key
*>(

70 
	`ÿÎoc
(1, (
adb_public_key
) + 4));

71 ià(
key
 =ğ
nuÎ±r
) {

72 
	`D
("Can't malloc key\n");

76 
£p
 = 
	`¡½brk
(
buf
, " \t");

77 ià(
£p
)

78 *
£p
 = '\0';

80 
»t
 = 
	`__b64_±Ú
(
buf
, (
u_ch¬
 *)&
key
->key, (key->key) + 4);

81 ià(
»t
 !ğ(
key
->key)) {

82 
	`D
("%s: Inv®id ba£64 d©¨»t=%d\n", 
fe
, 
»t
);

83 
	`ä“
(
key
);

87 ià(
key
->key.
Ën
 !ğ
RSANUMWORDS
) {

88 
	`D
("%s: Inv®id key†’ %d\n", 
fe
, 
key
->key.
Ën
);

89 
	`ä“
(
key
);

93 
	`li¡_add_
(
li¡
, &
key
->
node
);

96 
	`fşo£
(
f
);

97 
	}
}

99 
	$ä“_keys
(
li¡node
 *
li¡
)

101 
li¡node
 *
™em
;

103 !
	`li¡_em±y
(
li¡
)) {

104 
™em
 = 
	`li¡_h—d
(
li¡
);

105 
	`li¡_»move
(
™em
);

106 
	`ä“
(
	`node_to_™em
(
™em
, 
adb_public_key
, 
node
));

108 
	}
}

110 
	$lßd_keys
(
li¡node
 *
li¡
)

112 cÚ¡ * 
·th
;

113 cÚ¡ ** 
·ths
 = 
key_·ths
;

114 
¡©
 
buf
;

116 
	`li¡_š™
(
li¡
);

118 (
·th
 = *
·ths
++)) {

119 ià(!
	`¡©
(
·th
, &
buf
)) {

120 
	`D
("Lßdšg key äom '%s'\n", 
·th
);

121 
	`»ad_keys
(
·th
, 
li¡
);

124 
	}
}

126 
	$adb_auth_g’”©e_tok’
(*
tok’
, 
size_t
 
tok’_size
)

128 
FILE
 *
f
;

129 
»t
;

131 
f
 = 
	`fİ’
("/dev/urandom", "re");

132 ià(!
f
)

135 
»t
 = 
	`ä—d
(
tok’
, 
tok’_size
, 1, 
f
);

137 
	`fşo£
(
f
);

138  
»t
 * 
tok’_size
;

139 
	}
}

141 
	$adb_auth_v”ify
(
ušt8_t
* 
tok’
, ušt8_t* 
sig
, 
sigËn
)

143 
li¡node
 *
™em
;

144 
li¡node
 
key_li¡
;

145 
»t
 = 0;

147 ià(
sigËn
 !ğ
RSANUMBYTES
)

150 
	`lßd_keys
(&
key_li¡
);

152 
	`li¡_fÜ_—ch
(
™em
, &
key_li¡
) {

153 
adb_public_key
* 
key
 = 
	`node_to_™em
(
™em
, adb_public_key, 
node
);

154 
»t
 = 
	`RSA_v”ify
(&
key
->key, 
sig
, 
sigËn
, 
tok’
, 
SHA_DIGEST_SIZE
);

155 ià(
»t
)

159 
	`ä“_keys
(&
key_li¡
);

161  
»t
;

162 
	}
}

164 
	$usb_discÚÃùed
(* 
unu£d
, 
©¿n¥Üt
* 
t
)

166 
	`D
("USB disconnect\n");

167 
	`»move_Œª¥Üt_discÚÃù
(
usb_Œª¥Üt
, &
usb_discÚÃù
);

168 
usb_Œª¥Üt
 = 
NULL
;

169 
Ãeds_»Œy
 = 
çl£
;

170 
	}
}

172 
	$adb_auth_ev’t
(
fd
, 
ev’ts
, *
d©a
)

174 
»¥Ú£
[2];

175 
»t
;

177 ià(
ev’ts
 & 
FDE_READ
) {

178 
»t
 = 
	`unix_»ad
(
fd
, 
»¥Ú£
, (response));

179 ià(
»t
 <= 0) {

180 
	`D
("Framework disconnect\n");

181 ià(
usb_Œª¥Üt
)

182 
	`fdev’t_»move
(&
usb_Œª¥Üt
->
auth_fde
);

183 
äamewÜk_fd
 = -1;

185 ià(
»t
 =ğ2 && 
»¥Ú£
[0] == 'O' &&„esponse[1] == 'K') {

186 ià(
usb_Œª¥Üt
)

187 
	`adb_auth_v”if›d
(
usb_Œª¥Üt
);

190 
	}
}

192 
	$adb_auth_cÚfœm_key
(*
key
, 
size_t
 
Ën
, 
©¿n¥Üt
 *
t
)

194 
msg
[
MAX_PAYLOAD_V1
];

195 
»t
;

197 ià(!
usb_Œª¥Üt
) {

198 
usb_Œª¥Üt
 = 
t
;

199 
	`add_Œª¥Üt_discÚÃù
(
t
, &
usb_discÚÃù
);

202 ià(
äamewÜk_fd
 < 0) {

203 
	`D
("Client‚ot connected\n");

204 
Ãeds_»Œy
 = 
Œue
;

208 ià(
key
[
Ën
 - 1] != '\0') {

209 
	`D
("Key must be‡‚ull-terminated string\n");

213 
»t
 = 
	`¢´štf
(
msg
, (msg), "PK%s", 
key
);

214 ià(
»t
 >ğ(sigÃd)(
msg
)) {

215 
	`D
("KeyoØlÚg.„‘=%d", 
»t
);

218 
	`D
("S’dšg '%s'\n", 
msg
);

220 
»t
 = 
	`unix_wr™e
(
äamewÜk_fd
, 
msg
,„et);

221 ià(
»t
 < 0) {

222 
	`D
("FaedØwr™PK,ƒ¼no=%d\n", 
”ºo
);

226 
	`fdev’t_š¡®l
(&
t
->
auth_fde
, 
äamewÜk_fd
, 
adb_auth_ev’t
,);

227 
	`fdev’t_add
(&
t
->
auth_fde
, 
FDE_READ
);

228 
	}
}

230 
	$adb_auth_li¡’”
(
fd
, 
ev’ts
, *
d©a
)

232 
sockaddr
 
addr
;

233 
sockËn_t
 
®’
;

234 
s
;

236 
®’
 = (
addr
);

238 
s
 = 
	`adb_sock‘_acû±
(
fd
, &
addr
, &
®’
);

239 ià(
s
 < 0) {

240 
	`D
("FaedØacû±:ƒ¼no=%d\n", 
”ºo
);

244 
äamewÜk_fd
 = 
s
;

246 ià(
Ãeds_»Œy
) {

247 
Ãeds_»Œy
 = 
çl£
;

248 
	`£nd_auth_»que¡
(
usb_Œª¥Üt
);

250 
	}
}

252 
	$adbd_şÛxec_auth_sock‘
() {

253 
fd
 = 
	`ªdroid_g‘_cÚŒŞ_sock‘
("adbd");

254 ià(
fd
 == -1) {

255 
	`D
("Failedo get‡dbd socket\n");

258 
	`fú
(
fd
, 
F_SETFD
, 
FD_CLOEXEC
);

259 
	}
}

261 
	$adbd_auth_š™
() {

262 
fd
 = 
	`ªdroid_g‘_cÚŒŞ_sock‘
("adbd");

263 ià(
fd
 == -1) {

264 
	`D
("Failedo get‡dbd socket\n");

268 ià(
	`li¡’
(
fd
, 4) == -1) {

269 
	`D
("FaedØli¡’ oÀ'%d'\n", 
fd
);

273 
	`fdev’t_š¡®l
(&
li¡’”_fde
, 
fd
, 
adb_auth_li¡’”
, 
NULL
);

274 
	`fdev’t_add
(&
li¡’”_fde
, 
FDE_READ
);

275 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_auth_host.cpp

17 
	#TRACE_TAG
 
TRACE_AUTH


	)

19 
	~"sysd•s.h
"

20 
	~"adb_auth.h
"

22 
	~<¡dio.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

26 #ifdeà
_WIN32


27 #iâdeà
WIN32_LEAN_AND_MEAN


28 
	#WIN32_LEAN_AND_MEAN


	)

30 
	~"wšdows.h
"

31 
	~"shlobj.h
"

33 
	~<sys/ty³s.h
>

34 
	~<sys/¡©.h
>

35 
	~<uni¡d.h
>

38 
	~"adb.h
"

42 
	#RSA_v”ify
 
RSA_v”ify_mšüy±


	)

43 
	~"mšüy±/r§.h
"

44 #undeà
RSA_v”ify


46 
	~<ba£/¡ršgs.h
>

47 
	~<cuts/li¡.h
>

49 
	~<İ’s¦/evp.h
>

50 
	~<İ’s¦/objeùs.h
>

51 
	~<İ’s¦/³m.h
>

52 
	~<İ’s¦/r§.h
>

53 
	~<İ’s¦/sha.h
>

55 #ià
defšed
(
OPENSSL_IS_BORINGSSL
)

56 
	~<İ’s¦/ba£64.h
>

59 
	#ANDROID_PATH
 ".ªdroid"

	)

60 
	#ADB_KEY_FILE
 "adbkey"

	)

62 
	sadb_´iv©e_key
 {

63 
li¡node
 
	mnode
;

64 
RSA
 *
	mr§
;

67 
li¡node
 
	gkey_li¡
;

71 
	$RSA_to_RSAPublicKey
(
RSA
 *
r§
, 
RSAPublicKey
 *
pkey
)

73 
»t
 = 1;

74 
i
;

76 
BN_CTX
* 
ùx
 = 
	`BN_CTX_Ãw
();

77 
BIGNUM
* 
r32
 = 
	`BN_Ãw
();

78 
BIGNUM
* 
¼
 = 
	`BN_Ãw
();

79 
BIGNUM
* 
r
 = 
	`BN_Ãw
();

80 
BIGNUM
* 
»m
 = 
	`BN_Ãw
();

81 
BIGNUM
* 
n
 = 
	`BN_Ãw
();

82 
BIGNUM
* 
n0šv
 = 
	`BN_Ãw
();

84 ià(
	`RSA_size
(
r§
è!ğ
RSANUMBYTES
) {

85 
»t
 = 0;

86 
out
;

89 
	`BN_£t_b™
(
r32
, 32);

90 
	`BN_cİy
(
n
, 
r§
->n);

91 
	`BN_£t_b™
(
r
, 
RSANUMWORDS
 * 32);

92 
	`BN_mod_sqr
(
¼
, 
r
, 
n
, 
ùx
);

93 
	`BN_div
(
NULL
, 
»m
, 
n
, 
r32
, 
ùx
);

94 
	`BN_mod_šv”£
(
n0šv
, 
»m
, 
r32
, 
ùx
);

96 
pkey
->
Ën
 = 
RSANUMWORDS
;

97 
pkey
->
n0šv
 = 0 - 
	`BN_g‘_wÜd
(n0inv);

98 
i
 = 0; i < 
RSANUMWORDS
; i++) {

99 
	`BN_div
(
¼
, 
»m
,„r, 
r32
, 
ùx
);

100 
pkey
->
¼
[
i
] = 
	`BN_g‘_wÜd
(
»m
);

101 
	`BN_div
(
n
, 
»m
,‚, 
r32
, 
ùx
);

102 
pkey
->
n
[
i
] = 
	`BN_g‘_wÜd
(
»m
);

104 
pkey
->
expÚ’t
 = 
	`BN_g‘_wÜd
(
r§
->
e
);

106 
out
:

107 
	`BN_ä“
(
n0šv
);

108 
	`BN_ä“
(
n
);

109 
	`BN_ä“
(
»m
);

110 
	`BN_ä“
(
r
);

111 
	`BN_ä“
(
¼
);

112 
	`BN_ä“
(
r32
);

113 
	`BN_CTX_ä“
(
ùx
);

115  
»t
;

116 
	}
}

118 
	$g‘_u£r_šfo
(*
buf
, 
size_t
 
Ën
)

120 
ho¡Çme
[1024], 
u£ºame
[1024];

121 
»t
 = -1;

123 ià(
	`g‘’v
("HOSTNAME"è!ğ
NULL
) {

124 
	`¡ºıy
(
ho¡Çme
, 
	`g‘’v
("HOSTNAME"), (hostname));

125 
ho¡Çme
[(hostname)-1] = '\0';

126 
»t
 = 0;

129 #iâdeà
_WIN32


130 ià(
»t
 < 0)

131 
»t
 = 
	`g‘ho¡Çme
(
ho¡Çme
, (hostname));

133 ià(
»t
 < 0)

134 
	`¡rıy
(
ho¡Çme
, "unknown");

136 
»t
 = -1;

138 ià(
	`g‘’v
("LOGNAME"è!ğ
NULL
) {

139 
	`¡ºıy
(
u£ºame
, 
	`g‘’v
("LOGNAME"), (username));

140 
u£ºame
[(username)-1] = '\0';

141 
»t
 = 0;

144 #ià!
defšed
 
_WIN32
 && !defšed 
ADB_HOST_ON_TARGET


145 ià(
»t
 < 0)

146 
»t
 = 
	`g‘logš_r
(
u£ºame
, (username));

148 ià(
»t
 < 0)

149 
	`¡rıy
(
u£ºame
, "unknown");

151 
»t
 = 
	`¢´štf
(
buf
, 
Ën
, " %s@%s", 
u£ºame
, 
ho¡Çme
);

152 ià(
»t
 >ğ(sigÃd)
Ën
)

153 
buf
[
Ën
 - 1] = '\0';

154 
	}
}

156 
	$wr™e_public_keyfe
(
RSA
 *
´iv©e_key
, cÚ¡ *
´iv©e_key_·th
)

158 
RSAPublicKey
 
pkey
;

159 
FILE
 *
outfe
 = 
NULL
;

160 
·th
[
PATH_MAX
], 
šfo
[
MAX_PAYLOAD_V1
];

161 
ušt8_t
* 
’coded
 = 
nuÎ±r
;

162 
size_t
 
’coded_Ëngth
;

163 
»t
 = 0;

165 ià(
	`¢´štf
(
·th
, Õ©h), "%s.pub", 
´iv©e_key_·th
) >=

166 ()(
·th
)) {

167 
	`D
("Pathoo†ong while writing…ublic key\n");

171 ià(!
	`RSA_to_RSAPublicKey
(
´iv©e_key
, &
pkey
)) {

172 
	`D
("Failedo converto…ublickey\n");

176 
outfe
 = 
	`fİ’
(
·th
, "w");

177 ià(!
outfe
) {

178 
	`D
("FaedØİ’ '%s'\n", 
·th
);

182 
	`D
("Wr™šg…ubliøkeyØ'%s'\n", 
·th
);

184 #ià
	`defšed
(
OPENSSL_IS_BORINGSSL
)

185 ià(!
	`EVP_EncodedL’gth
(&
’coded_Ëngth
, (
pkey
))) {

186 
	`D
("Public keyoo†argeo base64ƒncode");

187 
out
;

192 
’coded_Ëngth
 = 1 + (((
pkey
) + 2) / 3 * 4);

195 
’coded
 = 
Ãw
 
ušt8_t
[
’coded_Ëngth
];

196 ià(
’coded
 =ğ
nuÎ±r
) {

197 
	`D
("Allocation failure");

198 
out
;

201 
’coded_Ëngth
 = 
	`EVP_EncodeBlock
(
’coded
, (
ušt8_t
*è&
pkey
, (pkey));

202 
	`g‘_u£r_šfo
(
šfo
, (info));

204 ià(
	`fwr™e
(
’coded
, 
’coded_Ëngth
, 1, 
outfe
) != 1 ||

205 
	`fwr™e
(
šfo
, 
	`¡¾’
(šfo), 1, 
outfe
) != 1) {

206 
	`D
("Writeƒrror while writing…ublic key");

207 
out
;

210 
»t
 = 1;

212 
out
:

213 ià(
outfe
 !ğ
NULL
) {

214 
	`fşo£
(
outfe
);

216 
d–‘e
[] 
’coded
;

217  
»t
;

218 
	}
}

220 
	$g’”©e_key
(cÚ¡ *
fe
)

222 
EVP_PKEY
* 
pkey
 = 
	`EVP_PKEY_Ãw
();

223 
BIGNUM
* 
expÚ’t
 = 
	`BN_Ãw
();

224 
RSA
* 
r§
 = 
	`RSA_Ãw
();

225 
mode_t
 
Şd_mask
;

226 
FILE
 *
f
 = 
NULL
;

227 
»t
 = 0;

229 
	`D
("g’”©e_key '%s'\n", 
fe
);

231 ià(!
pkey
 || !
expÚ’t
 || !
r§
) {

232 
	`D
("Failedo‡llocate key\n");

233 
out
;

236 
	`BN_£t_wÜd
(
expÚ’t
, 
RSA_F4
);

237 
	`RSA_g’”©e_key_ex
(
r§
, 2048, 
expÚ’t
, 
NULL
);

238 
	`EVP_PKEY_£t1_RSA
(
pkey
, 
r§
);

240 
Şd_mask
 = 
	`umask
(077);

242 
f
 = 
	`fİ’
(
fe
, "w");

243 ià(!
f
) {

244 
	`D
("FaedØİ’ '%s'\n", 
fe
);

245 
	`umask
(
Şd_mask
);

246 
out
;

249 
	`umask
(
Şd_mask
);

251 ià(!
	`PEM_wr™e_Priv©eKey
(
f
, 
pkey
, 
NULL
, NULL, 0, NULL, NULL)) {

252 
	`D
("Failedo write key\n");

253 
out
;

256 ià(!
	`wr™e_public_keyfe
(
r§
, 
fe
)) {

257 
	`D
("Failedo write…ublic key\n");

258 
out
;

261 
»t
 = 1;

263 
out
:

264 ià(
f
)

265 
	`fşo£
(
f
);

266 
	`EVP_PKEY_ä“
(
pkey
);

267 
	`RSA_ä“
(
r§
);

268 
	`BN_ä“
(
expÚ’t
);

269  
»t
;

270 
	}
}

272 
	$»ad_key
(cÚ¡ *
fe
, 
li¡node
 *
li¡
)

274 
	`D
("»ad_key '%s'\n", 
fe
);

276 
FILE
* 
å
 = 
	`fİ’
(
fe
, "r");

277 ià(!
å
) {

278 
	`D
("FaedØİ’ '%s': %s\n", 
fe
, 
	`¡»¼Ü
(
”ºo
));

282 
adb_´iv©e_key
* 
key
 = 
Ãw
‡db_private_key;

283 
key
->
r§
 = 
	`RSA_Ãw
();

285 ià(!
	`PEM_»ad_RSAPriv©eKey
(
å
, &
key
->
r§
, 
NULL
, NULL)) {

286 
	`D
("Failedo„ead key\n");

287 
	`fşo£
(
å
);

288 
	`RSA_ä“
(
key
->
r§
);

289 
d–‘e
 
key
;

293 
	`fşo£
(
å
);

294 
	`li¡_add_
(
li¡
, &
key
->
node
);

296 
	}
}

298 
	$g‘_u£r_keyf•©h
(*
f’ame
, 
size_t
 
Ën
)

300 cÚ¡ *
fÜm©
, *
home
;

301 
ªdroid_dœ
[
PATH_MAX
];

302 
¡©
 
buf
;

303 #ifdeà
_WIN32


304 
·th
[
PATH_MAX
];

305 
home
 = 
	`g‘’v
("ANDROID_SDK_HOME");

306 ià(!
home
) {

307 
	`SHG‘FŞd”P©h
(
NULL
, 
CSIDL_PROFILE
, NULL, 0, 
·th
);

308 
home
 = 
·th
;

310 
fÜm©
 = "%s\\%s";

312 
home
 = 
	`g‘’v
("HOME");

313 ià(!
home
)

315 
fÜm©
 = "%s/%s";

318 
	`D
("hom'%s'\n", 
home
);

320 ià(
	`¢´štf
(
ªdroid_dœ
, ×ndroid_dœ), 
fÜm©
, 
home
,

321 
ANDROID_PATH
è>ğ()(
ªdroid_dœ
))

324 ià(
	`¡©
(
ªdroid_dœ
, &
buf
)) {

325 ià(
	`adb_mkdœ
(
ªdroid_dœ
, 0750) < 0) {

326 
	`D
("CªnÙ mkdœ '%s'", 
ªdroid_dœ
);

331  
	`¢´štf
(
f’ame
, 
Ën
, 
fÜm©
, 
ªdroid_dœ
, 
ADB_KEY_FILE
);

332 
	}
}

334 
	$g‘_u£r_key
(
li¡node
 *
li¡
)

336 
¡©
 
buf
;

337 
·th
[
PATH_MAX
];

338 
»t
;

340 
»t
 = 
	`g‘_u£r_keyf•©h
(
·th
, (path));

341 ià(
»t
 < 0 ||„‘ >ğ(sigÃd)(
·th
)) {

342 
	`D
("Error getting user key filename");

346 
	`D
("u£¸key '%s'\n", 
·th
);

348 ià(
	`¡©
(
·th
, &
buf
) == -1) {

349 ià(!
	`g’”©e_key
(
·th
)) {

350 
	`D
("Failedo generate‚ew key\n");

355  
	`»ad_key
(
·th
, 
li¡
);

356 
	}
}

358 
	$g‘_v’dÜ_keys
(
li¡node
* 
key_li¡
) {

359 cÚ¡ * 
adb_keys_·th
 = 
	`g‘’v
("ADB_VENDOR_KEYS");

360 ià(
adb_keys_·th
 =ğ
nuÎ±r
) {

364 auto& 
·th
 : 
ªdroid
::
ba£
::
	`S¶™
(
adb_keys_·th
, 
ENV_PATH_SEPARATOR_STR
)) {

365 ià(!
	`»ad_key
(
·th
.
	`c_¡r
(), 
key_li¡
)) {

366 
	`D
("FaedØ»ad '%s'\n", 
·th
.
	`c_¡r
());

369 
	}
}

371 
	$adb_auth_sign
(*
node
, cÚ¡ * 
tok’
, 
size_t
 
tok’_size
,

372 * 
sig
)

374 
Ën
;

375 
adb_´iv©e_key
 *
key
 = 
	`node_to_™em
(
node
, adb_private_key,‚ode);

377 ià(
tok’_size
 !ğ
TOKEN_SIZE
) {

378 
	`D
("UÃx³ùedok’ siz%zd\n", 
tok’_size
);

382 ià(!
	`RSA_sign
(
NID_sha1
, 
tok’
, 
tok’_size
, 
sig
, &
Ën
, 
key
->
r§
)) {

386 
	`D
("adb_auth_sigÀËn=%d\n", 
Ën
);

387  ()
Ën
;

388 
	}
}

390 *
	$adb_auth_Ãxtkey
(*
cu¼’t
)

392 
li¡node
 *
™em
;

394 ià(
	`li¡_em±y
(&
key_li¡
))

395  
NULL
;

397 ià(!
cu¼’t
)

398  
	`li¡_h—d
(&
key_li¡
);

400 
	`li¡_fÜ_—ch
(
™em
, &
key_li¡
) {

401 ià(
™em
 =ğ
cu¼’t
) {

403 ià(
™em
->
Ãxt
 =ğ&
key_li¡
)

404  
NULL
;

405  
™em
->
Ãxt
;

409  
NULL
;

410 
	}
}

412 
	$adb_auth_g‘_u£rkey
(*
d©a
, 
size_t
 
Ën
)

414 
·th
[
PATH_MAX
];

415 
»t
 = 
	`g‘_u£r_keyf•©h
(
·th
, (path) - 4);

416 ià(
»t
 < 0 ||„‘ >ğ(sigÃd)((
·th
) - 4)) {

417 
	`D
("Error getting user key filename");

420 
	`¡rÿt
(
·th
, ".pub");

423 
size
;

424 * 
fe_d©a
 = 
»š‹½»t_ÿ¡
<*>(
	`lßd_fe
(
·th
, &
size
));

425 ià(
fe_d©a
 =ğ
nuÎ±r
) {

426 
	`D
("Cª'ˆlßd '%s'\n", 
·th
);

430 ià(
Ën
 < (
size_t
)(
size
 + 1)) {

431 
	`D
("%s: CÚ‹ÁoØÏrg»t=%d\n", 
·th
, 
size
);

432 
	`ä“
(
fe_d©a
);

436 
	`memıy
(
d©a
, 
fe_d©a
, 
size
);

437 
	`ä“
(
fe_d©a
);

438 
fe_d©a
 = 
nuÎ±r
;

439 
d©a
[
size
] = '\0';

441  
size
 + 1;

442 
	}
}

444 
	$adb_auth_keyg’
(cÚ¡ * 
f’ame
) {

445 
adb_Œaû_mask
 |ğ(1 << 
TRACE_AUTH
);

446  (
	`g’”©e_key
(
f’ame
) == 0);

447 
	}
}

449 
	$adb_auth_š™
()

451 
»t
;

453 
	`D
("adb_auth_init\n");

455 
	`li¡_š™
(&
key_li¡
);

457 
»t
 = 
	`g‘_u£r_key
(&
key_li¡
);

458 ià(!
»t
) {

459 
	`D
("Failedo get user key\n");

463 
	`g‘_v’dÜ_keys
(&
key_li¡
);

464 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_client.cpp

17 
	#TRACE_TAG
 
TRACE_ADB


	)

19 
	~"sysd•s.h
"

20 
	~"adb_ş›Á.h
"

22 
	~<”ºo.h
>

23 
	~<lim™s.h
>

24 
	~<¡d¬g.h
>

25 
	~<¡dio.h
>

26 
	~<¡dlib.h
>

27 
	~<¡ršg.h
>

28 
	~<sys/¡©.h
>

29 
	~<sys/ty³s.h
>

31 
	~<¡ršg
>

32 
	~<veùÜ
>

34 
	~<ba£/¡ršg´štf.h
>

35 
	~<ba£/¡ršgs.h
>

37 
	~"adb_io.h
"

39 
Œª¥Üt_ty³
 
	g__adb_Œª¥Üt
 = 
kT¿n¥ÜtAny
;

40 cÚ¡ * 
	g__adb_£rŸl
 = 
NULL
;

42 
	g__adb_£rv”_pÜt
 = 
DEFAULT_ADB_PORT
;

43 cÚ¡ * 
	g__adb_£rv”_Çme
 = 
NULL
;

45 
	g¡d
::
¡ršg
 
	$³¼Ü_¡r
(cÚ¡ * 
msg
) {

46  
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s: %s", 
msg
, 
	`¡»¼Ü
(
”ºo
));

47 
	}
}

49 
boŞ
 
	$R—dPrÙocŞSŒšg
(
fd
, 
¡d
::
¡ršg
* 
s
, std::¡ršg* 
”rÜ
) {

50 
buf
[5];

51 ià(!
	`R—dFdExaùly
(
fd
, 
buf
, 4)) {

52 *
”rÜ
 = 
	`³¼Ü_¡r
("protocol fault (couldn't„ead status†ength)");

53  
çl£
;

55 
buf
[4] = 0;

57 
Ën
 = 
	`¡¹oul
(
buf
, 0, 16);

58 
s
->
	`»size
(
Ën
, '\0');

59 ià(!
	`R—dFdExaùly
(
fd
, &(*
s
)[0], 
Ën
)) {

60 *
”rÜ
 = 
	`³¼Ü_¡r
("protocol fault (couldn't„ead status message)");

61  
çl£
;

64  
Œue
;

65 
	}
}

67 
	$adb_£t_Œª¥Üt
(
Œª¥Üt_ty³
 
ty³
, cÚ¡ * 
£rŸl
)

69 
__adb_Œª¥Üt
 = 
ty³
;

70 
__adb_£rŸl
 = 
£rŸl
;

71 
	}
}

73 
	$adb_£t_tı_¥ecifics
(
£rv”_pÜt
)

75 
__adb_£rv”_pÜt
 = 
£rv”_pÜt
;

76 
	}
}

78 
	$adb_£t_tı_Çme
(cÚ¡ * 
ho¡Çme
)

80 
__adb_£rv”_Çme
 = 
ho¡Çme
;

81 
	}
}

83 
	$adb_g‘_emuÏtÜ_cÚsŞe_pÜt
() {

84 ià(
__adb_£rŸl
) {

86 
pÜt
;

87  (
	`ssÿnf
(
__adb_£rŸl
, "emuÏtÜ-%d", &
pÜt
) == 1) ?…ort : -1;

93 
¡d
::
¡ršg
 
deviûs
;

94 
¡d
::
¡ršg
 
”rÜ
;

95 ià(!
	`adb_qu”y
("ho¡:deviûs", &
deviûs
, &
”rÜ
)) {

96 
	`´štf
("nØemuÏtÜ cÚÃùed: %s\n", 
”rÜ
.
	`c_¡r
());

100 
pÜt
;

101 
size_t
 
emuÏtÜ_couÁ
 = 0;

102 auto& 
deviû
 : 
ªdroid
::
ba£
::
	`S¶™
(
deviûs
, "\n")) {

103 ià(
	`ssÿnf
(
deviû
.
	`c_¡r
(), "emuÏtÜ-%d", &
pÜt
) == 1) {

104 ià(++
emuÏtÜ_couÁ
 > 1) {

109 ià(
emuÏtÜ_couÁ
 == 0)  -1;

110  
pÜt
;

111 
	}
}

113 
	$sw™ch_sock‘_Œª¥Üt
(
fd
, 
¡d
::
¡ršg
* 
”rÜ
) {

114 
¡d
::
¡ršg
 
£rviû
;

115 ià(
__adb_£rŸl
) {

116 
£rviû
 += "host:transport:";

117 
£rviû
 +ğ
__adb_£rŸl
;

119 cÚ¡ * 
Œª¥Üt_ty³
 = "???";

120 
__adb_Œª¥Üt
) {

121 
kT¿n¥ÜtUsb
:

122 
Œª¥Üt_ty³
 = "transport-usb";

124 
kT¿n¥ÜtLoÿl
:

125 
Œª¥Üt_ty³
 = "transport-local";

127 
kT¿n¥ÜtAny
:

128 
Œª¥Üt_ty³
 = "transport-any";

130 
kT¿n¥ÜtHo¡
:

134 
£rviû
 += "host:";

135 
£rviû
 +ğ
Œª¥Üt_ty³
;

138 ià(!
	`S’dPrÙocŞSŒšg
(
fd
, 
£rviû
)) {

139 *
”rÜ
 = 
	`³¼Ü_¡r
("write failure during connection");

140 
	`adb_şo£
(
fd
);

143 
	`D
("Switchransport in…rogress\n");

145 ià(!
	`adb_¡©us
(
fd
, 
”rÜ
)) {

146 
	`adb_şo£
(
fd
);

147 
	`D
("Sw™ch¿n¥Üˆçed: %s\n", 
”rÜ
->
	`c_¡r
());

150 
	`D
("Switchransport success\n");

152 
	}
}

154 
boŞ
 
	$adb_¡©us
(
fd
, 
¡d
::
¡ršg
* 
”rÜ
) {

155 
buf
[5];

156 ià(!
	`R—dFdExaùly
(
fd
, 
buf
, 4)) {

157 *
”rÜ
 = 
	`³¼Ü_¡r
("protocol fault (couldn't„ead status)");

158  
çl£
;

161 ià(!
	`memcmp
(
buf
, "OKAY", 4)) {

162  
Œue
;

165 ià(
	`memcmp
(
buf
, "FAIL", 4)) {

166 *
”rÜ
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("protocol fault (status %02x %02x %02x %02x?!)",

167 
buf
[0], buf[1], buf[2], buf[3]);

168  
çl£
;

171 
	`R—dPrÙocŞSŒšg
(
fd
, 
”rÜ
,ƒrror);

172  
çl£
;

173 
	}
}

175 
	$_adb_cÚÃù
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
”rÜ
) {

176 
	`D
("_adb_cÚÃù: %s\n", 
£rviû
.
	`c_¡r
());

177 ià(
£rviû
.
	`em±y
(è|| s”viû.
	`size
() > 1024) {

178 *
”rÜ
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("bad service‚ame†ength (%d)",

179 
¡©ic_ÿ¡
<>(
£rviû
.
	`size
()));

183 
fd
;

184 ià(
__adb_£rv”_Çme
) {

185 
fd
 = 
	`sock‘_ÃtwÜk_ş›Á
(
__adb_£rv”_Çme
, 
__adb_£rv”_pÜt
, 
SOCK_STREAM
);

187 
fd
 = 
	`sock‘_loİback_ş›Á
(
__adb_£rv”_pÜt
, 
SOCK_STREAM
);

189 ià(
fd
 < 0) {

190 *
”rÜ
 = 
	`³¼Ü_¡r
("cannot connecto daemon");

194 ià(
	`memcmp
(&
£rviû
[0],"ho¡",4è!ğ0 && 
	`sw™ch_sock‘_Œª¥Üt
(
fd
, 
”rÜ
)) {

198 if(!
	`S’dPrÙocŞSŒšg
(
fd
, 
£rviû
)) {

199 *
”rÜ
 = 
	`³¼Ü_¡r
("write failure during connection");

200 
	`adb_şo£
(
fd
);

204 ià(!
	`adb_¡©us
(
fd
, 
”rÜ
)) {

205 
	`adb_şo£
(
fd
);

209 
	`D
("_adb_cÚÃù:„‘uº fd %d\n", 
fd
);

210  
fd
;

211 
	}
}

213 
	$adb_cÚÃù
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
”rÜ
) {

215 
fd
 = 
	`_adb_cÚÃù
("ho¡:v”siÚ", 
”rÜ
);

217 
	`D
("adb_cÚÃù: s”viû %s\n", 
£rviû
.
	`c_¡r
());

218 ià(
fd
 =ğ-2 && 
__adb_£rv”_Çme
) {

219 
	`årštf
(
¡d”r
,"** Cannot start server on„emote host\n");

220  
fd
;

221 } ià(
fd
 == -2) {

222 
	`årštf
(
¡dout
,"* daemon‚ot„unning. starting it‚ow on…ort %d *\n",

223 
__adb_£rv”_pÜt
);

224 
¡¬t_£rv”
:

225 ià(
	`Ïunch_£rv”
(
__adb_£rv”_pÜt
)) {

226 
	`årštf
(
¡d”r
,"* failedo start daemon *\n");

229 
	`årštf
(
¡dout
,"* daemon started successfully *\n");

232 
	`adb_¦“p_ms
(3000);

236 
v”siÚ
 = 
ADB_SERVER_VERSION
 - 1;

239 ià(
fd
 >= 0) {

240 
¡d
::
¡ršg
 
v”siÚ_¡ršg
;

241 ià(!
	`R—dPrÙocŞSŒšg
(
fd
, &
v”siÚ_¡ršg
, 
”rÜ
)) {

242 
”rÜ
;

245 
	`adb_şo£
(
fd
);

247 ià(
	`ssÿnf
(&
v”siÚ_¡ršg
[0], "%04x", &
v”siÚ
) != 1) {

248 
”rÜ
;

253 ià(*
”rÜ
 == "unknown host service") {

254  
fd
;

258 ià(
v”siÚ
 !ğ
ADB_SERVER_VERSION
) {

259 
	`´štf
("adb server is out of date. killing...\n");

260 
fd
 = 
	`_adb_cÚÃù
("ho¡:kl", 
”rÜ
);

261 
	`adb_şo£
(
fd
);

264 
	`adb_¦“p_ms
(2000);

265 
¡¬t_£rv”
;

270 ià(
£rviû
 == "host:start-server") {

274 
fd
 = 
	`_adb_cÚÃù
(
£rviû
, 
”rÜ
);

275 ià(
fd
 == -1) {

276 
	`D
("_adb_cÚÃùƒ¼Ü: %s", 
”rÜ
->
	`c_¡r
());

277 } if(
fd
 == -2) {

278 
	`årštf
(
¡d”r
,"** daemon still‚ot„unning\n");

280 
	`D
("adb_cÚÃù:„‘uº fd %d\n", 
fd
);

282  
fd
;

283 
”rÜ
:

284 
	`adb_şo£
(
fd
);

286 
	}
}

289 
	$adb_commªd
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
”rÜ
) {

290 
fd
 = 
	`adb_cÚÃù
(
£rviû
, 
”rÜ
);

291 ià(
fd
 < 0) {

292 
	`årštf
(
¡d”r
, "”rÜ: %s\n", 
”rÜ
->
	`c_¡r
());

296 ià(!
	`adb_¡©us
(
fd
, 
”rÜ
)) {

297 
	`adb_şo£
(
fd
);

302 
	}
}

304 
boŞ
 
	$adb_qu”y
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
»suÉ
, std::¡ršg* 
”rÜ
) {

305 
	`D
("adb_qu”y: %s\n", 
£rviû
.
	`c_¡r
());

306 
fd
 = 
	`adb_cÚÃù
(
£rviû
, 
”rÜ
);

307 ià(
fd
 < 0) {

308 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
”rÜ
->
	`c_¡r
());

312 
»suÉ
->
	`ş—r
();

313 ià(!
	`R—dPrÙocŞSŒšg
(
fd
, 
»suÉ
, 
”rÜ
)) {

314 
	`adb_şo£
(
fd
);

315  
çl£
;

317  
Œue
;

318 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_client.h

1 #iâdeà
_ADB_CLIENT_H_


2 
	#_ADB_CLIENT_H_


	)

4 
	~"adb.h
"

6 
	~<¡ršg
>

12 
adb_cÚÃù
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
”rÜ
);

13 
_adb_cÚÃù
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
”rÜ
);

18 
adb_commªd
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
”rÜ
);

22 
boŞ
 
adb_qu”y
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
»suÉ
, std::¡ršg* 
”rÜ
);

26 
adb_£t_Œª¥Üt
(
Œª¥Üt_ty³
 
ty³
, cÚ¡ * 
£rŸl
);

30 
adb_£t_tı_¥ecifics
(
£rv”_pÜt
);

34 
adb_£t_tı_Çme
(cÚ¡ * 
ho¡Çme
);

40 
adb_g‘_emuÏtÜ_cÚsŞe_pÜt
();

46 
adb_£nd_emuÏtÜ_commªd
(
¬gc
, cÚ¡ ** 
¬gv
);

51 
boŞ
 
adb_¡©us
(
fd
, 
¡d
::
¡ršg
* 
”rÜ
);

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_io.cpp

17 
	#TRACE_TAG
 
TRACE_RWX


	)

19 
	~"adb_io.h
"

21 
	~<uni¡d.h
>

23 
	~<ba£/¡ršg´štf.h
>

25 
	~"adb_Œaû.h
"

26 
	~"adb_uts.h
"

27 
	~"sysd•s.h
"

29 
boŞ
 
	$S’dPrÙocŞSŒšg
(
fd
, cÚ¡ 
¡d
::
¡ršg
& 
s
) {

30 
Ëngth
 = 
s
.
	`size
();

31 ià(
Ëngth
 > 0xffff) {

32 
Ëngth
 = 0xffff;

35  
	`Wr™eFdFmt
(
fd
, "%04x", 
Ëngth
è&& 
	`Wr™eFdExaùly
(fd, 
s
);

36 
	}
}

38 
boŞ
 
	$S’dOkay
(
fd
) {

39  
	`Wr™eFdExaùly
(
fd
, "OKAY", 4);

40 
	}
}

42 
boŞ
 
	$S’dFa
(
fd
, cÚ¡ 
¡d
::
¡ršg
& 
»asÚ
) {

43  
	`Wr™eFdExaùly
(
fd
, "FAIL", 4è&& 
	`S’dPrÙocŞSŒšg
(fd, 
»asÚ
);

44 
	}
}

46 
boŞ
 
	$R—dFdExaùly
(
fd
, * 
buf
, 
size_t
 
Ën
) {

47 * 
p
 = 
»š‹½»t_ÿ¡
<*>(
buf
);

49 
size_t
 
Ën0
 = 
Ën
;

51 
	`D
("»adx: fd=%d wª‹d=%zu\n", 
fd
, 
Ën
);

52 
Ën
 > 0) {

53 
r
 = 
	`adb_»ad
(
fd
, 
p
, 
Ën
);

54 ià(
r
 > 0) {

55 
Ën
 -ğ
r
;

56 
p
 +ğ
r
;

57 } ià(
r
 == -1) {

58 
	`D
("»adx: fd=%dƒ¼Ü %d: %s\n", 
fd
, 
”ºo
, 
	`¡»¼Ü
(errno));

59  
çl£
;

61 
	`D
("»adx: fd=%d discÚÃùed\n", 
fd
);

62 
”ºo
 = 0;

63  
çl£
;

67 
	`D
("»adx: fd=%d wª‹d=%zu gÙ=%zu\n", 
fd
, 
Ën0
,†’0 - 
Ën
);

68 ià(
ADB_TRACING
) {

69 
	`dump_hex
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
buf
), 
Ën0
);

72  
Œue
;

73 
	}
}

75 
boŞ
 
	$Wr™eFdExaùly
(
fd
, cÚ¡ * 
buf
, 
size_t
 
Ën
) {

76 cÚ¡ * 
p
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
buf
);

77 
r
;

79 
	`D
("wr™ex: fd=%d†’=%d: ", 
fd
, ()
Ën
);

80 ià(
ADB_TRACING
) {

81 
	`dump_hex
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
buf
), 
Ën
);

84 
Ën
 > 0) {

85 
r
 = 
	`adb_wr™e
(
fd
, 
p
, 
Ën
);

86 ià(
r
 == -1) {

87 
	`D
("wr™ex: fd=%dƒ¼Ü %d: %s\n", 
fd
, 
”ºo
, 
	`¡»¼Ü
(errno));

88 ià(
”ºo
 =ğ
EAGAIN
) {

89 
	`adb_¦“p_ms
(1);

91 } ià(
”ºo
 =ğ
EPIPE
) {

92 
	`D
("wr™ex: fd=%d discÚÃùed\n", 
fd
);

93 
”ºo
 = 0;

94  
çl£
;

96  
çl£
;

99 
Ën
 -ğ
r
;

100 
p
 +ğ
r
;

103  
Œue
;

104 
	}
}

106 
boŞ
 
	$Wr™eFdExaùly
(
fd
, cÚ¡ * 
¡r
) {

107  
	`Wr™eFdExaùly
(
fd
, 
¡r
, 
	`¡¾’
(str));

108 
	}
}

110 
boŞ
 
	$Wr™eFdExaùly
(
fd
, cÚ¡ 
¡d
::
¡ršg
& 
¡r
) {

111  
	`Wr™eFdExaùly
(
fd
, 
¡r
.
	`c_¡r
(), sŒ.
	`size
());

112 
	}
}

114 
boŞ
 
	$Wr™eFdFmt
(
fd
, cÚ¡ * 
fmt
, ...) {

115 
¡d
::
¡ršg
 
¡r
;

117 
va_li¡
 
­
;

118 
	`va_¡¬t
(
­
, 
fmt
);

119 
ªdroid
::
ba£
::
	`SŒšgAµ’dV
(&
¡r
, 
fmt
, 
­
);

120 
	`va_’d
(
­
);

122  
	`Wr™eFdExaùly
(
fd
, 
¡r
);

123 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_io.h

17 #iâdeà
ADB_IO_H


18 
	#ADB_IO_H


	)

20 
	~<sys/ty³s.h
>

22 
	~<¡ršg
>

25 
boŞ
 
S’dOkay
(
fd
);

28 
boŞ
 
S’dFa
(
fd
, cÚ¡ 
¡d
::
¡ršg
& 
»asÚ
);

31 
boŞ
 
S’dPrÙocŞSŒšg
(
fd
, cÚ¡ 
¡d
::
¡ršg
& 
s
);

41 
boŞ
 
R—dFdExaùly
(
fd
, *
buf
, 
size_t
 
Ën
);

50 
boŞ
 
Wr™eFdExaùly
(
fd
, cÚ¡ * 
buf
, 
size_t
 
Ën
);

53 
boŞ
 
Wr™eFdExaùly
(
fd
, cÚ¡ * 
s
);

54 
boŞ
 
Wr™eFdExaùly
(
fd
, cÚ¡ 
¡d
::
¡ršg
& 
s
);

57 
boŞ
 
	$Wr™eFdFmt
(
fd
, cÚ¡ * 
fmt
, ...è
	`__©Œibu‹__
((
	`__fÜm©__
(
__´štf__
, 2, 3)));

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_io_test.cpp

17 
	~"adb_io.h
"

19 
	~<g‹¡/g‹¡.h
>

21 
	~<fú.h
>

22 
	~<¡dio.h
>

23 
	~<¡dlib.h
>

24 
	~<sys/¡©.h
>

25 
	~<sys/ty³s.h
>

26 
	~<uni¡d.h
>

28 
	~<¡ršg
>

30 
	~"ba£/fe.h
"

32 şas 
	cTempÜ¬yFe
 {

33 
	mpublic
:

34 
	$TempÜ¬yFe
() {

35 
	`š™
("/data/local/tmp");

36 ià(
fd
 == -1) {

37 
	`š™
("/tmp");

41 ~
	$TempÜ¬yFe
() {

42 
	`şo£
(
fd
);

43 
	`uÆšk
(
f’ame
);

44 
	}
}

46 
	gfd
;

47 
	gf’ame
[1024];

49 
	g´iv©e
:

50 
	$š™
(cÚ¡ * 
tmp_dœ
) {

51 
	`¢´štf
(
f’ame
, (f’ame), "%s/TempÜ¬yFe-XXXXXX", 
tmp_dœ
);

52 
fd
 = 
	`mk¡emp
(
f’ame
);

53 
	}
}

56 
	$TEST
(
io
, 
R—dFdExaùly_whŞe
) {

57 cÚ¡ 
ex³ùed
[] = "Foobar";

58 
TempÜ¬yFe
 
tf
;

59 
	`ASSERT_NE
(-1, 
tf
.
fd
);

61 
	`ASSERT_TRUE
(
ªdroid
::
ba£
::
	`Wr™eSŒšgToFd
(
ex³ùed
, 
tf
.
fd
)è<< 
	`¡»¼Ü
(
”ºo
);

62 
	`ASSERT_EQ
(0, 
	`l£ek
(
tf
.
fd
, 
SEEK_SET
, 0));

65 
buf
[(
ex³ùed
)] = {};

66 
	`ASSERT_TRUE
(
	`R—dFdExaùly
(
tf
.
fd
, 
buf
, (bufè- 1)è<< 
	`¡»¼Ü
(
”ºo
);

67 
	`EXPECT_STREQ
(
ex³ùed
, 
buf
);

68 
	}
}

70 
	$TEST
(
io
, 
R—dFdExaùly_eof
) {

71 cÚ¡ 
ex³ùed
[] = "Foobar";

72 
TempÜ¬yFe
 
tf
;

73 
	`ASSERT_NE
(-1, 
tf
.
fd
);

75 
	`ASSERT_TRUE
(
ªdroid
::
ba£
::
	`Wr™eSŒšgToFd
(
ex³ùed
, 
tf
.
fd
)è<< 
	`¡»¼Ü
(
”ºo
);

76 
	`ASSERT_EQ
(0, 
	`l£ek
(
tf
.
fd
, 
SEEK_SET
, 0));

79 
buf
[(
ex³ùed
) + 1] = {};

80 
	`ASSERT_FALSE
(
	`R—dFdExaùly
(
tf
.
fd
, 
buf
, (buf)));

81 
	`EXPECT_EQ
(0, 
”ºo
è<< 
	`¡»¼Ü
(errno);

82 
	}
}

84 
	$TEST
(
io
, 
R—dFdExaùly_·¹Ÿl
) {

85 cÚ¡ 
šput
[] = "Foobar";

86 
TempÜ¬yFe
 
tf
;

87 
	`ASSERT_NE
(-1, 
tf
.
fd
);

89 
	`ASSERT_TRUE
(
ªdroid
::
ba£
::
	`Wr™eSŒšgToFd
(
šput
, 
tf
.
fd
)è<< 
	`¡»¼Ü
(
”ºo
);

90 
	`ASSERT_EQ
(0, 
	`l£ek
(
tf
.
fd
, 
SEEK_SET
, 0));

93 
buf
[(
šput
) - 1] = {};

94 
	`ASSERT_TRUE
(
	`R—dFdExaùly
(
tf
.
fd
, 
buf
, (buf) - 1));

96 
¡d
::
¡ršg
 
	`ex³ùed
(
šput
);

97 
ex³ùed
.
	`pİ_back
();

98 
	`EXPECT_STREQ
(
ex³ùed
.
	`c_¡r
(), 
buf
);

99 
	}
}

101 
	$TEST
(
io
, 
Wr™eFdExaùly_whŞe
) {

102 cÚ¡ 
ex³ùed
[] = "Foobar";

103 
TempÜ¬yFe
 
tf
;

104 
	`ASSERT_NE
(-1, 
tf
.
fd
);

107 
	`ASSERT_TRUE
(
	`Wr™eFdExaùly
(
tf
.
fd
, 
ex³ùed
, (expected)))

108 << 
	`¡»¼Ü
(
”ºo
);

109 
	`ASSERT_EQ
(0, 
	`l£ek
(
tf
.
fd
, 
SEEK_SET
, 0));

111 
¡d
::
¡ršg
 
s
;

112 
	`ASSERT_TRUE
(
ªdroid
::
ba£
::
	`R—dFdToSŒšg
(
tf
.
fd
, &
s
));

113 
	`EXPECT_STREQ
(
ex³ùed
, 
s
.
	`c_¡r
());

114 
	}
}

116 
	$TEST
(
io
, 
Wr™eFdExaùly_·¹Ÿl
) {

117 cÚ¡ 
buf
[] = "Foobar";

118 
TempÜ¬yFe
 
tf
;

119 
	`ASSERT_NE
(-1, 
tf
.
fd
);

122 
	`ASSERT_TRUE
(
	`Wr™eFdExaùly
(
tf
.
fd
, 
buf
, (bufè- 2)è<< 
	`¡»¼Ü
(
”ºo
);

123 
	`ASSERT_EQ
(0, 
	`l£ek
(
tf
.
fd
, 
SEEK_SET
, 0));

125 
¡d
::
¡ršg
 
	`ex³ùed
(
buf
);

126 
ex³ùed
.
	`pİ_back
();

128 
¡d
::
¡ršg
 
s
;

129 
	`ASSERT_TRUE
(
ªdroid
::
ba£
::
	`R—dFdToSŒšg
(
tf
.
fd
, &
s
));

130 
	`EXPECT_EQ
(
ex³ùed
, 
s
);

131 
	}
}

133 
	$TEST
(
io
, 
Wr™eFdExaùly_ENOSPC
) {

134 
fd
 = 
	`İ’
("/dev/fuÎ", 
O_WRONLY
);

135 
	`ASSERT_NE
(-1, 
fd
);

137 
buf
[] = "foo";

138 
	`ASSERT_FALSE
(
	`Wr™eFdExaùly
(
fd
, 
buf
, (buf)));

139 
	`ASSERT_EQ
(
ENOSPC
, 
”ºo
);

140 
	}
}

142 
	$TEST
(
io
, 
Wr™eFdExaùly_¡ršg
) {

143 cÚ¡ 
¡r
[] = "Foobar";

144 
TempÜ¬yFe
 
tf
;

145 
	`ASSERT_NE
(-1, 
tf
.
fd
);

148 
	`ASSERT_TRUE
(
	`Wr™eFdExaùly
(
tf
.
fd
, 
¡r
)è<< 
	`¡»¼Ü
(
”ºo
);

149 
	`ASSERT_EQ
(0, 
	`l£ek
(
tf
.
fd
, 
SEEK_SET
, 0));

151 
¡d
::
¡ršg
 
s
;

152 
	`ASSERT_TRUE
(
ªdroid
::
ba£
::
	`R—dFdToSŒšg
(
tf
.
fd
, &
s
));

153 
	`EXPECT_STREQ
(
¡r
, 
s
.
	`c_¡r
());

154 
	}
}

156 
	$TEST
(
io
, 
Wr™eFdFmt
) {

157 
TempÜ¬yFe
 
tf
;

158 
	`ASSERT_NE
(-1, 
tf
.
fd
);

161 
	`ASSERT_TRUE
(
	`Wr™eFdFmt
(
tf
.
fd
, "Foo%s%d", "b¬", 123)è<< 
	`¡»¼Ü
(
”ºo
);

162 
	`ASSERT_EQ
(0, 
	`l£ek
(
tf
.
fd
, 
SEEK_SET
, 0));

164 
¡d
::
¡ršg
 
s
;

165 
	`ASSERT_TRUE
(
ªdroid
::
ba£
::
	`R—dFdToSŒšg
(
tf
.
fd
, &
s
));

166 
	`EXPECT_STREQ
("Foob¬123", 
s
.
	`c_¡r
());

167 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_listeners.cpp

17 
	~"adb_li¡’”s.h
"

19 
	~<¡dio.h
>

20 
	~<¡dlib.h
>

22 
	~<ba£/¡ršg´štf.h
>

24 
	~"sysd•s.h
"

25 
	~"Œª¥Üt.h
"

27 
	ggLi¡’AÎ
 = 0;

29 
®i¡’”
 
	gli¡’”_li¡
 = {

30 .
Ãxt
 = &
li¡’”_li¡
,

31 .
	g´ev
 = &
li¡’”_li¡
,

34 
	$ss_li¡’”_ev’t_func
(
_fd
, 
ev
, *
_l
)

36 
asock‘
 *
s
;

38 if(
ev
 & 
FDE_READ
) {

39 
sockaddr
 
addr
;

40 
sockËn_t
 
®’
;

41 
fd
;

43 
®’
 = (
addr
);

44 
fd
 = 
	`adb_sock‘_acû±
(
_fd
, &
addr
, &
®’
);

45 if(
fd
 < 0) ;

47 
	`adb_sock‘_£tbufsize
(
fd
, 
CHUNK_SIZE
);

49 
s
 = 
	`ü—‹_loÿl_sock‘
(
fd
);

50 if(
s
) {

51 
	`cÚÃù_to_sm¬tsock‘
(
s
);

55 
	`adb_şo£
(
fd
);

57 
	}
}

59 
	$li¡’”_ev’t_func
(
_fd
, 
ev
, * 
_l
)

61 
®i¡’”
* 
li¡’”
 = 
»š‹½»t_ÿ¡
<®i¡’”*>(
_l
);

62 
asock‘
 *
s
;

64 ià(
ev
 & 
FDE_READ
) {

65 
sockaddr
 
addr
;

66 
sockËn_t
 
®’
;

67 
fd
;

69 
®’
 = (
addr
);

70 
fd
 = 
	`adb_sock‘_acû±
(
_fd
, &
addr
, &
®’
);

71 ià(
fd
 < 0) {

75 
s
 = 
	`ü—‹_loÿl_sock‘
(
fd
);

76 ià(
s
) {

77 
s
->
Œª¥Üt
 = 
li¡’”
->transport;

78 
	`cÚÃù_to_»mÙe
(
s
, 
li¡’”
->
cÚÃù_to
);

82 
	`adb_şo£
(
fd
);

84 
	}
}

86 
	$ä“_li¡’”
(
®i¡’”
* 
l
)

88 ià(
l
->
Ãxt
) {

89 
l
->
Ãxt
->
´ev
 =†->prev;

90 
l
->
´ev
->
Ãxt
 =†->next;

91 
l
->
Ãxt
 =†->
´ev
 =†;

95 
	`fdev’t_»move
(&
l
->
fde
);

97 ià(
l
->
loÿl_Çme
)

98 
	`ä“
((*)
l
->
loÿl_Çme
);

100 ià(
l
->
cÚÃù_to
)

101 
	`ä“
((*)
l
->
cÚÃù_to
);

103 ià(
l
->
Œª¥Üt
) {

104 
	`»move_Œª¥Üt_discÚÃù
(
l
->
Œª¥Üt
, &l->
discÚÃù
);

106 
	`ä“
(
l
);

107 
	}
}

109 
	$li¡’”_discÚÃù
(* 
li¡’”
, 
©¿n¥Üt
* 
t
)

111 
	`ä“_li¡’”
(
»š‹½»t_ÿ¡
<
®i¡’”
*>(
li¡’”
));

112 
	}
}

114 
	$loÿl_Çme_to_fd
(cÚ¡ *
Çme
)

116 
pÜt
;

118 if(!
	`¡ºcmp
("tı:", 
Çme
, 4)){

119 
»t
;

120 
pÜt
 = 
	`©oi
(
Çme
 + 4);

122 ià(
gLi¡’AÎ
 > 0) {

123 
»t
 = 
	`sock‘_šaddr_ªy_£rv”
(
pÜt
, 
SOCK_STREAM
);

125 
»t
 = 
	`sock‘_loİback_£rv”
(
pÜt
, 
SOCK_STREAM
);

128  
»t
;

130 #iâdeà
HAVE_WIN32_IPC


132 if(!
	`¡ºcmp
(
Çme
, "local:", 6)) {

133  
	`sock‘_loÿl_£rv”
(
Çme
 + 6,

134 
ANDROID_SOCKET_NAMESPACE_ABSTRACT
, 
SOCK_STREAM
);

135 } if(!
	`¡ºcmp
(
Çme
, "localabstract:", 14)) {

136  
	`sock‘_loÿl_£rv”
(
Çme
 + 14,

137 
ANDROID_SOCKET_NAMESPACE_ABSTRACT
, 
SOCK_STREAM
);

138 } if(!
	`¡ºcmp
(
Çme
, "localfilesystem:", 16)) {

139  
	`sock‘_loÿl_£rv”
(
Çme
 + 16,

140 
ANDROID_SOCKET_NAMESPACE_FILESYSTEM
, 
SOCK_STREAM
);

144 
	`´štf
("unknowÀloÿÈpÜŠam'%s'\n", 
Çme
);

146 
	}
}

149 
	g¡d
::
¡ršg
 
	$fÜm©_li¡’”s
() {

150 
¡d
::
¡ršg
 
»suÉ
;

151 
®i¡’”
* 
l
 = 
li¡’”_li¡
.
Ãxt
;† != &listener_list;† =†->next) {

153 ià(
l
->
cÚÃù_to
[0] == '*') {

157 
ªdroid
::
ba£
::
	`SŒšgAµ’dF
(&
»suÉ
, "%s %s %s\n",

158 
l
->
Œª¥Üt
->
£rŸl
,†->
loÿl_Çme
,†->
cÚÃù_to
);

160  
»suÉ
;

161 
	}
}

163 
š¡®l_¡©us_t
 
	$»move_li¡’”
(cÚ¡ *
loÿl_Çme
, 
©¿n¥Üt
* 
Œª¥Üt
)

165 
®i¡’”
 *
l
;

167 
l
 = 
li¡’”_li¡
.
Ãxt
;† != &listener_list;† =†->next) {

168 ià(!
	`¡rcmp
(
loÿl_Çme
, 
l
->local_name)) {

169 
	`li¡’”_discÚÃù
(
l
,†->
Œª¥Üt
);

170  
INSTALL_STATUS_OK
;

173  
INSTALL_STATUS_LISTENER_NOT_FOUND
;

174 
	}
}

176 
	$»move_®l_li¡’”s
()

178 
®i¡’”
 *
l
, *
l_Ãxt
;

179 
l
 = 
li¡’”_li¡
.
Ãxt
;† !ğ&li¡’”_li¡;† = 
l_Ãxt
) {

180 
l_Ãxt
 = 
l
->
Ãxt
;

182 ià(
l
->
cÚÃù_to
[0] == '*')

184 
	`li¡’”_discÚÃù
(
l
,†->
Œª¥Üt
);

186 
	}
}

188 
š¡®l_¡©us_t
 
	$š¡®l_li¡’”
(cÚ¡ 
¡d
::
¡ršg
& 
loÿl_Çme
,

189 cÚ¡ *
cÚÃù_to
,

190 
©¿n¥Üt
* 
Œª¥Üt
,

191 
no_»bšd
)

193 
®i¡’”
* 
l
 = 
li¡’”_li¡
.
Ãxt
;† != &listener_list;† =†->next) {

194 ià(
loÿl_Çme
 =ğ
l
->local_name) {

195 * 
ùo
;

198 if(
l
->
cÚÃù_to
[0] == '*') {

199  
INSTALL_STATUS_INTERNAL_ERROR
;

203 ià(
no_»bšd
) {

204  
INSTALL_STATUS_CANNOT_REBIND
;

207 
ùo
 = 
	`¡rdup
(
cÚÃù_to
);

208 if(
ùo
 == 0) {

209  
INSTALL_STATUS_INTERNAL_ERROR
;

212 
	`ä“
((*è
l
->
cÚÃù_to
);

213 
l
->
cÚÃù_to
 = 
ùo
;

214 ià(
l
->
Œª¥Üt
 !=ransport) {

215 
	`»move_Œª¥Üt_discÚÃù
(
l
->
Œª¥Üt
, &l->
discÚÃù
);

216 
l
->
Œª¥Üt
 =ransport;

217 
	`add_Œª¥Üt_discÚÃù
(
l
->
Œª¥Üt
, &l->
discÚÃù
);

219  
INSTALL_STATUS_OK
;

223 
®i¡’”
* 
li¡’”
 = 
»š‹½»t_ÿ¡
<alistener*>(

224 
	`ÿÎoc
(1, (
®i¡’”
)));

225 ià(
li¡’”
 =ğ
nuÎ±r
) {

226 
nomem
;

229 
li¡’”
->
loÿl_Çme
 = 
	`¡rdup
Öoÿl_Çme.
	`c_¡r
());

230 ià(
li¡’”
->
loÿl_Çme
 =ğ
nuÎ±r
) {

231 
nomem
;

234 
li¡’”
->
cÚÃù_to
 = 
	`¡rdup
(connect_to);

235 ià(
li¡’”
->
cÚÃù_to
 =ğ
nuÎ±r
) {

236 
nomem
;

239 
li¡’”
->
fd
 = 
	`loÿl_Çme_to_fd
Öi¡’”->
loÿl_Çme
);

240 ià(
li¡’”
->
fd
 < 0) {

241 
	`´štf
("ÿÂÙ bšd '%s': %s\n", 
li¡’”
->
loÿl_Çme
, 
	`¡»¼Ü
(
”ºo
));

242 
	`ä“
(
li¡’”
->
loÿl_Çme
);

243 
	`ä“
(
li¡’”
->
cÚÃù_to
);

244 
	`ä“
(
li¡’”
);

245  
INSTALL_STATUS_CANNOT_BIND
;

248 
	`şo£_Ú_exec
(
li¡’”
->
fd
);

249 ià(!
	`¡rcmp
(
li¡’”
->
cÚÃù_to
, "*smartsocket*")) {

250 
	`fdev’t_š¡®l
(&
li¡’”
->
fde
,†i¡’”->
fd
, 
ss_li¡’”_ev’t_func
,

251 
li¡’”
);

253 
	`fdev’t_š¡®l
(&
li¡’”
->
fde
,†i¡’”->
fd
, 
li¡’”_ev’t_func
,

254 
li¡’”
);

256 
	`fdev’t_£t
(&
li¡’”
->
fde
, 
FDE_READ
);

258 
li¡’”
->
Ãxt
 = &
li¡’”_li¡
;

259 
li¡’”
->
´ev
 = 
li¡’”_li¡
.prev;

260 
li¡’”
->
Ãxt
->
´ev
 =†istener;

261 
li¡’”
->
´ev
->
Ãxt
 =†istener;

262 
li¡’”
->
Œª¥Üt
 =ransport;

264 ià(
Œª¥Üt
) {

265 
li¡’”
->
discÚÃù
.
İaque
 =†istener;

266 
li¡’”
->
discÚÃù
.
func
 = 
li¡’”_discÚÃù
;

267 
	`add_Œª¥Üt_discÚÃù
(
Œª¥Üt
, &
li¡’”
->
discÚÃù
);

269  
INSTALL_STATUS_OK
;

271 
nomem
:

272 
	`çl
("cannot‡llocate†istener");

273  
INSTALL_STATUS_INTERNAL_ERROR
;

274 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_listeners.h

17 #iâdeà
__ADB_LISTENERS_H


18 
	#__ADB_LISTENERS_H


	)

20 
	~"adb.h
"

22 
	~<¡ršg
>

25 
	eš¡®l_¡©us_t
 {

26 
	mINSTALL_STATUS_OK
 = 0,

27 
	mINSTALL_STATUS_INTERNAL_ERROR
 = -1,

28 
	mINSTALL_STATUS_CANNOT_BIND
 = -2,

29 
	mINSTALL_STATUS_CANNOT_REBIND
 = -3,

30 
	mINSTALL_STATUS_LISTENER_NOT_FOUND
 = -4,

33 
®i¡’”
 
li¡’”_li¡
;

35 
li¡’”_discÚÃù
(* 
_l
, 
©¿n¥Üt
* 
t
);

36 
li¡’”_ev’t_func
(
_fd
, 
ev
, *
_l
);

37 
ss_li¡’”_ev’t_func
(
_fd
, 
ev
, *
_l
);

39 
š¡®l_¡©us_t
 
š¡®l_li¡’”
(cÚ¡ 
¡d
::
¡ršg
& 
loÿl_Çme
,

40 cÚ¡ * 
cÚÃù_to
,

41 
©¿n¥Üt
* 
Œª¥Üt
,

42 
no_»bšd
);

44 
	g¡d
::
¡ršg
 
fÜm©_li¡’”s
();

46 
š¡®l_¡©us_t
 
»move_li¡’”
(cÚ¡ * 
loÿl_Çme
, 
©¿n¥Üt
* 
Œª¥Üt
);

47 
»move_®l_li¡’”s
();

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_main.cpp

17 
	#TRACE_TAG
 
TRACE_ADB


	)

19 
	~"sysd•s.h
"

21 
	~<”ºo.h
>

22 
	~<sigÇl.h
>

23 
	~<¡dio.h
>

24 
	~<¡dlib.h
>

26 
	~"adb.h
"

27 
	~"adb_auth.h
"

28 
	~"adb_li¡’”s.h
"

29 
	~"Œª¥Üt.h
"

31 
	~<ba£/¡ršg´štf.h
>

33 #ià!
ADB_HOST


34 
	~<g‘İt.h
>

35 
	~<sys/´ùl.h
>

37 
	~"cuts/´İ”t›s.h
"

38 
	~"´iv©e/ªdroid_fesy¡em_cÚfig.h
"

39 
	~"£lšux/£lšux.h
"

41 
	~"qemu_Œacšg.h
"

44 
	$adb_ş—nup
()

46 
	`usb_ş—nup
();

47 
	}
}

49 #ià
defšed
(
_WIN32
)

50 
BOOL
 
WINAPI
 
	$ù¾c_hªdËr
(
DWORD
 
ty³
)

52 
	`ex™
(
STATUS_CONTROL_C_EXIT
);

53  
TRUE
;

54 
	}
}

57 #ià
ADB_HOST


58 #ifdeà
WORKAROUND_BUG6558362


59 
	~<sched.h
>

60 
	#AFFINITY_ENVVAR
 "ADB_CPU_AFFINITY_BUG6558362"

	)

61 
	$adb_£t_affš™y
()

63 
ıu_£t_t
 
ıu_£t
;

64 cÚ¡ * 
ıunum_¡r
 = 
	`g‘’v
(
AFFINITY_ENVVAR
);

65 * 
¡¹Ş_»s
;

66 
ıu_num
;

68 ià(!
ıunum_¡r
 || !*cpunum_str)

70 
ıu_num
 = 
	`¡¹Ş
(
ıunum_¡r
, &
¡¹Ş_»s
, 0);

71 ià(*
¡¹Ş_»s
 != '\0')

72 
	`çl
("bad‚umb” (%sèšƒnv v¬ %s. Ex³ùšg 0..n.\n", 
ıunum_¡r
, 
AFFINITY_ENVVAR
);

74 
	`sched_g‘affš™y
(0, (
ıu_£t
), &cpu_set);

75 
	`D
("Üig cpu_£t[0]=0x%08lx\n", 
ıu_£t
.
__b™s
[0]);

76 
	`CPU_ZERO
(&
ıu_£t
);

77 
	`CPU_SET
(
ıu_num
, &
ıu_£t
);

78 
	`sched_£ffš™y
(0, (
ıu_£t
), &cpu_set);

79 
	`sched_g‘affš™y
(0, (
ıu_£t
), &cpu_set);

80 
	`D
("Ãw cpu_£t[0]=0x%08lx\n", 
ıu_£t
.
__b™s
[0]);

81 
	}
}

84 cÚ¡ *
	groÙ_£şab–
 = 
NULL
;

86 
	$drİ_ÿ·b™›s_boundšg_£t_if_Ãeded
() {

87 #ifdeà
ALLOW_ADBD_ROOT


88 
v®ue
[
PROPERTY_VALUE_MAX
];

89 
	`´İ”ty_g‘
("ro.debuggabË", 
v®ue
, "");

90 ià(
	`¡rcmp
(
v®ue
, "1") == 0) {

94 
i
;

95 
i
 = 0; 
	`´ùl
(
PR_CAPBSET_READ
, i, 0, 0, 0) >= 0; i++) {

96 ià(
i
 =ğ
CAP_SETUID
 || i =ğ
CAP_SETGID
) {

100 
”r
 = 
	`´ùl
(
PR_CAPBSET_DROP
, 
i
, 0, 0, 0);

105 ià((
”r
 < 0è&& (
”ºo
 !ğ
EINVAL
)) {

106 
	`ex™
(1);

109 
	}
}

111 
boŞ
 
	$should_drİ_´iveges
() {

112 #ià
	`defšed
(
ALLOW_ADBD_ROOT
)

113 
v®ue
[
PROPERTY_VALUE_MAX
];

117 
	`´İ”ty_g‘
("ro.k”Ãl.qemu", 
v®ue
, "");

118 ià(
	`¡rcmp
(
v®ue
, "1") == 0) {

119  
çl£
;

132 
	`´İ”ty_g‘
("ro.£cu»", 
v®ue
, "1");

133 
boŞ
 
ro_£cu»
 = (
	`¡rcmp
(
v®ue
, "1") == 0);

135 
	`´İ”ty_g‘
("ro.debuggabË", 
v®ue
, "");

136 
boŞ
 
ro_debuggabË
 = (
	`¡rcmp
(
v®ue
, "1") == 0);

139 
boŞ
 
drİ
 = 
ro_£cu»
;

142 
	`´İ”ty_g‘
("£rviû.u£r.‹¡", 
v®ue
, "");

143 
boŞ
 
adb_roÙ
 = (
	`¡rcmp
(
v®ue
, "1") == 0);

144 
boŞ
 
adb_uÄoÙ
 = (
	`¡rcmp
(
v®ue
, "0") == 0);

147 ià(
ro_debuggabË
 && 
adb_roÙ
) {

148 
drİ
 = 
çl£
;

152 ià(
adb_uÄoÙ
) {

153 
drİ
 = 
Œue
;

156 #ià
ALLOW_USER_ADBD_ROOT


157 if(
adb_roÙ
) {

158  
çl£
;

162  
drİ
;

164  
Œue
;

166 
	}
}

169 
	$¡¬t_loggšg
()

171 #ià
	`defšed
(
_WIN32
)

172 
‹mp
[ 
MAX_PATH
 ];

173 
FILE
* 
âul
;

174 
FILE
* 
æog
;

176 
	`G‘TempP©h
Ğ(
‹mp
) - 8,emp );

177 
	`¡rÿt
Ğ
‹mp
, "adb.log" );

180 
âul
 = 
	`fİ’
( "NUL", "rt" );

181 ià(
âul
 !ğ
NULL
)

182 
¡dš
[0] = 
âul
[0];

184 
æog
 = 
	`fİ’
Ğ
‹mp
, "at" );

185 ià(
æog
 =ğ
NULL
)

186 
æog
 = 
âul
;

188 
	`£tvbuf
Ğ
æog
, 
NULL
, 
_IONBF
, 0 );

190 
¡dout
[0] = 
æog
[0];

191 
¡d”r
[0] = 
æog
[0];

192 
	`årštf
(
¡d”r
,"---‡db s¹šg (pid %dè---\n", 
	`g‘pid
());

194 
fd
;

196 
fd
 = 
	`unix_İ’
("/dev/nuÎ", 
O_RDONLY
);

197 
	`dup2
(
fd
, 0);

198 
	`adb_şo£
(
fd
);

200 
fd
 = 
	`unix_İ’
("/tmp/adb.log", 
O_WRONLY
 | 
O_CREAT
 | 
O_APPEND
, 0640);

201 if(
fd
 < 0) {

202 
fd
 = 
	`unix_İ’
("/dev/nuÎ", 
O_WRONLY
);

204 
	`dup2
(
fd
, 1);

205 
	`dup2
(
fd
, 2);

206 
	`adb_şo£
(
fd
);

207 
	`årštf
(
¡d”r
,"---‡db s¹šg (pid %dè---\n", 
	`g‘pid
());

209 
	}
}

211 
	$adb_maš
(
is_d«mÚ
, 
£rv”_pÜt
)

213 #ià!
ADB_HOST


214 
pÜt
;

215 
v®ue
[
PROPERTY_VALUE_MAX
];

217 
	`umask
(000);

220 
	`©ex™
(
adb_ş—nup
);

221 #ià
	`defšed
(
_WIN32
)

222 
	`S‘CÚsŞeCŒlHªdËr
Ğ
ù¾c_hªdËr
, 
TRUE
 );

225 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

228 
	`š™_Œª¥Üt_»gi¡¿tiÚ
();

230 #ià
ADB_HOST


231 
HOST
 = 1;

233 #ifdeà
WORKAROUND_BUG6558362


234 if(
is_d«mÚ
è
	`adb_£t_affš™y
();

236 
	`usb_š™
();

237 
	`loÿl_š™
(
DEFAULT_ADB_LOCAL_TRANSPORT_PORT
);

238 
	`adb_auth_š™
();

240 
¡d
::
¡ršg
 
loÿl_Çme
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("tı:%d", 
£rv”_pÜt
);

241 ià(
	`š¡®l_li¡’”
(
loÿl_Çme
, "*sm¬tsock‘*", 
NULL
, 0)) {

242 
	`ex™
(1);

247 
	`adbd_şÛxec_auth_sock‘
();

250 ià(
ALLOW_ADBD_NO_AUTH
) {

251 
auth_»quœed
 = 
çl£
;

254 
	`adbd_auth_š™
();

258 cÚ¡ * 
adb_ex‹º®_¡Üage
 = 
	`g‘’v
("ADB_EXTERNAL_STORAGE");

259 ià(
NULL
 !ğ
adb_ex‹º®_¡Üage
) {

260 
	`£‹nv
("EXTERNAL_STORAGE", 
adb_ex‹º®_¡Üage
, 1);

262 
	`D
("Warning: ADB_EXTERNAL_STORAGE is‚ot set. Leaving EXTERNAL_STORAGE"

276 
gid_t
 
groups
[] = { 
AID_ADB
, 
AID_LOG
, 
AID_INPUT
, 
AID_INET
, 
AID_NET_BT
,

277 
AID_NET_BT_ADMIN
, 
AID_SDCARD_R
, 
AID_SDCARD_RW
,

278 
AID_NET_BW_STATS
 };

279 ià(
	`£tgroups
((
groups
)/(groups[0]), groups) != 0) {

280 
	`ex™
(1);

285 ià(
	`should_drİ_´iveges
()) {

286 
	`drİ_ÿ·b™›s_boundšg_£t_if_Ãeded
();

289 ià(
	`£tgid
(
AID_SHELL
) != 0) {

290 
	`ex™
(1);

292 ià(
	`£tuid
(
AID_SHELL
) != 0) {

293 
	`ex™
(1);

296 
	`D
("Local…ort disabled\n");

298 #iâdeà
ALLOW_USER_ADBD_ROOT


299 ià((
roÙ_£şab–
 !ğ
NULL
è&& (
	`is_£lšux_’abËd
() > 0)) {

301 ià(
	`£tcÚ
((*)
roÙ_£şab–
) < 0) {

302 
	`ex™
(1);

306 
¡d
::
¡ršg
 
loÿl_Çme
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("tı:%d", 
£rv”_pÜt
);

307 ià(
	`š¡®l_li¡’”
(
loÿl_Çme
, "*sm¬tsock‘*", 
NULL
, 0)) {

308 
	`ex™
(1);

312 
usb
 = 0;

313 ià(
	`acûss
(
USB_ADB_PATH
, 
F_OK
è=ğ0 ||‡cûss(
USB_FFS_ADB_EP0
, F_OK) == 0) {

315 
	`usb_š™
();

316 
usb
 = 1;

322 
	`´İ”ty_g‘
("£rviû.adb.tı.pÜt", 
v®ue
, "");

323 ià(!
v®ue
[0]) {

324 
	`´İ”ty_g‘
("³rsi¡.adb.tı.pÜt", 
v®ue
, "");

326 ià(
	`ssÿnf
(
v®ue
, "%d", &
pÜt
) == 1 &&…ort > 0) {

327 
	`´štf
("usšg…Üt=%d\n", 
pÜt
);

329 
	`loÿl_š™
(
pÜt
);

330 } ià(!
usb
) {

332 
	`loÿl_š™
(
DEFAULT_ADB_LOCAL_TRANSPORT_PORT
);

335 
	`D
("adb_main():…re init_jdwp()\n");

336 
	`š™_jdwp
();

337 
	`D
("adb_main():…ost init_jdwp()\n");

340 ià(
is_d«mÚ
)

343 #ià
	`defšed
(
_WIN32
)

344 
DWORD
 
couÁ
;

345 
	`Wr™eFe
Ğ
	`G‘StdHªdË
Ğ
STD_OUTPUT_HANDLE
 ), "OK\n", 3, &
couÁ
, 
NULL
 );

347 
	`årštf
(
¡d”r
, "OK\n");

349 
	`¡¬t_loggšg
();

351 
	`D
("Event†oop starting\n");

353 
	`fdev’t_loİ
();

355 
	`usb_ş—nup
();

358 
	}
}

360 #ià!
ADB_HOST


361 
	$şo£_¡dš
() {

362 
fd
 = 
	`unix_İ’
("/dev/nuÎ", 
O_RDONLY
);

363 ià(
fd
 == -1) {

364 
	`³¼Ü
("failedo open /dev/null, stdin will„emain open");

367 
	`dup2
(
fd
, 0);

368 
	`adb_şo£
(
fd
);

369 
	}
}

373 
	$maš
(
¬gc
, **
¬gv
) {

374 #ià
ADB_HOST


376 
	`adb_sysd•s_š™
();

377 
	`adb_Œaû_š™
();

378 
	`D
("Handling commandline()\n");

379  
	`adb_commªdlše
(
¬gc
 - 1, 
cÚ¡_ÿ¡
<cÚ¡ **>(
¬gv
 + 1));

382 
Œue
) {

383 
İtiÚ
 
İts
[] = {

384 {"roÙ_£şab–", 
»quœed_¬gum’t
, 
nuÎ±r
, 's'},

385 {"deviû_bªÃr", 
»quœed_¬gum’t
, 
nuÎ±r
, 'b'},

386 {"v”siÚ", 
no_¬gum’t
, 
nuÎ±r
, 'v'},

389 
İtiÚ_šdex
 = 0;

390 
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, "", 
İts
, &
İtiÚ_šdex
);

391 ià(
c
 == -1)

393 
c
) {

395 
roÙ_£şab–
 = 
İrg
;

398 
adb_deviû_bªÃr
 = 
İrg
;

401 
	`´štf
("Android Debug Bridge Daemon version %d.%d.%d %s\n",

402 
ADB_VERSION_MAJOR
, 
ADB_VERSION_MINOR
, 
ADB_SERVER_VERSION
,

403 
ADB_REVISION
);

410 
	`şo£_¡dš
();

412 
	`adb_Œaû_š™
();

416 
	`adb_qemu_Œaû_š™
();

418 
	`D
("Handling main()\n");

419  
	`adb_maš
(0, 
DEFAULT_ADB_PORT
);

421 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_trace.h

17 #iâdeà
__ADB_TRACE_H


18 
	#__ADB_TRACE_H


	)

20 #ià!
ADB_HOST


21 
	~<ªdroid/log.h
>

23 
	~<¡dio.h
>

30 
	eAdbT¿û
 {

31 
	mTRACE_ADB
 = 0,

32 
	mTRACE_SOCKETS
,

33 
	mTRACE_PACKETS
,

34 
	mTRACE_TRANSPORT
,

35 
	mTRACE_RWX
,

36 
	mTRACE_USB
,

37 
	mTRACE_SYNC
,

38 
	mTRACE_SYSDEPS
,

39 
	mTRACE_JDWP
,

40 
	mTRACE_SERVICES
,

41 
	mTRACE_AUTH
,

42 
	mTRACE_FDEVENT
,

45 #ià!
ADB_HOST


53 
adb_qemu_Œaû
(cÚ¡ * 
fmt
, ...);

55 
	#DQ
(...è
	`adb_qemu_Œaû
(
__VA_ARGS__
)

	)

57 
	#DQ
(...è(()0)

	)

60 
adb_Œaû_mask
;

61 
adb_Œaû_ouut_couÁ
;

62 
adb_Œaû_š™
();

64 
	#ADB_TRACING
 ((
adb_Œaû_mask
 & (1 << 
TRACE_TAG
)è!ğ0)

	)

67 #ià
ADB_HOST


68 
	#D
(...) \

70 ià(
ADB_TRACING
) { \

71 
§ve_”ºo
 = 
”ºo
; \

72 
	`adb_mu‹x_lock
(&
D_lock
); \

73 
	`årštf
(
¡d”r
, "%16s: %5d:%5lu | ", \

74 
__FUNCTION__
, \

75 
	`g‘pid
(), 
	`adb_th»ad_id
()); \

76 
”ºo
 = 
§ve_”ºo
; \

77 
	`årštf
(
¡d”r
, 
__VA_ARGS__
 ); \

78 
	`fæush
(
¡d”r
); \

79 
	`adb_mu‹x_uÆock
(&
D_lock
); \

80 
”ºo
 = 
§ve_”ºo
; \

82 } 0)

	)

83 
	#DR
(...) \

85 ià(
ADB_TRACING
) { \

86 
§ve_”ºo
 = 
”ºo
; \

87 
	`adb_mu‹x_lock
(&
D_lock
); \

88 
”ºo
 = 
§ve_”ºo
; \

89 
	`årštf
(
¡d”r
, 
__VA_ARGS__
 ); \

90 
	`fæush
(
¡d”r
); \

91 
	`adb_mu‹x_uÆock
(&
D_lock
); \

92 
”ºo
 = 
§ve_”ºo
; \

94 } 0)

	)

96 
	#D
(...) \

98 ià(
ADB_TRACING
) { \

99 
	`__ªdroid_log_´št
( \

100 
ANDROID_LOG_INFO
, \

101 
__FUNCTION__
, \

102 
__VA_ARGS__
 ); \

104 } 0)

	)

105 
	#DR
(...) \

107 ià(
ADB_TRACING
) { \

108 
	`__ªdroid_log_´št
( \

109 
ANDROID_LOG_INFO
, \

110 
__FUNCTION__
, \

111 
__VA_ARGS__
 ); \

113 } 0)

	)

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_utils.cpp

17 
	#TRACE_TAG
 
TRACE_ADB


	)

19 
	~"adb_uts.h
"

21 
	~<¡dlib.h
>

22 
	~<sys/¡©.h
>

23 
	~<sys/ty³s.h
>

24 
	~<uni¡d.h
>

26 
	~<®gÜ™hm
>

28 
	~<ba£/¡ršg´štf.h
>

30 
	~"adb_Œaû.h
"

31 
	~"sysd•s.h
"

33 
boŞ
 
	$g‘cwd
(
¡d
::
¡ršg
* 
s
) {

34 * 
cwd
 = 
	`g‘cwd
(
nuÎ±r
, 0);

35 ià(
cwd
 !ğ
nuÎ±r
è*
s
 = cwd;

36 
	`ä“
(
cwd
);

37  (
cwd
 !ğ
nuÎ±r
);

38 
	}
}

40 
boŞ
 
	$dœeùÜy_exi¡s
(cÚ¡ 
¡d
::
¡ršg
& 
·th
) {

41 
¡©
 
sb
;

42  
	`l¡©
(
·th
.
	`c_¡r
(), &
sb
è!ğ-1 && 
	`S_ISDIR
(sb.
¡_mode
);

43 
	}
}

45 
	g¡d
::
¡ršg
 
	$esÿ³_¬g
(cÚ¡ 
¡d
::
¡ršg
& 
s
) {

46 
¡d
::
¡ršg
 
»suÉ
 = 
s
;

53 
size_t
 
i
 = 0; i < 
s
.
	`size
(); ++i) {

54 ià(
s
[
i
] == '\'') {

55 
»suÉ
.
	`š£¹
(
i
, "'\\'");

56 
i
 += 2;

61 
»suÉ
.
	`š£¹
ÔesuÉ.
	`begš
(), '\'');

62 
»suÉ
.
	`push_back
('\'');

63  
»suÉ
;

64 
	}
}

66 
	$dump_hex
(cÚ¡ * 
d©a
, 
size_t
 
by‹_couÁ
) {

67 
by‹_couÁ
 = 
¡d
::
	`mš
(by‹_couÁ, 
	`size_t
(16));

69 cÚ¡ 
ušt8_t
* 
p
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_t*>(
d©a
);

71 
¡d
::
¡ršg
 
lše
;

72 
size_t
 
i
 = 0; i < 
by‹_couÁ
; ++i) {

73 
ªdroid
::
ba£
::
	`SŒšgAµ’dF
(&
lše
, "%02x", 
p
[
i
]);

75 
lše
.
	`push_back
(' ');

77 
size_t
 
i
 = 0; i < 
by‹_couÁ
; ++i) {

78 
c
 = 
p
[
i
];

79 ià(
c
 < 32 || c > 127) {

80 
c
 = '.';

82 
lše
.
	`push_back
(
c
);

85 
	`DR
("%s\n", 
lše
.
	`c_¡r
());

86 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_utils.h

17 #iâdeà
_ADB_UTILS_H_


18 
	#_ADB_UTILS_H_


	)

20 
	~<¡ršg
>

22 
boŞ
 
g‘cwd
(
¡d
::
¡ršg
* 
cwd
);

23 
boŞ
 
dœeùÜy_exi¡s
(cÚ¡ 
¡d
::
¡ršg
& 
·th
);

25 
	g¡d
::
¡ršg
 
esÿ³_¬g
(cÚ¡ 
¡d
::¡ršg& 
s
);

27 
dump_hex
(cÚ¡ * 
±r
, 
size_t
 
by‹_couÁ
);

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_utils_test.cpp

17 
	~"adb_uts.h
"

19 
	~<g‹¡/g‹¡.h
>

21 
	$TEST
(
adb_uts
, 
dœeùÜy_exi¡s
) {

22 
	`ASSERT_TRUE
(
	`dœeùÜy_exi¡s
("/proc"));

23 
	`ASSERT_FALSE
(
	`dœeùÜy_exi¡s
("/proc/self"));

24 
	`ASSERT_FALSE
(
	`dœeùÜy_exi¡s
("/proc/does-not-exist"));

25 
	}
}

27 
	$TEST
(
adb_uts
, 
esÿ³_¬g
) {

28 
	`ASSERT_EQ
(
R
"('')", 
	`esÿ³_¬g
(""));

30 
	`ASSERT_EQ
(
R
"('abc')", 
	`esÿ³_¬g
("abc"));

32 
	`ASSERT_EQ
(
R
"('‡bc')", 
	`esÿ³_¬g
("‡bc"));

33 
	`ASSERT_EQ
(
R
"(''\''abc')", 
	`esÿ³_¬g
("'abc"));

34 
	`ASSERT_EQ
(
R
"('"
abc
')",ƒscape_arg("\"abc"));

35 
	`ASSERT_EQ
(
R
"('\abc')", 
	`esÿ³_¬g
("\\abc"));

36 
	`ASSERT_EQ
(
R
"('×bc')", 
	`esÿ³_¬g
("(abc"));

37 
	`ASSERT_EQ
(
R
"('ïbc')", 
	`esÿ³_¬g
(")abc"));

39 
	`ASSERT_EQ
(
R
"('abøabc')", 
	`esÿ³_¬g
("abc‡bc"));

40 
	`ASSERT_EQ
(
R
"('abc'\''abc')", 
	`esÿ³_¬g
("abc'abc"));

41 
	`ASSERT_EQ
(
R
"('abc"
abc
')",ƒscape_arg("abc\"abc"));

42 
	`ASSERT_EQ
(
R
"('abc\abc')", 
	`esÿ³_¬g
("abc\\abc"));

43 
	`ASSERT_EQ
(
R
"('abc×bc')", 
	`esÿ³_¬g
("abc(abc"));

44 
	`ASSERT_EQ
(
R
"('abcïbc')", 
	`esÿ³_¬g
("abc)abc"));

46 
	`ASSERT_EQ
(
R
"('abø')", 
	`esÿ³_¬g
("abc "));

47 
	`ASSERT_EQ
(
R
"('abc'\''')", 
	`esÿ³_¬g
("abc'"));

48 
	`ASSERT_EQ
(
R
"('abc"')",ƒscape_arg("abc\""));

49 
	`ASSERT_EQ
(
R
"('abc\')", 
	`esÿ³_¬g
("abc\\"));

50 
	`ASSERT_EQ
(
R
"('abc(')", 
	`esÿ³_¬g
("abc("));

51 
	`ASSERT_EQ
(
R
"('abc)')", 
	`esÿ³_¬g
("abc)"));

52 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/commandline.cpp

17 
	#TRACE_TAG
 
TRACE_ADB


	)

19 
	~"sysd•s.h
"

21 
	~<as£¹.h
>

22 
	~<ùy³.h
>

23 
	~<”ºo.h
>

24 
	~<š‰y³s.h
>

25 
	~<lim™s.h
>

26 
	~<¡d¬g.h
>

27 
	~<¡dšt.h
>

28 
	~<¡dio.h
>

29 
	~<¡dlib.h
>

30 
	~<¡ršg.h
>

31 
	~<sys/¡©.h
>

32 
	~<sys/ty³s.h
>

34 
	~<¡ršg
>

36 
	~<ba£/¡ršg´štf.h
>

38 #ià!
defšed
(
_WIN32
)

39 
	~<‹rmios.h
>

40 
	~<uni¡d.h
>

43 
	~"adb.h
"

44 
	~"adb_auth.h
"

45 
	~"adb_ş›Á.h
"

46 
	~"adb_io.h
"

47 
	~"adb_uts.h
"

48 
	~"fe_sync_£rviû.h
"

50 
š¡®l_­p
(
Œª¥Üt_ty³
 
t
, cÚ¡ * 
£rŸl
, 
¬gc
, cÚ¡ ** 
¬gv
);

51 
š¡®l_muÉË_­p
(
Œª¥Üt_ty³
 
t
, cÚ¡ * 
£rŸl
, 
¬gc
, cÚ¡ ** 
¬gv
);

52 
unš¡®l_­p
(
Œª¥Üt_ty³
 
t
, cÚ¡ * 
£rŸl
, 
¬gc
, cÚ¡ ** 
¬gv
);

54 
	g¡d
::
¡ršg
 
gProduùOutP©h
;

55 
gLi¡’AÎ
;

57 
	g¡d
::
¡ršg
 
	$´oduù_fe
(cÚ¡ *
exŒa
) {

58 ià(
gProduùOutP©h
.
	`em±y
()) {

59 
	`årštf
(
¡d”r
, "adb: Product directory‚ot specified; "

61 
	`ex™
(1);

64  
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s%s%s",

65 
gProduùOutP©h
.
	`c_¡r
(), 
OS_PATH_SEPARATOR_STR
, 
exŒa
);

66 
	}
}

68 
	$v”siÚ
(
FILE
* 
out
) {

69 
	`årštf
(
out
, "Android Debug Bridge version %d.%d.%d\nRevision %s\n",

70 
ADB_VERSION_MAJOR
, 
ADB_VERSION_MINOR
, 
ADB_SERVER_VERSION
, 
ADB_REVISION
);

71 
	}
}

73 
	$h–p
() {

74 
	`v”siÚ
(
¡d”r
);

76 
	`årštf
(
¡d”r
,

238 
	}
}

240 
	$u§ge
() {

241 
	`h–p
();

243 
	}
}

245 #ià
defšed
(
_WIN32
)

248 
¡dš_¿w_š™
(
fd
);

249 
¡dš_¿w_»¡Üe
(
fd
);

252 
‹rmios
 
	gg_§ved_‹rmš®_¡©e
;

254 
	$¡dš_¿w_š™
(
fd
) {

255 ià(
	`tcg‘©Œ
(
fd
, &
g_§ved_‹rmš®_¡©e
)) ;

257 
‹rmios
 
tio
;

258 ià(
	`tcg‘©Œ
(
fd
, &
tio
)) ;

260 
	`cfmak”aw
(&
tio
);

263 
tio
.
c_cc
[
VTIME
] = 0;

264 
tio
.
c_cc
[
VMIN
] = 1;

266 
	`tc£‰r
(
fd
, 
TCSAFLUSH
, &
tio
);

267 
	}
}

269 
	$¡dš_¿w_»¡Üe
(
fd
) {

270 
	`tc£‰r
(
fd
, 
TCSAFLUSH
, &
g_§ved_‹rmš®_¡©e
);

271 
	}
}

274 
	$»ad_ªd_dump
(
fd
) {

275 
fd
 >= 0) {

276 
	`D
("»ad_ªd_dump():…»‡db_»ad(fd=%d)\n", 
fd
);

277 
buf
[
BUFSIZ
];

278 
Ën
 = 
	`adb_»ad
(
fd
, 
buf
, (buf));

279 
	`D
("»ad_ªd_dump():…o¡‡db_»ad(fd=%d):†’=%d\n", 
fd
, 
Ën
);

280 ià(
Ën
 <= 0) {

284 
	`fwr™e
(
buf
, 1, 
Ën
, 
¡dout
);

285 
	`fæush
(
¡dout
);

287 
	}
}

289 
	$»ad_¡©us_lše
(
fd
, * 
buf
, 
size_t
 
couÁ
)

291 
couÁ
--;

292 
couÁ
 > 0) {

293 
Ën
 = 
	`adb_»ad
(
fd
, 
buf
, 
couÁ
);

294 ià(
Ën
 == 0) {

296 } ià(
Ën
 < 0) {

297 ià(
”ºo
 =ğ
EINTR
) ;

301 
buf
 +ğ
Ën
;

302 
couÁ
 -ğ
Ën
;

304 *
buf
 = '\0';

305 
	}
}

307 
	$cİy_to_fe
(
šFd
, 
outFd
) {

308 cÚ¡ 
size_t
 
BUFSIZE
 = 32 * 1024;

309 * 
buf
 = (*è
	`m®loc
(
BUFSIZE
);

310 ià(
buf
 =ğ
nuÎ±r
è
	`çl
("couldn't‡llocate buffer for copy_to_file");

311 
Ën
;

312 
tÙ®
 = 0;

314 
	`D
("cİy_to_fe(%d -> %d)\n", 
šFd
, 
outFd
);

316 ià(
šFd
 =ğ
STDIN_FILENO
) {

317 
	`¡dš_¿w_š™
(
STDIN_FILENO
);

320 
Œue
) {

321 ià(
šFd
 =ğ
STDIN_FILENO
) {

322 
Ën
 = 
	`unix_»ad
(
šFd
, 
buf
, 
BUFSIZE
);

324 
Ën
 = 
	`adb_»ad
(
šFd
, 
buf
, 
BUFSIZE
);

326 ià(
Ën
 == 0) {

327 
	`D
("copy_to_file() :„ead 0 bytes;ƒxiting\n");

330 ià(
Ën
 < 0) {

331 ià(
”ºo
 =ğ
EINTR
) {

332 
	`D
("copy_to_file() : EINTR,„etrying\n");

335 
	`D
("cİy_to_fe(è:ƒ¼Ü %d\n", 
”ºo
);

338 ià(
outFd
 =ğ
STDOUT_FILENO
) {

339 
	`fwr™e
(
buf
, 1, 
Ën
, 
¡dout
);

340 
	`fæush
(
¡dout
);

342 
	`adb_wr™e
(
outFd
, 
buf
, 
Ën
);

344 
tÙ®
 +ğ
Ën
;

347 ià(
šFd
 =ğ
STDIN_FILENO
) {

348 
	`¡dš_¿w_»¡Üe
(
STDIN_FILENO
);

351 
	`D
("cİy_to_fe(èfšished‡á” %lu by‹s\n", 
tÙ®
);

352 
	`ä“
(
buf
);

353 
	}
}

355 *
	$¡dš_»ad_th»ad
(*
x
)

357 
fd
, 
fdi
;

358 
buf
[1024];

359 
r
, 
n
;

360 
¡©e
 = 0;

362 *
fds
 = (*è
x
;

363 
fd
 = 
fds
[0];

364 
fdi
 = 
fds
[1];

365 
	`ä“
(
fds
);

369 
	`D
("¡dš_»ad_th»ad():…» unix_»ad(fdi=%d,...)\n", 
fdi
);

370 
r
 = 
	`unix_»ad
(
fdi
, 
buf
, 1024);

371 
	`D
("¡dš_»ad_th»ad():…o¡ unix_»ad(fdi=%d,...)\n", 
fdi
);

372 if(
r
 == 0) ;

373 if(
r
 < 0) {

374 if(
”ºo
 =ğ
EINTR
) ;

377 
n
 = 0;‚ < 
r
;‚++){

378 
buf
[
n
]) {

380 
¡©e
 = 1;

383 
¡©e
 = 1;

386 if(
¡©e
 == 1) state++;

389 if(
¡©e
 == 2) {

390 
	`årštf
(
¡d”r
,"\n* disconnect *\n");

391 
	`¡dš_¿w_»¡Üe
(
fdi
);

392 
	`ex™
(0);

395 
¡©e
 = 0;

398 
r
 = 
	`adb_wr™e
(
fd
, 
buf
,„);

399 if(
r
 <= 0) {

404 
	}
}

406 
	$š‹¿ùive_sh–l
() {

407 
adb_th»ad_t
 
thr
;

408 
fdi
;

410 
¡d
::
¡ršg
 
”rÜ
;

411 
fd
 = 
	`adb_cÚÃù
("sh–l:", &
”rÜ
);

412 ià(
fd
 < 0) {

413 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

416 
fdi
 = 0;

418 * 
fds
 = 
»š‹½»t_ÿ¡
<*>(
	`m®loc
(() * 2));

419 ià(
fds
 =ğ
nuÎ±r
) {

420 
	`årštf
(
¡d”r
, "couldn'ˆ®loÿ‹ fd ¬¿y: %s\n", 
	`¡»¼Ü
(
”ºo
));

424 
fds
[0] = 
fd
;

425 
fds
[1] = 
fdi
;

427 
	`¡dš_¿w_š™
(
fdi
);

428 
	`adb_th»ad_ü—‹
(&
thr
, 
¡dš_»ad_th»ad
, 
fds
);

429 
	`»ad_ªd_dump
(
fd
);

430 
	`¡dš_¿w_»¡Üe
(
fdi
);

432 
	}
}

435 
	g¡d
::
¡ršg
 
	$fÜm©_ho¡_commªd
(cÚ¡ * 
commªd
, 
Œª¥Üt_ty³
 
ty³
, cÚ¡ * 
£rŸl
) {

436 ià(
£rŸl
) {

437  
ªdroid
::
ba£
::
	`SŒšgPrštf
("ho¡-£rŸl:%s:%s", 
£rŸl
, 
commªd
);

440 cÚ¡ * 
´efix
 = "host";

441 ià(
ty³
 =ğ
kT¿n¥ÜtUsb
) {

442 
´efix
 = "host-usb";

443 } ià(
ty³
 =ğ
kT¿n¥ÜtLoÿl
) {

444 
´efix
 = "host-local";

446  
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s:%s", 
´efix
, 
commªd
);

447 
	}
}

449 
	$adb_dowÆßd_bufãr
(cÚ¡ *
£rviû
, cÚ¡ *
â
, cÚ¡ * 
d©a
, 
sz
,

450 
boŞ
 
show_´og»ss
)

452 
¡d
::
¡ršg
 
”rÜ
;

453 
fd
 = 
	`adb_cÚÃù
(
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s:%d", 
£rviû
, 
sz
), &
”rÜ
);

454 ià(
fd
 < 0) {

455 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

459 
İt
 = 
CHUNK_SIZE
;

460 
İt
 = 
	`adb_£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_SNDBUF
, (const *) &opt, (opt));

462 
tÙ®
 = 
sz
;

463 cÚ¡ 
ušt8_t
* 
±r
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_t*>(
d©a
);

465 ià(
show_´og»ss
) {

466 *
x
 = 
	`¡¼chr
(
£rviû
, ':');

467 if(
x
è
£rviû
 = x + 1;

470 
sz
 > 0) {

471 
xãr
 = (
sz
 > 
CHUNK_SIZE
) ? CHUNK_SIZE : sz;

472 ià(!
	`Wr™eFdExaùly
(
fd
, 
±r
, 
xãr
)) {

473 
¡d
::
¡ršg
 
”rÜ
;

474 
	`adb_¡©us
(
fd
, &
”rÜ
);

475 
	`årštf
(
¡d”r
,"* faedØwr™d©¨'%s' *\n", 
”rÜ
.
	`c_¡r
());

478 
sz
 -ğ
xãr
;

479 
±r
 +ğ
xãr
;

480 ià(
show_´og»ss
) {

481 
	`´štf
("£ndšg: '%s' %4d%% \r", 
â
, ()(100LL - ((100LL * 
sz
è/ (
tÙ®
))));

482 
	`fæush
(
¡dout
);

485 ià(
show_´og»ss
) {

486 
	`´štf
("\n");

489 ià(!
	`adb_¡©us
(
fd
, &
”rÜ
)) {

490 
	`årštf
(
¡d”r
,"*ƒ¼Ü„e¥Ú£ '%s' *\n", 
”rÜ
.
	`c_¡r
());

494 
	`adb_şo£
(
fd
);

496 
	}
}

498 
	#SIDELOAD_HOST_BLOCK_SIZE
 (
CHUNK_SIZE
)

	)

519 
	$adb_sid–ßd_ho¡
(cÚ¡ * 
â
) {

520 
sz
;

521 
size_t
 
xãr
 = 0;

522 
¡©us
;

523 
Ï¡_³rûÁ
 = -1;

524 
İt
 = 
SIDELOAD_HOST_BLOCK_SIZE
;

526 
	`´štf
("lßdšg: '%s'", 
â
);

527 
	`fæush
(
¡dout
);

528 
ušt8_t
* 
d©a
 = 
»š‹½»t_ÿ¡
<ušt8_t*>(
	`lßd_fe
(
â
, &
sz
));

529 ià(
d©a
 == 0) {

530 
	`´štf
("\n");

531 
	`årštf
(
¡d”r
, "* cªnÙ„—d '%s' *\n", 
â
);

535 
¡d
::
¡ršg
 
£rviû
 =

536 
ªdroid
::
ba£
::
	`SŒšgPrštf
("sid–ßd-ho¡:%d:%d", 
sz
, 
SIDELOAD_HOST_BLOCK_SIZE
);

537 
¡d
::
¡ršg
 
”rÜ
;

538 
fd
 = 
	`adb_cÚÃù
(
£rviû
, &
”rÜ
);

539 ià(
fd
 < 0) {

542 
	`´štf
("\n");

543 
¡©us
 = 
	`adb_dowÆßd_bufãr
("sid–ßd", 
â
, 
d©a
, 
sz
, 
Œue
);

544 
dÚe
;

547 
İt
 = 
	`adb_£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_SNDBUF
, (const *) &opt, (opt));

549 
Œue
) {

550 
buf
[9];

551 ià(!
	`R—dFdExaùly
(
fd
, 
buf
, 8)) {

552 
	`årštf
(
¡d”r
, "* faedØ»ad commªd: %s\n", 
	`¡»¼Ü
(
”ºo
));

553 
¡©us
 = -1;

554 
dÚe
;

556 
buf
[8] = '\0';

558 ià(
	`¡rcmp
("DONEDONE", 
buf
) == 0) {

559 
¡©us
 = 0;

563 
block
 = 
	`¡¹Ş
(
buf
, 
NULL
, 10);

565 
size_t
 
off£t
 = 
block
 * 
SIDELOAD_HOST_BLOCK_SIZE
;

566 ià(
off£t
 >ğ
sz
) {

567 
	`årštf
(
¡d”r
, "*‡‰em±Ø»ad block %d…a¡ƒnd\n", 
block
);

568 
¡©us
 = -1;

569 
dÚe
;

571 
ušt8_t
* 
¡¬t
 = 
d©a
 + 
off£t
;

572 
size_t
 
off£t_’d
 = 
off£t
 + 
SIDELOAD_HOST_BLOCK_SIZE
;

573 
size_t
 
to_wr™e
 = 
SIDELOAD_HOST_BLOCK_SIZE
;

574 ià(
off£t_’d
 > 
sz
) {

575 
to_wr™e
 = 
sz
 - 
off£t
;

578 if(!
	`Wr™eFdExaùly
(
fd
, 
¡¬t
, 
to_wr™e
)) {

579 
	`adb_¡©us
(
fd
, &
”rÜ
);

580 
	`årštf
(
¡d”r
,"* faedØwr™d©¨'%s' *\n", 
”rÜ
.
	`c_¡r
());

581 
¡©us
 = -1;

582 
dÚe
;

584 
xãr
 +ğ
to_wr™e
;

592 
³rûÁ
 = ()(
xãr
 * 47LL / (
sz
 ? sz : 1));

593 ià(
³rûÁ
 !ğ
Ï¡_³rûÁ
) {

594 
	`´štf
("\r£rvšg: '%s' (~%d%%è ", 
â
, 
³rûÁ
);

595 
	`fæush
(
¡dout
);

596 
Ï¡_³rûÁ
 = 
³rûÁ
;

600 
	`´štf
("\rTÙ® xãr: %.2fx%*s\n", ()
xãr
 / (
sz
 ? sz : 1), ()
	`¡¾’
(
â
)+10, "");

602 
dÚe
:

603 ià(
fd
 >ğ0è
	`adb_şo£
(fd);

604 
	`ä“
(
d©a
);

605  
¡©us
;

606 
	}
}

615 
	$µp
(
¬gc
, cÚ¡ ** 
¬gv
) {

616 #ià
	`defšed
(
_WIN32
)

617 
	`årštf
(
¡d”r
, "”rÜ:‡db % nÙ im¶em’‹d oÀWš32\n", 
¬gv
[0]);

620 ià(
¬gc
 < 2) {

621 
	`årštf
(
¡d”r
, "usage:‡db %s <adb service‚ame> [ppp opts]\n",

622 
¬gv
[0]);

627 cÚ¡ * 
adb_£rviû_Çme
 = 
¬gv
[1];

628 
¡d
::
¡ršg
 
”rÜ
;

629 
fd
 = 
	`adb_cÚÃù
(
adb_£rviû_Çme
, &
”rÜ
);

630 ià(
fd
 < 0) {

631 
	`årštf
(
¡d”r
,"Error: Could‚ot open‡db service: %s. Error: %s\n",

632 
adb_£rviû_Çme
, 
”rÜ
.
	`c_¡r
());

636 
pid_t
 
pid
 = 
	`fÜk
();

638 ià(
pid
 < 0) {

639 
	`³¼Ü
("from fork()");

641 } ià(
pid
 == 0) {

642 
”r
;

643 
i
;

644 cÚ¡ **
µp_¬gs
;

647 
µp_¬gs
 = (cÚ¡ **è
	`®loÿ
((*è* 
¬gc
 + 1);

648 
µp_¬gs
[0] = "pppd";

649 
i
 = 2 ; i < 
¬gc
 ; i++) {

651 
µp_¬gs
[
i
 - 1] = 
¬gv
[i];

653 
µp_¬gs
[
i
-1] = 
NULL
;

657 
	`dup2
(
fd
, 
STDIN_FILENO
);

658 
	`dup2
(
fd
, 
STDOUT_FILENO
);

659 
	`adb_şo£
(
STDERR_FILENO
);

660 
	`adb_şo£
(
fd
);

662 
”r
 = 
	`execvp
("µpd", (* cÚ¡ *)
µp_¬gs
);

664 ià(
”r
 < 0) {

665 
	`³¼Ü
("execing…ppd");

667 
	`ex™
(-1);

671 
	`adb_şo£
(
fd
);

675 
	}
}

677 
boŞ
 
	$wa™_fÜ_deviû
(cÚ¡ * 
£rviû
, 
Œª¥Üt_ty³
 
t
, cÚ¡ * 
£rŸl
) {

680 ià(
	`¡rcmp
(
£rviû
, "wait-for-device") == 0) {

681 ià(
t
 =ğ
kT¿n¥ÜtUsb
) {

682 
£rviû
 = "wait-for-usb";

683 } ià(
t
 =ğ
kT¿n¥ÜtLoÿl
) {

684 
£rviû
 = "wait-for-local";

686 
£rviû
 = "wait-for-any";

690 
¡d
::
¡ršg
 
cmd
 = 
	`fÜm©_ho¡_commªd
(
£rviû
, 
t
, 
£rŸl
);

691 
¡d
::
¡ršg
 
”rÜ
;

692 ià(
	`adb_commªd
(
cmd
, &
”rÜ
)) {

693 
	`D
("çu»: % *\n", 
”rÜ
.
	`c_¡r
());

694 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

695  
çl£
;

698  
Œue
;

699 
	}
}

701 
	$£nd_sh–l_commªd
(
Œª¥Üt_ty³
¿n¥Üt_ty³, cÚ¡ * 
£rŸl
,

702 cÚ¡ 
¡d
::
¡ršg
& 
commªd
) {

703 
fd
;

704 
Œue
) {

705 
¡d
::
¡ršg
 
”rÜ
;

706 
fd
 = 
	`adb_cÚÃù
(
commªd
, &
”rÜ
);

707 ià(
fd
 >= 0) {

710 
	`årštf
(
¡d”r
,"- waiting for device -\n");

711 
	`adb_¦“p_ms
(1000);

712 
	`wa™_fÜ_deviû
("wa™-fÜ-deviû", 
Œª¥Üt_ty³
, 
£rŸl
);

715 
	`»ad_ªd_dump
(
fd
);

716 
rc
 = 
	`adb_şo£
(
fd
);

717 ià(
rc
) {

718 
	`³¼Ü
("close");

720  
rc
;

721 
	}
}

723 
	$logÿt
(
Œª¥Üt_ty³
 
Œª¥Üt
, cÚ¡ * 
£rŸl
, 
¬gc
, cÚ¡ ** 
¬gv
) {

724 * 
log_gs
 = 
	`g‘’v
("ANDROID_LOG_TAGS");

725 
¡d
::
¡ršg
 
quÙed
 = 
	`esÿ³_¬g
(
log_gs
 =ğ
nuÎ±r
 ? "" :†og_tags);

727 
¡d
::
¡ršg
 
cmd
 = "sh–l:expÜˆANDROID_LOG_TAGS=\"" + 
quÙed
 + "\";ƒxec†ogcat";

729 ià(!
	`¡rcmp
(
¬gv
[0], "longcat")) {

730 
cmd
 += " -v†ong";

733 --
¬gc
;

734 ++
¬gv
;

735 
¬gc
-- > 0) {

736 
cmd
 +ğ" " + 
	`esÿ³_¬g
(*
¬gv
++);

739  
	`£nd_sh–l_commªd
(
Œª¥Üt
, 
£rŸl
, 
cmd
);

740 
	}
}

742 
	$mkdœs
(cÚ¡ *
·th
)

744 
»t
;

745 *
x
 = (*)
·th
 + 1;

748 
x
 = 
	`adb_dœ¡¬t
(x);

749 if(
x
 == 0)  0;

750 *
x
 = 0;

751 
»t
 = 
	`adb_mkdœ
(
·th
, 0775);

752 *
x
 = 
OS_PATH_SEPARATOR
;

753 if((
»t
 < 0è&& (
”ºo
 !ğ
EEXIST
)) {

754  
»t
;

756 
x
++;

759 
	}
}

761 
	$backup
(
¬gc
, cÚ¡ ** 
¬gv
) {

762 cÚ¡ * 
f’ame
 = "./backup.ab";

765 
i
 = 1; i < 
¬gc
; i++) {

766 ià(!
	`¡rcmp
("-f", 
¬gv
[
i
])) {

767 ià(
i
 =ğ
¬gc
-1) {

768 
	`årštf
(
¡d”r
, "adb: -f…assed with‚o filename\n");

769  
	`u§ge
();

771 
f’ame
 = 
¬gv
[
i
+1];

772 
j
 = 
i
+2; j <ğ
¬gc
; ) {

773 
¬gv
[
i
++] =‡rgv[
j
++];

775 
¬gc
 -= 2;

776 
¬gv
[
¬gc
] = 
NULL
;

781 ià(
¬gc
 < 2è 
	`u§ge
();

783 
	`adb_uÆšk
(
f’ame
);

784 
	`mkdœs
(
f’ame
);

785 
outFd
 = 
	`adb_ü—t
(
f’ame
, 0640);

786 ià(
outFd
 < 0) {

787 
	`årštf
(
¡d”r
, "adb: uÇbËØİ’ f%s\n", 
f’ame
);

791 
¡d
::
¡ršg
 
cmd
 = "backup:";

792 --
¬gc
;

793 ++
¬gv
;

794 
¬gc
-- > 0) {

795 
cmd
 +ğ" " + 
	`esÿ³_¬g
(*
¬gv
++);

798 
	`D
("backup. f’ame=% cmd=%s\n", 
f’ame
, 
cmd
.
	`c_¡r
());

799 
¡d
::
¡ršg
 
”rÜ
;

800 
fd
 = 
	`adb_cÚÃù
(
cmd
, &
”rÜ
);

801 ià(
fd
 < 0) {

802 
	`årštf
(
¡d”r
, "adb: uÇbËØcÚÃù fÜ backup: %s\n", 
”rÜ
.
	`c_¡r
());

803 
	`adb_şo£
(
outFd
);

807 
	`´štf
("Now unlock your device‡nd confirmhe backup operation.\n");

808 
	`cİy_to_fe
(
fd
, 
outFd
);

810 
	`adb_şo£
(
fd
);

811 
	`adb_şo£
(
outFd
);

813 
	}
}

815 
	$»¡Üe
(
¬gc
, cÚ¡ ** 
¬gv
) {

816 ià(
¬gc
 !ğ2è 
	`u§ge
();

818 cÚ¡ * 
f’ame
 = 
¬gv
[1];

819 
rFd
 = 
	`adb_İ’
(
f’ame
, 
O_RDONLY
);

820 ià(
rFd
 < 0) {

821 
	`årštf
(
¡d”r
, "adb: uÇbËØİ’ f%s: %s\n", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

825 
¡d
::
¡ršg
 
”rÜ
;

826 
fd
 = 
	`adb_cÚÃù
("»¡Üe:", &
”rÜ
);

827 ià(
fd
 < 0) {

828 
	`årštf
(
¡d”r
, "adb: uÇbËØcÚÃù fÜ„e¡Üe: %s\n", 
”rÜ
.
	`c_¡r
());

829 
	`adb_şo£
(
rFd
);

833 
	`´štf
("Now unlock your device‡nd confirmhe„estore operation.\n");

834 
	`cİy_to_fe
(
rFd
, 
fd
);

836 
	`adb_şo£
(
fd
);

837 
	`adb_şo£
(
rFd
);

839 
	}
}

852 
	g¡d
::
¡ršg
 
	$fšd_´oduù_out_·th
(cÚ¡ * 
hšt
) {

853 ià(
hšt
 =ğ
NULL
 || hint[0] == '\0') {

858 ià(
	`adb_is_absŞu‹_ho¡_·th
(
hšt
)) {

859  
hšt
;

864 ià(
	`adb_dœ¡¬t
(
hšt
è!ğ
nuÎ±r
) {

865 
¡d
::
¡ršg
 
cwd
;

866 ià(!
	`g‘cwd
(&
cwd
)) {

867 
	`årštf
(
¡d”r
, "adb: g‘cwd faed: %s\n", 
	`¡»¼Ü
(
”ºo
));

870  
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s%s%s", 
cwd
.
	`c_¡r
(), 
OS_PATH_SEPARATOR_STR
, 
hšt
);

877 * 
tİ
 = 
	`g‘’v
("ANDROID_BUILD_TOP");

878 ià(
tİ
 =ğ
nuÎ±r
) {

879 
	`årštf
(
¡d”r
, "adb: ANDROID_BUILD_TOP‚ot set!\n");

883 
¡d
::
¡ršg
 
·th
 = 
tİ
;

884 
·th
 +ğ
OS_PATH_SEPARATOR_STR
;

885 
·th
 += "out";

886 
·th
 +ğ
OS_PATH_SEPARATOR_STR
;

887 
·th
 += "target";

888 
·th
 +ğ
OS_PATH_SEPARATOR_STR
;

889 
·th
 += "product";

890 
·th
 +ğ
OS_PATH_SEPARATOR_STR
;

891 
·th
 +ğ
hšt
;

892 ià(!
	`dœeùÜy_exi¡s
(
·th
)) {

893 
	`årštf
(
¡d”r
, "adb: Couldn't find‡…roduct dir based on -p %s; "

894 "\"%s\" dÛ¢'ˆexi¡\n", 
hšt
, 
·th
.
	`c_¡r
());

897  
·th
;

898 
	}
}

900 
	$·r£_push_puÎ_¬gs
(cÚ¡ **
¬g
, 
Çrg
, cÚ¡ **
·th1
,

901 cÚ¡ **
·th2
, *
show_´og»ss
,

902 *
cİy_©Œs
) {

903 *
show_´og»ss
 = 0;

904 *
cİy_©Œs
 = 0;

906 
Çrg
 > 0) {

907 ià(!
	`¡rcmp
(*
¬g
, "-p")) {

908 *
show_´og»ss
 = 1;

909 } ià(!
	`¡rcmp
(*
¬g
, "-a")) {

910 *
cİy_©Œs
 = 1;

914 ++
¬g
;

915 --
Çrg
;

918 ià(
Çrg
 > 0) {

919 *
·th1
 = *
¬g
;

920 ++
¬g
;

921 --
Çrg
;

924 ià(
Çrg
 > 0) {

925 *
·th2
 = *
¬g
;

927 
	}
}

929 
	$adb_cÚÃù_commªd
(cÚ¡ 
¡d
::
¡ršg
& 
commªd
) {

930 
¡d
::
¡ršg
 
”rÜ
;

931 
fd
 = 
	`adb_cÚÃù
(
commªd
, &
”rÜ
);

932 ià(
fd
 < 0) {

933 
	`årštf
(
¡d”r
, "”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

936 
	`»ad_ªd_dump
(
fd
);

937 
	`adb_şo£
(
fd
);

939 
	}
}

941 
	$adb_qu”y_commªd
(cÚ¡ 
¡d
::
¡ršg
& 
commªd
) {

942 
¡d
::
¡ršg
 
»suÉ
;

943 
¡d
::
¡ršg
 
”rÜ
;

944 ià(!
	`adb_qu”y
(
commªd
, &
»suÉ
, &
”rÜ
)) {

945 
	`årštf
(
¡d”r
, "”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

948 
	`´štf
("%s\n", 
»suÉ
.
	`c_¡r
());

950 
	}
}

952 
	$adb_commªdlše
(
¬gc
, cÚ¡ **
¬gv
) {

953 
no_d«mÚ
 = 0;

954 
is_d«mÚ
 = 0;

955 
is_£rv”
 = 0;

956 
³rsi¡
 = 0;

957 
r
;

958 
Œª¥Üt_ty³
 
‰y³
 = 
kT¿n¥ÜtAny
;

959 cÚ¡ * 
£rŸl
 = 
NULL
;

960 cÚ¡ * 
£rv”_pÜt_¡r
 = 
NULL
;

967 * 
ANDROID_PRODUCT_OUT
 = 
	`g‘’v
("ANDROID_PRODUCT_OUT");

968 ià(
ANDROID_PRODUCT_OUT
 !ğ
nuÎ±r
) {

969 
gProduùOutP©h
 = 
ANDROID_PRODUCT_OUT
;

973 
£rŸl
 = 
	`g‘’v
("ANDROID_SERIAL");

976 
£rv”_pÜt_¡r
 = 
	`g‘’v
("ANDROID_ADB_SERVER_PORT");

977 
£rv”_pÜt
 = 
DEFAULT_ADB_PORT
;

978 ià(
£rv”_pÜt_¡r
 && 
	`¡¾’
(server_port_str) > 0) {

979 
£rv”_pÜt
 = (è
	`¡¹Ş
(
£rv”_pÜt_¡r
, 
NULL
, 0);

980 ià(
£rv”_pÜt
 <= 0 || server_port > 65535) {

981 
	`årštf
(
¡d”r
,

983 
£rv”_pÜt_¡r
);

984  
	`u§ge
();

989 
¬gc
 > 0) {

990 ià(!
	`¡rcmp
(
¬gv
[0],"server")) {

991 
is_£rv”
 = 1;

992 } ià(!
	`¡rcmp
(
¬gv
[0],"nodaemon")) {

993 
no_d«mÚ
 = 1;

994 } ià(!
	`¡rcmp
(
¬gv
[0], "fork-server")) {

996 
is_d«mÚ
 = 1;

997 } ià(!
	`¡rcmp
(
¬gv
[0],"persist")) {

998 
³rsi¡
 = 1;

999 } ià(!
	`¡ºcmp
(
¬gv
[0], "-p", 2)) {

1000 cÚ¡ *
´oduù
 = 
NULL
;

1001 ià(
¬gv
[0][2] == '\0') {

1002 ià(
¬gc
 < 2è 
	`u§ge
();

1003 
´oduù
 = 
¬gv
[1];

1004 
¬gc
--;

1005 
¬gv
++;

1007 
´oduù
 = 
¬gv
[0] + 2;

1009 
gProduùOutP©h
 = 
	`fšd_´oduù_out_·th
(
´oduù
);

1010 ià(
gProduùOutP©h
.
	`em±y
()) {

1011 
	`årštf
(
¡d”r
, "adb: could‚Ù„esŞv\"-°%s\"\n", 
´oduù
);

1012  
	`u§ge
();

1014 } ià(
¬gv
[0][0]=='-' &&‡rgv[0][1]=='s') {

1015 ià(
	`isdig™
(
¬gv
[0][2])) {

1016 
£rŸl
 = 
¬gv
[0] + 2;

1018 ià(
¬gc
 < 2 || 
¬gv
[0][2] !ğ'\0'è 
	`u§ge
();

1019 
£rŸl
 = 
¬gv
[1];

1020 
¬gc
--;

1021 
¬gv
++;

1023 } ià(!
	`¡rcmp
(
¬gv
[0],"-d")) {

1024 
‰y³
 = 
kT¿n¥ÜtUsb
;

1025 } ià(!
	`¡rcmp
(
¬gv
[0],"-e")) {

1026 
‰y³
 = 
kT¿n¥ÜtLoÿl
;

1027 } ià(!
	`¡rcmp
(
¬gv
[0],"-a")) {

1028 
gLi¡’AÎ
 = 1;

1029 } ià(!
	`¡ºcmp
(
¬gv
[0], "-H", 2)) {

1030 cÚ¡ *
ho¡Çme
 = 
NULL
;

1031 ià(
¬gv
[0][2] == '\0') {

1032 ià(
¬gc
 < 2è 
	`u§ge
();

1033 
ho¡Çme
 = 
¬gv
[1];

1034 
¬gc
--;

1035 
¬gv
++;

1037 
ho¡Çme
 = 
¬gv
[0] + 2;

1039 
	`adb_£t_tı_Çme
(
ho¡Çme
);

1041 } ià(!
	`¡ºcmp
(
¬gv
[0], "-P", 2)) {

1042 ià(
¬gv
[0][2] == '\0') {

1043 ià(
¬gc
 < 2è 
	`u§ge
();

1044 
£rv”_pÜt_¡r
 = 
¬gv
[1];

1045 
¬gc
--;

1046 
¬gv
++;

1048 
£rv”_pÜt_¡r
 = 
¬gv
[0] + 2;

1050 ià(
	`¡¾’
(
£rv”_pÜt_¡r
) > 0) {

1051 
£rv”_pÜt
 = (è
	`¡¹Ş
(
£rv”_pÜt_¡r
, 
NULL
, 0);

1052 ià(
£rv”_pÜt
 <= 0 || server_port > 65535) {

1053 
	`årštf
(
¡d”r
,

1055 
£rv”_pÜt_¡r
);

1056  
	`u§ge
();

1059 
	`årštf
(
¡d”r
,

1061  
	`u§ge
();

1067 
¬gc
--;

1068 
¬gv
++;

1071 
	`adb_£t_Œª¥Üt
(
‰y³
, 
£rŸl
);

1072 
	`adb_£t_tı_¥ecifics
(
£rv”_pÜt
);

1074 ià(
is_£rv”
) {

1075 ià(
no_d«mÚ
 || 
is_d«mÚ
) {

1076 
r
 = 
	`adb_maš
(
is_d«mÚ
, 
£rv”_pÜt
);

1078 
r
 = 
	`Ïunch_£rv”
(
£rv”_pÜt
);

1080 ià(
r
) {

1081 
	`årštf
(
¡d”r
,"* could‚ot start server *\n");

1083  
r
;

1086 ià(
¬gc
 == 0) {

1087  
	`u§ge
();

1091 ià(!
	`¡ºcmp
(
¬gv
[0], "wa™-fÜ-", 
	`¡¾’
("wait-for-"))) {

1092 cÚ¡ * 
£rviû
 = 
¬gv
[0];

1094 ià(!
	`wa™_fÜ_deviû
(
£rviû
, 
‰y³
, 
£rŸl
)) {

1100 ià(
¬gc
 == 1) {

1105 
¬gc
--;

1106 
¬gv
++;

1110 ià(!
	`¡rcmp
(
¬gv
[0], "devices")) {

1111 cÚ¡ *
li¡İt
;

1112 ià(
¬gc
 < 2) {

1113 
li¡İt
 = "";

1114 } ià(
¬gc
 =ğ2 && !
	`¡rcmp
(
¬gv
[1], "-l")) {

1115 
li¡İt
 = 
¬gv
[1];

1117 
	`årštf
(
¡d”r
, "Usage:‡db devices [-l]\n");

1121 
¡d
::
¡ršg
 
qu”y
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("ho¡:%s%s", 
¬gv
[0], 
li¡İt
);

1122 
	`´štf
("List of devices‡ttached\n");

1123  
	`adb_qu”y_commªd
(
qu”y
);

1125 ià(!
	`¡rcmp
(
¬gv
[0], "connect")) {

1126 ià(
¬gc
 != 2) {

1127 
	`årštf
(
¡d”r
, "Usage:‡db connect <host>[:<port>]\n");

1131 
¡d
::
¡ršg
 
qu”y
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("ho¡:cÚÃù:%s", 
¬gv
[1]);

1132  
	`adb_qu”y_commªd
(
qu”y
);

1134 ià(!
	`¡rcmp
(
¬gv
[0], "disconnect")) {

1135 ià(
¬gc
 > 2) {

1136 
	`årštf
(
¡d”r
, "Usage:‡db disconnect [<host>[:<port>]]\n");

1140 
¡d
::
¡ršg
 
qu”y
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("host:disconnect:%s",

1141 (
¬gc
 =ğ2è? 
¬gv
[1] : "");

1142  
	`adb_qu”y_commªd
(
qu”y
);

1144 ià(!
	`¡rcmp
(
¬gv
[0], "emu")) {

1145  
	`adb_£nd_emuÏtÜ_commªd
(
¬gc
, 
¬gv
);

1147 ià(!
	`¡rcmp
(
¬gv
[0], "shell") || !strcmp(argv[0], "hell")) {

1148 
h
 = (
¬gv
[0][0] == 'h');

1150 ià(
h
) {

1151 
	`´štf
("\x1b[41;33m");

1152 
	`fæush
(
¡dout
);

1155 ià(
¬gc
 < 2) {

1156 
	`D
("starting interactive shell\n");

1157 
r
 = 
	`š‹¿ùive_sh–l
();

1158 ià(
h
) {

1159 
	`´štf
("\x1b[0m");

1160 
	`fæush
(
¡dout
);

1162  
r
;

1165 
¡d
::
¡ršg
 
cmd
 = "shell:";

1166 --
¬gc
;

1167 ++
¬gv
;

1168 
¬gc
-- > 0) {

1170 
cmd
 +ğ*
¬gv
++;

1171 ià(*
¬gv
è
cmd
 += " ";

1174 
Œue
) {

1175 
	`D
("š‹¿ùivsh–Èloİ. cmd=%s\n", 
cmd
.
	`c_¡r
());

1176 
¡d
::
¡ršg
 
”rÜ
;

1177 
fd
 = 
	`adb_cÚÃù
(
cmd
, &
”rÜ
);

1178 
r
;

1179 ià(
fd
 >= 0) {

1180 
	`D
("abouˆtØ»ad_ªd_dump(fd=%d)\n", 
fd
);

1181 
	`»ad_ªd_dump
(
fd
);

1182 
	`D
("read_and_dump() done.\n");

1183 
	`adb_şo£
(
fd
);

1184 
r
 = 0;

1186 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

1187 
r
 = -1;

1190 ià(
³rsi¡
) {

1191 
	`årštf
(
¡d”r
,"\n- waiting for device -\n");

1192 
	`adb_¦“p_ms
(1000);

1193 
	`wa™_fÜ_deviû
("wa™-fÜ-deviû", 
‰y³
, 
£rŸl
);

1195 ià(
h
) {

1196 
	`´štf
("\x1b[0m");

1197 
	`fæush
(
¡dout
);

1199 
	`D
("š‹¿ùivsh–Èloİ.„‘uº„=%d\n", 
r
);

1200  
r
;

1204 ià(!
	`¡rcmp
(
¬gv
[0], "exec-in") || !strcmp(argv[0], "exec-out")) {

1205 
exec_š
 = !
	`¡rcmp
(
¬gv
[0], "exec-in");

1207 
¡d
::
¡ršg
 
cmd
 = "exec:";

1208 
cmd
 +ğ
¬gv
[1];

1209 
¬gc
 -= 2;

1210 
¬gv
 += 2;

1211 
¬gc
-- > 0) {

1212 
cmd
 +ğ" " + 
	`esÿ³_¬g
(*
¬gv
++);

1215 
¡d
::
¡ršg
 
”rÜ
;

1216 
fd
 = 
	`adb_cÚÃù
(
cmd
, &
”rÜ
);

1217 ià(
fd
 < 0) {

1218 
	`årštf
(
¡d”r
, "”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

1222 ià(
exec_š
) {

1223 
	`cİy_to_fe
(
STDIN_FILENO
, 
fd
);

1225 
	`cİy_to_fe
(
fd
, 
STDOUT_FILENO
);

1228 
	`adb_şo£
(
fd
);

1231 ià(!
	`¡rcmp
(
¬gv
[0], "kill-server")) {

1232 
¡d
::
¡ršg
 
”rÜ
;

1233 
fd
 = 
	`_adb_cÚÃù
("ho¡:kl", &
”rÜ
);

1234 ià(
fd
 == -1) {

1235 
	`årštf
(
¡d”r
,"* server‚ot„unning *\n");

1240 ià(!
	`¡rcmp
(
¬gv
[0], "sideload")) {

1241 ià(
¬gc
 !ğ2è 
	`u§ge
();

1242 ià(
	`adb_sid–ßd_ho¡
(
¬gv
[1])) {

1248 ià(!
	`¡rcmp
(
¬gv
[0], "remount") ||

1249 !
	`¡rcmp
(
¬gv
[0], "reboot") ||

1250 !
	`¡rcmp
(
¬gv
[0], "reboot-bootloader") ||

1251 !
	`¡rcmp
(
¬gv
[0], "tcpip") ||

1252 !
	`¡rcmp
(
¬gv
[0], "usb") ||

1253 !
	`¡rcmp
(
¬gv
[0], "root") ||

1254 !
	`¡rcmp
(
¬gv
[0], "unroot") ||

1255 !
	`¡rcmp
(
¬gv
[0], "disable-verity") ||

1256 !
	`¡rcmp
(
¬gv
[0], "enable-verity")) {

1257 
¡d
::
¡ršg
 
commªd
;

1258 ià(!
	`¡rcmp
(
¬gv
[0], "reboot-bootloader")) {

1259 
commªd
 = "reboot:bootloader";

1260 } ià(
¬gc
 > 1) {

1261 
commªd
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s:%s", 
¬gv
[0],‡rgv[1]);

1263 
commªd
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s:", 
¬gv
[0]);

1265  
	`adb_cÚÃù_commªd
(
commªd
);

1267 ià(!
	`¡rcmp
(
¬gv
[0], "bugreport")) {

1268 ià(
¬gc
 !ğ1è 
	`u§ge
();

1269  
	`£nd_sh–l_commªd
(
‰y³
, 
£rŸl
, "shell:bugreport");

1272 ià(!
	`¡rcmp
(
¬gv
[0], "forward") || !strcmp(argv[0], "reverse")) {

1273 
¡d
::
¡ršg
 
cmd
;

1274 
ho¡_´efix
[64];

1275 
»v”£
 = (è!
	`¡rcmp
(
¬gv
[0], "reverse");

1276 
»move
 = 0;

1277 
»move_®l
 = 0;

1278 
li¡
 = 0;

1279 
no_»bšd
 = 0;

1282 
¬gc
 > 1 && 
¬gv
[1][0] == '-') {

1283 ià(!
	`¡rcmp
(
¬gv
[1], "--list"))

1284 
li¡
 = 1;

1285 ià(!
	`¡rcmp
(
¬gv
[1], "--remove"))

1286 
»move
 = 1;

1287 ià(!
	`¡rcmp
(
¬gv
[1], "--remove-all"))

1288 
»move_®l
 = 1;

1289 ià(!
	`¡rcmp
(
¬gv
[1], "--no-rebind"))

1290 
no_»bšd
 = 1;

1292  
	`u§ge
();

1294 
¬gc
--;

1295 
¬gv
++;

1299 ià(
li¡
 + 
»move
 + 
»move_®l
 + 
no_»bšd
 > 1) {

1300  
	`u§ge
();

1304 ià(
»v”£
) {

1305 
	`¢´štf
(
ho¡_´efix
,  host_prefix, "reverse");

1307 ià(
£rŸl
) {

1308 
	`¢´štf
(
ho¡_´efix
,  host_prefix, "host-serial:%s",

1309 
£rŸl
);

1310 } ià(
‰y³
 =ğ
kT¿n¥ÜtUsb
) {

1311 
	`¢´štf
(
ho¡_´efix
,  host_prefix, "host-usb");

1312 } ià(
‰y³
 =ğ
kT¿n¥ÜtLoÿl
) {

1313 
	`¢´štf
(
ho¡_´efix
,  host_prefix, "host-local");

1315 
	`¢´štf
(
ho¡_´efix
,  host_prefix, "host");

1320 ià(
li¡
) {

1321 ià(
¬gc
 != 1) {

1322  
	`u§ge
();

1325 
¡d
::
¡ršg
 
qu”y
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s:li¡-fÜw¬d", 
ho¡_´efix
);

1326  
	`adb_qu”y_commªd
(
qu”y
);

1330 ià(
»move_®l
) {

1331 ià(
¬gc
 !ğ1è 
	`u§ge
();

1332 
cmd
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s:klfÜw¬d-®l", 
ho¡_´efix
);

1336 ià(
»move
) {

1337 ià(
¬gc
 !ğ2è 
	`u§ge
();

1338 
cmd
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s:klfÜw¬d:%s", 
ho¡_´efix
, 
¬gv
[1]);

1344 ià(
¬gc
 !ğ3è 
	`u§ge
();

1345 cÚ¡ * 
commªd
 = 
no_»bšd
 ? "forward:norebind" : "forward";

1346 
cmd
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s:%s:%s;%s", 
ho¡_´efix
, 
commªd
, 
¬gv
[1],‡rgv[2]);

1349 
¡d
::
¡ršg
 
”rÜ
;

1350 ià(
	`adb_commªd
(
cmd
, &
”rÜ
)) {

1351 
	`årštf
(
¡d”r
, "”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

1357 ià(!
	`¡rcmp
(
¬gv
[0], "ls")) {

1358 ià(
¬gc
 !ğ2è 
	`u§ge
();

1359  
	`do_sync_ls
(
¬gv
[1]);

1361 ià(!
	`¡rcmp
(
¬gv
[0], "push")) {

1362 
show_´og»ss
 = 0;

1363 
cİy_©Œs
 = 0;

1364 cÚ¡ * 
Í©h
 = 
NULL
, *
½©h
 = NULL;

1366 
	`·r£_push_puÎ_¬gs
(&
¬gv
[1], 
¬gc
 - 1, &
Í©h
, &
½©h
, &
show_´og»ss
, &
cİy_©Œs
);

1368 ià((
Í©h
 !ğ
NULL
è&& (
½©h
 != NULL)) {

1369  
	`do_sync_push
(
Í©h
, 
½©h
, 
show_´og»ss
);

1372  
	`u§ge
();

1374 ià(!
	`¡rcmp
(
¬gv
[0], "pull")) {

1375 
show_´og»ss
 = 0;

1376 
cİy_©Œs
 = 0;

1377 cÚ¡ * 
½©h
 = 
NULL
, *
Í©h
 = ".";

1379 
	`·r£_push_puÎ_¬gs
(&
¬gv
[1], 
¬gc
 - 1, &
½©h
, &
Í©h
, &
show_´og»ss
, &
cİy_©Œs
);

1381 ià(
½©h
 !ğ
NULL
) {

1382  
	`do_sync_puÎ
(
½©h
, 
Í©h
, 
show_´og»ss
, 
cİy_©Œs
);

1385  
	`u§ge
();

1387 ià(!
	`¡rcmp
(
¬gv
[0], "install")) {

1388 ià(
¬gc
 < 2è 
	`u§ge
();

1389  
	`š¡®l_­p
(
‰y³
, 
£rŸl
, 
¬gc
, 
¬gv
);

1391 ià(!
	`¡rcmp
(
¬gv
[0], "install-multiple")) {

1392 ià(
¬gc
 < 2è 
	`u§ge
();

1393  
	`š¡®l_muÉË_­p
(
‰y³
, 
£rŸl
, 
¬gc
, 
¬gv
);

1395 ià(!
	`¡rcmp
(
¬gv
[0], "uninstall")) {

1396 ià(
¬gc
 < 2è 
	`u§ge
();

1397  
	`unš¡®l_­p
(
‰y³
, 
£rŸl
, 
¬gc
, 
¬gv
);

1399 ià(!
	`¡rcmp
(
¬gv
[0], "sync")) {

1400 
¡d
::
¡ršg
 
¤c
;

1401 
boŞ
 
li¡_Úly
 = 
çl£
;

1402 ià(
¬gc
 < 2) {

1404 
¤c
 = "";

1405 } ià(
¬gc
 >ğ2 && 
	`¡rcmp
(
¬gv
[1], "-l") == 0) {

1406 
li¡_Úly
 = 
Œue
;

1407 ià(
¬gc
 == 3) {

1408 
¤c
 = 
¬gv
[2];

1410 
¤c
 = "";

1412 } ià(
¬gc
 == 2) {

1414 
¤c
 = 
¬gv
[1];

1416  
	`u§ge
();

1419 ià(
¤c
 != "" &&

1420 
¤c
 != "system" && src != "data" && src != "vendor" && src != "oem") {

1421  
	`u§ge
();

1424 
¡d
::
¡ršg
 
sy¡em_¤c_·th
 = 
	`´oduù_fe
("system");

1425 
¡d
::
¡ršg
 
d©a_¤c_·th
 = 
	`´oduù_fe
("data");

1426 
¡d
::
¡ršg
 
v’dÜ_¤c_·th
 = 
	`´oduù_fe
("vendor");

1427 
¡d
::
¡ršg
 
Ûm_¤c_·th
 = 
	`´oduù_fe
("oem");

1429 
rc
 = 0;

1430 ià(
rc
 =ğ0 && (
¤c
.
	`em±y
() || src == "system")) {

1431 
rc
 = 
	`do_sync_sync
(
sy¡em_¤c_·th
, "/sy¡em", 
li¡_Úly
);

1433 ià(
rc
 =ğ0 && (
¤c
.
	`em±y
(è|| srø=ğ"v’dÜ"è&& 
	`dœeùÜy_exi¡s
(
v’dÜ_¤c_·th
)) {

1434 
rc
 = 
	`do_sync_sync
(
v’dÜ_¤c_·th
, "/v’dÜ", 
li¡_Úly
);

1436 ià(
rc
 =ğ0 && (
¤c
.
	`em±y
(è|| srø=ğ"Ûm"è&& 
	`dœeùÜy_exi¡s
(
Ûm_¤c_·th
)) {

1437 
rc
 = 
	`do_sync_sync
(
Ûm_¤c_·th
, "/Ûm", 
li¡_Úly
);

1439 ià(
rc
 =ğ0 && (
¤c
.
	`em±y
() || src == "data")) {

1440 
rc
 = 
	`do_sync_sync
(
d©a_¤c_·th
, "/d©a", 
li¡_Úly
);

1442  
rc
;

1445 ià(!
	`¡rcmp
(
¬gv
[0],"get-state") ||

1446 !
	`¡rcmp
(
¬gv
[0],"get-serialno") ||

1447 !
	`¡rcmp
(
¬gv
[0],"get-devpath"))

1449  
	`adb_qu”y_commªd
(
	`fÜm©_ho¡_commªd
(
¬gv
[0], 
‰y³
, 
£rŸl
));

1452 ià(!
	`¡rcmp
(
¬gv
[0],"logcat") || !strcmp(argv[0],"lolcat") || !strcmp(argv[0],"longcat")) {

1453  
	`logÿt
(
‰y³
, 
£rŸl
, 
¬gc
, 
¬gv
);

1455 ià(!
	`¡rcmp
(
¬gv
[0],"ppp")) {

1456  
	`µp
(
¬gc
, 
¬gv
);

1458 ià(!
	`¡rcmp
(
¬gv
[0], "start-server")) {

1459 
¡d
::
¡ršg
 
”rÜ
;

1460  
	`adb_cÚÃù
("ho¡:¡¬t-£rv”", &
”rÜ
);

1462 ià(!
	`¡rcmp
(
¬gv
[0], "backup")) {

1463  
	`backup
(
¬gc
, 
¬gv
);

1465 ià(!
	`¡rcmp
(
¬gv
[0], "restore")) {

1466  
	`»¡Üe
(
¬gc
, 
¬gv
);

1468 ià(!
	`¡rcmp
(
¬gv
[0], "keygen")) {

1469 ià(
¬gc
 < 2è 
	`u§ge
();

1470  
	`adb_auth_keyg’
(
¬gv
[1]);

1472 ià(!
	`¡rcmp
(
¬gv
[0], "jdwp")) {

1473  
	`adb_cÚÃù_commªd
("jdwp");

1476 ià(!
	`¡rcmp
(
¬gv
[0], "help") || !strcmp(argv[0], "/?")) {

1477 
	`h–p
();

1480 ià(!
	`¡rcmp
(
¬gv
[0], "version")) {

1481 
	`v”siÚ
(
¡dout
);

1485 
	`u§ge
();

1487 
	}
}

1489 
	$pm_commªd
(
Œª¥Üt_ty³
 
Œª¥Üt
, cÚ¡ * 
£rŸl
,

1490 
¬gc
, cÚ¡ ** 
¬gv
)

1492 
¡d
::
¡ršg
 
cmd
 = "shell:pm";

1494 
¬gc
-- > 0) {

1495 
cmd
 +ğ" " + 
	`esÿ³_¬g
(*
¬gv
++);

1498  
	`£nd_sh–l_commªd
(
Œª¥Üt
, 
£rŸl
, 
cmd
);

1499 
	}
}

1501 
	$unš¡®l_­p
(
Œª¥Üt_ty³
 
Œª¥Üt
, cÚ¡ * 
£rŸl
, 
¬gc
,

1502 cÚ¡ ** 
¬gv
)

1506 ià(
¬gc
 =ğ3 && 
	`¡rcmp
(
¬gv
[1], "-k") == 0)

1508 
	`´štf
(

1512 "Iàyouruly wishØcÚtšue,ƒxecu‹ 'adb sh–Èpm unš¡®È-k %s'\n", 
¬gv
[2]);

1517  
	`pm_commªd
(
Œª¥Üt
, 
£rŸl
, 
¬gc
, 
¬gv
);

1518 
	}
}

1520 
	$d–‘e_fe
(
Œª¥Üt_ty³
 
Œª¥Üt
, cÚ¡ * 
£rŸl
, * 
f’ame
)

1522 
¡d
::
¡ršg
 
cmd
 = "sh–l:rm -à" + 
	`esÿ³_¬g
(
f’ame
);

1523  
	`£nd_sh–l_commªd
(
Œª¥Üt
, 
£rŸl
, 
cmd
);

1524 
	}
}

1526 cÚ¡ * 
	$g‘_ba£Çme
(cÚ¡ * 
f’ame
)

1528 cÚ¡ * 
ba£Çme
 = 
	`adb_dœ¡İ
(
f’ame
);

1529 ià(
ba£Çme
) {

1530 
ba£Çme
++;

1531  
ba£Çme
;

1533  
f’ame
;

1535 
	}
}

1537 
	$š¡®l_­p
(
Œª¥Üt_ty³
 
Œª¥Üt
, cÚ¡ * 
£rŸl
, 
¬gc
,

1538 cÚ¡ ** 
¬gv
)

1540 cÚ¡ *cÚ¡ 
DATA_DEST
 = "/data/local/tmp/%s";

1541 cÚ¡ *cÚ¡ 
SD_DEST
 = "/sdcard/tmp/%s";

1542 cÚ¡ * 
wh”e
 = 
DATA_DEST
;

1543 
i
;

1544 
¡©
 
sb
;

1546 
i
 = 1; i < 
¬gc
; i++) {

1547 ià(!
	`¡rcmp
(
¬gv
[
i
], "-s")) {

1548 
wh”e
 = 
SD_DEST
;

1554 
Ï¡_­k
 = -1;

1555 
i
 = 
¬gc
 - 1; i >= 0; i--) {

1556 cÚ¡ * 
fe
 = 
¬gv
[
i
];

1557 * 
dÙ
 = 
	`¡¼chr
(
fe
, '.');

1558 ià(
dÙ
 && !
	`¡rÿ£cmp
(dot, ".apk")) {

1559 ià(
	`¡©
(
fe
, &
sb
è=ğ-1 || !
	`S_ISREG
(sb.
¡_mode
)) {

1560 
	`årštf
(
¡d”r
, "Inv®id APK fe: %s\n", 
fe
);

1564 
Ï¡_­k
 = 
i
;

1569 ià(
Ï¡_­k
 == -1) {

1570 
	`årštf
(
¡d”r
, "Missing APK file\n");

1574 cÚ¡ * 
­k_fe
 = 
¬gv
[
Ï¡_­k
];

1575 
­k_de¡
[
PATH_MAX
];

1576 
	`¢´štf
(
­k_de¡
, ‡pk_de¡, 
wh”e
, 
	`g‘_ba£Çme
(
­k_fe
));

1577 
”r
 = 
	`do_sync_push
(
­k_fe
, 
­k_de¡
, 0 );

1578 ià(
”r
) {

1579 
ş—nup_­k
;

1581 
¬gv
[
Ï¡_­k
] = 
­k_de¡
;

1584 
”r
 = 
	`pm_commªd
(
Œª¥Üt
, 
£rŸl
, 
¬gc
, 
¬gv
);

1586 
ş—nup_­k
:

1587 
	`d–‘e_fe
(
Œª¥Üt
, 
£rŸl
, 
­k_de¡
);

1588  
”r
;

1589 
	}
}

1591 
	$š¡®l_muÉË_­p
(
Œª¥Üt_ty³
 
Œª¥Üt
, cÚ¡ * 
£rŸl
, 
¬gc
,

1592 cÚ¡ ** 
¬gv
)

1594 
i
;

1595 
¡©
 
sb
;

1596 
ušt64_t
 
tÙ®_size
 = 0;

1600 
fœ¡_­k
 = -1;

1601 
i
 = 
¬gc
 - 1; i >= 0; i--) {

1602 cÚ¡ * 
fe
 = 
¬gv
[
i
];

1603 * 
dÙ
 = 
	`¡¼chr
(
fe
, '.');

1604 ià(
dÙ
 && !
	`¡rÿ£cmp
(dot, ".apk")) {

1605 ià(
	`¡©
(
fe
, &
sb
è=ğ-1 || !
	`S_ISREG
(sb.
¡_mode
)) {

1606 
	`årštf
(
¡d”r
, "Inv®id APK fe: %s\n", 
fe
);

1610 
tÙ®_size
 +ğ
sb
.
¡_size
;

1611 
fœ¡_­k
 = 
i
;

1617 ià(
fœ¡_­k
 == -1) {

1618 
	`årštf
(
¡d”r
, "Missing APK file\n");

1622 #ià
	`defšed
(
_WIN32
)

1623 
¡d
::
¡ršg
 
cmd
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("exec:pm in¡®l-ü—‹ -S %u", (è
tÙ®_size
);

1625 
¡d
::
¡ršg
 
cmd
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("exec:pm in¡®l-ü—‹ -S %" 
PRIu64
, 
tÙ®_size
);

1627 
i
 = 1; i < 
fœ¡_­k
; i++) {

1628 
cmd
 +ğ" " + 
	`esÿ³_¬g
(
¬gv
[
i
]);

1632 
¡d
::
¡ršg
 
”rÜ
;

1633 
fd
 = 
	`adb_cÚÃù
(
cmd
, &
”rÜ
);

1634 ià(
fd
 < 0) {

1635 
	`årštf
(
¡d”r
, "CÚÃùƒ¼Ü fÜ c»©e: %s\n", 
”rÜ
.
	`c_¡r
());

1638 
buf
[
BUFSIZ
];

1639 
	`»ad_¡©us_lše
(
fd
, 
buf
, (buf));

1640 
	`adb_şo£
(
fd
);

1642 
£ssiÚ_id
 = -1;

1643 ià(!
	`¡ºcmp
("Sucûss", 
buf
, 7)) {

1644 * 
¡¬t
 = 
	`¡¼chr
(
buf
, '[');

1645 * 
’d
 = 
	`¡¼chr
(
buf
, ']');

1646 ià(
¡¬t
 && 
’d
) {

1647 *
’d
 = '\0';

1648 
£ssiÚ_id
 = 
	`¡¹Ş
(
¡¬t
 + 1, 
NULL
, 10);

1651 ià(
£ssiÚ_id
 < 0) {

1652 
	`årštf
(
¡d”r
, "Failedo create session\n");

1653 
	`åuts
(
buf
, 
¡d”r
);

1658 
sucûss
 = 1;

1659 
i
 = 
fœ¡_­k
; i < 
¬gc
; i++) {

1660 cÚ¡ * 
fe
 = 
¬gv
[
i
];

1661 ià(
	`¡©
(
fe
, &
sb
) == -1) {

1662 
	`årštf
(
¡d”r
, "FaedØ¡© %s\n", 
fe
);

1663 
sucûss
 = 0;

1664 
fš®ize_£ssiÚ
;

1667 #ià
	`defšed
(
_WIN32
)

1668 
¡d
::
¡ršg
 
cmd
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
(

1670 (è
sb
.
¡_size
, 
£ssiÚ_id
, 
i
, 
	`g‘_ba£Çme
(
fe
));

1672 
¡d
::
¡ršg
 
cmd
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
(

1673 "exec:pm in¡®l-wr™-S %" 
PRIu64
 " %d %d_%s -",

1674 
¡©ic_ÿ¡
<
ušt64_t
>(
sb
.
¡_size
), 
£ssiÚ_id
, 
i
, 
	`g‘_ba£Çme
(
fe
));

1677 
loÿlFd
 = 
	`adb_İ’
(
fe
, 
O_RDONLY
);

1678 ià(
loÿlFd
 < 0) {

1679 
	`årštf
(
¡d”r
, "FaedØİ’ %s: %s\n", 
fe
, 
	`¡»¼Ü
(
”ºo
));

1680 
sucûss
 = 0;

1681 
fš®ize_£ssiÚ
;

1684 
¡d
::
¡ršg
 
”rÜ
;

1685 
»mÙeFd
 = 
	`adb_cÚÃù
(
cmd
, &
”rÜ
);

1686 ià(
»mÙeFd
 < 0) {

1687 
	`årštf
(
¡d”r
, "CÚÃùƒ¼Ü fÜ wr™e: %s\n", 
”rÜ
.
	`c_¡r
());

1688 
	`adb_şo£
(
loÿlFd
);

1689 
sucûss
 = 0;

1690 
fš®ize_£ssiÚ
;

1693 
	`cİy_to_fe
(
loÿlFd
, 
»mÙeFd
);

1694 
	`»ad_¡©us_lše
(
»mÙeFd
, 
buf
, (buf));

1696 
	`adb_şo£
(
loÿlFd
);

1697 
	`adb_şo£
(
»mÙeFd
);

1699 ià(
	`¡ºcmp
("Sucûss", 
buf
, 7)) {

1700 
	`årštf
(
¡d”r
, "FaedØwr™%s\n", 
fe
);

1701 
	`åuts
(
buf
, 
¡d”r
);

1702 
sucûss
 = 0;

1703 
fš®ize_£ssiÚ
;

1707 
fš®ize_£ssiÚ
:

1709 
¡d
::
¡ršg
 
£rviû
 =

1710 
ªdroid
::
ba£
::
	`SŒšgPrštf
("exec:pm install-%s %d",

1711 
sucûss
 ? "comm™" : "abªdÚ", 
£ssiÚ_id
);

1712 
fd
 = 
	`adb_cÚÃù
(
£rviû
, &
”rÜ
);

1713 ià(
fd
 < 0) {

1714 
	`årštf
(
¡d”r
, "CÚÃùƒ¼Ü fÜ fš®ize: %s\n", 
”rÜ
.
	`c_¡r
());

1717 
	`»ad_¡©us_lše
(
fd
, 
buf
, (buf));

1718 
	`adb_şo£
(
fd
);

1720 ià(!
	`¡ºcmp
("Sucûss", 
buf
, 7)) {

1721 
	`åuts
(
buf
, 
¡d”r
);

1724 
	`årštf
(
¡d”r
, "Failedo finalize session\n");

1725 
	`åuts
(
buf
, 
¡d”r
);

1728 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/console.cpp

1 
	~"sysd•s.h
"

2 
	~"adb.h
"

3 
	~"adb_ş›Á.h
"

4 
	~<¡dio.h
>

6 
	$cÚÃù_to_cÚsŞe
()

8 
fd
, 
pÜt
;

10 
pÜt
 = 
	`adb_g‘_emuÏtÜ_cÚsŞe_pÜt
();

11 ià(
pÜt
 < 0) {

12 ià(
pÜt
 == -2)

13 
	`årštf
(
¡d”r
, "error: morehan oneƒmulator detected. use -s option\n");

15 
	`årštf
(
¡d”r
, "error:‚oƒmulator detected\n");

18 
fd
 = 
	`sock‘_loİback_ş›Á
Ğ
pÜt
, 
SOCK_STREAM
 );

19 ià(
fd
 < 0) {

20 
	`årštf
(
¡d”r
, "”rÜ: could‚Ù cÚÃùØTCP…Üˆ%d\n", 
pÜt
);

23  
fd
;

24 
	}
}

27 
	$adb_£nd_emuÏtÜ_commªd
(
¬gc
, cÚ¡ ** 
¬gv
)

29 
fd
, 
Â
;

31 
fd
 = 
	`cÚÃù_to_cÚsŞe
();

32 ià(
fd
 < 0)

35 
	#QUIT
 "qu™\n"

	)

37 
Â
 = 1;‚À< 
¬gc
;‚n++) {

38 
	`adb_wr™e
Ğ
fd
, 
¬gv
[
Â
], 
	`¡¾’
(argv[nn]) );

39 
	`adb_wr™e
Ğ
fd
, (
Â
 =ğ
¬gc
-1) ? "\n" : " ", 1 );

41 
	`adb_wr™e
Ğ
fd
, 
QUIT
, (QUIT)-1 );

42 
	`adb_şo£
(
fd
);

45 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/fdevent.cpp

18 
	#TRACE_TAG
 
TRACE_FDEVENT


	)

20 
	~"sysd•s.h
"

21 
	~"fdev’t.h
"

23 
	~<”ºo.h
>

24 
	~<fú.h
>

25 
	~<¡d¬g.h
>

26 
	~<¡ddef.h
>

27 
	~<¡dio.h
>

28 
	~<¡dlib.h
>

29 
	~<¡ršg.h
>

30 
	~<sys/ioùl.h
>

31 
	~<uni¡d.h
>

33 
	~"adb_io.h
"

34 
	~"adb_Œaû.h
"

40 
	#DEBUG
 0

	)

45 
	gSHELL_EXIT_NOTIFY_FD
 = -1;

47 
	$çl
(cÚ¡ *
â
, cÚ¡ *
fmt
, ...)

49 
va_li¡
 
­
;

50 
	`va_¡¬t
(
­
, 
fmt
);

51 
	`årštf
(
¡d”r
, "%s:", 
â
);

52 
	`vårštf
(
¡d”r
, 
fmt
, 
­
);

53 
	`va_’d
(
­
);

54 
	`abÜt
();

55 
	}
}

57 
	#FATAL
(
x
...è
	`çl
(
__FUNCTION__
, x)

	)

59 #ià
DEBUG


60 
	$dump_fde
(
fdev’t
 *
fde
, cÚ¡ *
šfo
)

62 
	`adb_mu‹x_lock
(&
D_lock
);

63 
	`årštf
(
¡d”r
,"FDE #%03d %c%c%ø%s\n", 
fde
->
fd
,

64 
fde
->
¡©e
 & 
FDE_READ
 ? 'R' : ' ',

65 
fde
->
¡©e
 & 
FDE_WRITE
 ? 'W' : ' ',

66 
fde
->
¡©e
 & 
FDE_ERROR
 ? 'E' : ' ',

67 
šfo
);

68 
	`adb_mu‹x_uÆock
(&
D_lock
);

69 
	}
}

71 
	#dump_fde
(
fde
, 
šfo
èdØ{ } 0)

	)

74 
	#FDE_EVENTMASK
 0x00ff

	)

75 
	#FDE_STATEMASK
 0xff00

	)

77 
	#FDE_ACTIVE
 0x0100

	)

78 
	#FDE_PENDING
 0x0200

	)

79 
	#FDE_CREATED
 0x0400

	)

81 
fdev’t_¶i¡_’queue
(
fdev’t
 *
node
);

82 
fdev’t_¶i¡_»move
(
fdev’t
 *
node
);

83 
fdev’t
 *
fdev’t_¶i¡_dequeue
();

84 
fdev’t_sub´oc_ev’t_func
(
fd
, 
ev’ts
, *
u£rd©a
);

86 
fdev’t
 
	gli¡_³ndšg
 = {

87 .
Ãxt
 = &
li¡_³ndšg
,

88 .
	g´ev
 = &
li¡_³ndšg
,

89 .
	gfd
 = -1,

90 .
	gfÜû_eof
 = 0,

91 .
	g¡©e
 = 0,

92 .
	gev’ts
 = 0,

93 .
	gfunc
 = 
nuÎ±r
,

94 .
	g¬g
 = 
nuÎ±r
,

97 
fdev’t
 **
	gfd_bË
 = 0;

98 
	gfd_bË_max
 = 0;

100 #ifdeà
CRAPTASTIC


103 
	~<sys/•Şl.h
>

105 
	g•Şl_fd
 = -1;

107 
	$fdev’t_š™
()

110 
•Şl_fd
 = 
	`•Şl_ü—‹
(256);

112 if(
•Şl_fd
 < 0) {

113 
	`³¼Ü
("epoll_create() failed");

114 
	`ex™
(1);

118 
	`fú
(
•Şl_fd
, 
F_SETFD
, 
FD_CLOEXEC
);

119 
	}
}

121 
	$fdev’t_cÚÃù
(
fdev’t
 *
fde
)

123 
•Şl_ev’t
 
ev
;

125 
	`mem£t
(&
ev
, 0, (ev));

126 
ev
.
ev’ts
 = 0;

127 
ev
.
d©a
.
±r
 = 
fde
;

130 if(
	`•Şl_ùl
(
•Şl_fd
, 
EPOLL_CTL_ADD
, 
fde
->
fd
, &
ev
)) {

131 
	`³¼Ü
("epoll_ctl() failed\n");

132 
	`ex™
(1);

135 
	}
}

137 
	$fdev’t_discÚÃù
(
fdev’t
 *
fde
)

139 
•Şl_ev’t
 
ev
;

141 
	`mem£t
(&
ev
, 0, (ev));

142 
ev
.
ev’ts
 = 0;

143 
ev
.
d©a
.
±r
 = 
fde
;

150 
	`•Şl_ùl
(
•Şl_fd
, 
EPOLL_CTL_DEL
, 
fde
->
fd
, &
ev
);

151 
	}
}

153 
	$fdev’t_upd©e
(
fdev’t
 *
fde
, 
ev’ts
)

155 
•Şl_ev’t
 
ev
;

156 
aùive
;

158 
aùive
 = (
fde
->
¡©e
 & 
FDE_EVENTMASK
) != 0;

160 
	`mem£t
(&
ev
, 0, (ev));

161 
ev
.
ev’ts
 = 0;

162 
ev
.
d©a
.
±r
 = 
fde
;

164 if(
ev’ts
 & 
FDE_READ
è
ev
.ev’t |ğ
EPOLLIN
;

165 if(
ev’ts
 & 
FDE_WRITE
è
ev
.ev’t |ğ
EPOLLOUT
;

166 if(
ev’ts
 & 
FDE_ERROR
è
ev
.ev’t |ğ(
EPOLLERR
 | 
EPOLLHUP
);

168 
fde
->
¡©e
 = (fde->¡©& 
FDE_STATEMASK
è| 
ev’ts
;

170 if(
aùive
) {

175 if(
ev
.
ev’ts
) {

176 if(
	`•Şl_ùl
(
•Şl_fd
, 
EPOLL_CTL_MOD
, 
fde
->
fd
, &
ev
)) {

177 
	`³¼Ü
("epoll_ctl() failed\n");

178 
	`ex™
(1);

181 if(
	`•Şl_ùl
(
•Şl_fd
, 
EPOLL_CTL_DEL
, 
fde
->
fd
, &
ev
)) {

182 
	`³¼Ü
("epoll_ctl() failed\n");

183 
	`ex™
(1);

190 if(
ev
.
ev’ts
) {

191 if(
	`•Şl_ùl
(
•Şl_fd
, 
EPOLL_CTL_ADD
, 
fde
->
fd
, &
ev
)) {

192 
	`³¼Ü
("epoll_ctl() failed\n");

193 
	`ex™
(1);

197 
	}
}

199 
	$fdev’t_´oûss
()

201 
•Şl_ev’t
 
ev’ts
[256];

202 
fdev’t
 *
fde
;

203 
i
, 
n
;

205 
n
 = 
	`•Şl_wa™
(
•Şl_fd
, 
ev’ts
, 256, -1);

207 if(
n
 < 0) {

208 if(
”ºo
 =ğ
EINTR
) ;

209 
	`³¼Ü
("epoll_wait");

210 
	`ex™
(1);

213 
i
 = 0; i < 
n
; i++) {

214 
•Şl_ev’t
 *
ev
 = 
ev’ts
 + 
i
;

215 
fde
 = 
ev
->
d©a
.
±r
;

217 if(
ev
->
ev’ts
 & 
EPOLLIN
) {

218 
fde
->
ev’ts
 |ğ
FDE_READ
;

220 if(
ev
->
ev’ts
 & 
EPOLLOUT
) {

221 
fde
->
ev’ts
 |ğ
FDE_WRITE
;

223 if(
ev
->
ev’ts
 & (
EPOLLERR
 | 
EPOLLHUP
)) {

224 
fde
->
ev’ts
 |ğ
FDE_ERROR
;

226 if(
fde
->
ev’ts
) {

227 if(
fde
->
¡©e
 & 
FDE_PENDING
) ;

228 
fde
->
¡©e
 |ğ
FDE_PENDING
;

229 
	`fdev’t_¶i¡_’queue
(
fde
);

232 
	}
}

236 #ifdeà
HAVE_WINSOCK


237 
	~<wšsock2.h
>

239 
	~<sys/£Ëù.h
>

242 
fd_£t
 
	g»ad_fds
;

243 
fd_£t
 
	gwr™e_fds
;

244 
fd_£t
 
	g”rÜ_fds
;

246 
	g£Ëù_n
 = 0;

248 
	$fdev’t_š™
()

250 
	`FD_ZERO
(&
»ad_fds
);

251 
	`FD_ZERO
(&
wr™e_fds
);

252 
	`FD_ZERO
(&
”rÜ_fds
);

253 
	}
}

255 
	$fdev’t_cÚÃù
(
fdev’t
 *
fde
)

257 if(
fde
->
fd
 >ğ
£Ëù_n
) {

258 
£Ëù_n
 = 
fde
->
fd
 + 1;

260 
	}
}

262 
	$fdev’t_discÚÃù
(
fdev’t
 *
fde
)

264 
i
, 
n
;

266 
	`FD_CLR
(
fde
->
fd
, &
»ad_fds
);

267 
	`FD_CLR
(
fde
->
fd
, &
wr™e_fds
);

268 
	`FD_CLR
(
fde
->
fd
, &
”rÜ_fds
);

270 
n
 = 0, 
i
 = 0; i < 
£Ëù_n
; i++) {

271 if(
fd_bË
[
i
] !ğ0è
n
 = i;

273 
£Ëù_n
 = 
n
 + 1;

274 
	}
}

276 
	$fdev’t_upd©e
(
fdev’t
 *
fde
, 
ev’ts
)

278 if(
ev’ts
 & 
FDE_READ
) {

279 
	`FD_SET
(
fde
->
fd
, &
»ad_fds
);

281 
	`FD_CLR
(
fde
->
fd
, &
»ad_fds
);

283 if(
ev’ts
 & 
FDE_WRITE
) {

284 
	`FD_SET
(
fde
->
fd
, &
wr™e_fds
);

286 
	`FD_CLR
(
fde
->
fd
, &
wr™e_fds
);

288 if(
ev’ts
 & 
FDE_ERROR
) {

289 
	`FD_SET
(
fde
->
fd
, &
”rÜ_fds
);

291 
	`FD_CLR
(
fde
->
fd
, &
”rÜ_fds
);

294 
fde
->
¡©e
 = (fde->¡©& 
FDE_STATEMASK
è| 
ev’ts
;

295 
	}
}

300 
	$fdev’t_fd_check
(
fd_£t
 *
fds
)

302 
i
, 
n
 = 0;

303 
fdev’t
 *
fde
;

305 
i
 = 0; i < 
£Ëù_n
; i++) {

306 
fde
 = 
fd_bË
[
i
];

307 if(
fde
 == 0) ;

308 if(
	`fú
(
i
, 
F_GETFL
, 
NULL
) < 0) {

309 
	`FD_SET
(
i
, 
fds
);

310 
n
++;

315  
n
;

316 
	}
}

318 #ià!
DEBUG


319 
šlše
 
	$dump_®l_fds
(cÚ¡ * ) {
	}
}

321 
	$dump_®l_fds
(cÚ¡ *
exŒa_msg
)

323 
i
;

324 
fdev’t
 *
fde
;

326 
msg_buff
[
FD_SETSIZE
*6 + 1], *
pb
=msg_buff;

327 
size_t
 
max_ch¬s
 = 
FD_SETSIZE
 * 6 + 1;

328 
´š‹d_out
;

329 
	#SAFE_SPRINTF
(...) \

331 
´š‹d_out
 = 
	`¢´štf
(
pb
, 
max_ch¬s
, 
__VA_ARGS__
); \

332 ià(
´š‹d_out
 <= 0) { \

333 
	`D
("... snprintf failed.\n"); \

336 ià(
max_ch¬s
 < ()
´š‹d_out
) { \

337 
	`D
("... snprintf out of space.\n"); \

340 
pb
 +ğ
´š‹d_out
; \

341 
max_ch¬s
 -ğ
´š‹d_out
; \

342 } 0)

	)

344 
i
 = 0; i < 
£Ëù_n
; i++) {

345 
fde
 = 
fd_bË
[
i
];

346 
	`SAFE_SPRINTF
("%d", 
i
);

347 if(
fde
 == 0) {

348 
	`SAFE_SPRINTF
("? ");

351 if(
	`fú
(
i
, 
F_GETFL
, 
NULL
) < 0) {

352 
	`SAFE_SPRINTF
("b");

354 
	`SAFE_SPRINTF
(" ");

356 
	`D
("% fd_bË[]->fd = {%s}\n", 
exŒa_msg
, 
msg_buff
);

357 
	}
}

360 
	$fdev’t_´oûss
()

362 
i
, 
n
;

363 
fdev’t
 *
fde
;

364 
ev’ts
;

365 
fd_£t
 
rfd
, 
wfd
, 
efd
;

367 
	`memıy
(&
rfd
, &
»ad_fds
, (
fd_£t
));

368 
	`memıy
(&
wfd
, &
wr™e_fds
, (
fd_£t
));

369 
	`memıy
(&
efd
, &
”rÜ_fds
, (
fd_£t
));

371 
	`dump_®l_fds
("pre select()");

373 
n
 = 
	`£Ëù
(
£Ëù_n
, &
rfd
, &
wfd
, &
efd
, 
NULL
);

374 
§ved_”ºo
 = 
”ºo
;

375 
	`D
("£Ëù(è»tuºed‚=%d,ƒ¼no=%d\n", 
n
,‚<0?
§ved_”ºo
:0);

377 
	`dump_®l_fds
("post select()");

379 if(
n
 < 0) {

380 
§ved_”ºo
) {

381 
EINTR
: ;

382 
EBADF
:

384 
	`FD_ZERO
(&
wfd
);

385 
	`FD_ZERO
(&
efd
);

386 
	`FD_ZERO
(&
rfd
);

389 
	`D
("UÃx³ùed s–eù(è”rÜ=%d\n", 
§ved_”ºo
);

393 if(
n
 <= 0) {

396 
n
 = 
	`fdev’t_fd_check
(&
rfd
);

399 
i
 = 0; (˜< 
£Ëù_n
è&& (
n
 > 0); i++) {

400 
ev’ts
 = 0;

401 if(
	`FD_ISSET
(
i
, &
rfd
)è{ 
ev’ts
 |ğ
FDE_READ
; 
n
--; }

402 if(
	`FD_ISSET
(
i
, &
wfd
)è{ 
ev’ts
 |ğ
FDE_WRITE
; 
n
--; }

403 if(
	`FD_ISSET
(
i
, &
efd
)è{ 
ev’ts
 |ğ
FDE_ERROR
; 
n
--; }

405 if(
ev’ts
) {

406 
fde
 = 
fd_bË
[
i
];

407 if(
fde
 == 0)

408 
	`FATAL
("missšg fdfÜ fd %d\n", 
i
);

410 
fde
->
ev’ts
 |=ƒvents;

412 
	`D
("gotƒvents fde->fd=%dƒvents=%04x, state=%04x\n",

413 
fde
->
fd
, fde->
ev’ts
, fde->
¡©e
);

414 if(
fde
->
¡©e
 & 
FDE_PENDING
) ;

415 
fde
->
¡©e
 |ğ
FDE_PENDING
;

416 
	`fdev’t_¶i¡_’queue
(
fde
);

419 
	}
}

423 
	$fdev’t_»gi¡”
(
fdev’t
 *
fde
)

425 if(
fde
->
fd
 < 0) {

426 
	`FATAL
("bogu Ãg©ivfd (%d)\n", 
fde
->
fd
);

429 if(
fde
->
fd
 >ğ
fd_bË_max
) {

430 
Şdmax
 = 
fd_bË_max
;

431 if(
fde
->
fd
 > 32000) {

432 
	`FATAL
("bogu huuuugfd (%d)\n", 
fde
->
fd
);

434 if(
fd_bË_max
 == 0) {

435 
	`fdev’t_š™
();

436 
fd_bË_max
 = 256;

438 
fd_bË_max
 <ğ
fde
->
fd
) {

439 
fd_bË_max
 *= 2;

441 
fd_bË
 = 
»š‹½»t_ÿ¡
<
fdev’t
**>(

442 
	`»®loc
(
fd_bË
, (
fdev’t
*è* 
fd_bË_max
));

443 if(
fd_bË
 == 0) {

444 
	`FATAL
("could‚Ùƒx·nd fd_bËØ%dƒÁr›s\n", 
fd_bË_max
);

446 
	`mem£t
(
fd_bË
 + 
Şdmax
, 0, (è* (
fd_bË_max
 - oldmax));

449 
fd_bË
[
fde
->
fd
] = fde;

450 
	}
}

452 
	$fdev’t_uÄegi¡”
(
fdev’t
 *
fde
)

454 if((
fde
->
fd
 < 0è|| (fde->fd >ğ
fd_bË_max
)) {

455 
	`FATAL
("fd ouˆoà¿ng(%d)\n", 
fde
->
fd
);

458 if(
fd_bË
[
fde
->
fd
] != fde) {

459 
	`FATAL
("fd_bË ouˆoàsynø[%d]\n", 
fde
->
fd
);

462 
fd_bË
[
fde
->
fd
] = 0;

464 if(!(
fde
->
¡©e
 & 
FDE_DONT_CLOSE
)) {

465 
	`dump_fde
(
fde
, "close");

466 
	`adb_şo£
(
fde
->
fd
);

468 
	}
}

470 
	$fdev’t_¶i¡_’queue
(
fdev’t
 *
node
)

472 
fdev’t
 *
li¡
 = &
li¡_³ndšg
;

474 
node
->
Ãxt
 = 
li¡
;

475 
node
->
´ev
 = 
li¡
->prev;

476 
node
->
´ev
->
Ãxt
 =‚ode;

477 
li¡
->
´ev
 = 
node
;

478 
	}
}

480 
	$fdev’t_¶i¡_»move
(
fdev’t
 *
node
)

482 
node
->
´ev
->
Ãxt
 =‚ode->next;

483 
node
->
Ãxt
->
´ev
 =‚ode->prev;

484 
node
->
Ãxt
 = 0;

485 
node
->
´ev
 = 0;

486 
	}
}

488 
fdev’t
 *
	$fdev’t_¶i¡_dequeue
()

490 
fdev’t
 *
li¡
 = &
li¡_³ndšg
;

491 
fdev’t
 *
node
 = 
li¡
->
Ãxt
;

493 if(
node
 =ğ
li¡
)  0;

495 
li¡
->
Ãxt
 = 
node
->next;

496 
li¡
->
Ãxt
->
´ev
 =†ist;

497 
node
->
Ãxt
 = 0;

498 
node
->
´ev
 = 0;

500  
node
;

501 
	}
}

503 
	$fdev’t_ÿÎ_fdfunc
(
fdev’t
* 
fde
)

505 
ev’ts
 = 
fde
->events;

506 
fde
->
ev’ts
 = 0;

507 if(!(
fde
->
¡©e
 & 
FDE_PENDING
)) ;

508 
fde
->
¡©e
 &ğ(~
FDE_PENDING
);

509 
	`dump_fde
(
fde
, "callback");

510 
fde
->
	`func
(fde->
fd
, 
ev’ts
, fde->
¬g
);

511 
	}
}

513 
	$fdev’t_sub´oc_ev’t_func
(
fd
, 
ev
,

517 
	`D
("sub´oøhªdlšg oÀfd=%dƒv=%04x\n", 
fd
, 
ev
);

520 if((
fd
 < 0è|| (fd >ğ
fd_bË_max
)) {

521 
	`FATAL
("fd %d ouˆoà¿ngfÜ fd_bË \n", 
fd
);

523 
fdev’t
 *
fde
 = 
fd_bË
[
fd
];

524 
	`fdev’t_add
(
fde
, 
FDE_READ
);

526 if(
ev
 & 
FDE_READ
){

527 
sub´oc_fd
;

529 if(!
	`R—dFdExaùly
(
fd
, &
sub´oc_fd
, (subproc_fd))) {

530 
	`FATAL
("FaedØ»adhsub´oc' fd from fd=%d\n", 
fd
);

532 if((
sub´oc_fd
 < 0è|| (sub´oc_fd >ğ
fd_bË_max
)) {

533 
	`D
("subproc_fd %d out of„ange 0, fd_table_max=%d\n",

534 
sub´oc_fd
, 
fd_bË_max
);

537 
fdev’t
 *
sub´oc_fde
 = 
fd_bË
[
sub´oc_fd
];

538 if(!
sub´oc_fde
) {

539 
	`D
("sub´oc_fd %d cË¬ed from fd_bË\n", 
sub´oc_fd
);

542 if(
sub´oc_fde
->
fd
 !ğ
sub´oc_fd
) {

544 
	`D
("sub´oc_fd %d !ğfd_bË[].fd %d\n", 
sub´oc_fd
, 
sub´oc_fde
->
fd
);

548 
sub´oc_fde
->
fÜû_eof
 = 1;

550 
rcouÁ
 = 0;

551 
	`ioùl
(
sub´oc_fd
, 
FIONREAD
, &
rcouÁ
);

552 
	`D
("subproc with fd=%d has„count=%dƒrr=%d\n",

553 
sub´oc_fd
, 
rcouÁ
, 
”ºo
);

555 if(
rcouÁ
) {

562 
	`D
("sub´oc_fde.¡©e=%04x\n", 
sub´oc_fde
->
¡©e
);

563 
sub´oc_fde
->
ev’ts
 |ğ
FDE_READ
;

564 if(
sub´oc_fde
->
¡©e
 & 
FDE_PENDING
) {

567 
sub´oc_fde
->
¡©e
 |ğ
FDE_PENDING
;

568 
	`fdev’t_ÿÎ_fdfunc
(
sub´oc_fde
);

570 
	}
}

572 
fdev’t
 *
	$fdev’t_ü—‹
(
fd
, 
fd_func
 
func
, *
¬g
)

574 
fdev’t
 *
fde
 = (fdev’t*è
	`m®loc
((fdevent));

575 if(
fde
 == 0)  0;

576 
	`fdev’t_š¡®l
(
fde
, 
fd
, 
func
, 
¬g
);

577 
fde
->
¡©e
 |ğ
FDE_CREATED
;

578  
fde
;

579 
	}
}

581 
	$fdev’t_de¡roy
(
fdev’t
 *
fde
)

583 if(
fde
 == 0) ;

584 if(!(
fde
->
¡©e
 & 
FDE_CREATED
)) {

585 
	`FATAL
("fd%°nÙ c»©ed by fdev’t_ü—‹()\n", 
fde
);

587 
	`fdev’t_»move
(
fde
);

588 
	`ä“
(
fde
);

589 
	}
}

591 
	$fdev’t_š¡®l
(
fdev’t
 *
fde
, 
fd
, 
fd_func
 
func
, *
¬g
)

593 
	`mem£t
(
fde
, 0, (
fdev’t
));

594 
fde
->
¡©e
 = 
FDE_ACTIVE
;

595 
fde
->
fd
 = fd;

596 
fde
->
fÜû_eof
 = 0;

597 
fde
->
func
 = func;

598 
fde
->
¬g
 =‡rg;

600 #iâdeà
HAVE_WINSOCK


601 
	`fú
(
fd
, 
F_SETFL
, 
O_NONBLOCK
);

603 
	`fdev’t_»gi¡”
(
fde
);

604 
	`dump_fde
(
fde
, "connect");

605 
	`fdev’t_cÚÃù
(
fde
);

606 
fde
->
¡©e
 |ğ
FDE_ACTIVE
;

607 
	}
}

609 
	$fdev’t_»move
(
fdev’t
 *
fde
)

611 if(
fde
->
¡©e
 & 
FDE_PENDING
) {

612 
	`fdev’t_¶i¡_»move
(
fde
);

615 if(
fde
->
¡©e
 & 
FDE_ACTIVE
) {

616 
	`fdev’t_discÚÃù
(
fde
);

617 
	`dump_fde
(
fde
, "disconnect");

618 
	`fdev’t_uÄegi¡”
(
fde
);

621 
fde
->
¡©e
 = 0;

622 
fde
->
ev’ts
 = 0;

623 
	}
}

626 
	$fdev’t_£t
(
fdev’t
 *
fde
, 
ev’ts
)

628 
ev’ts
 &ğ
FDE_EVENTMASK
;

630 if((
fde
->
¡©e
 & 
FDE_EVENTMASK
è=ğ
ev’ts
) ;

632 if(
fde
->
¡©e
 & 
FDE_ACTIVE
) {

633 
	`fdev’t_upd©e
(
fde
, 
ev’ts
);

634 
	`dump_fde
(
fde
, "update");

637 
fde
->
¡©e
 = (fde->¡©& 
FDE_STATEMASK
è| 
ev’ts
;

639 if(
fde
->
¡©e
 & 
FDE_PENDING
) {

644 
fde
->
ev’ts
 &= (~events);

645 if(
fde
->
ev’ts
 == 0) {

646 
	`fdev’t_¶i¡_»move
(
fde
);

647 
fde
->
¡©e
 &ğ(~
FDE_PENDING
);

650 
	}
}

652 
	$fdev’t_add
(
fdev’t
 *
fde
, 
ev’ts
)

654 
	`fdev’t_£t
(

655 
fde
, (fde->
¡©e
 & 
FDE_EVENTMASK
è| (
ev’ts
 & FDE_EVENTMASK));

656 
	}
}

658 
	$fdev’t_d–
(
fdev’t
 *
fde
, 
ev’ts
)

660 
	`fdev’t_£t
(

661 
fde
, (fde->
¡©e
 & 
FDE_EVENTMASK
è& (~(
ev’ts
 & FDE_EVENTMASK)));

662 
	}
}

664 
	$fdev’t_sub´oc_£tup
()

666 
s
[2];

668 if(
	`adb_sock‘·œ
(
s
)) {

669 
	`FATAL
("cannot create shell-exit socket-pair\n");

671 
	`D
("sock‘·œ: (%d,%d)", 
s
[0], s[1]);

673 
SHELL_EXIT_NOTIFY_FD
 = 
s
[0];

674 
fdev’t
 *
fde
;

675 
fde
 = 
	`fdev’t_ü—‹
(
s
[1], 
fdev’t_sub´oc_ev’t_func
, 
NULL
);

676 if(!
fde
)

677 
	`FATAL
("cannot create fdevent for shell-exit handler\n");

678 
	`fdev’t_add
(
fde
, 
FDE_READ
);

679 
	}
}

681 
	$fdev’t_loİ
()

683 
fdev’t
 *
fde
;

684 
	`fdev’t_sub´oc_£tup
();

687 
	`D
("--- ---- waiting forƒvents\n");

689 
	`fdev’t_´oûss
();

691 (
fde
 = 
	`fdev’t_¶i¡_dequeue
())) {

692 
	`fdev’t_ÿÎ_fdfunc
(
fde
);

695 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/fdevent.h

17 #iâdeà
__FDEVENT_H


18 
	#__FDEVENT_H


	)

20 
	~<¡dšt.h
>

23 
	#FDE_READ
 0x0001

	)

24 
	#FDE_WRITE
 0x0002

	)

25 
	#FDE_ERROR
 0x0004

	)

26 
	#FDE_TIMEOUT
 0x0008

	)

29 
	#FDE_DONT_CLOSE
 0x0080

	)

31 
	gfdev’t
;

33 (*
	tfd_func
)(
	tfd
, 
	tev’ts
, *
	tu£rd©a
);

39 
fdev’t
 *
	`fdev’t_ü—‹
(
fd
, 
fd_func
 
func
, *
¬g
);

44 
	`fdev’t_de¡roy
(
fdev’t
 *
fde
);

48 
	`fdev’t_š¡®l
(
fdev’t
 *
fde
, 
fd
, 
fd_func
 
func
, *
¬g
);

53 
	`fdev’t_»move
(
fdev’t
 *
™em
);

57 
	`fdev’t_£t
(
fdev’t
 *
fde
, 
ev’ts
);

58 
	`fdev’t_add
(
fdev’t
 *
fde
, 
ev’ts
);

59 
	`fdev’t_d–
(
fdev’t
 *
fde
, 
ev’ts
);

61 
	`fdev’t_£t_timeout
(
fdev’t
 *
fde
, 
št64_t
 
timeout_ms
);

65 
	`fdev’t_loİ
();

67 
	sfdev’t
 {

68 
fdev’t
 *
Ãxt
;

69 
fdev’t
 *
´ev
;

71 
fd
;

72 
fÜû_eof
;

74 
ušt16_t
 
¡©e
;

75 
ušt16_t
 
ev’ts
;

77 
fd_func
 
func
;

78 *
¬g
;

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/file_sync_client.cpp

17 
	~<dœ’t.h
>

18 
	~<”ºo.h
>

19 
	~<lim™s.h
>

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<sys/¡©.h
>

24 
	~<sys/time.h
>

25 
	~<sys/ty³s.h
>

26 
	~<time.h
>

27 
	~<utime.h
>

29 
	~"sysd•s.h
"

31 
	~"adb.h
"

32 
	~"adb_ş›Á.h
"

33 
	~"adb_io.h
"

34 
	~"fe_sync_£rviû.h
"

36 
	gtÙ®_by‹s
;

37 
	g¡¬t_time
;

39 
	$NOW
()

41 
timev®
 
tv
;

42 
	`g‘timeofday
(&
tv
, 0);

43  ((è
tv
.
tv_u£c
) +

44 1000000LL * ((è
tv
.
tv_£c
);

45 
	}
}

47 
	$BEGIN
()

49 
tÙ®_by‹s
 = 0;

50 
¡¬t_time
 = 
	`NOW
();

51 
	}
}

53 
	$END
()

55 
t
 = 
	`NOW
(è- 
¡¬t_time
;

56 if(
tÙ®_by‹s
 == 0) ;

58 ià(
t
 == 0)

59 
t
 = 1000000;

61 
	`årštf
(
¡d”r
,"%lld KB/s (%lld bytes in %lld.%03llds)\n",

62 ((
tÙ®_by‹s
 * 1000000LLè/ 
t
) / 1024LL,

63 
tÙ®_by‹s
, (
t
 / 1000000LL), (t % 1000000LL) / 1000LL);

64 
	}
}

66 cÚ¡ * 
	gŒªsãr_´og»ss_fÜm©
 = "\rTransferring: %llu/%llu (%d%%)";

68 
	$´št_Œªsãr_´og»ss
(
by‹s_cu¼’t
,

69 
by‹s_tÙ®
) {

70 ià(
by‹s_tÙ®
 == 0) ;

72 
	`årštf
(
¡d”r
, 
Œªsãr_´og»ss_fÜm©
, 
by‹s_cu¼’t
, 
by‹s_tÙ®
,

73 (è(
by‹s_cu¼’t
 * 100 / 
by‹s_tÙ®
));

75 ià(
by‹s_cu¼’t
 =ğ
by‹s_tÙ®
) {

76 
	`åutc
('\n', 
¡d”r
);

79 
	`fæush
(
¡d”r
);

80 
	}
}

82 
	$sync_qu™
(
fd
)

84 
syncmsg
 
msg
;

86 
msg
.
»q
.
id
 = 
ID_QUIT
;

87 
msg
.
»q
.
Çm–’
 = 0;

89 
	`Wr™eFdExaùly
(
fd
, &
msg
.
»q
, (msg.req));

90 
	}
}

92 (*
	tsync_ls_cb
)(
	tmode
, 
	tsize
, 
	ttime
, cÚ¡ *
	tÇme
, *
	tcook›
);

94 
	$sync_ls
(
fd
, cÚ¡ *
·th
, 
sync_ls_cb
 
func
, *
cook›
)

96 
syncmsg
 
msg
;

97 
buf
[257];

98 
Ën
;

100 
Ën
 = 
	`¡¾’
(
·th
);

101 if(
Ën
 > 1024è
ç
;

103 
msg
.
»q
.
id
 = 
ID_LIST
;

104 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
);

106 if(!
	`Wr™eFdExaùly
(
fd
, &
msg
.
»q
, (msg.req)) ||

107 !
	`Wr™eFdExaùly
(
fd
, 
·th
, 
Ën
)) {

108 
ç
;

112 if(!
	`R—dFdExaùly
(
fd
, &
msg
.
d’t
, (msg.dent))) ;

113 if(
msg
.
d’t
.
id
 =ğ
ID_DONE
)  0;

114 if(
msg
.
d’t
.
id
 !ğ
ID_DENT
) ;

116 
Ën
 = 
	`Éohl
(
msg
.
d’t
.
Çm–’
);

117 if(
Ën
 > 256) ;

119 if(!
	`R—dFdExaùly
(
fd
, 
buf
, 
Ën
)) ;

120 
buf
[
Ën
] = 0;

122 
	`func
(
	`Éohl
(
msg
.
d’t
.
mode
),

123 
	`Éohl
(
msg
.
d’t
.
size
),

124 
	`Éohl
(
msg
.
d’t
.
time
),

125 
buf
, 
cook›
);

128 
ç
:

129 
	`adb_şo£
(
fd
);

131 
	}
}

133 
	ssync£ndbuf
 {

134 
	mid
;

135 
	msize
;

136 
	md©a
[
SYNC_DATA_MAX
];

139 
sync£ndbuf
 
	g£nd_bufãr
;

141 
	$sync_»adtime
(
fd
, cÚ¡ *
·th
, *
time¡amp
,

142 *
mode
)

144 
syncmsg
 
msg
;

145 
Ën
 = 
	`¡¾’
(
·th
);

147 
msg
.
»q
.
id
 = 
ID_STAT
;

148 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
);

150 if(!
	`Wr™eFdExaùly
(
fd
, &
msg
.
»q
, (msg.req)) ||

151 !
	`Wr™eFdExaùly
(
fd
, 
·th
, 
Ën
)) {

155 if(!
	`R—dFdExaùly
(
fd
, &
msg
.
¡©
, (msg.stat))) {

159 if(
msg
.
¡©
.
id
 !ğ
ID_STAT
) {

163 *
time¡amp
 = 
	`Éohl
(
msg
.
¡©
.
time
);

164 *
mode
 = 
	`Éohl
(
msg
.
¡©
.mode);

166 
	}
}

168 
	$sync_¡¬t_»adtime
(
fd
, cÚ¡ *
·th
)

170 
syncmsg
 
msg
;

171 
Ën
 = 
	`¡¾’
(
·th
);

173 
msg
.
»q
.
id
 = 
ID_STAT
;

174 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
);

176 if(!
	`Wr™eFdExaùly
(
fd
, &
msg
.
»q
, (msg.req)) ||

177 !
	`Wr™eFdExaùly
(
fd
, 
·th
, 
Ën
)) {

182 
	}
}

184 
	$sync_fšish_»adtime
(
fd
, *
time¡amp
,

185 *
mode
, *
size
)

187 
syncmsg
 
msg
;

189 if(!
	`R—dFdExaùly
(
fd
, &
msg
.
¡©
, (msg.stat)))

192 if(
msg
.
¡©
.
id
 !ğ
ID_STAT
)

195 *
time¡amp
 = 
	`Éohl
(
msg
.
¡©
.
time
);

196 *
mode
 = 
	`Éohl
(
msg
.
¡©
.mode);

197 *
size
 = 
	`Éohl
(
msg
.
¡©
.size);

200 
	}
}

202 
	$sync_»admode
(
fd
, cÚ¡ *
·th
, *
mode
)

204 
syncmsg
 
msg
;

205 
Ën
 = 
	`¡¾’
(
·th
);

207 
msg
.
»q
.
id
 = 
ID_STAT
;

208 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
);

210 if(!
	`Wr™eFdExaùly
(
fd
, &
msg
.
»q
, (msg.req)) ||

211 !
	`Wr™eFdExaùly
(
fd
, 
·th
, 
Ën
)) {

215 if(!
	`R—dFdExaùly
(
fd
, &
msg
.
¡©
, (msg.stat))) {

219 if(
msg
.
¡©
.
id
 !ğ
ID_STAT
) {

223 *
mode
 = 
	`Éohl
(
msg
.
¡©
.mode);

225 
	}
}

227 
	$wr™e_d©a_fe
(
fd
, cÚ¡ *
·th
, 
sync£ndbuf
 *
sbuf
, 
show_´og»ss
)

229 
lfd
, 
”r
 = 0;

230 
size
 = 0;

232 
lfd
 = 
	`adb_İ’
(
·th
, 
O_RDONLY
);

233 if(
lfd
 < 0) {

234 
	`årštf
(
¡d”r
,"ÿÂÙ o³À'%s': %s\n", 
·th
, 
	`¡»¼Ü
(
”ºo
));

238 ià(
show_´og»ss
) {

240 
¡©
 
¡
;

241 ià(
	`¡©
(
·th
, &
¡
)) {

242 
	`årštf
(
¡d”r
,"ÿÂÙ sˆ'%s': %s\n", 
·th
, 
	`¡»¼Ü
(
”ºo
));

246 
size
 = 
¡
.
¡_size
;

249 
sbuf
->
id
 = 
ID_DATA
;

251 
»t
;

253 
»t
 = 
	`adb_»ad
(
lfd
, 
sbuf
->
d©a
, 
SYNC_DATA_MAX
);

254 if(!
»t
)

257 if(
»t
 < 0) {

258 if(
”ºo
 =ğ
EINTR
)

260 
	`årštf
(
¡d”r
,"ÿÂÙ„—d '%s': %s\n", 
·th
, 
	`¡»¼Ü
(
”ºo
));

264 
sbuf
->
size
 = 
	`htŞl
(
»t
);

265 if(!
	`Wr™eFdExaùly
(
fd
, 
sbuf
, (è* 2 + 
»t
)){

266 
”r
 = -1;

269 
tÙ®_by‹s
 +ğ
»t
;

271 ià(
show_´og»ss
) {

272 
	`´št_Œªsãr_´og»ss
(
tÙ®_by‹s
, 
size
);

276 
	`adb_şo£
(
lfd
);

277  
”r
;

278 
	}
}

280 
	$wr™e_d©a_bufãr
(
fd
, * 
fe_bufãr
, 
size
, 
sync£ndbuf
 *
sbuf
,

281 
show_´og»ss
)

283 
”r
 = 0;

284 
tÙ®
 = 0;

286 
sbuf
->
id
 = 
ID_DATA
;

287 
tÙ®
 < 
size
) {

288 
couÁ
 = 
size
 - 
tÙ®
;

289 ià(
couÁ
 > 
SYNC_DATA_MAX
) {

290 
couÁ
 = 
SYNC_DATA_MAX
;

293 
	`memıy
(
sbuf
->
d©a
, &
fe_bufãr
[
tÙ®
], 
couÁ
);

294 
sbuf
->
size
 = 
	`htŞl
(
couÁ
);

295 if(!
	`Wr™eFdExaùly
(
fd
, 
sbuf
, (è* 2 + 
couÁ
)){

296 
”r
 = -1;

299 
tÙ®
 +ğ
couÁ
;

300 
tÙ®_by‹s
 +ğ
couÁ
;

302 ià(
show_´og»ss
) {

303 
	`´št_Œªsãr_´og»ss
(
tÙ®
, 
size
);

307  
”r
;

308 
	}
}

310 #ià
defšed
(
_WIN32
)

311 
	$wr™e_d©a_lšk
(
fd
, cÚ¡ *
·th
, 
sync£ndbuf
 *
sbuf
è
	`__©Œibu‹__
((
	`”rÜ
("no symlinks on Windows")));

313 
	$wr™e_d©a_lšk
(
fd
, cÚ¡ *
·th
, 
sync£ndbuf
 *
sbuf
)

315 
Ën
, 
»t
;

317 
Ën
 = 
	`»adlšk
(
·th
, 
sbuf
->
d©a
, 
SYNC_DATA_MAX
-1);

318 if(
Ën
 < 0) {

319 
	`årštf
(
¡d”r
, "”rÜ„—dšg†šk '%s': %s\n", 
·th
, 
	`¡»¼Ü
(
”ºo
));

322 
sbuf
->
d©a
[
Ën
] = '\0';

324 
sbuf
->
size
 = 
	`htŞl
(
Ën
 + 1);

325 
sbuf
->
id
 = 
ID_DATA
;

327 
»t
 = !
	`Wr™eFdExaùly
(
fd
, 
sbuf
, (è* 2 + 
Ën
 + 1);

328 if(
»t
)

331 
tÙ®_by‹s
 +ğ
Ën
 + 1;

334 
	}
}

337 
	$sync_£nd
(
fd
, cÚ¡ *
Í©h
, cÚ¡ *
½©h
,

338 
mtime
, 
mode_t
 
mode
, 
show_´og»ss
)

340 
syncmsg
 
msg
;

341 
Ën
, 
r
;

342 
sync£ndbuf
 *
sbuf
 = &
£nd_bufãr
;

343 * 
fe_bufãr
 = 
NULL
;

344 
size
 = 0;

345 
tmp
[64];

347 
Ën
 = 
	`¡¾’
(
½©h
);

348 if(
Ën
 > 1024è
ç
;

350 
	`¢´štf
(
tmp
, Ñmp), ",%d", 
mode
);

351 
r
 = 
	`¡¾’
(
tmp
);

353 
msg
.
»q
.
id
 = 
ID_SEND
;

354 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
 + 
r
);

356 if(!
	`Wr™eFdExaùly
(
fd
, &
msg
.
»q
, (msg.req)) ||

357 !
	`Wr™eFdExaùly
(
fd
, 
½©h
, 
Ën
è|| !Wr™eFdExaùly(fd, 
tmp
, 
r
)) {

358 
	`ä“
(
fe_bufãr
);

359 
ç
;

362 ià(
fe_bufãr
) {

363 
	`wr™e_d©a_bufãr
(
fd
, 
fe_bufãr
, 
size
, 
sbuf
, 
show_´og»ss
);

364 
	`ä“
(
fe_bufãr
);

365 } ià(
	`S_ISREG
(
mode
))

366 
	`wr™e_d©a_fe
(
fd
, 
Í©h
, 
sbuf
, 
show_´og»ss
);

367 ià(
	`S_ISLNK
(
mode
))

368 
	`wr™e_d©a_lšk
(
fd
, 
Í©h
, 
sbuf
);

370 
ç
;

372 
msg
.
d©a
.
id
 = 
ID_DONE
;

373 
msg
.
d©a
.
size
 = 
	`htŞl
(
mtime
);

374 if(!
	`Wr™eFdExaùly
(
fd
, &
msg
.
d©a
, (msg.data)))

375 
ç
;

377 if(!
	`R—dFdExaùly
(
fd
, &
msg
.
¡©us
, (msg.status)))

380 if(
msg
.
¡©us
.
id
 !ğ
ID_OKAY
) {

381 if(
msg
.
¡©us
.
id
 =ğ
ID_FAIL
) {

382 
Ën
 = 
	`Éohl
(
msg
.
¡©us
.
msgËn
);

383 if(
Ën
 > 256)†en = 256;

384 if(!
	`R—dFdExaùly
(
fd
, 
sbuf
->
d©a
, 
Ën
)) {

387 
sbuf
->
d©a
[
Ën
] = 0;

389 
	`¡rıy
(
sbuf
->
d©a
, "unknown„eason");

391 
	`årštf
(
¡d”r
,"çedØcİy '%s'Ø'%s': %s\n", 
Í©h
, 
½©h
, 
sbuf
->
d©a
);

397 
ç
:

398 
	`årštf
(
¡d”r
,"protocol failure\n");

399 
	`adb_şo£
(
fd
);

401 
	}
}

403 
	$mkdœs
(cÚ¡ *
Çme
)

405 
»t
;

406 *
x
 = (*)
Çme
 + 1;

409 
x
 = 
	`adb_dœ¡¬t
(x);

410 if(
x
 == 0)  0;

411 *
x
 = 0;

412 
»t
 = 
	`adb_mkdœ
(
Çme
, 0775);

413 *
x
 = 
OS_PATH_SEPARATOR
;

414 if((
»t
 < 0è&& (
”ºo
 !ğ
EEXIST
)) {

415  
»t
;

417 
x
++;

420 
	}
}

422 
	$sync_»cv
(
fd
, cÚ¡ *
½©h
, cÚ¡ *
Í©h
, 
show_´og»ss
)

424 
syncmsg
 
msg
;

425 
Ën
;

426 
lfd
 = -1;

427 *
bufãr
 = 
£nd_bufãr
.
d©a
;

428 
id
;

429 
size
 = 0;

431 
Ën
 = 
	`¡¾’
(
½©h
);

432 if(
Ën
 > 1024)  -1;

434 ià(
show_´og»ss
) {

436 
syncmsg
 
¡©_msg
;

437 
¡©_msg
.
»q
.
id
 = 
ID_STAT
;

438 
¡©_msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
);

440 ià(!
	`Wr™eFdExaùly
(
fd
, &
¡©_msg
.
»q
, (stat_msg.req)) ||

441 !
	`Wr™eFdExaùly
(
fd
, 
½©h
, 
Ën
)) {

445 ià(!
	`R—dFdExaùly
(
fd
, &
¡©_msg
.
¡©
, (stat_msg.stat))) {

449 ià(
¡©_msg
.
¡©
.
id
 !ğ
ID_STAT
)  -1;

451 
size
 = 
	`Éohl
(
¡©_msg
.
¡©
.size);

454 
msg
.
»q
.
id
 = 
ID_RECV
;

455 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
);

456 if(!
	`Wr™eFdExaùly
(
fd
, &
msg
.
»q
, (msg.req)) ||

457 !
	`Wr™eFdExaùly
(
fd
, 
½©h
, 
Ën
)) {

461 if(!
	`R—dFdExaùly
(
fd
, &
msg
.
d©a
, (msg.data))) {

464 
id
 = 
msg
.
d©a
.id;

466 if((
id
 =ğ
ID_DATA
è|| (id =ğ
ID_DONE
)) {

467 
	`adb_uÆšk
(
Í©h
);

468 
	`mkdœs
(
Í©h
);

469 
lfd
 = 
	`adb_ü—t
(
Í©h
, 0644);

470 if(
lfd
 < 0) {

471 
	`årštf
(
¡d”r
,"ÿÂÙ c»©'%s': %s\n", 
Í©h
, 
	`¡»¼Ü
(
”ºo
));

474 
hªdË_d©a
;

476 
»mÙe_”rÜ
;

480 if(!
	`R—dFdExaùly
(
fd
, &
msg
.
d©a
, (msg.data))) {

483 
id
 = 
msg
.
d©a
.id;

485 
hªdË_d©a
:

486 
Ën
 = 
	`Éohl
(
msg
.
d©a
.
size
);

487 if(
id
 =ğ
ID_DONE
) ;

488 if(
id
 !ğ
ID_DATA
è
»mÙe_”rÜ
;

489 if(
Ën
 > 
SYNC_DATA_MAX
) {

490 
	`årštf
(
¡d”r
,"data overrun\n");

491 
	`adb_şo£
(
lfd
);

495 if(!
	`R—dFdExaùly
(
fd
, 
bufãr
, 
Ën
)) {

496 
	`adb_şo£
(
lfd
);

500 if(!
	`Wr™eFdExaùly
(
lfd
, 
bufãr
, 
Ën
)) {

501 
	`årštf
(
¡d”r
,"ÿÂÙ wr™'%s': %s\n", 
½©h
, 
	`¡»¼Ü
(
”ºo
));

502 
	`adb_şo£
(
lfd
);

506 
tÙ®_by‹s
 +ğ
Ën
;

508 ià(
show_´og»ss
) {

509 
	`´št_Œªsãr_´og»ss
(
tÙ®_by‹s
, 
size
);

513 
	`adb_şo£
(
lfd
);

516 
»mÙe_”rÜ
:

517 
	`adb_şo£
(
lfd
);

518 
	`adb_uÆšk
(
Í©h
);

520 if(
id
 =ğ
ID_FAIL
) {

521 
Ën
 = 
	`Éohl
(
msg
.
d©a
.
size
);

522 if(
Ën
 > 256)†en = 256;

523 if(!
	`R—dFdExaùly
(
fd
, 
bufãr
, 
Ën
)) {

526 
bufãr
[
Ën
] = 0;

528 
	`memıy
(
bufãr
, &
id
, 4);

529 
bufãr
[4] = 0;

531 
	`årštf
(
¡d”r
,"çedØcİy '%s'Ø'%s': %s\n", 
½©h
, 
Í©h
, 
bufãr
);

533 
	}
}

536 
	$do_sync_ls_cb
(
mode
, 
size
, 
time
,

537 cÚ¡ *
Çme
, *
cook›
)

539 
	`´štf
("%08x %08x %08x %s\n", 
mode
, 
size
, 
time
, 
Çme
);

540 
	}
}

542 
	$do_sync_ls
(cÚ¡ * 
·th
) {

543 
¡d
::
¡ršg
 
”rÜ
;

544 
fd
 = 
	`adb_cÚÃù
("sync:", &
”rÜ
);

545 ià(
fd
 < 0) {

546 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

550 if(
	`sync_ls
(
fd
, 
·th
, 
do_sync_ls_cb
, 0)) {

553 
	`sync_qu™
(
fd
);

556 
	}
}

558 
	scİyšfo


560 
cİyšfo
 *
	mÃxt
;

561 cÚ¡ *
	m¤c
;

562 cÚ¡ *
	md¡
;

563 
	mtime
;

564 
	mmode
;

565 
	msize
;

566 
	mæag
;

569 
cİyšfo
 *
	$mkcİyšfo
(cÚ¡ *
¥©h
, cÚ¡ *
d·th
,

570 cÚ¡ *
Çme
, 
isdœ
)

572 
¦’
 = 
	`¡¾’
(
¥©h
);

573 
dËn
 = 
	`¡¾’
(
d·th
);

574 
Æ’
 = 
	`¡¾’
(
Çme
);

575 
ssize
 = 
¦’
 + 
Æ’
 + 2;

576 
dsize
 = 
dËn
 + 
Æ’
 + 2;

578 
cİyšfo
 *
ci
 = 
»š‹½»t_ÿ¡
<copyinfo*>(

579 
	`m®loc
((
cİyšfo
è+ 
ssize
 + 
dsize
));

580 if(
ci
 == 0) {

581 
	`årštf
(
¡d”r
,"out of memory\n");

582 
	`abÜt
();

585 
ci
->
Ãxt
 = 0;

586 
ci
->
time
 = 0;

587 
ci
->
mode
 = 0;

588 
ci
->
size
 = 0;

589 
ci
->
æag
 = 0;

590 
ci
->
¤c
 = (const *)(ci + 1);

591 
ci
->
d¡
 = ci->
¤c
 + 
ssize
;

592 
	`¢´štf
((*è
ci
->
¤c
, 
ssize
, 
isdœ
 ? "%s%s/" : "%s%s", 
¥©h
, 
Çme
);

593 
	`¢´štf
((*è
ci
->
d¡
, 
dsize
, 
isdœ
 ? "%s%s/" : "%s%s", 
d·th
, 
Çme
);

595  
ci
;

596 
	}
}

599 
	$loÿl_bud_li¡
(
cİyšfo
 **
f–i¡
,

600 cÚ¡ *
Í©h
, cÚ¡ *
½©h
)

602 
DIR
 *
d
;

603 
dœ’t
 *
de
;

604 
¡©
 
¡
;

605 
cİyšfo
 *
dœli¡
 = 0;

606 
cİyšfo
 *
ci
, *
Ãxt
;

608 
d
 = 
	`İ’dœ
(
Í©h
);

609 if(
d
 == 0) {

610 
	`årštf
(
¡d”r
,"ÿÂÙ o³À'%s': %s\n", 
Í©h
, 
	`¡»¼Ü
(
”ºo
));

614 (
de
 = 
	`»addœ
(
d
))) {

615 
¡©_·th
[
PATH_MAX
];

616 *
Çme
 = 
de
->
d_Çme
;

618 if(
Çme
[0] == '.') {

619 if(
Çme
[1] == 0) ;

620 if((
Çme
[1] == '.') && (name[2] == 0)) ;

627 ià(
	`¡¾’
(
Í©h
è+ sŒËn(
de
->
d_Çme
è+ 1 > (
¡©_·th
))

629 
	`¡rıy
(
¡©_·th
, 
Í©h
);

630 
	`¡rÿt
(
¡©_·th
, 
de
->
d_Çme
);

632 if(!
	`l¡©
(
¡©_·th
, &
¡
)) {

633 ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

634 
ci
 = 
	`mkcİyšfo
(
Í©h
, 
½©h
, 
Çme
, 1);

635 
ci
->
Ãxt
 = 
dœli¡
;

636 
dœli¡
 = 
ci
;

638 
ci
 = 
	`mkcİyšfo
(
Í©h
, 
½©h
, 
Çme
, 0);

639 if(
	`l¡©
(
ci
->
¤c
, &
¡
)) {

640 
	`årštf
(
¡d”r
,"ÿÂÙ sˆ'%s': %s\n", 
ci
->
¤c
, 
	`¡»¼Ü
(
”ºo
));

641 
	`ä“
(
ci
);

642 
	`şo£dœ
(
d
);

645 if(!
	`S_ISREG
(
¡
.
¡_mode
è&& !
	`S_ISLNK
(st.st_mode)) {

646 
	`årštf
(
¡d”r
, "skpšg s³cŸÈf'%s'\n", 
ci
->
¤c
);

647 
	`ä“
(
ci
);

649 
ci
->
time
 = 
¡
.
¡_mtime
;

650 
ci
->
mode
 = 
¡
.
¡_mode
;

651 
ci
->
size
 = 
¡
.
¡_size
;

652 
ci
->
Ãxt
 = *
f–i¡
;

653 *
f–i¡
 = 
ci
;

657 
	`årštf
(
¡d”r
, "ÿÂÙ†¡© '%s': %s\n",
¡©_·th
 , 
	`¡»¼Ü
(
”ºo
));

661 
	`şo£dœ
(
d
);

663 
ci
 = 
dœli¡
; c˜!ğ0; c˜ğ
Ãxt
) {

664 
Ãxt
 = 
ci
->next;

665 
	`loÿl_bud_li¡
(
f–i¡
, 
ci
->
¤c
, ci->
d¡
);

666 
	`ä“
(
ci
);

670 
	}
}

673 
	$cİy_loÿl_dœ_»mÙe
(
fd
, cÚ¡ *
Í©h
, cÚ¡ *
½©h
, 
checktime¡amps
, 
li¡Úly
)

675 
cİyšfo
 *
f–i¡
 = 0;

676 
cİyšfo
 *
ci
, *
Ãxt
;

677 
pushed
 = 0;

678 
sk³d
 = 0;

680 if((
Í©h
[0] =ğ0è|| (
½©h
[0] == 0))  -1;

681 if(
Í©h
[
	`¡¾’
(lpath) - 1] != '/') {

682 
tm¶’
 = 
	`¡¾’
(
Í©h
)+2;

683 *
tmp
 = 
»š‹½»t_ÿ¡
<*>(
	`m®loc
(
tm¶’
));

684 if(
tmp
 == 0)  -1;

685 
	`¢´štf
(
tmp
, 
tm¶’
, "%s/",
Í©h
);

686 
Í©h
 = 
tmp
;

688 if(
½©h
[
	`¡¾’
(rpath) - 1] != '/') {

689 
tm¶’
 = 
	`¡¾’
(
½©h
)+2;

690 *
tmp
 = 
»š‹½»t_ÿ¡
<*>(
	`m®loc
(
tm¶’
));

691 if(
tmp
 == 0)  -1;

692 
	`¢´štf
(
tmp
, 
tm¶’
, "%s/",
½©h
);

693 
½©h
 = 
tmp
;

696 if(
	`loÿl_bud_li¡
(&
f–i¡
, 
Í©h
, 
½©h
)) {

700 if(
checktime¡amps
){

701 
ci
 = 
f–i¡
; c˜!ğ0; c˜ğci->
Ãxt
) {

702 if(
	`sync_¡¬t_»adtime
(
fd
, 
ci
->
d¡
)) {

706 
ci
 = 
f–i¡
; c˜!ğ0; c˜ğci->
Ãxt
) {

707 
time¡amp
, 
mode
, 
size
;

708 if(
	`sync_fšish_»adtime
(
fd
, &
time¡amp
, &
mode
, &
size
))

710 if(
size
 =ğ
ci
->size) {

712 if((
	`S_ISREG
(
ci
->
mode
 & modeè&& 
time¡amp
 =ğci->
time
) ||

713 (
	`S_ISLNK
(
ci
->
mode
 & modeè&& 
time¡amp
 >ğci->
time
))

714 
ci
->
æag
 = 1;

718 
ci
 = 
f–i¡
; c˜!ğ0; c˜ğ
Ãxt
) {

719 
Ãxt
 = 
ci
->next;

720 if(
ci
->
æag
 == 0) {

721 
	`årštf
(
¡d”r
,"%¥ush: % -> %s\n", 
li¡Úly
 ? "would " : "", 
ci
->
¤c
, ci->
d¡
);

722 if(!
li¡Úly
 &&

723 
	`sync_£nd
(
fd
, 
ci
->
¤c
, ci->
d¡
, ci->
time
, ci->
mode
,

727 
pushed
++;

729 
sk³d
++;

731 
	`ä“
(
ci
);

734 
	`årštf
(
¡d”r
,"%d file%s…ushed. %d file%s skipped.\n",

735 
pushed
, (pushed == 1) ? "" : "s",

736 
sk³d
, (skipped == 1) ? "" : "s");

739 
	}
}

742 
	$do_sync_push
(cÚ¡ *
Í©h
, cÚ¡ *
½©h
, 
show_´og»ss
)

744 
¡©
 
¡
;

745 
mode
;

747 
¡d
::
¡ršg
 
”rÜ
;

748 
fd
 = 
	`adb_cÚÃù
("sync:", &
”rÜ
);

749 ià(
fd
 < 0) {

750 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

754 if(
	`¡©
(
Í©h
, &
¡
)) {

755 
	`årštf
(
¡d”r
,"ÿÂÙ sˆ'%s': %s\n", 
Í©h
, 
	`¡»¼Ü
(
”ºo
));

756 
	`sync_qu™
(
fd
);

760 if(
	`S_ISDIR
(
¡
.
¡_mode
)) {

761 
	`BEGIN
();

762 if(
	`cİy_loÿl_dœ_»mÙe
(
fd
, 
Í©h
, 
½©h
, 0, 0)) {

765 
	`END
();

766 
	`sync_qu™
(
fd
);

769 if(
	`sync_»admode
(
fd
, 
½©h
, &
mode
)) {

772 if((
mode
 !ğ0è&& 
	`S_ISDIR
(mode)) {

776 cÚ¡ *
Çme
 = 
	`adb_dœ¡İ
(
Í©h
);

777 if(
Çme
 == 0) {

778 
Çme
 = 
Í©h
;

780 
Çme
++;

782 
tm¶’
 = 
	`¡¾’
(
Çme
è+ sŒËn(
½©h
) + 2;

783 *
tmp
 = 
»š‹½»t_ÿ¡
<*>(

784 
	`m®loc
(
	`¡¾’
(
Çme
è+ sŒËn(
½©h
) + 2));

785 if(
tmp
 == 0)  1;

786 
	`¢´štf
(
tmp
, 
tm¶’
, "%s/%s", 
½©h
, 
Çme
);

787 
½©h
 = 
tmp
;

789 
	`BEGIN
();

790 if(
	`sync_£nd
(
fd
, 
Í©h
, 
½©h
, 
¡
.
¡_mtime
, st.
¡_mode
, 
show_´og»ss
)) {

793 
	`END
();

794 
	`sync_qu™
(
fd
);

800 
	}
}

803 
	ssync_ls_bud_li¡_cb_¬gs
 {

804 
cİyšfo
 **
	mf–i¡
;

805 
cİyšfo
 **
	mdœli¡
;

806 cÚ¡ *
	m½©h
;

807 cÚ¡ *
	mÍ©h
;

811 
	$sync_ls_bud_li¡_cb
(
mode
, 
size
, 
time
,

812 cÚ¡ *
Çme
, *
cook›
)

814 
sync_ls_bud_li¡_cb_¬gs
 *
¬gs
 = (sync_ls_bud_li¡_cb_¬g *)
cook›
;

815 
cİyšfo
 *
ci
;

817 ià(
	`S_ISDIR
(
mode
)) {

818 
cİyšfo
 **
dœli¡
 = 
¬gs
->dirlist;

821 ià(
Çme
[0] == '.') {

822 ià(
Çme
[1] == '\0') ;

823 ià((
Çme
[1] == '.') && (name[2] == '\0')) ;

826 
ci
 = 
	`mkcİyšfo
(
¬gs
->
½©h
,‡rgs->
Í©h
, 
Çme
, 1);

827 
ci
->
Ãxt
 = *
dœli¡
;

828 *
dœli¡
 = 
ci
;

829 } ià(
	`S_ISREG
(
mode
è|| 
	`S_ISLNK
(mode)) {

830 
cİyšfo
 **
f–i¡
 = 
¬gs
->filelist;

832 
ci
 = 
	`mkcİyšfo
(
¬gs
->
½©h
,‡rgs->
Í©h
, 
Çme
, 0);

833 
ci
->
time
 =ime;

834 
ci
->
mode
 = mode;

835 
ci
->
size
 = size;

836 
ci
->
Ãxt
 = *
f–i¡
;

837 *
f–i¡
 = 
ci
;

839 
	`årštf
(
¡d”r
, "skpšg s³cŸÈf'%s'\n", 
Çme
);

841 
	}
}

843 
	$»mÙe_bud_li¡
(
syncfd
, 
cİyšfo
 **
f–i¡
,

844 cÚ¡ *
½©h
, cÚ¡ *
Í©h
)

846 
cİyšfo
 *
dœli¡
 = 
NULL
;

847 
sync_ls_bud_li¡_cb_¬gs
 
¬gs
;

849 
¬gs
.
f–i¡
 = filelist;

850 
¬gs
.
dœli¡
 = &dirlist;

851 
¬gs
.
½©h
 =„path;

852 
¬gs
.
Í©h
 =†path;

855 ià(
	`sync_ls
(
syncfd
, 
½©h
, 
sync_ls_bud_li¡_cb
, (*)&
¬gs
)) {

860 
dœli¡
 !ğ
NULL
) {

861 
cİyšfo
 *
Ãxt
 = 
dœli¡
->next;

862 ià(
	`»mÙe_bud_li¡
(
syncfd
, 
f–i¡
, 
dœli¡
->
¤c
, dœli¡->
d¡
)) {

865 
	`ä“
(
dœli¡
);

866 
dœli¡
 = 
Ãxt
;

870 
	}
}

872 
	$£t_time_ªd_mode
(cÚ¡ *
Í©h
, 
time_t
 
time
, 
mode
)

874 
utimbuf
 
times
 = { 
time
,ime };

875 
r1
 = 
	`utime
(
Í©h
, &
times
);

878 
mode_t
 
mask
=
	`umask
(0000);

879 
	`umask
(
mask
);

880 
r2
 = 
	`chmod
(
Í©h
, 
mode
 & ~
mask
);

882  
r1
 ? : 
r2
;

883 
	}
}

886 *
	$add_¦ash_to_·th
(cÚ¡ *
·th
)

888 ià(
·th
[
	`¡¾’
(path) - 1] != '/') {

889 
size_t
 
Ën
 = 
	`¡¾’
(
·th
) + 2;

890 *
·th_w™h_¦ash
 = 
»š‹½»t_ÿ¡
<*>(
	`m®loc
(
Ën
));

891 ià(
·th_w™h_¦ash
 =ğ
NULL
)

892  
NULL
;

893 
	`¢´štf
(
·th_w™h_¦ash
, 
Ën
, "%s/", 
·th
);

894  
·th_w™h_¦ash
;

896  
	`¡rdup
(
·th
);

898 
	}
}

900 
	$cİy_»mÙe_dœ_loÿl
(
fd
, cÚ¡ *
½©h
, cÚ¡ *
Í©h
,

901 
cİy_©Œs
)

903 
cİyšfo
 *
f–i¡
 = 0;

904 
cİyšfo
 *
ci
, *
Ãxt
;

905 
puÎed
 = 0;

906 
sk³d
 = 0;

907 *
½©h_ş—n
 = 
NULL
;

908 *
Í©h_ş—n
 = 
NULL
;

909 
»t
 = 0;

911 ià(
½©h
[0] =ğ'\0' || 
Í©h
[0] == '\0') {

912 
»t
 = -1;

913 
fšish
;

917 
½©h_ş—n
 = 
	`add_¦ash_to_·th
(
½©h
);

918 ià(!
½©h_ş—n
) {

919 
»t
 = -1;

920 
fšish
;

922 
Í©h_ş—n
 = 
	`add_¦ash_to_·th
(
Í©h
);

923 ià(!
Í©h_ş—n
) {

924 
»t
 = -1;

925 
fšish
;

929 
	`årštf
(
¡d”r
, "pull: building file†ist...\n");

930 ià(
	`»mÙe_bud_li¡
(
fd
, &
f–i¡
, 
½©h_ş—n
, 
Í©h_ş—n
)) {

931 
»t
 = -1;

932 
fšish
;

935 
ci
 = 
f–i¡
; c˜!ğ0; c˜ğ
Ãxt
) {

936 
Ãxt
 = 
ci
->next;

937 ià(
ci
->
æag
 == 0) {

938 
	`årštf
(
¡d”r
, "puÎ: % -> %s\n", 
ci
->
¤c
, ci->
d¡
);

939 ià(
	`sync_»cv
(
fd
, 
ci
->
¤c
, ci->
d¡
, 0 )) {

940 
»t
 = -1;

941 
fšish
;

944 ià(
cİy_©Œs
 && 
	`£t_time_ªd_mode
(
ci
->
d¡
, ci->
time
, ci->
mode
)) {

945 
»t
 = -1;

946 
fšish
;

948 
puÎed
++;

950 
sk³d
++;

952 
	`ä“
(
ci
);

955 
	`årštf
(
¡d”r
, "%d file%s…ulled. %d file%s skipped.\n",

956 
puÎed
, (pulled == 1) ? "" : "s",

957 
sk³d
, (skipped == 1) ? "" : "s");

959 
fšish
:

960 
	`ä“
(
Í©h_ş—n
);

961 
	`ä“
(
½©h_ş—n
);

962  
»t
;

963 
	}
}

965 
	$do_sync_puÎ
(cÚ¡ *
½©h
, cÚ¡ *
Í©h
, 
show_´og»ss
, 
cİy_©Œs
)

967 
mode
, 
time
;

968 
¡©
 
¡
;

970 
¡d
::
¡ršg
 
”rÜ
;

971 
fd
 = 
	`adb_cÚÃù
("sync:", &
”rÜ
);

972 ià(
fd
 < 0) {

973 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

977 if(
	`sync_»adtime
(
fd
, 
½©h
, &
time
, &
mode
)) {

980 if(
mode
 == 0) {

981 
	`årštf
(
¡d”r
,"»mÙobjeù '%s' dÛ nÙƒxi¡\n", 
½©h
);

985 if(
	`S_ISREG
(
mode
è|| 
	`S_ISLNK
(modeè|| 
	`S_ISCHR
(modeè|| 
	`S_ISBLK
(mode)) {

986 if(
	`¡©
(
Í©h
, &
¡
) == 0) {

987 if(
	`S_ISDIR
(
¡
.
¡_mode
)) {

991 cÚ¡ *
Çme
 = 
	`adb_dœ¡İ
(
½©h
);

992 if(
Çme
 == 0) {

993 
Çme
 = 
½©h
;

995 
Çme
++;

997 
tm¶’
 = 
	`¡¾’
(
Çme
è+ sŒËn(
Í©h
) + 2;

998 *
tmp
 = 
»š‹½»t_ÿ¡
<*>(
	`m®loc
(
tm¶’
));

999 if(
tmp
 == 0)  1;

1000 
	`¢´štf
(
tmp
, 
tm¶’
, "%s/%s", 
Í©h
, 
Çme
);

1001 
Í©h
 = 
tmp
;

1004 
	`BEGIN
();

1005 ià(
	`sync_»cv
(
fd
, 
½©h
, 
Í©h
, 
show_´og»ss
)) {

1008 ià(
cİy_©Œs
 && 
	`£t_time_ªd_mode
(
Í©h
, 
time
, 
mode
))

1010 
	`END
();

1011 
	`sync_qu™
(
fd
);

1014 } if(
	`S_ISDIR
(
mode
)) {

1015 
	`BEGIN
();

1016 ià(
	`cİy_»mÙe_dœ_loÿl
(
fd
, 
½©h
, 
Í©h
, 
cİy_©Œs
)) {

1019 
	`END
();

1020 
	`sync_qu™
(
fd
);

1024 
	`årštf
(
¡d”r
,"»mÙobjeù '%s'‚Ù‡ fÜ dœeùÜy\n", 
½©h
);

1027 
	}
}

1029 
	$do_sync_sync
(cÚ¡ 
¡d
::
¡ršg
& 
Í©h
, cÚ¡ std::¡ršg& 
½©h
, 
boŞ
 
li¡_Úly
)

1031 
	`årštf
(
¡d”r
, "syncšg %s...\n", 
½©h
.
	`c_¡r
());

1033 
¡d
::
¡ršg
 
”rÜ
;

1034 
fd
 = 
	`adb_cÚÃù
("sync:", &
”rÜ
);

1035 ià(
fd
 < 0) {

1036 
	`årštf
(
¡d”r
, "”rÜ: %s\n", 
”rÜ
.
	`c_¡r
());

1040 
	`BEGIN
();

1041 ià(
	`cİy_loÿl_dœ_»mÙe
(
fd
, 
Í©h
.
	`c_¡r
(), 
½©h
.c_¡r(), 1, 
li¡_Úly
)) {

1044 
	`END
();

1045 
	`sync_qu™
(
fd
);

1048 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/file_sync_service.cpp

17 
	#TRACE_TAG
 
TRACE_SYNC


	)

19 
	~"sysd•s.h
"

20 
	~"fe_sync_£rviû.h
"

22 
	~<dœ’t.h
>

23 
	~<”ºo.h
>

24 
	~<£lšux/ªdroid.h
>

25 
	~<¡dio.h
>

26 
	~<¡dlib.h
>

27 
	~<¡ršg.h
>

28 
	~<sys/¡©.h
>

29 
	~<sys/ty³s.h
>

30 
	~<uni¡d.h
>

31 
	~<utime.h
>

33 
	~"adb.h
"

34 
	~"adb_io.h
"

35 
	~"´iv©e/ªdroid_fesy¡em_cÚfig.h
"

37 
boŞ
 
	$should_u£_fs_cÚfig
(cÚ¡ * 
·th
) {

39  
	`¡ºcmp
("/sy¡em/", 
·th
, 
	`¡¾’
("/system/")) == 0 ||

40 
	`¡ºcmp
("/v’dÜ/", 
·th
, 
	`¡¾’
("/vendor/")) == 0 ||

41 
	`¡ºcmp
("/Ûm/", 
·th
, 
	`¡¾’
("/oem/")) == 0;

42 
	}
}

44 
	$mkdœs
(*
Çme
)

46 
»t
;

47 *
x
 = 
Çme
 + 1;

48 
uid_t
 
uid
 = -1;

49 
gid_t
 
gid
 = -1;

50 
mode
 = 0775;

51 
ušt64_t
 
ÿp
 = 0;

53 if(
Çme
[0] != '/')  -1;

56 
x
 = 
	`adb_dœ¡¬t
(x);

57 if(
x
 == 0)  0;

58 *
x
 = 0;

59 ià(
	`should_u£_fs_cÚfig
(
Çme
)) {

60 
	`fs_cÚfig
(
Çme
, 1, 
NULL
, &
uid
, &
gid
, &
mode
, &
ÿp
);

62 
»t
 = 
	`adb_mkdœ
(
Çme
, 
mode
);

63 if((
»t
 < 0è&& (
”ºo
 !ğ
EEXIST
)) {

64 
	`D
("mkdœ(\"%s\"è-> %s\n", 
Çme
, 
	`¡»¼Ü
(
”ºo
));

65 *
x
 = '/';

66  
»t
;

67 } if(
»t
 == 0) {

68 
»t
 = 
	`chown
(
Çme
, 
uid
, 
gid
);

69 ià(
»t
 < 0) {

70 *
x
 = '/';

71  
»t
;

73 
	`£lšux_ªdroid_»¡ÜecÚ
(
Çme
, 0);

75 *
x
++ = '/';

78 
	}
}

80 
	$do_¡©
(
s
, cÚ¡ *
·th
)

82 
syncmsg
 
msg
;

83 
¡©
 
¡
;

85 
msg
.
¡©
.
id
 = 
ID_STAT
;

87 if(
	`l¡©
(
·th
, &
¡
)) {

88 
msg
.
¡©
.
mode
 = 0;

89 
msg
.
¡©
.
size
 = 0;

90 
msg
.
¡©
.
time
 = 0;

92 
msg
.
¡©
.
mode
 = 
	`htŞl
(
¡
.
¡_mode
);

93 
msg
.
¡©
.
size
 = 
	`htŞl
(
¡
.
¡_size
);

94 
msg
.
¡©
.
time
 = 
	`htŞl
(
¡
.
¡_mtime
);

97  
	`Wr™eFdExaùly
(
s
, &
msg
.
¡©
, (msg.stat)) ? 0 : -1;

98 
	}
}

100 
	$do_li¡
(
s
, cÚ¡ *
·th
)

102 
DIR
 *
d
;

103 
dœ’t
 *
de
;

104 
¡©
 
¡
;

105 
syncmsg
 
msg
;

106 
Ën
;

108 
tmp
[1024 + 256 + 1];

109 *
âame
;

111 
Ën
 = 
	`¡¾’
(
·th
);

112 
	`memıy
(
tmp
, 
·th
, 
Ën
);

113 
tmp
[
Ën
] = '/';

114 
âame
 = 
tmp
 + 
Ën
 + 1;

116 
msg
.
d’t
.
id
 = 
ID_DENT
;

118 
d
 = 
	`İ’dœ
(
·th
);

119 if(
d
 =ğ0è
dÚe
;

121 (
de
 = 
	`»addœ
(
d
))) {

122 
Ën
 = 
	`¡¾’
(
de
->
d_Çme
);

126 if(
Ën
 > 256) ;

128 
	`¡rıy
(
âame
, 
de
->
d_Çme
);

129 if(
	`l¡©
(
tmp
, &
¡
) == 0) {

130 
msg
.
d’t
.
mode
 = 
	`htŞl
(
¡
.
¡_mode
);

131 
msg
.
d’t
.
size
 = 
	`htŞl
(
¡
.
¡_size
);

132 
msg
.
d’t
.
time
 = 
	`htŞl
(
¡
.
¡_mtime
);

133 
msg
.
d’t
.
Çm–’
 = 
	`htŞl
(
Ën
);

135 if(!
	`Wr™eFdExaùly
(
s
, &
msg
.
d’t
, (msg.dent)) ||

136 !
	`Wr™eFdExaùly
(
s
, 
de
->
d_Çme
, 
Ën
)) {

137 
	`şo£dœ
(
d
);

143 
	`şo£dœ
(
d
);

145 
dÚe
:

146 
msg
.
d’t
.
id
 = 
ID_DONE
;

147 
msg
.
d’t
.
mode
 = 0;

148 
msg
.
d’t
.
size
 = 0;

149 
msg
.
d’t
.
time
 = 0;

150 
msg
.
d’t
.
Çm–’
 = 0;

151  
	`Wr™eFdExaùly
(
s
, &
msg
.
d’t
, (msg.dent)) ? 0 : -1;

152 
	}
}

154 
	$ç_mes§ge
(
s
, cÚ¡ *
»asÚ
)

156 
syncmsg
 
msg
;

157 
Ën
 = 
	`¡¾’
(
»asÚ
);

159 
	`D
("sync: fau»: %s\n", 
»asÚ
);

161 
msg
.
d©a
.
id
 = 
ID_FAIL
;

162 
msg
.
d©a
.
size
 = 
	`htŞl
(
Ën
);

163 if(!
	`Wr™eFdExaùly
(
s
, &
msg
.
d©a
, (msg.data)) ||

164 !
	`Wr™eFdExaùly
(
s
, 
»asÚ
, 
Ën
)) {

169 
	}
}

171 
	$ç_”ºo
(
s
)

173  
	`ç_mes§ge
(
s
, 
	`¡»¼Ü
(
”ºo
));

174 
	}
}

176 
	$hªdË_£nd_fe
(
s
, *
·th
, 
uid_t
 
uid
,

177 
gid_t
 
gid
, 
mode_t
 
mode
, *
bufãr
, 
boŞ
 
do_uÆšk
)

179 
syncmsg
 
msg
;

180 
time¡amp
 = 0;

181 
fd
;

183 
fd
 = 
	`adb_İ’_mode
(
·th
, 
O_WRONLY
 | 
O_CREAT
 | 
O_EXCL
 | 
O_CLOEXEC
, 
mode
);

184 if(
fd
 < 0 && 
”ºo
 =ğ
ENOENT
) {

185 if(
	`mkdœs
(
·th
) != 0) {

186 if(
	`ç_”ºo
(
s
))

188 
fd
 = -1;

190 
fd
 = 
	`adb_İ’_mode
(
·th
, 
O_WRONLY
 | 
O_CREAT
 | 
O_EXCL
 | 
O_CLOEXEC
, 
mode
);

193 if(
fd
 < 0 && 
”ºo
 =ğ
EEXIST
) {

194 
fd
 = 
	`adb_İ’_mode
(
·th
, 
O_WRONLY
 | 
O_CLOEXEC
, 
mode
);

196 if(
fd
 < 0) {

197 if(
	`ç_”ºo
(
s
))

199 
fd
 = -1;

201 if(
	`fchown
(
fd
, 
uid
, 
gid
) != 0) {

202 
	`ç_”ºo
(
s
);

203 
”ºo
 = 0;

211 
	`fchmod
(
fd
, 
mode
);

215 
Ën
;

217 if(!
	`R—dFdExaùly
(
s
, &
msg
.
d©a
, (msg.data)))

218 
ç
;

220 if(
msg
.
d©a
.
id
 !ğ
ID_DATA
) {

221 if(
msg
.
d©a
.
id
 =ğ
ID_DONE
) {

222 
time¡amp
 = 
	`Éohl
(
msg
.
d©a
.
size
);

225 
	`ç_mes§ge
(
s
, "invalid data message");

226 
ç
;

228 
Ën
 = 
	`Éohl
(
msg
.
d©a
.
size
);

229 if(
Ën
 > 
SYNC_DATA_MAX
) {

230 
	`ç_mes§ge
(
s
, "oversize data message");

231 
ç
;

233 if(!
	`R—dFdExaùly
(
s
, 
bufãr
, 
Ën
))

234 
ç
;

236 if(
fd
 < 0)

238 if(!
	`Wr™eFdExaùly
(
fd
, 
bufãr
, 
Ën
)) {

239 
§ved_”ºo
 = 
”ºo
;

240 
	`adb_şo£
(
fd
);

241 ià(
do_uÆšk
è
	`adb_uÆšk
(
·th
);

242 
fd
 = -1;

243 
”ºo
 = 
§ved_”ºo
;

244 if(
	`ç_”ºo
(
s
))  -1;

248 if(
fd
 >= 0) {

249 
utimbuf
 
u
;

250 
	`adb_şo£
(
fd
);

251 
	`£lšux_ªdroid_»¡ÜecÚ
(
·th
, 0);

252 
u
.
aùime
 = 
time¡amp
;

253 
u
.
modtime
 = 
time¡amp
;

254 
	`utime
(
·th
, &
u
);

256 
msg
.
¡©us
.
id
 = 
ID_OKAY
;

257 
msg
.
¡©us
.
msgËn
 = 0;

258 if(!
	`Wr™eFdExaùly
(
s
, &
msg
.
¡©us
, (msg.status)))

263 
ç
:

264 if(
fd
 >= 0)

265 
	`adb_şo£
(
fd
);

266 ià(
do_uÆšk
è
	`adb_uÆšk
(
·th
);

268 
	}
}

270 #ià
defšed
(
_WIN32
)

271 
	$hªdË_£nd_lšk
(
s
, *
·th
, *
bufãr
è
	`__©Œibu‹__
((
	`”rÜ
("no symlinks on Windows")));

273 
	$hªdË_£nd_lšk
(
s
, *
·th
, *
bufãr
)

275 
syncmsg
 
msg
;

276 
Ën
;

277 
»t
;

279 if(!
	`R—dFdExaùly
(
s
, &
msg
.
d©a
, (msg.data)))

282 if(
msg
.
d©a
.
id
 !ğ
ID_DATA
) {

283 
	`ç_mes§ge
(
s
, "invalid data message:ƒxpected ID_DATA");

287 
Ën
 = 
	`Éohl
(
msg
.
d©a
.
size
);

288 if(
Ën
 > 
SYNC_DATA_MAX
) {

289 
	`ç_mes§ge
(
s
, "oversize data message");

292 if(!
	`R—dFdExaùly
(
s
, 
bufãr
, 
Ën
))

295 
»t
 = 
	`symlšk
(
bufãr
, 
·th
);

296 if(
»t
 && 
”ºo
 =ğ
ENOENT
) {

297 if(
	`mkdœs
(
·th
) != 0) {

298 
	`ç_”ºo
(
s
);

301 
»t
 = 
	`symlšk
(
bufãr
, 
·th
);

303 if(
»t
) {

304 
	`ç_”ºo
(
s
);

308 if(!
	`R—dFdExaùly
(
s
, &
msg
.
d©a
, (msg.data)))

311 if(
msg
.
d©a
.
id
 =ğ
ID_DONE
) {

312 
msg
.
¡©us
.
id
 = 
ID_OKAY
;

313 
msg
.
¡©us
.
msgËn
 = 0;

314 if(!
	`Wr™eFdExaùly
(
s
, &
msg
.
¡©us
, (msg.status)))

317 
	`ç_mes§ge
(
s
, "invalid data message:ƒxpected ID_DONE");

322 
	}
}

325 
	$do_£nd
(
s
, *
·th
, *
bufãr
)

327 
mode
;

328 
boŞ
 
is_lšk
 = 
çl£
;

329 
boŞ
 
do_uÆšk
;

331 * 
tmp
 = 
	`¡¼chr
(
·th
,',');

332 if(
tmp
) {

333 *
tmp
 = 0;

334 
”ºo
 = 0;

335 
mode
 = 
	`¡¹oul
(
tmp
 + 1, 
NULL
, 0);

336 
is_lšk
 = 
	`S_ISLNK
((
mode_t
è
mode
);

337 
mode
 &= 0777;

339 if(!
tmp
 || 
”ºo
) {

340 
mode
 = 0644;

341 
is_lšk
 = 0;

342 
do_uÆšk
 = 
Œue
;

344 
¡©
 
¡
;

346 
do_uÆšk
 = 
	`l¡©
(
·th
, &
¡
è|| 
	`S_ISREG
(¡.
¡_mode
è|| 
	`S_ISLNK
(st.st_mode);

347 ià(
do_uÆšk
) {

348 
	`adb_uÆšk
(
·th
);

352 ià(
is_lšk
) {

353  
	`hªdË_£nd_lšk
(
s
, 
·th
, 
bufãr
);

356 
uid_t
 
uid
 = -1;

357 
gid_t
 
gid
 = -1;

358 
ušt64_t
 
ÿp
 = 0;

361 
mode
 |= ((mode >> 3) & 0070);

362 
mode
 |= ((mode >> 3) & 0007);

364 
tmp
 = 
·th
;

365 if(*
tmp
 == '/') {

366 
tmp
++;

368 ià(
	`should_u£_fs_cÚfig
(
·th
)) {

369 
	`fs_cÚfig
(
tmp
, 0, 
NULL
, &
uid
, &
gid
, &
mode
, &
ÿp
);

371  
	`hªdË_£nd_fe
(
s
, 
·th
, 
uid
, 
gid
, 
mode
, 
bufãr
, 
do_uÆšk
);

372 
	}
}

374 
	$do_»cv
(
s
, cÚ¡ *
·th
, *
bufãr
)

376 
syncmsg
 
msg
;

377 
fd
, 
r
;

379 
fd
 = 
	`adb_İ’
(
·th
, 
O_RDONLY
 | 
O_CLOEXEC
);

380 if(
fd
 < 0) {

381 if(
	`ç_”ºo
(
s
))  -1;

385 
msg
.
d©a
.
id
 = 
ID_DATA
;

387 
r
 = 
	`adb_»ad
(
fd
, 
bufãr
, 
SYNC_DATA_MAX
);

388 if(
r
 <= 0) {

389 if(
r
 == 0) ;

390 if(
”ºo
 =ğ
EINTR
) ;

391 
r
 = 
	`ç_”ºo
(
s
);

392 
	`adb_şo£
(
fd
);

393  
r
;

395 
msg
.
d©a
.
size
 = 
	`htŞl
(
r
);

396 if(!
	`Wr™eFdExaùly
(
s
, &
msg
.
d©a
, (msg.data)) ||

397 !
	`Wr™eFdExaùly
(
s
, 
bufãr
, 
r
)) {

398 
	`adb_şo£
(
fd
);

403 
	`adb_şo£
(
fd
);

405 
msg
.
d©a
.
id
 = 
ID_DONE
;

406 
msg
.
d©a
.
size
 = 0;

407 if(!
	`Wr™eFdExaùly
(
s
, &
msg
.
d©a
, (msg.data))) {

412 
	}
}

414 
	$fe_sync_£rviû
(
fd
, *
cook›
)

416 
syncmsg
 
msg
;

417 
Çme
[1025];

418 
Çm–’
;

420 *
bufãr
 = 
»š‹½»t_ÿ¡
<*>(
	`m®loc
(
SYNC_DATA_MAX
));

421 if(
bufãr
 =ğ0è
ç
;

424 
	`D
("sync: waiting for command\n");

426 if(!
	`R—dFdExaùly
(
fd
, &
msg
.
»q
, (msg.req))) {

427 
	`ç_mes§ge
(
fd
, "command„ead failure");

430 
Çm–’
 = 
	`Éohl
(
msg
.
»q
.namelen);

431 if(
Çm–’
 > 1024) {

432 
	`ç_mes§ge
(
fd
, "invalid‚amelen");

435 if(!
	`R—dFdExaùly
(
fd
, 
Çme
, 
Çm–’
)) {

436 
	`ç_mes§ge
(
fd
, "filename„ead failure");

439 
Çme
[
Çm–’
] = 0;

441 
msg
.
»q
.
Çm–’
 = 0;

442 
	`D
("sync: '%s' '%s'\n", (*è&
msg
.
»q
, 
Çme
);

444 
msg
.
»q
.
id
) {

445 
ID_STAT
:

446 if(
	`do_¡©
(
fd
, 
Çme
)è
ç
;

448 
ID_LIST
:

449 if(
	`do_li¡
(
fd
, 
Çme
)è
ç
;

451 
ID_SEND
:

452 if(
	`do_£nd
(
fd
, 
Çme
, 
bufãr
)è
ç
;

454 
ID_RECV
:

455 if(
	`do_»cv
(
fd
, 
Çme
, 
bufãr
)è
ç
;

457 
ID_QUIT
:

458 
ç
;

460 
	`ç_mes§ge
(
fd
, "unknown command");

461 
ç
;

465 
ç
:

466 if(
bufãr
 !ğ0è
	`ä“
(buffer);

467 
	`D
("sync: done\n");

468 
	`adb_şo£
(
fd
);

469 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/file_sync_service.h

17 #iâdeà
_FILE_SYNC_SERVICE_H_


18 
	#_FILE_SYNC_SERVICE_H_


	)

20 
	~<¡ršg
>

22 
	#htŞl
(
x
è(x)

	)

23 
	#Éohl
(
x
è(x)

	)

25 
	#MKID
(
a
,
b
,
c
,
d
è(×è| ((bè<< 8è| ((cè<< 16è| ((dè<< 24))

	)

27 
	#ID_STAT
 
	`MKID
('S','T','A','T')

	)

28 
	#ID_LIST
 
	`MKID
('L','I','S','T')

	)

29 
	#ID_ULNK
 
	`MKID
('U','L','N','K')

	)

30 
	#ID_SEND
 
	`MKID
('S','E','N','D')

	)

31 
	#ID_RECV
 
	`MKID
('R','E','C','V')

	)

32 
	#ID_DENT
 
	`MKID
('D','E','N','T')

	)

33 
	#ID_DONE
 
	`MKID
('D','O','N','E')

	)

34 
	#ID_DATA
 
	`MKID
('D','A','T','A')

	)

35 
	#ID_OKAY
 
	`MKID
('O','K','A','Y')

	)

36 
	#ID_FAIL
 
	`MKID
('F','A','I','L')

	)

37 
	#ID_QUIT
 
	`MKID
('Q','U','I','T')

	)

39 
	usyncmsg
 {

40 
	mid
;

42 
	mid
;

43 
	mÇm–’
;

44 } 
	m»q
;

46 
	mid
;

47 
	mmode
;

48 
	msize
;

49 
	mtime
;

50 } 
	m¡©
;

52 
	mid
;

53 
	mmode
;

54 
	msize
;

55 
	mtime
;

56 
	mÇm–’
;

57 } 
	md’t
;

59 
	mid
;

60 
	msize
;

61 } 
	md©a
;

63 
	mid
;

64 
	mmsgËn
;

65 } 
	m¡©us
;

69 
fe_sync_£rviû
(
fd
, *
cook›
);

70 
do_sync_ls
(cÚ¡ *
·th
);

71 
do_sync_push
(cÚ¡ *
Í©h
, cÚ¡ *
½©h
, 
show_´og»ss
);

72 
do_sync_sync
(cÚ¡ 
¡d
::
¡ršg
& 
Í©h
, cÚ¡ std::¡ršg& 
½©h
, 
boŞ
 
li¡_Úly
);

73 
do_sync_puÎ
(cÚ¡ *
½©h
, cÚ¡ *
Í©h
, 
show_´og»ss
, 
puÎTime
);

75 
	#SYNC_DATA_MAX
 (64*1024)

	)

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/framebuffer_service.cpp

17 
	~<”ºo.h
>

18 
	~<fú.h
>

19 
	~<lšux/fb.h
>

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<sys/ioùl.h
>

24 
	~<sys/mmª.h
>

25 
	~<sys/ty³s.h
>

26 
	~<sys/wa™.h
>

27 
	~<uni¡d.h
>

29 
	~"sysd•s.h
"

31 
	~"adb.h
"

32 
	~"adb_io.h
"

33 
	~"fdev’t.h
"

40 
	#DDMS_RAWIMAGE_VERSION
 1

	)

41 
	sfbšfo
 {

42 
	mv”siÚ
;

43 
	mbµ
;

44 
	msize
;

45 
	mwidth
;

46 
	mheight
;

47 
	m»d_off£t
;

48 
	m»d_Ëngth
;

49 
	mblue_off£t
;

50 
	mblue_Ëngth
;

51 
	mg»’_off£t
;

52 
	mg»’_Ëngth
;

53 
	m®pha_off£t
;

54 
	m®pha_Ëngth
;

55 } 
__©Œibu‹__
((
·cked
));

57 
	$äamebufãr_£rviû
(
fd
, *
cook›
)

59 
fbšfo
 fbinfo;

60 
i
, 
bsize
;

61 
buf
[640];

62 
fd_sü“nÿp
;

63 
w
, 
h
, 
f
;

64 
fds
[2];

65 
pid_t
 
pid
;

67 ià(
	`pe2
(
fds
, 
O_CLOEXEC
è< 0è
peç
;

69 
pid
 = 
	`fÜk
();

70 ià(
pid
 < 0è
dÚe
;

72 ià(
pid
 == 0) {

73 
	`dup2
(
fds
[1], 
STDOUT_FILENO
);

74 
	`adb_şo£
(
fds
[0]);

75 
	`adb_şo£
(
fds
[1]);

76 cÚ¡ * 
commªd
 = "screencap";

77 cÚ¡ *
¬gs
[2] = {
commªd
, 
NULL
};

78 
	`execvp
(
commªd
, (**)
¬gs
);

79 
	`ex™
(1);

82 
	`adb_şo£
(
fds
[1]);

83 
fd_sü“nÿp
 = 
fds
[0];

86 if(!
	`R—dFdExaùly
(
fd_sü“nÿp
, &
w
, 4)è
dÚe
;

87 if(!
	`R—dFdExaùly
(
fd_sü“nÿp
, &
h
, 4)è
dÚe
;

88 if(!
	`R—dFdExaùly
(
fd_sü“nÿp
, &
f
, 4)è
dÚe
;

90 
fbšfo
.
v”siÚ
 = 
DDMS_RAWIMAGE_VERSION
;

92 
f
) {

94 
fbšfo
.
bµ
 = 32;

95 
fbšfo
.
size
 = 
w
 * 
h
 * 4;

96 
fbšfo
.
width
 = 
w
;

97 
fbšfo
.
height
 = 
h
;

98 
fbšfo
.
»d_off£t
 = 0;

99 
fbšfo
.
»d_Ëngth
 = 8;

100 
fbšfo
.
g»’_off£t
 = 8;

101 
fbšfo
.
g»’_Ëngth
 = 8;

102 
fbšfo
.
blue_off£t
 = 16;

103 
fbšfo
.
blue_Ëngth
 = 8;

104 
fbšfo
.
®pha_off£t
 = 24;

105 
fbšfo
.
®pha_Ëngth
 = 8;

108 
fbšfo
.
bµ
 = 32;

109 
fbšfo
.
size
 = 
w
 * 
h
 * 4;

110 
fbšfo
.
width
 = 
w
;

111 
fbšfo
.
height
 = 
h
;

112 
fbšfo
.
»d_off£t
 = 0;

113 
fbšfo
.
»d_Ëngth
 = 8;

114 
fbšfo
.
g»’_off£t
 = 8;

115 
fbšfo
.
g»’_Ëngth
 = 8;

116 
fbšfo
.
blue_off£t
 = 16;

117 
fbšfo
.
blue_Ëngth
 = 8;

118 
fbšfo
.
®pha_off£t
 = 24;

119 
fbšfo
.
®pha_Ëngth
 = 0;

122 
fbšfo
.
bµ
 = 24;

123 
fbšfo
.
size
 = 
w
 * 
h
 * 3;

124 
fbšfo
.
width
 = 
w
;

125 
fbšfo
.
height
 = 
h
;

126 
fbšfo
.
»d_off£t
 = 0;

127 
fbšfo
.
»d_Ëngth
 = 8;

128 
fbšfo
.
g»’_off£t
 = 8;

129 
fbšfo
.
g»’_Ëngth
 = 8;

130 
fbšfo
.
blue_off£t
 = 16;

131 
fbšfo
.
blue_Ëngth
 = 8;

132 
fbšfo
.
®pha_off£t
 = 24;

133 
fbšfo
.
®pha_Ëngth
 = 0;

136 
fbšfo
.
bµ
 = 16;

137 
fbšfo
.
size
 = 
w
 * 
h
 * 2;

138 
fbšfo
.
width
 = 
w
;

139 
fbšfo
.
height
 = 
h
;

140 
fbšfo
.
»d_off£t
 = 11;

141 
fbšfo
.
»d_Ëngth
 = 5;

142 
fbšfo
.
g»’_off£t
 = 5;

143 
fbšfo
.
g»’_Ëngth
 = 6;

144 
fbšfo
.
blue_off£t
 = 0;

145 
fbšfo
.
blue_Ëngth
 = 5;

146 
fbšfo
.
®pha_off£t
 = 0;

147 
fbšfo
.
®pha_Ëngth
 = 0;

150 
fbšfo
.
bµ
 = 32;

151 
fbšfo
.
size
 = 
w
 * 
h
 * 4;

152 
fbšfo
.
width
 = 
w
;

153 
fbšfo
.
height
 = 
h
;

154 
fbšfo
.
»d_off£t
 = 16;

155 
fbšfo
.
»d_Ëngth
 = 8;

156 
fbšfo
.
g»’_off£t
 = 8;

157 
fbšfo
.
g»’_Ëngth
 = 8;

158 
fbšfo
.
blue_off£t
 = 0;

159 
fbšfo
.
blue_Ëngth
 = 8;

160 
fbšfo
.
®pha_off£t
 = 24;

161 
fbšfo
.
®pha_Ëngth
 = 8;

164 
dÚe
;

168 if(!
	`Wr™eFdExaùly
(
fd
, &
fbšfo
, (fbšfo))è
dÚe
;

171 
i
 = 0; i < 
fbšfo
.
size
; i +ğ
bsize
) {

172 
bsize
 = (
buf
);

173 ià(
i
 + 
bsize
 > 
fbšfo
.
size
)

174 
bsize
 = 
fbšfo
.
size
 - 
i
;

175 if(!
	`R—dFdExaùly
(
fd_sü“nÿp
, 
buf
, 
bsize
)è
dÚe
;

176 if(!
	`Wr™eFdExaùly
(
fd
, 
buf
, 
bsize
)è
dÚe
;

179 
dÚe
:

180 
	`adb_şo£
(
fds
[0]);

182 
	`TEMP_FAILURE_RETRY
(
	`wa™pid
(
pid
, 
NULL
, 0));

183 
peç
:

184 
	`adb_şo£
(
fd
);

185 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/get_my_path_darwin.cpp

17 #impÜˆ<
C¬bÚ
/C¬bÚ.
h
>

18 
	~<uni¡d.h
>

20 
	~"adb.h
"

22 
	$g‘_my_·th
(*
s
, 
size_t
 
maxL’
)

24 
CFBundËRef
 
mašBundË
 = 
	`CFBundËG‘MašBundË
();

25 
CFURLRef
 
execubËURL
 = 
	`CFBundËCİyExecubËURL
(
mašBundË
);

26 
CFSŒšgRef
 
execubËP©hSŒšg
 = 
	`CFURLCİyFeSy¡emP©h
(
execubËURL
, 
kCFURLPOSIXP©hStyË
);

27 
	`CFR–—£
(
execubËURL
);

29 
	`CFSŒšgG‘FeSy¡emR•»£Á©iÚ
(
execubËP©hSŒšg
, 
s
, 
maxL’
);

30 
	`CFR–—£
(
execubËP©hSŒšg
);

31 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/get_my_path_linux.cpp

17 
	~<lim™s.h
>

18 
	~<¡dio.h
>

19 
	~<sys/ty³s.h
>

20 
	~<uni¡d.h
>

22 
	~"adb.h
"

24 
	$g‘_my_·th
(*
exe
, 
size_t
 
maxL’
)

26 
´oc
[64];

27 
	`¢´štf
(
´oc
, …roc, "/´oc/%d/exe", 
	`g‘pid
());

28 
”r
 = 
	`»adlšk
(
´oc
, 
exe
, 
maxL’
 - 1);

29 if(
”r
 > 0) {

30 
exe
[
”r
] = '\0';

32 
exe
[0] = '\0';

34 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/get_my_path_windows.cpp

17 
	~<as£¹.h
>

18 
	~<lim™s.h
>

19 
	~<wšdows.h
>

21 
	~"adb.h
"

23 
	$g‘_my_·th
(*
exe
, 
size_t
 
maxL’
)

25 *
r
;

28 ià(
	`G‘ModuËFeName
(
NULL
, 
exe
, 
maxL’
) > 0) {

29 
r
 = 
	`¡¼chr
(
exe
, '\\');

30 ià(
r
 !ğ
NULL
)

31 *
r
 = '\0';

33 
exe
[0] = '\0';

35 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/jdwp_service.cpp

19 
	#TRACE_TAG
 
TRACE_JDWP


	)

21 
	~"sysd•s.h
"

23 
	~<”ºo.h
>

24 
	~<¡dio.h
>

25 
	~<¡ršg.h
>

26 
	~<uni¡d.h
>

28 
	~"adb.h
"

117 
	#MAX_OUT_FDS
 4

	)

119 #ià!
ADB_HOST


121 
	~<sys/sock‘.h
>

122 
	~<sys/un.h
>

124 
	sJdwpProûss
 {

125 
JdwpProûss
* 
	mÃxt
;

126 
JdwpProûss
* 
	m´ev
;

127 
	mpid
;

128 
	msock‘
;

129 
fdev’t
* 
	mfde
;

131 
	mš_buff
[4];

132 
	mš_Ën
;

134 
	mout_fds
[
MAX_OUT_FDS
];

135 
	mout_couÁ
;

138 
JdwpProûss
 
	g_jdwp_li¡
;

141 
	$jdwp_´oûss_li¡
Ğ* 
bufãr
, 
bufã¾’
 )

143 * 
’d
 = 
bufãr
 + 
bufã¾’
;

144 * 
p
 = 
bufãr
;

145 
JdwpProûss
* 
´oc
 = 
_jdwp_li¡
.
Ãxt
;

147  ; 
´oc
 !ğ&
_jdwp_li¡
;…roøğ´oc->
Ãxt
 ) {

148 
Ën
;

151 ià(
´oc
->
pid
 < 0)

154 
Ën
 = 
	`¢´štf
(
p
, 
’d
-p, "%d\n", 
´oc
->
pid
);

155 ià(
p
 + 
Ën
 >ğ
’d
)

157 
p
 +ğ
Ën
;

159 
p
[0] = 0;

160  (
p
 - 
bufãr
);

161 
	}
}

165 
	$jdwp_´oûss_li¡_msg
Ğ* 
bufãr
, 
bufã¾’
 )

167 
h—d
[5];

168 
Ën
 = 
	`jdwp_´oûss_li¡
Ğ
bufãr
+4, 
bufã¾’
-4 );

169 
	`¢´štf
(
h—d
,  h—d, "%04x", 
Ën
);

170 
	`memıy
(
bufãr
, 
h—d
, 4);

171  
Ën
 + 4;

172 
	}
}

175 
jdwp_´oûss_li¡_upd©ed
();

178 
	$jdwp_´oûss_ä“
Ğ
JdwpProûss
* 
´oc
 )

180 ià(
´oc
) {

181 
n
;

183 
´oc
->
´ev
->
Ãxt
 =…roc->next;

184 
´oc
->
Ãxt
->
´ev
 =…roc->prev;

186 ià(
´oc
->
sock‘
 >= 0) {

187 
	`adb_shutdown
(
´oc
->
sock‘
);

188 
	`adb_şo£
(
´oc
->
sock‘
);

189 
´oc
->
sock‘
 = -1;

192 ià(
´oc
->
fde
 !ğ
NULL
) {

193 
	`fdev’t_de¡roy
(
´oc
->
fde
);

194 
´oc
->
fde
 = 
NULL
;

196 
´oc
->
pid
 = -1;

198 
n
 = 0;‚ < 
´oc
->
out_couÁ
;‚++) {

199 
	`adb_şo£
(
´oc
->
out_fds
[
n
]);

201 
´oc
->
out_couÁ
 = 0;

203 
	`ä“
(
´oc
);

205 
	`jdwp_´oûss_li¡_upd©ed
();

207 
	}
}

210 
jdwp_´oûss_ev’t
(, , *);

213 
JdwpProûss
*

214 
	$jdwp_´oûss_®loc
Ğ
sock‘
 )

216 
JdwpProûss
* 
´oc
 = 
»š‹½»t_ÿ¡
<JdwpProcess*>(

217 
	`ÿÎoc
(1, (*
´oc
)));

219 ià(
´oc
 =ğ
NULL
) {

220 
	`D
("notƒnough memoryo create‚ew JDWP…rocess\n");

221  
NULL
;

224 
´oc
->
sock‘
 = socket;

225 
´oc
->
pid
 = -1;

226 
´oc
->
Ãxt
 =…roc;

227 
´oc
->
´ev
 =…roc;

229 
´oc
->
fde
 = 
	`fdev’t_ü—‹
Ğ
sock‘
, 
jdwp_´oûss_ev’t
,…roc );

230 ià(
´oc
->
fde
 =ğ
NULL
) {

231 
	`D
("could‚ot create fdevent for‚ew JDWP…rocess\n" );

232 
	`ä“
(
´oc
);

233  
NULL
;

236 
´oc
->
fde
->
¡©e
 |ğ
FDE_DONT_CLOSE
;

237 
´oc
->
š_Ën
 = 0;

238 
´oc
->
out_couÁ
 = 0;

241 
´oc
->
Ãxt
 = &
_jdwp_li¡
;

242 
´oc
->
´ev
 =…roc->
Ãxt
->prev;

244 
´oc
->
´ev
->
Ãxt
 =…roc;

245 
´oc
->
Ãxt
->
´ev
 =…roc;

248 
	`fdev’t_add
(
´oc
->
fde
, 
FDE_READ
);

250  
´oc
;

251 
	}
}

255 
	$jdwp_´oûss_ev’t
Ğ
sock‘
, 
ev’ts
, * 
_´oc
 )

257 
JdwpProûss
* 
´oc
 = 
»š‹½»t_ÿ¡
<JdwpProûss*>(
_´oc
);

259 ià(
ev’ts
 & 
FDE_READ
) {

260 ià(
´oc
->
pid
 < 0) {

262 * 
p
 = 
´oc
->
š_buff
 +…roc->
š_Ën
;

263 
size
 = 4 - 
´oc
->
š_Ën
;

264 
‹mp
[5];

265 
size
 > 0) {

266 
Ën
 = 
	`»cv
Ğ
sock‘
, 
p
, 
size
, 0 );

267 ià(
Ën
 < 0) {

268 ià(
”ºo
 =ğ
EINTR
)

270 ià(
”ºo
 =ğ
EAGAIN
)

273 
	`D
("weird unknown JDWP…rocess failure: %s\n",

274 
	`¡»¼Ü
(
”ºo
));

276 
Clo£Proûss
;

278 ià(
Ën
 == 0) {

279 
	`D
("weirdƒnd-of-stream from unknown JDWP…rocess\n");

280 
Clo£Proûss
;

282 
p
 +ğ
Ën
;

283 
´oc
->
š_Ën
 +ğ
Ën
;

284 
size
 -ğ
Ën
;

287 
	`memıy
(
‹mp
, 
´oc
->
š_buff
, 4);

288 
‹mp
[4] = 0;

290 ià(
	`ssÿnf
Ğ
‹mp
, "%04x", &
´oc
->
pid
 ) != 1) {

291 
	`D
("could‚Ù decodJDWP %°PID‚umb”: '%s'\n", 
´oc
, 
‹mp
);

292 
Clo£Proûss
;

296 
	`D
("Addšg…id %dØjdw°´oûs li¡\n", 
´oc
->
pid
);

297 
	`jdwp_´oûss_li¡_upd©ed
();

303 
buf
[32];

306 
Ën
 = 
	`»cv
(
sock‘
, 
buf
, (buf), 0);

308 ià(
Ën
 <= 0) {

309 ià(
Ën
 < 0 && 
”ºo
 =ğ
EINTR
)

311 ià(
Ën
 < 0 && 
”ºo
 =ğ
EAGAIN
)

314 
	`D
("‹rmš©šg JDWP %d cÚÃùiÚ: %s\n", 
´oc
->
pid
,

315 
	`¡»¼Ü
(
”ºo
));

320 
	`D
( "ignoring unexpected JDWP %d control socket‡ctivity (%d bytes)\n",

321 
´oc
->
pid
, 
Ën
 );

325 
Clo£Proûss
:

326 ià(
´oc
->
pid
 >= 0)

327 
	`D
Ğ"»movpid %dØjdw°´oûs li¡\n", 
´oc
->
pid
 );

328 
	`jdwp_´oûss_ä“
(
´oc
);

333 ià(
ev’ts
 & 
FDE_WRITE
) {

334 
	`D
("tryingo writeo JDWP…id controli (count=%d first=%d) %d\n",

335 
´oc
->
pid
,…roc->
out_couÁ
,…roc->
out_fds
[0]);

336 ià(
´oc
->
out_couÁ
 > 0) {

337 
fd
 = 
´oc
->
out_fds
[0];

338 
n
, 
»t
;

339 
cmsghdr
* 
cmsg
;

340 
msghdr
 
msg
;

341 
iovec
 
iov
;

342 
dummy
 = '!';

343 
bufãr
[(
cmsghdr
) + ()];

344 
æags
;

346 
iov
.
iov_ba£
 = &
dummy
;

347 
iov
.
iov_Ën
 = 1;

348 
msg
.
msg_Çme
 = 
NULL
;

349 
msg
.
msg_Çm–’
 = 0;

350 
msg
.
msg_iov
 = &
iov
;

351 
msg
.
msg_iovËn
 = 1;

352 
msg
.
msg_æags
 = 0;

353 
msg
.
msg_cÚŒŞ
 = 
bufãr
;

354 
msg
.
msg_cÚŒŞËn
 = (
bufãr
);

356 
cmsg
 = 
	`CMSG_FIRSTHDR
(&
msg
);

357 
cmsg
->
cmsg_Ën
 = 
msg
.
msg_cÚŒŞËn
;

358 
cmsg
->
cmsg_Ëv–
 = 
SOL_SOCKET
;

359 
cmsg
->
cmsg_ty³
 = 
SCM_RIGHTS
;

360 ((*)
	`CMSG_DATA
(
cmsg
))[0] = 
fd
;

362 
æags
 = 
	`fú
(
´oc
->
sock‘
,
F_GETFL
,0);

364 ià(
æags
 == -1) {

365 
	`D
("failedo get cntl flags for socket %d: %s\n",

366 
´oc
->
pid
, 
	`¡»¼Ü
(
”ºo
));

367 
Clo£Proûss
;

371 ià(
	`fú
(
´oc
->
sock‘
, 
F_SETFL
, 
æags
 & ~
O_NONBLOCK
) == -1) {

372 
	`D
("failedo„emove O_NONBLOCK flag for socket %d: %s\n",

373 
´oc
->
pid
, 
	`¡»¼Ü
(
”ºo
));

374 
Clo£Proûss
;

378 
»t
 = 
	`£ndmsg
(
´oc
->
sock‘
, &
msg
, 0);

379 ià(
»t
 >= 0) {

380 
	`adb_şo£
(
fd
);

383 ià(
”ºo
 =ğ
EINTR
)

385 
	`D
("sending‚ew file descriptoro JDWP %d failed: %s\n",

386 
´oc
->
pid
, 
	`¡»¼Ü
(
”ºo
));

387 
Clo£Proûss
;

390 
	`D
("sent file descriptor %do JDWP…rocess %d\n",

391 
fd
, 
´oc
->
pid
);

393 
n
 = 1;‚ < 
´oc
->
out_couÁ
;‚++)

394 
´oc
->
out_fds
[
n
-1] =…roc->out_fds[n];

396 ià(
	`fú
(
´oc
->
sock‘
, 
F_SETFL
, 
æags
) == -1) {

397 
	`D
("failedo set O_NONBLOCK flag for socket %d: %s\n",

398 
´oc
->
pid
, 
	`¡»¼Ü
(
”ºo
));

399 
Clo£Proûss
;

402 ià(--
´oc
->
out_couÁ
 == 0)

403 
	`fdev’t_d–
Ğ
´oc
->
fde
, 
FDE_WRITE
 );

406 
	}
}

410 
	$ü—‹_jdwp_cÚÃùiÚ_fd
(
pid
)

412 
JdwpProûss
* 
´oc
 = 
_jdwp_li¡
.
Ãxt
;

414 
	`D
("lookšg fÜ…id %d iÀJDWP…roûs li¡\n", 
pid
);

415  ; 
´oc
 !ğ&
_jdwp_li¡
;…roøğ´oc->
Ãxt
 ) {

416 ià(
´oc
->
pid
 ==…id) {

417 
FoundIt
;

420 
	`D
("search failed !!\n");

423 
FoundIt
:

425 
fds
[2];

427 ià(
´oc
->
out_couÁ
 >ğ
MAX_OUT_FDS
) {

428 
	`D
("%s:oo many…ending JDWP connection for…id %d\n",

429 
__FUNCTION__
, 
pid
);

433 ià(
	`adb_sock‘·œ
(
fds
) < 0) {

434 
	`D
("%s: socket…air creation failed: %s\n",

435 
__FUNCTION__
, 
	`¡»¼Ü
(
”ºo
));

438 
	`D
("sock‘·œ: (%d,%d)", 
fds
[0], fds[1]);

440 
´oc
->
out_fds
[…roc->
out_couÁ
 ] = 
fds
[1];

441 ià(++
´oc
->
out_couÁ
 == 1)

442 
	`fdev’t_add
Ğ
´oc
->
fde
, 
FDE_WRITE
 );

444  
fds
[0];

446 
	}
}

454 
	#JDWP_CONTROL_NAME
 "\0jdwp-cÚŒŞ"

	)

455 
	#JDWP_CONTROL_NAME_LEN
 ((
JDWP_CONTROL_NAME
)-1)

	)

457 
	sJdwpCÚŒŞ
 {

458 
	mli¡’_sock‘
;

459 
fdev’t
* 
	mfde
;

464 
jdwp_cÚŒŞ_ev’t
(
s
, 
ev’ts
, * 
u£r
);

468 
	$jdwp_cÚŒŞ_š™
Ğ
JdwpCÚŒŞ
* 
cÚŒŞ
,

469 cÚ¡ * 
sockÇme
,

470 
sockÇm–’
 )

472 
sockaddr_un
 
addr
;

473 
sockËn_t
 
add¾’
;

474 
s
;

475 
max·th
 = (
addr
.
sun_·th
);

476 
·thËn
 = 
sockÇm–’
;

478 ià(
·thËn
 >ğ
max·th
) {

479 
	`D
( "vm debug control socket‚ameoo†ong (%dƒxtra chars)\n",

480 
·thËn
+1-
max·th
 );

484 
	`mem£t
(&
addr
, 0, (addr));

485 
addr
.
sun_çmy
 = 
AF_UNIX
;

486 
	`memıy
(
addr
.
sun_·th
, 
sockÇme
, 
sockÇm–’
);

488 
s
 = 
	`sock‘
Ğ
AF_UNIX
, 
SOCK_STREAM
, 0 );

489 ià(
s
 < 0) {

490 
	`D
( "could‚ot create vm debug control socket. %d: %s\n",

491 
”ºo
, 
	`¡»¼Ü
(errno));

495 
add¾’
 = (
·thËn
 + (
addr
.
sun_çmy
));

497 ià(
	`bšd
(
s
, (
sockaddr
*)&
addr
, 
add¾’
) < 0) {

498 
	`D
( "could‚ot bind vm debug control socket: %d: %s\n",

499 
”ºo
, 
	`¡»¼Ü
(errno) );

500 
	`adb_şo£
(
s
);

504 iàĞ
	`li¡’
(
s
, 4) < 0 ) {

505 
	`D
("listen failed in jdwp control socket: %d: %s\n",

506 
”ºo
, 
	`¡»¼Ü
(errno));

507 
	`adb_şo£
(
s
);

511 
cÚŒŞ
->
li¡’_sock‘
 = 
s
;

513 
cÚŒŞ
->
fde
 = 
	`fdev’t_ü—‹
(
s
, 
jdwp_cÚŒŞ_ev’t
, control);

514 ià(
cÚŒŞ
->
fde
 =ğ
NULL
) {

515 
	`D
( "could‚ot create fdevent for jdwp control socket\n" );

516 
	`adb_şo£
(
s
);

521 
	`fdev’t_add
(
cÚŒŞ
->
fde
, 
FDE_READ
);

522 
	`şo£_Ú_exec
(
s
);

524 
	`D
("jdw°cÚŒŞ sock‘ s¹ed (%d)\n", 
cÚŒŞ
->
li¡’_sock‘
);

526 
	}
}

530 
	$jdwp_cÚŒŞ_ev’t
Ğ
s
, 
ev’ts
, * 
_cÚŒŞ
 )

532 
JdwpCÚŒŞ
* 
cÚŒŞ
 = (JdwpCÚŒŞ*è
_cÚŒŞ
;

534 ià(
ev’ts
 & 
FDE_READ
) {

535 
sockaddr
 
addr
;

536 
sockËn_t
 
add¾’
 = (
addr
);

537 
s
 = -1;

538 
JdwpProûss
* 
´oc
;

541 
s
 = 
	`adb_sock‘_acû±
Ğ
cÚŒŞ
->
li¡’_sock‘
, &
addr
, &
add¾’
 );

542 ià(
s
 < 0) {

543 ià(
”ºo
 =ğ
EINTR
)

545 ià(
”ºo
 =ğ
ECONNABORTED
) {

547 
	`D
("oops,he JDWP…rocess died„eally quick\n");

551 
	`D
( "weird‡ccept() failed on jdwp control socket: %s\n",

552 
	`¡»¼Ü
(
”ºo
) );

556 
s
 < 0);

558 
´oc
 = 
	`jdwp_´oûss_®loc
Ğ
s
 );

559 ià(
´oc
 =ğ
NULL
)

562 
	}
}

565 
JdwpCÚŒŞ
 
	g_jdwp_cÚŒŞ
;

571 
	sJdwpSock‘
 {

572 
asock‘
 
	msock‘
;

573 
	m·ss
;

577 
	$jdwp_sock‘_şo£
Ğ
asock‘
* 
s
 )

579 
asock‘
* 
³”
 = 
s
->peer;

581 
	`»move_sock‘
(
s
);

583 ià(
³”
) {

584 
³”
->³” = 
NULL
;

585 
³”
->
	`şo£
(peer);

587 
	`ä“
(
s
);

588 
	}
}

591 
	$jdwp_sock‘_’queue
Ğ
asock‘
* 
s
, 
­ack‘
* 
p
 )

594 
	`put_­ack‘
(
p
);

595 
s
->
³”
->
	`şo£
(s->peer);

597 
	}
}

601 
	$jdwp_sock‘_»ady
Ğ
asock‘
* 
s
 )

603 
JdwpSock‘
* 
jdwp
 = (JdwpSock‘*)
s
;

604 
asock‘
* 
³”
 = 
jdwp
->
sock‘
.peer;

609 ià(
jdwp
->
·ss
 == 0) {

610 
­ack‘
* 
p
 = 
	`g‘_­ack‘
();

611 
p
->
Ën
 = 
	`jdwp_´oûss_li¡
((*í->
d©a
, 
s
->
	`g‘_max_·ylßd
());

612 
³”
->
	`’queue
Õ“r, 
p
);

613 
jdwp
->
·ss
 = 1;

616 
³”
->
	`şo£
(peer);

618 
	}
}

620 
asock‘
*

621 
	$ü—‹_jdwp_£rviû_sock‘
( )

623 
JdwpSock‘
* 
s
 = 
»š‹½»t_ÿ¡
<JdwpSock‘*>(
	`ÿÎoc
((*s), 1));

625 ià(
s
 =ğ
NULL
)

626  
NULL
;

628 
	`š¡®l_loÿl_sock‘
(&
s
->
sock‘
);

630 
s
->
sock‘
.
»ady
 = 
jdwp_sock‘_»ady
;

631 
s
->
sock‘
.
’queue
 = 
jdwp_sock‘_’queue
;

632 
s
->
sock‘
.
şo£
 = 
jdwp_sock‘_şo£
;

633 
s
->
·ss
 = 0;

635  &
s
->
sock‘
;

636 
	}
}

643 
	sJdwpT¿ck”
 {

644 
asock‘
 
	msock‘
;

645 
JdwpT¿ck”
* 
	mÃxt
;

646 
JdwpT¿ck”
* 
	m´ev
;

647 
	mÃed_upd©e
;

650 
JdwpT¿ck”
 
	g_jdwp_Œack”s_li¡
;

654 
	$jdwp_´oûss_li¡_upd©ed
()

656 
bufãr
[1024];

657 
Ën
;

658 
JdwpT¿ck”
* 
t
 = 
_jdwp_Œack”s_li¡
.
Ãxt
;

660 
Ën
 = 
	`jdwp_´oûss_li¡_msg
(
bufãr
, (buffer));

662  ; 
t
 !ğ&
_jdwp_Œack”s_li¡
; =->
Ãxt
 ) {

663 
­ack‘
* 
p
 = 
	`g‘_­ack‘
();

664 
asock‘
* 
³”
 = 
t
->
sock‘
.peer;

665 
	`memıy
(
p
->
d©a
, 
bufãr
, 
Ën
);

666 
p
->
Ën
 =†en;

667 
³”
->
	`’queue
Ğ³”, 
p
 );

669 
	}
}

672 
	$jdwp_Œack”_şo£
Ğ
asock‘
* 
s
 )

674 
JdwpT¿ck”
* 
Œack”
 = (JdwpT¿ck”*è
s
;

675 
asock‘
* 
³”
 = 
s
->peer;

677 ià(
³”
) {

678 
³”
->³” = 
NULL
;

679 
³”
->
	`şo£
(peer);

682 
	`»move_sock‘
(
s
);

684 
Œack”
->
´ev
->
Ãxt
 =racker->next;

685 
Œack”
->
Ãxt
->
´ev
 =racker->prev;

687 
	`ä“
(
s
);

688 
	}
}

691 
	$jdwp_Œack”_»ady
Ğ
asock‘
* 
s
 )

693 
JdwpT¿ck”
* 
t
 = (JdwpT¿ck”*è
s
;

695 ià(
t
->
Ãed_upd©e
) {

696 
­ack‘
* 
p
 = 
	`g‘_­ack‘
();

697 
t
->
Ãed_upd©e
 = 0;

698 
p
->
Ën
 = 
	`jdwp_´oûss_li¡_msg
((*í->
d©a
, 
s
->
	`g‘_max_·ylßd
());

699 
s
->
³”
->
	`’queue
(s->³”, 
p
);

701 
	}
}

704 
	$jdwp_Œack”_’queue
Ğ
asock‘
* 
s
, 
­ack‘
* 
p
 )

707 
	`put_­ack‘
(
p
);

708 
s
->
³”
->
	`şo£
(s->peer);

710 
	}
}

713 
asock‘
*

714 
	$ü—‹_jdwp_Œack”_£rviû_sock‘
( )

716 
JdwpT¿ck”
* 
t
 = 
»š‹½»t_ÿ¡
<JdwpT¿ck”*>(
	`ÿÎoc
((*t), 1));

718 ià(
t
 =ğ
NULL
)

719  
NULL
;

721 
t
->
Ãxt
 = &
_jdwp_Œack”s_li¡
;

722 
t
->
´ev
 =->
Ãxt
->prev;

724 
t
->
Ãxt
->
´ev
 =;

725 
t
->
´ev
->
Ãxt
 =;

727 
	`š¡®l_loÿl_sock‘
(&
t
->
sock‘
);

729 
t
->
sock‘
.
»ady
 = 
jdwp_Œack”_»ady
;

730 
t
->
sock‘
.
’queue
 = 
jdwp_Œack”_’queue
;

731 
t
->
sock‘
.
şo£
 = 
jdwp_Œack”_şo£
;

732 
t
->
Ãed_upd©e
 = 1;

734  &
t
->
sock‘
;

735 
	}
}

739 
	$š™_jdwp
()

741 
_jdwp_li¡
.
Ãxt
 = &_jdwp_list;

742 
_jdwp_li¡
.
´ev
 = &_jdwp_list;

744 
_jdwp_Œack”s_li¡
.
Ãxt
 = &_jdwp_trackers_list;

745 
_jdwp_Œack”s_li¡
.
´ev
 = &_jdwp_trackers_list;

747  
	`jdwp_cÚŒŞ_š™
Ğ&
_jdwp_cÚŒŞ
,

748 
JDWP_CONTROL_NAME
,

749 
JDWP_CONTROL_NAME_LEN
 );

750 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/mutex_list.h

6 #iâdeà
ADB_MUTEX


7 #”rÜ 
ADB_MUTEX
 
nÙ
 
defšed
 
wh’
 
šşudšg
 
this
 
fe


9 
	$ADB_MUTEX
(
Œª¥Üt_lock
)

10 #ià
ADB_HOST


11 
	$ADB_MUTEX
(
loÿl_Œª¥Üts_lock
)

13 
	$ADB_MUTEX
(
usb_lock
)

22 
	$ADB_MUTEX
(
D_lock
)

24 #undeà
ADB_MUTEX


	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/qemu_tracing.cpp

21 
	~<¡d¬g.h
>

23 
	~"sysd•s.h
"

24 
	~"qemu_Œacšg.h
"

31 #undeà
İ’


32 #undeà
wr™e


33 
	#İ’
 
adb_İ’


	)

34 
	#wr™e
 
adb_wr™e


	)

35 
	~<h¬dw¬e/qemu_pe.h
>

36 #undeà
İ’


37 #undeà
wr™e


38 
	#İ’
 
___xxx_İ’


	)

39 
	#wr™e
 
___xxx_wr™e


	)

42 
	gadb_debug_qemu
 = -1;

45 
	$adb_qemu_Œaû_š™
()

47 
cÚ_Çme
[32];

49 ià(
adb_debug_qemu
 >= 0) {

54 
	`¢´štf
(
cÚ_Çme
, (con_name), "qemud:adb-debug");

55 
adb_debug_qemu
 = 
	`qemu_pe_İ’
(
cÚ_Çme
);

56  (
adb_debug_qemu
 >= 0) ? 0 : -1;

57 
	}
}

59 
	$adb_qemu_Œaû
(cÚ¡ * 
fmt
, ...)

61 
va_li¡
 
¬gs
;

62 
	`va_¡¬t
(
¬gs
, 
fmt
);

63 
msg
[1024];

65 ià(
adb_debug_qemu
 >= 0) {

66 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
¬gs
);

67 
	`adb_wr™e
(
adb_debug_qemu
, 
msg
, 
	`¡¾’
(msg));

69 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/qemu_tracing.h

21 #iâdeà
__QEMU_TRACING_H


22 
	#__QEMU_TRACING_H


	)

25 
adb_qemu_Œaû_š™
();

26 
adb_qemu_Œaû
(cÚ¡ * 
fmt
, ...);

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/remount_service.cpp

17 
	#TRACE_TAG
 
TRACE_ADB


	)

19 
	~"sysd•s.h
"

21 
	~<”ºo.h
>

22 
	~<fú.h
>

23 
	~<mÁ’t.h
>

24 
	~<¡dio.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

27 
	~<sys/mouÁ.h
>

28 
	~<uni¡d.h
>

30 
	~<¡ršg
>

32 
	~"adb.h
"

33 
	~"adb_io.h
"

34 
	~"adb_uts.h
"

35 
	~"cuts/´İ”t›s.h
"

38 
	g¡d
::
¡ršg
 
	$fšd_mouÁ
(cÚ¡ * 
dœ
) {

39 
¡d
::
unique_±r
<
FILE
, (*)(FILE*)> 
	`å
(
	`£tmÁ’t
("/´oc/mouÁs", "r"), 
’dmÁ’t
);

40 ià(!
å
) {

44 
mÁ’t
* 
e
;

45 (
e
 = 
	`g‘mÁ’t
(
å
.
	`g‘
())è!ğ
nuÎ±r
) {

46 ià(
	`¡rcmp
(
dœ
, 
e
->
mÁ_dœ
) == 0) {

47  
e
->
mÁ_f¢ame
;

51 
	}
}

53 
boŞ
 
	$make_block_deviû_wr™abË
(cÚ¡ 
¡d
::
¡ršg
& 
dev
) {

54 
fd
 = 
	`unix_İ’
(
dev
.
	`c_¡r
(), 
O_RDONLY
 | 
O_CLOEXEC
);

55 ià(
fd
 == -1) {

56  
çl£
;

59 
OFF
 = 0;

60 
boŞ
 
»suÉ
 = (
	`ioùl
(
fd
, 
BLKROSET
, &
OFF
) != -1);

61 
	`adb_şo£
(
fd
);

62  
»suÉ
;

63 
	}
}

65 
boŞ
 
	$»mouÁ_·¹™iÚ
(
fd
, cÚ¡ * 
dœ
) {

66 ià(!
	`dœeùÜy_exi¡s
(
dœ
)) {

67  
Œue
;

69 
¡d
::
¡ršg
 
dev
 = 
	`fšd_mouÁ
(
dœ
);

70 ià(
dev
.
	`em±y
()) {

71  
Œue
;

73 ià(!
	`make_block_deviû_wr™abË
(
dev
)) {

74 
	`Wr™eFdFmt
(
fd
, "remount of %s failed; couldn't make block device %s writable: %s\n",

75 
dœ
, 
dev
.
	`c_¡r
(), 
	`¡»¼Ü
(
”ºo
));

76  
çl£
;

78 ià(
	`mouÁ
(
dev
.
	`c_¡r
(), 
dœ
, "nÚe", 
MS_REMOUNT
, 
nuÎ±r
) == -1) {

79 
	`Wr™eFdFmt
(
fd
, "»mouÁ oà% çed: %s\n", 
dœ
, 
	`¡»¼Ü
(
”ºo
));

80  
çl£
;

82  
Œue
;

83 
	}
}

85 
	$»mouÁ_£rviû
(
fd
, * 
cook›
) {

86 ià(
	`g‘uid
() != 0) {

87 
	`Wr™eFdExaùly
(
fd
, "Not„unning‡s„oot. Try \"adb„oot\" first.\n");

88 
	`adb_şo£
(
fd
);

92 
´İ_buf
[
PROPERTY_VALUE_MAX
];

93 
	`´İ”ty_g‘
("·¹™iÚ.sy¡em.v”if›d", 
´İ_buf
, "");

94 
boŞ
 
sy¡em_v”if›d
 = (
	`¡¾’
(
´İ_buf
) > 0);

96 
	`´İ”ty_g‘
("·¹™iÚ.v’dÜ.v”if›d", 
´İ_buf
, "");

97 
boŞ
 
v’dÜ_v”if›d
 = (
	`¡¾’
(
´İ_buf
) > 0);

99 ià(
sy¡em_v”if›d
 || 
v’dÜ_v”if›d
) {

101 
boŞ
 
bÙh
 = 
sy¡em_v”if›d
 && 
v’dÜ_v”if›d
;

102 
	`Wr™eFdFmt
(
fd
,

104 
sy¡em_v”if›d
 ? "system" : "",

105 
bÙh
 ? "‡nd " : "",

106 
v’dÜ_v”if›d
 ? "vendor" : "",

107 
bÙh
 ? "s" : "");

108 
	`Wr™eFdExaùly
(
fd
,

114 
boŞ
 
sucûss
 = 
Œue
;

115 
sucûss
 &ğ
	`»mouÁ_·¹™iÚ
(
fd
, "/system");

116 
sucûss
 &ğ
	`»mouÁ_·¹™iÚ
(
fd
, "/vendor");

117 
sucûss
 &ğ
	`»mouÁ_·¹™iÚ
(
fd
, "/oem");

119 
	`Wr™eFdExaùly
(
fd
, 
sucûss
 ? "remount succeeded\n" : "remount failed\n");

121 
	`adb_şo£
(
fd
);

122 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/remount_service.h

17 #iâdeà
_REMOUNT_SERVICE_H_


18 
	#_REMOUNT_SERVICE_H_


	)

20 
	~<¡ršg
>

22 
boŞ
 
make_block_deviû_wr™abË
(cÚ¡ 
¡d
::
¡ršg
&);

23 
»mouÁ_£rviû
(, *);

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/services.cpp

17 
	#TRACE_TAG
 
TRACE_SERVICES


	)

19 
	~"sysd•s.h
"

21 
	~<”ºo.h
>

22 
	~<¡ddef.h
>

23 
	~<¡dio.h
>

24 
	~<¡dlib.h
>

25 
	~<¡ršg.h
>

27 #iâdeà
_WIN32


28 
	~<Ãtdb.h
>

29 
	~<Ãtš‘/š.h
>

30 
	~<sys/ioùl.h
>

31 
	~<uni¡d.h
>

34 
	~<ba£/fe.h
>

35 
	~<ba£/¡ršg´štf.h
>

36 
	~<ba£/¡ršgs.h
>

38 #ià!
ADB_HOST


39 
	~"cuts/ªdroid_»boÙ.h
"

40 
	~"cuts/´İ”t›s.h
"

43 
	~"adb.h
"

44 
	~"adb_io.h
"

45 
	~"fe_sync_£rviû.h
"

46 
	~"»mouÁ_£rviû.h
"

47 
	~"Œª¥Üt.h
"

49 
	s¡šfo
 {

50 (*
	mfunc
)(
	mfd
, *
	mcook›
);

51 
	mfd
;

52 *
	mcook›
;

56 *
	$£rviû_boÙ¡¿p_func
(*
x
)

58 
¡šfo
* 
¡i
 = 
»š‹½»t_ÿ¡
<¡šfo*>(
x
);

59 
¡i
->
	`func
(¡i->
fd
, sti->
cook›
);

60 
	`ä“
(
¡i
);

62 
	}
}

64 #ià!
ADB_HOST


66 
	$»¡¬t_roÙ_£rviû
(
fd
, *
cook›
) {

67 ià(
	`g‘uid
() == 0) {

68 
	`Wr™eFdExaùly
(
fd
, "adbd is‡lready„unning‡s„oot\n");

69 
	`adb_şo£
(
fd
);

71 
v®ue
[
PROPERTY_VALUE_MAX
];

72 
	`´İ”ty_g‘
("ro.debuggabË", 
v®ue
, "");

73 ià(
	`¡rcmp
(
v®ue
, "1") != 0) {

74 
	`Wr™eFdExaùly
(
fd
, "adbd cannot„un‡s„oot in…roduction builds\n");

75 
	`adb_şo£
(
fd
);

80 
	`´İ”ty_£t
("service.user.test", "1");

81 
	`Wr™eFdExaùly
(
fd
, "restarting‡dbd‡s„oot\n");

82 
	`adb_şo£
(
fd
);

84 
	}
}

86 
	$»¡¬t_uÄoÙ_£rviû
(
fd
, *
cook›
) {

87 ià(
	`g‘uid
() != 0) {

88 
	`Wr™eFdExaùly
(
fd
, "adbd‚ot„unning‡s„oot\n");

89 
	`adb_şo£
(
fd
);

92 
	`´İ”ty_£t
("service.user.test", "0");

93 
	`Wr™eFdExaùly
(
fd
, "restarting‡dbd‡s‚on„oot\n");

94 
	`adb_şo£
(
fd
);

96 
	}
}

98 
	$»¡¬t_tı_£rviû
(
fd
, *
cook›
) {

99 
pÜt
 = (è(
ušŒ_t
è
cook›
;

100 ià(
pÜt
 <= 0) {

101 
	`Wr™eFdFmt
(
fd
, "šv®id…Üˆ%d\n", 
pÜt
);

102 
	`adb_şo£
(
fd
);

106 
v®ue
[
PROPERTY_VALUE_MAX
];

107 
	`¢´štf
(
v®ue
, (v®ue), "%d", 
pÜt
);

108 
	`´İ”ty_£t
("£rviû.adb.tı.pÜt", 
v®ue
);

109 
	`Wr™eFdFmt
(
fd
, "»¡¬tšg iÀTCP modpÜt: %d\n", 
pÜt
);

110 
	`adb_şo£
(
fd
);

111 
	}
}

113 
	$»¡¬t_usb_£rviû
(
fd
, *
cook›
) {

114 
	`´İ”ty_£t
("service.adb.tcp.port", "0");

115 
	`Wr™eFdExaùly
(
fd
, "restarting in USB mode\n");

116 
	`adb_şo£
(
fd
);

117 
	}
}

119 
boŞ
 
	$»boÙ_£rviû_im¶
(
fd
, cÚ¡ * 
¬g
) {

120 cÚ¡ * 
»boÙ_¬g
 = 
¬g
;

121 
boŞ
 
auto_»boÙ
 = 
çl£
;

123 ià(
	`¡rcmp
(
»boÙ_¬g
, "sideload-auto-reboot") == 0) {

124 
auto_»boÙ
 = 
Œue
;

125 
»boÙ_¬g
 = "sideload";

130 ià(
	`¡rcmp
(
»boÙ_¬g
, "sideload") == 0) {

131 ià(
	`g‘uid
() != 0) {

132 
	`Wr™eFdExaùly
(
fd
, "'adb„oot' is„equired for 'adb„eboot sideload'.\n");

133  
çl£
;

136 cÚ¡ * cÚ¡ 
»cov”y_dœ
 = "/cache/recovery";

137 cÚ¡ * cÚ¡ 
commªd_fe
 = "/cache/recovery/command";

139 ià(
	`adb_mkdœ
(
»cov”y_dœ
, 0770è=ğ-1 && 
”ºo
 !ğ
EEXIST
) {

140 
	`D
("FaedØü—‹ dœeùÜy '%s': %s\n", 
»cov”y_dœ
, 
	`¡»¼Ü
(
”ºo
));

141  
çl£
;

144 
boŞ
 
wr™e_¡©us
 = 
ªdroid
::
ba£
::
	`Wr™eSŒšgToFe
(

145 
auto_»boÙ
 ? "--sid–ßd_auto_»boÙ" : "--sid–ßd", 
commªd_fe
);

146 ià(!
wr™e_¡©us
) {

147  
çl£
;

150 
»boÙ_¬g
 = "recovery";

153 
	`sync
();

155 
´İ”ty_v®
[
PROPERTY_VALUE_MAX
];

156 
»t
 = 
	`¢´štf
(
´İ”ty_v®
, Õrİ”ty_v®), "»boÙ,%s", 
»boÙ_¬g
);

157 ià(
»t
 >ğ
¡©ic_ÿ¡
<>((
´İ”ty_v®
))) {

158 
	`Wr™eFdFmt
(
fd
, "»boÙ sŒšgoØlÚg: %d\n", 
»t
);

159  
çl£
;

162 
»t
 = 
	`´İ”ty_£t
(
ANDROID_RB_PROPERTY
, 
´İ”ty_v®
);

163 ià(
»t
 < 0) {

164 
	`Wr™eFdFmt
(
fd
, "»boÙ faed: %d\n", 
»t
);

165  
çl£
;

168  
Œue
;

169 
	}
}

171 
	$»boÙ_£rviû
(
fd
, * 
¬g
)

173 ià(
	`»boÙ_£rviû_im¶
(
fd
, 
¡©ic_ÿ¡
<cÚ¡ *>(
¬g
))) {

176 
Œue
) {

177 
	`·u£
();

181 
	`ä“
(
¬g
);

182 
	`adb_şo£
(
fd
);

183 
	}
}

185 
	$»v”£_£rviû
(
fd
, * 
¬g
)

187 cÚ¡ * 
commªd
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
¬g
);

189 ià(
	`hªdË_fÜw¬d_»que¡
(
commªd
, 
kT¿n¥ÜtAny
, 
NULL
, 
fd
) < 0) {

190 
	`S’dFa
(
fd
, "not‡„everse forwarding command");

192 
	`ä“
(
¬g
);

193 
	`adb_şo£
(
fd
);

194 
	}
}

198 
ü—‹_£rviû_th»ad
((*
func
)(, *), *
cook›
)

200 
s
[2];

201 ià(
	`adb_sock‘·œ
(
s
)) {

202 
	`´štf
("cannot create service socket…air\n");

205 
	`D
("sock‘·œ: (%d,%d)", 
s
[0], s[1]);

207 
¡šfo
* 
¡i
 = 
»š‹½»t_ÿ¡
<¡šfo*>(
	`m®loc
((stinfo)));

208 ià(
¡i
 =ğ
nuÎ±r
) {

209 
	`çl
("cannot‡llocate stinfo");

211 
¡i
->
func
 = func;

212 
¡i
->
cook›
 = cookie;

213 
¡i
->
fd
 = 
s
[1];

215 
adb_th»ad_t
 
t
;

216 ià(
	`adb_th»ad_ü—‹
(&
t
, 
£rviû_boÙ¡¿p_func
, 
¡i
)) {

217 
	`ä“
(
¡i
);

218 
	`adb_şo£
(
s
[0]);

219 
	`adb_şo£
(
s
[1]);

220 
	`´štf
("cannot create servicehread\n");

224 
	`D
("£rviûh»ad s¹ed, %d:%d\n",
s
[0], s[1]);

225  
s
[0];

226 
	}
}

228 #ià!
ADB_HOST


230 
	$š™_sub´oc_chd
()

232 
	`£tsid
();

235 
fd
 = 
	`adb_İ’
("/´oc/£lf/oom_scÜe_adj", 
O_WRONLY
 | 
O_CLOEXEC
);

236 ià(
fd
 >= 0) {

237 
	`adb_wr™e
(
fd
, "0", 1);

238 
	`adb_şo£
(
fd
);

240 
	`D
("adb: unableo update oom_score_adj\n");

242 
	}
}

244 
	$ü—‹_sub´oc_±y
(cÚ¡ *
cmd
, cÚ¡ *
¬g0
, cÚ¡ *
¬g1
, 
pid_t
 *
pid
)

246 
	`D
("ü—‹_sub´oc_±y(cmd=%s,‡rg0=%s,‡rg1=%s)\n", 
cmd
, 
¬g0
, 
¬g1
);

247 #ià
	`defšed
(
_WIN32
)

248 
	`årštf
(
¡d”r
, "”rÜ: c»©e_sub´oc_±y‚Ù im¶em’‹d oÀWš32 (% % %s)\n", 
cmd
, 
¬g0
, 
¬g1
);

251 
±m
;

253 
±m
 = 
	`unix_İ’
("/dev/±mx", 
O_RDWR
 | 
O_CLOEXEC
);

254 if(
±m
 < 0){

255 
	`´štf
("[ cªnÙ o³À/dev/±mx - % ]\n",
	`¡»¼Ü
(
”ºo
));

259 
devÇme
[64];

260 if(
	`g¿Á±
(
±m
è|| 
	`uÆock±
Õtmè|| 
	`±¢ame_r
Õtm, 
devÇme
, (devname)) != 0) {

261 
	`´štf
("[roubË w™h /dev/±mx - % ]\n", 
	`¡»¼Ü
(
”ºo
));

262 
	`adb_şo£
(
±m
);

266 *
pid
 = 
	`fÜk
();

267 if(*
pid
 < 0) {

268 
	`´štf
("- fÜk faed: % -\n", 
	`¡»¼Ü
(
”ºo
));

269 
	`adb_şo£
(
±m
);

273 ià(*
pid
 == 0) {

274 
	`š™_sub´oc_chd
();

276 
±s
 = 
	`unix_İ’
(
devÇme
, 
O_RDWR
 | 
O_CLOEXEC
);

277 ià(
±s
 < 0) {

278 
	`årštf
(
¡d”r
, "chd faedØİ’…£udo-‹rm sÏve: %s\n", 
devÇme
);

279 
	`ex™
(-1);

282 
	`dup2
(
±s
, 
STDIN_FILENO
);

283 
	`dup2
(
±s
, 
STDOUT_FILENO
);

284 
	`dup2
(
±s
, 
STDERR_FILENO
);

286 
	`adb_şo£
(
±s
);

287 
	`adb_şo£
(
±m
);

289 
	`exeş
(
cmd
, cmd, 
¬g0
, 
¬g1
, 
NULL
);

290 
	`årštf
(
¡d”r
, "-ƒxec '%s' failed: %s (%d) -\n",

291 
cmd
, 
	`¡»¼Ü
(
”ºo
),ƒrrno);

292 
	`ex™
(-1);

294  
±m
;

297 
	}
}

299 
	$ü—‹_sub´oc_¿w
(cÚ¡ *
cmd
, cÚ¡ *
¬g0
, cÚ¡ *
¬g1
, 
pid_t
 *
pid
)

301 
	`D
("ü—‹_sub´oc_¿w(cmd=%s,‡rg0=%s,‡rg1=%s)\n", 
cmd
, 
¬g0
, 
¬g1
);

302 #ià
	`defšed
(
_WIN32
)

303 
	`årštf
(
¡d”r
, "”rÜ: c»©e_sub´oc_¿w‚Ù im¶em’‹d oÀWš32 (% % %s)\n", 
cmd
, 
¬g0
, 
¬g1
);

308 
sv
[2];

309 ià(
	`adb_sock‘·œ
(
sv
) < 0) {

310 
	`´štf
("[ cªnÙ c»©sock‘…aœ - % ]\n", 
	`¡»¼Ü
(
”ºo
));

313 
	`D
("sock‘·œ: (%d,%d)", 
sv
[0], sv[1]);

315 *
pid
 = 
	`fÜk
();

316 ià(*
pid
 < 0) {

317 
	`´štf
("- fÜk faed: % -\n", 
	`¡»¼Ü
(
”ºo
));

318 
	`adb_şo£
(
sv
[0]);

319 
	`adb_şo£
(
sv
[1]);

323 ià(*
pid
 == 0) {

324 
	`adb_şo£
(
sv
[0]);

325 
	`š™_sub´oc_chd
();

327 
	`dup2
(
sv
[1], 
STDIN_FILENO
);

328 
	`dup2
(
sv
[1], 
STDOUT_FILENO
);

329 
	`dup2
(
sv
[1], 
STDERR_FILENO
);

331 
	`adb_şo£
(
sv
[1]);

333 
	`exeş
(
cmd
, cmd, 
¬g0
, 
¬g1
, 
NULL
);

334 
	`årštf
(
¡d”r
, "-ƒxec '%s' failed: %s (%d) -\n",

335 
cmd
, 
	`¡»¼Ü
(
”ºo
),ƒrrno);

336 
	`ex™
(-1);

338 
	`adb_şo£
(
sv
[1]);

339  
sv
[0];

342 
	}
}

345 #ià
ADB_HOST


346 
	#SHELL_COMMAND
 "/bš/sh"

	)

348 
	#SHELL_COMMAND
 "/sy¡em/bš/sh"

	)

351 #ià!
ADB_HOST


352 
	$sub´oc_wa™”_£rviû
(
fd
, *
cook›
)

354 
pid_t
 
pid
 = (pid_tè(
ušŒ_t
è
cook›
;

356 
	`D
("’‹»d. fd=%d oàpid=%d\n", 
fd
, 
pid
);

357 
Œue
) {

358 
¡©us
;

359 
pid_t
 
p
 = 
	`wa™pid
(
pid
, &
¡©us
, 0);

360 ià(
p
 =ğ
pid
) {

361 
	`D
("fd=%d,…o¡ wa™pidÕid=%dè¡©us=%04x\n", 
fd
, 
p
, 
¡©us
);

362 ià(
	`WIFSIGNALED
(
¡©us
)) {

363 
	`D
("*** KËd by sigÇÈ%d\n", 
	`WTERMSIG
(
¡©us
));

365 } ià(!
	`WIFEXITED
(
¡©us
)) {

366 
	`D
("*** Didn'ˆex™!!. stu %d\n", 
¡©us
);

368 } ià(
	`WEXITSTATUS
(
¡©us
) >= 0) {

369 
	`D
("*** Ex™ cod%d\n", 
	`WEXITSTATUS
(
¡©us
));

374 
	`D
("sh–Èex™ed fd=%d oàpid=%dƒ¼=%d\n", 
fd
, 
pid
, 
”ºo
);

375 ià(
SHELL_EXIT_NOTIFY_FD
 >=0) {

376 
»s
;

377 
»s
 = 
	`Wr™eFdExaùly
(
SHELL_EXIT_NOTIFY_FD
, &
fd
, (fd)) ? 0 : -1;

378 
	`D
("notified shellƒxit via fd=%d for…id=%d„es=%dƒrrno=%d\n",

379 
SHELL_EXIT_NOTIFY_FD
, 
pid
, 
»s
, 
”ºo
);

381 
	}
}

383 
	$ü—‹_sub´oc_th»ad
(cÚ¡ *
Çme
, cÚ¡ 
sub´oc_mode
 
mode
)

385 
adb_th»ad_t
 
t
;

386 
»t_fd
;

387 
pid_t
 
pid
 = -1;

389 cÚ¡ *
¬g0
, *
¬g1
;

390 ià(
Çme
 == 0 || *name == 0) {

391 
¬g0
 = "-"; 
¬g1
 = 0;

393 
¬g0
 = "-c"; 
¬g1
 = 
Çme
;

396 
mode
) {

397 
SUBPROC_PTY
:

398 
»t_fd
 = 
	`ü—‹_sub´oc_±y
(
SHELL_COMMAND
, 
¬g0
, 
¬g1
, &
pid
);

400 
SUBPROC_RAW
:

401 
»t_fd
 = 
	`ü—‹_sub´oc_¿w
(
SHELL_COMMAND
, 
¬g0
, 
¬g1
, &
pid
);

404 
	`årštf
(
¡d”r
, "šv®id sub´oc_mod%d\n", 
mode
);

407 
	`D
("ü—‹_sub´oø»t_fd=%d…id=%d\n", 
»t_fd
, 
pid
);

409 
¡šfo
* 
¡i
 = 
»š‹½»t_ÿ¡
<¡šfo*>(
	`m®loc
((stinfo)));

410 if(
¡i
 =ğ0è
	`çl
("cannot‡llocate stinfo");

411 
¡i
->
func
 = 
sub´oc_wa™”_£rviû
;

412 
¡i
->
cook›
 = (*è(
ušŒ_t
è
pid
;

413 
¡i
->
fd
 = 
»t_fd
;

415 ià(
	`adb_th»ad_ü—‹
(&
t
, 
£rviû_boÙ¡¿p_func
, 
¡i
)) {

416 
	`ä“
(
¡i
);

417 
	`adb_şo£
(
»t_fd
);

418 
	`årštf
(
¡d”r
, "cannot create servicehread\n");

422 
	`D
("£rviûh»ad s¹ed, fd=%d…id=%d\n", 
»t_fd
, 
pid
);

423  
»t_fd
;

424 
	}
}

427 
	$£rviû_to_fd
(cÚ¡ *
Çme
)

429 
»t
 = -1;

431 if(!
	`¡ºcmp
(
Çme
, "tcp:", 4)) {

432 
pÜt
 = 
	`©oi
(
Çme
 + 4);

433 
Çme
 = 
	`¡rchr
(name + 4, ':');

434 if(
Çme
 == 0) {

435 
»t
 = 
	`sock‘_loİback_ş›Á
(
pÜt
, 
SOCK_STREAM
);

436 ià(
»t
 >= 0)

437 
	`di§bË_tı_ÇgË
(
»t
);

439 #ià
ADB_HOST


440 
»t
 = 
	`sock‘_ÃtwÜk_ş›Á
(
Çme
 + 1, 
pÜt
, 
SOCK_STREAM
);

445 #iâdeà
HAVE_WINSOCK


446 } if(!
	`¡ºcmp
(
Çme
, "local:", 6)) {

447 
»t
 = 
	`sock‘_loÿl_ş›Á
(
Çme
 + 6,

448 
ANDROID_SOCKET_NAMESPACE_RESERVED
, 
SOCK_STREAM
);

449 } if(!
	`¡ºcmp
(
Çme
, "localreserved:", 14)) {

450 
»t
 = 
	`sock‘_loÿl_ş›Á
(
Çme
 + 14,

451 
ANDROID_SOCKET_NAMESPACE_RESERVED
, 
SOCK_STREAM
);

452 } if(!
	`¡ºcmp
(
Çme
, "localabstract:", 14)) {

453 
»t
 = 
	`sock‘_loÿl_ş›Á
(
Çme
 + 14,

454 
ANDROID_SOCKET_NAMESPACE_ABSTRACT
, 
SOCK_STREAM
);

455 } if(!
	`¡ºcmp
(
Çme
, "localfilesystem:", 16)) {

456 
»t
 = 
	`sock‘_loÿl_ş›Á
(
Çme
 + 16,

457 
ANDROID_SOCKET_NAMESPACE_FILESYSTEM
, 
SOCK_STREAM
);

459 #ià!
ADB_HOST


460 } if(!
	`¡ºcmp
("dev:", 
Çme
, 4)) {

461 
»t
 = 
	`unix_İ’
(
Çme
 + 4, 
O_RDWR
 | 
O_CLOEXEC
);

462 } if(!
	`¡ºcmp
(
Çme
, "framebuffer:", 12)) {

463 
»t
 = 
	`ü—‹_£rviû_th»ad
(
äamebufãr_£rviû
, 0);

464 } ià(!
	`¡ºcmp
(
Çme
, "jdwp:", 5)) {

465 
»t
 = 
	`ü—‹_jdwp_cÚÃùiÚ_fd
(
	`©oi
(
Çme
+5));

466 } if(!
HOST
 && !
	`¡ºcmp
(
Çme
, "shell:", 6)) {

467 
»t
 = 
	`ü—‹_sub´oc_th»ad
(
Çme
 + 6, 
SUBPROC_PTY
);

468 } if(!
HOST
 && !
	`¡ºcmp
(
Çme
, "exec:", 5)) {

469 
»t
 = 
	`ü—‹_sub´oc_th»ad
(
Çme
 + 5, 
SUBPROC_RAW
);

470 } if(!
	`¡ºcmp
(
Çme
, "sync:", 5)) {

471 
»t
 = 
	`ü—‹_£rviû_th»ad
(
fe_sync_£rviû
, 
NULL
);

472 } if(!
	`¡ºcmp
(
Çme
, "remount:", 8)) {

473 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»mouÁ_£rviû
, 
NULL
);

474 } if(!
	`¡ºcmp
(
Çme
, "reboot:", 7)) {

475 * 
¬g
 = 
	`¡rdup
(
Çme
 + 7);

476 ià(
¬g
 =ğ
NULL
)  -1;

477 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»boÙ_£rviû
, 
¬g
);

478 } if(!
	`¡ºcmp
(
Çme
, "root:", 5)) {

479 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»¡¬t_roÙ_£rviû
, 
NULL
);

480 } if(!
	`¡ºcmp
(
Çme
, "unroot:", 7)) {

481 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»¡¬t_uÄoÙ_£rviû
, 
NULL
);

482 } if(!
	`¡ºcmp
(
Çme
, "backup:", 7)) {

483 
»t
 = 
	`ü—‹_sub´oc_th»ad
(
ªdroid
::
ba£
::
	`SŒšgPrštf
("/system/bin/bu backup %s",

484 (
Çme
 + 7)).
	`c_¡r
(), 
SUBPROC_RAW
);

485 } if(!
	`¡ºcmp
(
Çme
, "restore:", 8)) {

486 
»t
 = 
	`ü—‹_sub´oc_th»ad
("/sy¡em/bš/bu„e¡Üe", 
SUBPROC_RAW
);

487 } if(!
	`¡ºcmp
(
Çme
, "tcpip:", 6)) {

488 
pÜt
;

489 ià(
	`ssÿnf
(
Çme
 + 6, "%d", &
pÜt
) != 1) {

490 
pÜt
 = 0;

492 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»¡¬t_tı_£rviû
, (*è(
ušŒ_t
è
pÜt
);

493 } if(!
	`¡ºcmp
(
Çme
, "usb:", 4)) {

494 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»¡¬t_usb_£rviû
, 
NULL
);

495 } ià(!
	`¡ºcmp
(
Çme
, "reverse:", 8)) {

496 * 
cook›
 = 
	`¡rdup
(
Çme
 + 8);

497 ià(
cook›
 =ğ
NULL
) {

498 
»t
 = -1;

500 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»v”£_£rviû
, 
cook›
);

501 ià(
»t
 < 0) {

502 
	`ä“
(
cook›
);

505 } if(!
	`¡ºcmp
(
Çme
, "disable-verity:", 15)) {

506 
»t
 = 
	`ü—‹_£rviû_th»ad
(
£t_v”™y_’abËd_¡©e_£rviû
, (*)0);

507 } if(!
	`¡ºcmp
(
Çme
, "enable-verity:", 15)) {

508 
»t
 = 
	`ü—‹_£rviû_th»ad
(
£t_v”™y_’abËd_¡©e_£rviû
, (*)1);

511 ià(
»t
 >= 0) {

512 
	`şo£_Ú_exec
(
»t
);

514  
»t
;

515 
	}
}

517 #ià
ADB_HOST


518 
	s¡©e_šfo
 {

519 
Œª¥Üt_ty³
 
	mŒª¥Üt
;

520 * 
	m£rŸl
;

521 
	m¡©e
;

524 
	$wa™_fÜ_¡©e
(
fd
, * 
cook›
)

526 
¡©e_šfo
* 
sšfo
 = 
»š‹½»t_ÿ¡
<¡©e_šfo*>(
cook›
);

528 
	`D
("wa™_fÜ_¡©%d\n", 
sšfo
->
¡©e
);

530 
¡d
::
¡ršg
 
”rÜ_msg
 = "unknownƒrror";

531 
©¿n¥Üt
* 
t
 = 
	`acquœe_Úe_Œª¥Üt
(
sšfo
->
¡©e
, sšfo->
Œª¥Üt
, sšfo->
£rŸl
, &
”rÜ_msg
);

532 ià(
t
 != 0) {

533 
	`S’dOkay
(
fd
);

535 
	`S’dFa
(
fd
, 
”rÜ_msg
);

538 ià(
sšfo
->
£rŸl
)

539 
	`ä“
(
sšfo
->
£rŸl
);

540 
	`ä“
(
sšfo
);

541 
	`adb_şo£
(
fd
);

542 
	`D
("wait_for_state is done\n");

543 
	}
}

545 
	$cÚÃù_deviû
(cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, std::¡ršg* 
»¥Ú£
) {

546 ià(
ho¡
.
	`em±y
()) {

547 *
»¥Ú£
 = "empty host‚ame";

551 
¡d
::
veùÜ
<¡d::
¡ršg
> 
p›ûs
 = 
ªdroid
::
ba£
::
	`S¶™
(
ho¡
, ":");

552 cÚ¡ 
¡d
::
¡ršg
& 
ho¡Çme
 = 
p›ûs
[0];

554 
pÜt
 = 
DEFAULT_ADB_LOCAL_TRANSPORT_PORT
;

555 ià(
p›ûs
.
	`size
() > 1) {

556 ià(
	`ssÿnf
(
p›ûs
[1].
	`c_¡r
(), "%d", &
pÜt
) != 1) {

557 *
»¥Ú£
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("bad…Üˆnumb” %s", 
p›ûs
[1].
	`c_¡r
());

564 
¡d
::
¡ršg
 
£rŸl
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("%s:%d", 
ho¡Çme
.
	`c_¡r
(), 
pÜt
);

566 
fd
 = 
	`sock‘_ÃtwÜk_ş›Á_timeout
(
ho¡Çme
.
	`c_¡r
(), 
pÜt
, 
SOCK_STREAM
, 10);

567 ià(
fd
 < 0) {

568 *
»¥Ú£
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("unableo connecto %s:%d",

569 
ho¡Çme
.
	`c_¡r
(), 
pÜt
);

573 
	`D
("ş›Á: cÚÃùed oÀ»mÙÚ fd %d\n", 
fd
);

574 
	`şo£_Ú_exec
(
fd
);

575 
	`di§bË_tı_ÇgË
(
fd
);

577 
»t
 = 
	`»gi¡”_sock‘_Œª¥Üt
(
fd
, 
£rŸl
.
	`c_¡r
(), 
pÜt
, 0);

578 ià(
»t
 < 0) {

579 
	`adb_şo£
(
fd
);

580 *
»¥Ú£
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("®»ady cÚÃùedØ%s", 
£rŸl
.
	`c_¡r
());

582 *
»¥Ú£
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("cÚÃùedØ%s", 
£rŸl
.
	`c_¡r
());

584 
	}
}

586 
	$cÚÃù_emuÏtÜ
(cÚ¡ 
¡d
::
¡ršg
& 
pÜt_¥ec
, std::¡ršg* 
»¥Ú£
) {

587 
¡d
::
veùÜ
<¡d::
¡ršg
> 
p›ûs
 = 
ªdroid
::
ba£
::
	`S¶™
(
pÜt_¥ec
, ",");

588 ià(
p›ûs
.
	`size
() != 2) {

589 *
»¥Ú£
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("unableo…arse '%s'‡s <console…ort>,<adb…ort>",

590 
pÜt_¥ec
.
	`c_¡r
());

594 
cÚsŞe_pÜt
 = 
	`¡¹Ş
(
p›ûs
[0].
	`c_¡r
(), 
NULL
, 0);

595 
adb_pÜt
 = 
	`¡¹Ş
(
p›ûs
[1].
	`c_¡r
(), 
NULL
, 0);

596 ià(
cÚsŞe_pÜt
 <ğ0 || 
adb_pÜt
 <= 0) {

597 *
»¥Ú£
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("Inv®id…Üˆnumb”s: %s", 
pÜt_¥ec
.
	`c_¡r
());

608 
©¿n¥Üt
* 
known_emuÏtÜ
 = 
	`fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt
(
adb_pÜt
);

609 ià(
known_emuÏtÜ
 !ğ
nuÎ±r
) {

610 *
»¥Ú£
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("EmuÏtÜ‡Ì—dy„egi¡”ed oÀpÜˆ%d", 
adb_pÜt
);

616 
ÿndid©e_¦Ù
 = 
	`g‘_avaabË_loÿl_Œª¥Üt_šdex
();

617 ià(
ÿndid©e_¦Ù
 < 0) {

618 *
»¥Ú£
 = "Cannot‡ccept moreƒmulators";

623 ià(!
	`loÿl_cÚÃù_¬b™¿ry_pÜts
(
cÚsŞe_pÜt
, 
adb_pÜt
)) {

624 *
»¥Ú£
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("Connectedoƒmulator on…orts %d,%d",

625 
cÚsŞe_pÜt
, 
adb_pÜt
);

627 *
»¥Ú£
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("Could‚ot connectoƒmulator on…orts %d,%d",

628 
cÚsŞe_pÜt
, 
adb_pÜt
);

630 
	}
}

632 
	$cÚÃù_£rviû
(
fd
, * 
cook›
)

634 *
ho¡
 = 
»š‹½»t_ÿ¡
<*>(
cook›
);

636 
¡d
::
¡ršg
 
»¥Ú£
;

637 ià(!
	`¡ºcmp
(
ho¡
, "emu:", 4)) {

638 
	`cÚÃù_emuÏtÜ
(
ho¡
 + 4, &
»¥Ú£
);

640 
	`cÚÃù_deviû
(
ho¡
, &
»¥Ú£
);

644 
	`S’dPrÙocŞSŒšg
(
fd
, 
»¥Ú£
);

645 
	`adb_şo£
(
fd
);

646 
	}
}

649 #ià
ADB_HOST


650 
asock‘
* 
	$ho¡_£rviû_to_sock‘
(cÚ¡ * 
Çme
, cÚ¡ *
£rŸl
)

652 ià(!
	`¡rcmp
(
Çme
,"track-devices")) {

653  
	`ü—‹_deviû_Œack”
();

654 } ià(!
	`¡ºcmp
(
Çme
, "wa™-fÜ-", 
	`¡¾’
("wait-for-"))) {

655 autØ
sšfo
 = 
»š‹½»t_ÿ¡
<
¡©e_šfo
*>(
	`m®loc
((state_info)));

656 ià(
sšfo
 =ğ
nuÎ±r
) {

657 
	`årštf
(
¡d”r
, "couldn'ˆ®loÿ‹ s‹_šfo: %s", 
	`¡»¼Ü
(
”ºo
));

658  
NULL
;

661 ià(
£rŸl
)

662 
sšfo
->
£rŸl
 = 
	`¡rdup
(serial);

664 
sšfo
->
£rŸl
 = 
NULL
;

666 
Çme
 +ğ
	`¡¾’
("wait-for-");

668 ià(!
	`¡ºcmp
(
Çme
, "loÿl", 
	`¡¾’
("local"))) {

669 
sšfo
->
Œª¥Üt
 = 
kT¿n¥ÜtLoÿl
;

670 
sšfo
->
¡©e
 = 
CS_DEVICE
;

671 } ià(!
	`¡ºcmp
(
Çme
, "usb", 
	`¡¾’
("usb"))) {

672 
sšfo
->
Œª¥Üt
 = 
kT¿n¥ÜtUsb
;

673 
sšfo
->
¡©e
 = 
CS_DEVICE
;

674 } ià(!
	`¡ºcmp
(
Çme
, "ªy", 
	`¡¾’
("any"))) {

675 
sšfo
->
Œª¥Üt
 = 
kT¿n¥ÜtAny
;

676 
sšfo
->
¡©e
 = 
CS_DEVICE
;

678 
	`ä“
(
sšfo
);

679  
NULL
;

682 
fd
 = 
	`ü—‹_£rviû_th»ad
(
wa™_fÜ_¡©e
, 
sšfo
);

683  
	`ü—‹_loÿl_sock‘
(
fd
);

684 } ià(!
	`¡ºcmp
(
Çme
, "connect:", 8)) {

685 cÚ¡ *
ho¡
 = 
Çme
 + 8;

686 
fd
 = 
	`ü—‹_£rviû_th»ad
(
cÚÃù_£rviû
, (*)
ho¡
);

687  
	`ü—‹_loÿl_sock‘
(
fd
);

689  
NULL
;

690 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/set_verity_enable_state_service.cpp

17 
	#TRACE_TAG
 
TRACE_ADB


	)

19 
	~"sysd•s.h
"

21 
	~<fú.h
>

22 
	~<š‰y³s.h
>

23 
	~<¡d¬g.h
>

24 
	~<¡dio.h
>

25 
	~<sys/¡©.h
>

27 
	~"cuts/´İ”t›s.h
"

29 
	~"adb.h
"

30 
	~"adb_io.h
"

31 
	~"ext4_sb.h
"

32 
	~"fs_mgr.h
"

33 
	~"»mouÁ_£rviû.h
"

35 
	#FSTAB_PREFIX
 "/f¡ab."

	)

36 
f¡ab
 *
	gf¡ab
;

38 #ifdeà
ALLOW_ADBD_DISABLE_VERITY


39 cÚ¡ 
boŞ
 
	gkAÎowDi§bËV”™y
 = 
Œue
;

41 cÚ¡ 
boŞ
 
	gkAÎowDi§bËV”™y
 = 
çl£
;

44 
	$g‘_rg‘_deviû_size
(
fd
, cÚ¡ *
blk_deviû
,

45 
ušt64_t
 *
deviû_size
)

47 
d©a_deviû
;

48 
ext4_su³r_block
 
sb
;

49 
fs_šfo
 
šfo
;

51 
šfo
.
Ën
 = 0;

53 
d©a_deviû
 = 
	`adb_İ’
(
blk_deviû
, 
O_RDONLY
 | 
O_CLOEXEC
);

54 ià(
d©a_deviû
 < 0) {

55 
	`Wr™eFdFmt
(
fd
, "E¼Ü o³nšg block deviû (%s)\n", 
	`¡»¼Ü
(
”ºo
));

59 ià(
	`l£ek64
(
d©a_deviû
, 1024, 
SEEK_SET
) < 0) {

60 
	`Wr™eFdFmt
(
fd
, "Error seekingo superblock\n");

61 
	`adb_şo£
(
d©a_deviû
);

65 ià(
	`adb_»ad
(
d©a_deviû
, &
sb
, (sb)) != (sb)) {

66 
	`Wr™eFdFmt
(
fd
, "Error„eading superblock\n");

67 
	`adb_şo£
(
d©a_deviû
);

71 
	`ext4_·r£_sb
(&
sb
, &
šfo
);

72 *
deviû_size
 = 
šfo
.
Ën
;

74 
	`adb_şo£
(
d©a_deviû
);

76 
	}
}

79 
	$£t_v”™y_’abËd_¡©e
(
fd
, cÚ¡ *
block_deviû
,

80 cÚ¡ * 
mouÁ_pošt
, 
boŞ
 
’abË
)

82 
ušt32_t
 
magic_numb”
;

83 cÚ¡ 
ušt32_t
 
Ãw_magic
 = 
’abË
 ? 
VERITY_METADATA_MAGIC_NUMBER


84 : 
VERITY_METADATA_MAGIC_DISABLE
;

85 
ušt64_t
 
deviû_Ëngth
 = 0;

86 
deviû
 = -1;

87 
»tv®
 = -1;

89 ià(!
	`make_block_deviû_wr™abË
(
block_deviû
)) {

90 
	`Wr™eFdFmt
(
fd
, "Could‚ot make block device %s writable (%s).\n",

91 
block_deviû
, 
	`¡»¼Ü
(
”ºo
));

92 
”rout
;

95 
deviû
 = 
	`adb_İ’
(
block_deviû
, 
O_RDWR
 | 
O_CLOEXEC
);

96 ià(
deviû
 == -1) {

97 
	`Wr™eFdFmt
(
fd
, "Could‚Ù o³Àblock deviû % (%s).\n", 
block_deviû
, 
	`¡»¼Ü
(
”ºo
));

98 
	`Wr™eFdFmt
(
fd
, "Maybe„un‡db„emount?\n");

99 
”rout
;

103 ià(
	`g‘_rg‘_deviû_size
(
fd
, (*)
block_deviû
, &
deviû_Ëngth
) < 0) {

104 
	`Wr™eFdFmt
(
fd
, "Could‚ot getarget device size.\n");

105 
”rout
;

108 ià(
	`l£ek64
(
deviû
, 
deviû_Ëngth
, 
SEEK_SET
) < 0) {

109 
	`Wr™eFdFmt
(
fd
, "Could‚ot seeko start of verity metadata block.\n");

110 
”rout
;

114 ià(
	`adb_»ad
(
deviû
, &
magic_numb”
, (magic_number)) != (magic_number)) {

115 
	`Wr™eFdFmt
(
fd
, "Couldn't„ead magic‚umber!\n");

116 
”rout
;

119 ià(!
’abË
 && 
magic_numb”
 =ğ
VERITY_METADATA_MAGIC_DISABLE
) {

120 
	`Wr™eFdFmt
(
fd
, "V”™y‡Ì—dy di§bËd oÀ%s\n", 
mouÁ_pošt
);

121 
”rout
;

124 ià(
’abË
 && 
magic_numb”
 =ğ
VERITY_METADATA_MAGIC_NUMBER
) {

125 
	`Wr™eFdFmt
(
fd
, "V”™y‡Ì—dyƒÇbËd oÀ%s\n", 
mouÁ_pošt
);

126 
”rout
;

129 ià(
magic_numb”
 !ğ
VERITY_METADATA_MAGIC_NUMBER


130 && 
magic_numb”
 !ğ
VERITY_METADATA_MAGIC_DISABLE
) {

131 
	`Wr™eFdFmt
(
fd
, "Couldn'ˆfšd v”™y m‘ad©¨© off£ˆ%" 
PRIu64
 "!\n", 
deviû_Ëngth
);

132 
”rout
;

135 ià(
	`l£ek64
(
deviû
, 
deviû_Ëngth
, 
SEEK_SET
) < 0) {

136 
	`Wr™eFdFmt
(
fd
, "Could‚ot seeko start of verity metadata block.\n");

137 
”rout
;

140 ià(
	`adb_wr™e
(
deviû
, &
Ãw_magic
, (new_magic)) != (new_magic)) {

141 
	`Wr™eFdFmt
(
fd
, "Could‚ot set verity %s flag on device %s withƒrror %s\n",

142 
’abË
 ? "enabled" : "disabled",

143 
block_deviû
, 
	`¡»¼Ü
(
”ºo
));

144 
”rout
;

147 
	`Wr™eFdFmt
(
fd
, "V”™y % Ú %s\n", 
’abË
 ? "’abËd" : "di§bËd", 
mouÁ_pošt
);

148 
»tv®
 = 0;

149 
”rout
:

150 ià(
deviû
 != -1)

151 
	`adb_şo£
(
deviû
);

152  
»tv®
;

153 
	}
}

155 
	$£t_v”™y_’abËd_¡©e_£rviû
(
fd
, * 
cook›
)

157 
boŞ
 
’abË
 = (
cook›
 !ğ
NULL
);

158 ià(
kAÎowDi§bËV”™y
) {

159 
f¡ab_f’ame
[
PROPERTY_VALUE_MAX
 + (
FSTAB_PREFIX
)];

160 
´İbuf
[
PROPERTY_VALUE_MAX
];

161 
i
;

162 
boŞ
 
ªy_chªged
 = 
çl£
;

164 
	`´İ”ty_g‘
("ro.£cu»", 
´İbuf
, "0");

165 ià(
	`¡rcmp
(
´İbuf
, "1")) {

166 
	`Wr™eFdFmt
(
fd
, "verity‚otƒnabled - ENG build\n");

167 
”rout
;

170 
	`´İ”ty_g‘
("ro.debuggabË", 
´İbuf
, "0");

171 ià(
	`¡rcmp
(
´İbuf
, "1")) {

172 
	`Wr™eFdFmt
(
fd
, "verity cannot be disabled/enabled - USER build\n");

173 
”rout
;

176 
	`´İ”ty_g‘
("ro.h¬dw¬e", 
´İbuf
, "");

177 
	`¢´štf
(
f¡ab_f’ame
, (f¡ab_f’ame), 
FSTAB_PREFIX
"%s",

178 
´İbuf
);

180 
f¡ab
 = 
	`fs_mgr_»ad_f¡ab
(
f¡ab_f’ame
);

181 ià(!
f¡ab
) {

182 
	`Wr™eFdFmt
(
fd
, "FaedØİ’ %s\nMaybruÀadb„oÙ?\n", 
f¡ab_f’ame
);

183 
”rout
;

187 
i
 = 0; i < 
f¡ab
->
num_’Œ›s
; i++) {

188 if(
	`fs_mgr_is_v”if›d
(&
f¡ab
->
»cs
[
i
])) {

189 ià(!
	`£t_v”™y_’abËd_¡©e
(
fd
, 
f¡ab
->
»cs
[
i
].
blk_deviû
,

190 
f¡ab
->
»cs
[
i
].
mouÁ_pošt
,

191 
’abË
)) {

192 
ªy_chªged
 = 
Œue
;

197 ià(
ªy_chªged
) {

198 
	`Wr™eFdFmt
(
fd
, "Now„eboot your device for settingsoakeƒffect\n");

201 
	`Wr™eFdFmt
(
fd
, "%s-verity only works for userdebug builds\n",

202 
’abË
 ? "enable" : "disable");

205 
”rout
:

206 
	`adb_şo£
(
fd
);

207 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/sockets.cpp

17 
	#TRACE_TAG
 
TRACE_SOCKETS


	)

19 
	~"sysd•s.h
"

21 
	~<ùy³.h
>

22 
	~<”ºo.h
>

23 
	~<¡dio.h
>

24 
	~<¡dlib.h
>

25 
	~<¡ršg.h
>

26 
	~<uni¡d.h
>

28 
	~<®gÜ™hm
>

29 
	~<mu‹x
>

30 
	~<¡ršg
>

31 
	~<veùÜ
>

33 #ià!
ADB_HOST


34 
	~"cuts/´İ”t›s.h
"

37 
	~"adb.h
"

38 
	~"adb_io.h
"

39 
	~"sysd•s/mu‹x.h
"

40 
	~"Œª¥Üt.h
"

42 #ià!
defšed
(
__BIONIC__
)

43 
usšg
 
	g¡d
::
»cursive_mu‹x
;

46 
	g»cursive_mu‹x
& 
	gloÿl_sock‘_li¡_lock
 = *
Ãw
 
»cursive_mu‹x
();

47 
	gloÿl_sock‘_Ãxt_id
 = 1;

49 
asock‘
 
	gloÿl_sock‘_li¡
 = {

50 .
Ãxt
 = &
loÿl_sock‘_li¡
,

51 .
	g´ev
 = &
loÿl_sock‘_li¡
,

58 
asock‘
 
	gloÿl_sock‘_şosšg_li¡
 = {

59 .
Ãxt
 = &
loÿl_sock‘_şosšg_li¡
,

60 .
	g´ev
 = &
loÿl_sock‘_şosšg_li¡
,

66 
asock‘
 *
	$fšd_loÿl_sock‘
(
loÿl_id
, 
³”_id
)

68 
asock‘
 *
s
;

69 
asock‘
 *
»suÉ
 = 
NULL
;

71 
¡d
::
lock_gu¬d
<
»cursive_mu‹x
> 
	`lock
(
loÿl_sock‘_li¡_lock
);

72 
s
 = 
loÿl_sock‘_li¡
.
Ãxt
; s != &local_socket_list; s = s->next) {

73 ià(
s
->
id
 !ğ
loÿl_id
)

75 ià(
³”_id
 =ğ0 || (
s
->
³”
 && s->³”->
id
 ==…eer_id)) {

76 
»suÉ
 = 
s
;

81  
»suÉ
;

82 
	}
}

85 
	$š£¹_loÿl_sock‘
(
asock‘
* 
s
,‡sock‘* 
li¡
)

87 
s
->
Ãxt
 = 
li¡
;

88 
s
->
´ev
 = s->
Ãxt
->prev;

89 
s
->
´ev
->
Ãxt
 = s;

90 
s
->
Ãxt
->
´ev
 = s;

91 
	}
}

93 
	$š¡®l_loÿl_sock‘
(
asock‘
* 
s
) {

94 
¡d
::
lock_gu¬d
<
»cursive_mu‹x
> 
	`lock
(
loÿl_sock‘_li¡_lock
);

96 
s
->
id
 = 
loÿl_sock‘_Ãxt_id
++;

99 ià(
loÿl_sock‘_Ãxt_id
 == 0) {

100 
	`çl
("local socket id overflow");

103 
	`š£¹_loÿl_sock‘
(
s
, &
loÿl_sock‘_li¡
);

104 
	}
}

106 
	$»move_sock‘
(
asock‘
 *
s
)

109 ià(
s
->
´ev
 && s->
Ãxt
)

111 
s
->
´ev
->
Ãxt
 = s->next;

112 
s
->
Ãxt
->
´ev
 = s->prev;

113 
s
->
Ãxt
 = 0;

114 
s
->
´ev
 = 0;

115 
s
->
id
 = 0;

117 
	}
}

119 
	$şo£_®l_sock‘s
(
©¿n¥Üt
 *
t
)

121 
asock‘
 *
s
;

125 
¡d
::
lock_gu¬d
<
»cursive_mu‹x
> 
	`lock
(
loÿl_sock‘_li¡_lock
);

126 
»¡¬t
:

127 
s
 = 
loÿl_sock‘_li¡
.
Ãxt
; s != &local_socket_list; s = s->next) {

128 ià(
s
->
Œª¥Üt
 =ğ
t
 || (s->
³”
 && s->peer->transport ==)) {

129 
s
->
	`şo£
(s);

130 
»¡¬t
;

133 
	}
}

135 
	$loÿl_sock‘_’queue
(
asock‘
 *
s
, 
­ack‘
 *
p
)

137 
	`D
("LS(%d):ƒnqueu%d\n", 
s
->
id
, 
p
->
Ën
);

139 
p
->
±r
 =…->
d©a
;

145 if(
s
->
pkt_fœ¡
) {

146 
’queue
;

152 
p
->
Ën
 > 0) {

153 
r
 = 
	`adb_wr™e
(
s
->
fd
, 
p
->
±r
,…->
Ën
);

154 if(
r
 > 0) {

155 
p
->
Ën
 -ğ
r
;

156 
p
->
±r
 +ğ
r
;

159 if((
r
 =ğ0è|| (
”ºo
 !ğ
EAGAIN
)) {

160 
	`D
Ğ"LS(%d):‚Ù„—dy,ƒ¼no=%d: %s\n", 
s
->
id
, 
”ºo
, 
	`¡»¼Ü
(errno) );

161 
s
->
	`şo£
(s);

168 if(
p
->
Ën
 == 0) {

169 
	`put_­ack‘
(
p
);

173 
’queue
:

174 
p
->
Ãxt
 = 0;

175 if(
s
->
pkt_fœ¡
) {

176 
s
->
pkt_Ï¡
->
Ãxt
 = 
p
;

178 
s
->
pkt_fœ¡
 = 
p
;

180 
s
->
pkt_Ï¡
 = 
p
;

183 
	`fdev’t_add
(&
s
->
fde
, 
FDE_WRITE
);

186 
	}
}

188 
	$loÿl_sock‘_»ady
(
asock‘
 *
s
)

192 
	`fdev’t_add
(&
s
->
fde
, 
FDE_READ
);

193 
	}
}

196 
	$loÿl_sock‘_de¡roy
(
asock‘
 *
s
)

198 
­ack‘
 *
p
, *
n
;

199 
ex™_Ú_şo£
 = 
s
->exit_on_close;

201 
	`D
("LS(%d): de¡royšg fde.fd=%d\n", 
s
->
id
, s->
fde
.
fd
);

206 
	`fdev’t_»move
(&
s
->
fde
);

209 
p
 = 
s
->
pkt_fœ¡
;…;… = 
n
) {

210 
	`D
("LS(%d): disÿrdšg %d by‹s\n", 
s
->
id
, 
p
->
Ën
);

211 
n
 = 
p
->
Ãxt
;

212 
	`put_­ack‘
(
p
);

214 
	`»move_sock‘
(
s
);

215 
	`ä“
(
s
);

217 ià(
ex™_Ú_şo£
) {

218 
	`D
("local_socket_destroy:ƒxiting\n");

219 
	`ex™
(1);

221 
	}
}

223 
	$loÿl_sock‘_şo£
(
asock‘
* 
s
) {

224 
	`D
("’‹»d†oÿl_sock‘_şo£. LS(%dèfd=%d", 
s
->
id
, s->
fd
);

225 
¡d
::
lock_gu¬d
<
»cursive_mu‹x
> 
	`lock
(
loÿl_sock‘_li¡_lock
);

226 ià(
s
->
³”
) {

227 
	`D
("LS(%d): closšg…“r.…“r->id=%d…“r->fd=%d", 
s
->
id
, s->
³”
->id, s->³”->
fd
);

232 ià(
s
->
³”
->
shutdown
) {

233 
s
->
³”
->
	`shutdown
(s->peer);

235 
s
->
³”
->³” = 
nuÎ±r
;

236 
s
->
³”
->
	`şo£
(s->peer);

237 
s
->
³”
 = 
nuÎ±r
;

243 ià(
s
->
şosšg
 || s->
pkt_fœ¡
 =ğ
NULL
) {

244 
id
 = 
s
->id;

245 
	`loÿl_sock‘_de¡roy
(
s
);

246 
	`D
("LS(%d): clo£d\n", 
id
);

252 
	`D
("LS(%d): closšg\n", 
s
->
id
);

253 
s
->
şosšg
 = 1;

254 
	`fdev’t_d–
(&
s
->
fde
, 
FDE_READ
);

255 
	`»move_sock‘
(
s
);

256 
	`D
("LS(%d):…uˆÚ sock‘_şosšg_li¡ fd=%d\n", 
s
->
id
, s->
fd
);

257 
	`š£¹_loÿl_sock‘
(
s
, &
loÿl_sock‘_şosšg_li¡
);

258 
	}
}

260 
	$loÿl_sock‘_ev’t_func
(
fd
, 
ev
, * 
_s
)

262 
asock‘
* 
s
 = 
»š‹½»t_ÿ¡
<asock‘*>(
_s
);

263 
	`D
("LS(%d):ƒv’t_func(fd=%d(==%d),ƒv=%04x)\n", 
s
->
id
, s->
fd
, fd, 
ev
);

268 ià(
ev
 & 
FDE_WRITE
) {

269 
­ack‘
* 
p
;

270 (
p
 = 
s
->
pkt_fœ¡
è!ğ
nuÎ±r
) {

271 
p
->
Ën
 > 0) {

272 
r
 = 
	`adb_wr™e
(
fd
, 
p
->
±r
,…->
Ën
);

273 ià(
r
 == -1) {

277 ià(
”ºo
 =ğ
EAGAIN
) {

280 } ià(
r
 > 0) {

281 
p
->
±r
 +ğ
r
;

282 
p
->
Ën
 -ğ
r
;

286 
	`D
(" closšg‡á” wr™beÿu£„=%d‡ndƒ¼nØi %d\n", 
r
, 
”ºo
);

287 
s
->
	`şo£
(s);

291 ià(
p
->
Ën
 == 0) {

292 
s
->
pkt_fœ¡
 = 
p
->
Ãxt
;

293 ià(
s
->
pkt_fœ¡
 == 0) {

294 
s
->
pkt_Ï¡
 = 0;

296 
	`put_­ack‘
(
p
);

303 ià(
s
->
şosšg
) {

304 
	`D
(" closing because 'closing' is set‡fter write\n");

305 
s
->
	`şo£
(s);

313 
	`fdev’t_d–
(&
s
->
fde
, 
FDE_WRITE
);

314 
s
->
³”
->
	`»ady
(s->peer);

318 ià(
ev
 & 
FDE_READ
) {

319 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

320 *
x
 = 
p
->
d©a
;

321 
is_eof
 = 0;

322 cÚ¡ 
size_t
 
max_·ylßd
 = 
s
->
	`g‘_max_·ylßd
();

323 
size_t
 
ava
 = 
max_·ylßd
;

324 
r
 = 0;

326 
ava
 > 0) {

327 
r
 = 
	`adb_»ad
(
fd
, 
x
, 
ava
);

328 
	`D
("LS(%d):…ost‡db_read(fd=%d,...)„=%d (errno=%d)‡vail=%zu\n",

329 
s
->
id
, s->
fd
, 
r
,„ < 0 ? 
”ºo
 : 0, 
ava
);

330 ià(
r
 == -1) {

331 ià(
”ºo
 =ğ
EAGAIN
) {

334 } ià(
r
 > 0) {

335 
ava
 -ğ
r
;

336 
x
 +ğ
r
;

341 
is_eof
 = 1;

344 
	`D
("LS(%d): fd=%d…ost‡vail†oop.„=%d is_eof=%d forced_eof=%d\n",

345 
s
->
id
, s->
fd
, 
r
, 
is_eof
, s->
fde
.
fÜû_eof
);

346 ià((
ava
 =ğ
max_·ylßd
è|| (
s
->
³”
 == 0)) {

347 
	`put_­ack‘
(
p
);

349 
p
->
Ën
 = 
max_·ylßd
 - 
ava
;

351 
r
 = 
s
->
³”
->
	`’queue
(s->³”, 
p
);

352 
	`D
("LS(%d): fd=%d…o¡…“r->’queue().„=%d\n", 
s
->
id
, s->
fd
,

353 
r
);

355 ià(
r
 < 0) {

367 ià(
r
 > 0) {

372 
	`fdev’t_d–
(&
s
->
fde
, 
FDE_READ
);

376 ià((
s
->
fde
.
fÜû_eof
 && !
r
è|| 
is_eof
) {

377 
	`D
(" closing because is_eof=%d„=%d s->fde.force_eof=%d\n",

378 
is_eof
, 
r
, 
s
->
fde
.
fÜû_eof
);

379 
s
->
	`şo£
(s);

383 ià(
ev
 & 
FDE_ERROR
){

388 
	`D
("LS(%d): FDE_ERROR (fd=%d)\n", 
s
->
id
, s->
fd
);

392 
	}
}

394 
asock‘
 *
	$ü—‹_loÿl_sock‘
(
fd
)

396 
asock‘
 *
s
 = 
»š‹½»t_ÿ¡
<asock‘*>(
	`ÿÎoc
(1, (asocket)));

397 ià(
s
 =ğ
NULL
è
	`çl
("cannot‡llocate socket");

398 
s
->
fd
 = fd;

399 
s
->
’queue
 = 
loÿl_sock‘_’queue
;

400 
s
->
»ady
 = 
loÿl_sock‘_»ady
;

401 
s
->
shutdown
 = 
NULL
;

402 
s
->
şo£
 = 
loÿl_sock‘_şo£
;

403 
	`š¡®l_loÿl_sock‘
(
s
);

405 
	`fdev’t_š¡®l
(&
s
->
fde
, 
fd
, 
loÿl_sock‘_ev’t_func
, s);

406 
	`D
("LS(%d): c»©ed (fd=%d)\n", 
s
->
id
, s->
fd
);

407  
s
;

408 
	}
}

410 
asock‘
 *
	$ü—‹_loÿl_£rviû_sock‘
(cÚ¡ *
Çme
)

412 #ià!
ADB_HOST


413 ià(!
	`¡rcmp
(
Çme
,"jdwp")) {

414  
	`ü—‹_jdwp_£rviû_sock‘
();

416 ià(!
	`¡rcmp
(
Çme
,"track-jdwp")) {

417  
	`ü—‹_jdwp_Œack”_£rviû_sock‘
();

420 
fd
 = 
	`£rviû_to_fd
(
Çme
);

421 if(
fd
 < 0)  0;

423 
asock‘
* 
s
 = 
	`ü—‹_loÿl_sock‘
(
fd
);

424 
	`D
("LS(%d): boundØ'%s' vŸ %d\n", 
s
->
id
, 
Çme
, 
fd
);

426 #ià!
ADB_HOST


427 
debug
[
PROPERTY_VALUE_MAX
];

428 ià(!
	`¡ºcmp
(
Çme
, "root:", 5))

429 
	`´İ”ty_g‘
("ro.debuggabË", 
debug
, "");

431 ià((!
	`¡ºcmp
(
Çme
, "roÙ:", 5è&& 
	`g‘uid
(è!ğ0 && 
	`¡rcmp
(
debug
, "1") == 0)

432 || (!
	`¡ºcmp
(
Çme
, "uÄoÙ:", 7è&& 
	`g‘uid
() == 0)

433 || !
	`¡ºcmp
(
Çme
, "usb:", 4)

434 || !
	`¡ºcmp
(
Çme
, "tcpip:", 6)) {

435 
	`D
("LS(%d):ƒÇblšgƒx™_Ú_şo£\n", 
s
->
id
);

436 
s
->
ex™_Ú_şo£
 = 1;

440  
s
;

441 
	}
}

443 #ià
ADB_HOST


444 
asock‘
 *
	$ü—‹_ho¡_£rviû_sock‘
(cÚ¡ *
Çme
, cÚ¡ * 
£rŸl
)

446 
asock‘
 *
s
;

448 
s
 = 
	`ho¡_£rviû_to_sock‘
(
Çme
, 
£rŸl
);

450 ià(
s
 !ğ
NULL
) {

451 
	`D
("LS(%dèboundØ'%s'\n", 
s
->
id
, 
Çme
);

452  
s
;

455  
s
;

456 
	}
}

462 
	s¬emÙesock‘
 {

463 
asock‘
 
	msock‘
;

464 
adiscÚÃù
 
	mdiscÚÃù
;

467 
	$»mÙe_sock‘_’queue
(
asock‘
 *
s
, 
­ack‘
 *
p
)

469 
	`D
("entered„emote_socket_enqueue RS(%d) WRITE fd=%d…eer.fd=%d\n",

470 
s
->
id
, s->
fd
, s->
³”
->fd);

471 
p
->
msg
.
commªd
 = 
A_WRTE
;

472 
p
->
msg
.
¬g0
 = 
s
->
³”
->
id
;

473 
p
->
msg
.
¬g1
 = 
s
->
id
;

474 
p
->
msg
.
d©a_Ëngth
 =…->
Ën
;

475 
	`£nd_·ck‘
(
p
, 
s
->
Œª¥Üt
);

477 
	}
}

479 
	$»mÙe_sock‘_»ady
(
asock‘
 *
s
)

481 
	`D
("entered„emote_socket_ready RS(%d) OKAY fd=%d…eer.fd=%d\n",

482 
s
->
id
, s->
fd
, s->
³”
->fd);

483 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

484 
p
->
msg
.
commªd
 = 
A_OKAY
;

485 
p
->
msg
.
¬g0
 = 
s
->
³”
->
id
;

486 
p
->
msg
.
¬g1
 = 
s
->
id
;

487 
	`£nd_·ck‘
(
p
, 
s
->
Œª¥Üt
);

488 
	}
}

490 
	$»mÙe_sock‘_shutdown
(
asock‘
 *
s
)

492 
	`D
("entered„emote_socket_shutdown RS(%d) CLOSE fd=%d…eer->fd=%d\n",

493 
s
->
id
, s->
fd
, s->
³”
?s->peer->fd:-1);

494 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

495 
p
->
msg
.
commªd
 = 
A_CLSE
;

496 if(
s
->
³”
) {

497 
p
->
msg
.
¬g0
 = 
s
->
³”
->
id
;

499 
p
->
msg
.
¬g1
 = 
s
->
id
;

500 
	`£nd_·ck‘
(
p
, 
s
->
Œª¥Üt
);

501 
	}
}

503 
	$»mÙe_sock‘_şo£
(
asock‘
 *
s
)

505 ià(
s
->
³”
) {

506 
s
->
³”
->peer = 0;

507 
	`D
("RS(%d)…eer->close()ing…eer->id=%d…eer->fd=%d\n",

508 
s
->
id
, s->
³”
->id, s->³”->
fd
);

509 
s
->
³”
->
	`şo£
(s->peer);

511 
	`D
("entered„emote_socket_close RS(%d) CLOSE fd=%d…eer->fd=%d\n",

512 
s
->
id
, s->
fd
, s->
³”
?s->peer->fd:-1);

513 
	`D
("RS(%d): clo£d\n", 
s
->
id
);

514 
	`»move_Œª¥Üt_discÚÃù
Ğ
s
->
Œª¥Üt
, &((
¬emÙesock‘
*)s)->
discÚÃù
 );

515 
	`ä“
(
s
);

516 
	}
}

518 
	$»mÙe_sock‘_discÚÃù
(* 
_s
, 
©¿n¥Üt
* 
t
)

520 
asock‘
* 
s
 = 
»š‹½»t_ÿ¡
<asock‘*>(
_s
);

521 
asock‘
* 
³”
 = 
s
->peer;

523 
	`D
("»mÙe_sock‘_discÚÃù RS(%d)\n", 
s
->
id
);

524 ià(
³”
) {

525 
³”
->³” = 
NULL
;

526 
³”
->
	`şo£
(peer);

528 
	`»move_Œª¥Üt_discÚÃù
Ğ
s
->
Œª¥Üt
, &((
¬emÙesock‘
*)s)->
discÚÃù
 );

529 
	`ä“
(
s
);

530 
	}
}

536 
asock‘
 *
	$ü—‹_»mÙe_sock‘
(
id
, 
©¿n¥Üt
 *
t
)

538 ià(
id
 =ğ0è
	`çl
("invalid„emote socket id (0)");

539 
asock‘
* 
s
 = 
»š‹½»t_ÿ¡
<asock‘*>(
	`ÿÎoc
(1, (
¬emÙesock‘
)));

540 
adiscÚÃù
* 
dis
 = &
»š‹½»t_ÿ¡
<
¬emÙesock‘
*>(
s
)->
discÚÃù
;

542 ià(
s
 =ğ
NULL
è
	`çl
("cannot‡llocate socket");

543 
s
->
id
 = id;

544 
s
->
’queue
 = 
»mÙe_sock‘_’queue
;

545 
s
->
»ady
 = 
»mÙe_sock‘_»ady
;

546 
s
->
shutdown
 = 
»mÙe_sock‘_shutdown
;

547 
s
->
şo£
 = 
»mÙe_sock‘_şo£
;

548 
s
->
Œª¥Üt
 = 
t
;

550 
dis
->
func
 = 
»mÙe_sock‘_discÚÃù
;

551 
dis
->
İaque
 = 
s
;

552 
	`add_Œª¥Üt_discÚÃù
Ğ
t
, 
dis
 );

553 
	`D
("RS(%d): c»©ed\n", 
s
->
id
);

554  
s
;

555 
	}
}

557 
	$cÚÃù_to_»mÙe
(
asock‘
 *
s
, cÚ¡ *
de¡š©iÚ
)

559 
	`D
("CÚÃù_to_»mÙÿÎ RS(%dèfd=%d\n", 
s
->
id
, s->
fd
);

560 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

561 
size_t
 
Ën
 = 
	`¡¾’
(
de¡š©iÚ
) + 1;

563 if(
Ën
 > (
s
->
	`g‘_max_·ylßd
()-1)) {

564 
	`çl
("destination oversized");

567 
	`D
("LS(%d): cÚÃù('%s')\n", 
s
->
id
, 
de¡š©iÚ
);

568 
p
->
msg
.
commªd
 = 
A_OPEN
;

569 
p
->
msg
.
¬g0
 = 
s
->
id
;

570 
p
->
msg
.
d©a_Ëngth
 = 
Ën
;

571 
	`¡rıy
((*è
p
->
d©a
, 
de¡š©iÚ
);

572 
	`£nd_·ck‘
(
p
, 
s
->
Œª¥Üt
);

573 
	}
}

578 
	$loÿl_sock‘_»ady_nÙify
(
asock‘
 *
s
)

580 
s
->
»ady
 = 
loÿl_sock‘_»ady
;

581 
s
->
shutdown
 = 
NULL
;

582 
s
->
şo£
 = 
loÿl_sock‘_şo£
;

583 
	`S’dOkay
(
s
->
fd
);

584 
s
->
	`»ady
(s);

585 
	}
}

590 
	$loÿl_sock‘_şo£_nÙify
(
asock‘
 *
s
)

592 
s
->
»ady
 = 
loÿl_sock‘_»ady
;

593 
s
->
shutdown
 = 
NULL
;

594 
s
->
şo£
 = 
loÿl_sock‘_şo£
;

595 
	`S’dFa
(
s
->
fd
, "closed");

596 
s
->
	`şo£
(s);

597 
	}
}

599 
	$unhex
(*
s
, 
Ën
)

601 
n
 = 0, 
c
;

603 
Ën
-- > 0) {

604 (
c
 = *
s
++)) {

609 
c
 -= '0';

613 
c
 = c - 'a' + 10;

617 
c
 = c - 'A' + 10;

623 
n
 = (À<< 4è| 
c
;

626  
n
;

627 
	}
}

629 #ià
ADB_HOST


631 
	#PREFIX
(
¡r
è{ sŒ, (¡rè- 1 }

	)

632 cÚ¡ 
	s´efix_¡ruù
 {

633 cÚ¡ *
	m¡r
;

634 cÚ¡ 
size_t
 
	mËn
;

635 } 
	g´efixes
[] = {

636 
PREFIX
("usb:"),

637 
PREFIX
("product:"),

638 
PREFIX
("model:"),

639 
PREFIX
("device:"),

641 cÚ¡ 
	gnum_´efixes
 = ((
´efixes
) / (prefixes[0]));

647 *
	$sk_ho¡_£rŸl
(*
£rviû
) {

648 *
fœ¡_cŞÚ
, *
£rŸl_’d
;

649 
i
;

651 
i
 = 0; i < 
num_´efixes
; i++) {

652 ià(!
	`¡ºcmp
(
£rviû
, 
´efixes
[
i
].
¡r
,…»fixes[i].
Ën
))

653  
	`¡rchr
(
£rviû
 + 
´efixes
[
i
].
Ën
, ':');

656 
fœ¡_cŞÚ
 = 
	`¡rchr
(
£rviû
, ':');

657 ià(!
fœ¡_cŞÚ
) {

659  
NULL
;

661 
£rŸl_’d
 = 
fœ¡_cŞÚ
;

662 ià(
	`isdig™
(
£rŸl_’d
[1])) {

663 
£rŸl_’d
++;

664 (*
£rŸl_’d
è&& 
	`isdig™
(*serial_end)) {

665 
£rŸl_’d
++;

667 ià((*
£rŸl_’d
) != ':') {

669 
£rŸl_’d
 = 
fœ¡_cŞÚ
;

672  
£rŸl_’d
;

673 
	}
}

677 
	$sm¬t_sock‘_’queue
(
asock‘
 *
s
, 
­ack‘
 *
p
)

679 
Ën
;

680 #ià
ADB_HOST


681 *
£rviû
 = 
NULL
;

682 * 
£rŸl
 = 
NULL
;

683 
Œª¥Üt_ty³
 
‰y³
 = 
kT¿n¥ÜtAny
;

686 
	`D
("SS(%d):ƒnqueu%d\n", 
s
->
id
, 
p
->
Ën
);

688 if(
s
->
pkt_fœ¡
 == 0) {

689 
s
->
pkt_fœ¡
 = 
p
;

690 
s
->
pkt_Ï¡
 = 
p
;

692 if((
s
->
pkt_fœ¡
->
Ën
 + 
p
->Ënè> s->
	`g‘_max_·ylßd
()) {

693 
	`D
("SS(%d): ov”æow\n", 
s
->
id
);

694 
	`put_­ack‘
(
p
);

695 
ç
;

698 
	`memıy
(
s
->
pkt_fœ¡
->
d©a
 + s->pkt_fœ¡->
Ën
,

699 
p
->
d©a
,…->
Ën
);

700 
s
->
pkt_fœ¡
->
Ën
 +ğ
p
->len;

701 
	`put_­ack‘
(
p
);

703 
p
 = 
s
->
pkt_fœ¡
;

707 if(
p
->
Ën
 < 4)  0;

709 
Ën
 = 
	`unhex
(
p
->
d©a
, 4);

710 if((
Ën
 < 1) || (len > 1024)) {

711 
	`D
("SS(%d): bad siz(%d)\n", 
s
->
id
, 
Ën
);

712 
ç
;

715 
	`D
("SS(%d):†’ i %d\n", 
s
->
id
, 
Ën
 );

717 if((
Ën
 + 4è> 
p
->len) {

718 
	`D
("SS(%d): wa™šg fÜ %d mÜby‹s\n", 
s
->
id
, 
Ën
+4 - 
p
->len);

722 
p
->
d©a
[
Ën
 + 4] = 0;

724 
	`D
("SS(%d): '%s'\n", 
s
->
id
, (*è(
p
->
d©a
 + 4));

726 #ià
ADB_HOST


727 
£rviû
 = (*)
p
->
d©a
 + 4;

728 if(!
	`¡ºcmp
(
£rviû
, "ho¡-£rŸl:", 
	`¡¾’
("host-serial:"))) {

729 * 
£rŸl_’d
;

730 
£rviû
 +ğ
	`¡¾’
("host-serial:");

733 
£rŸl_’d
 = 
	`sk_ho¡_£rŸl
(
£rviû
);

734 ià(
£rŸl_’d
) {

735 *
£rŸl_’d
 = 0;

736 
£rŸl
 = 
£rviû
;

737 
£rviû
 = 
£rŸl_’d
 + 1;

739 } ià(!
	`¡ºcmp
(
£rviû
, "ho¡-usb:", 
	`¡¾’
("host-usb:"))) {

740 
‰y³
 = 
kT¿n¥ÜtUsb
;

741 
£rviû
 +ğ
	`¡¾’
("host-usb:");

742 } ià(!
	`¡ºcmp
(
£rviû
, "ho¡-loÿl:", 
	`¡¾’
("host-local:"))) {

743 
‰y³
 = 
kT¿n¥ÜtLoÿl
;

744 
£rviû
 +ğ
	`¡¾’
("host-local:");

745 } ià(!
	`¡ºcmp
(
£rviû
, "ho¡:", 
	`¡¾’
("host:"))) {

746 
‰y³
 = 
kT¿n¥ÜtAny
;

747 
£rviû
 +ğ
	`¡¾’
("host:");

749 
£rviû
 = 
NULL
;

752 ià(
£rviû
) {

753 
asock‘
 *
s2
;

760 if(
	`hªdË_ho¡_»que¡
(
£rviû
, 
‰y³
, 
£rŸl
, 
s
->
³”
->
fd
, s) == 0) {

762 
	`D
Ğ"SS(%d): hªdËd ho¡ s”viû '%s'\n", 
s
->
id
, 
£rviû
 );

763 
ç
;

765 ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt", 
	`¡¾’
("transport"))) {

766 
	`D
Ğ"SS(%d): okay¿n¥Üt\n", 
s
->
id
 );

767 
p
->
Ën
 = 0;

775 
s2
 = 
	`ü—‹_ho¡_£rviû_sock‘
(
£rviû
, 
£rŸl
);

776 if(
s2
 == 0) {

777 
	`D
Ğ"SS(%d): couldn'ˆü—‹ ho¡ s”viû '%s'\n", 
s
->
id
, 
£rviû
 );

778 
	`S’dFa
(
s
->
³”
->
fd
, "unknown host service");

779 
ç
;

789 
	`S’dOkay
(
s
->
³”
->
fd
);

791 
s
->
³”
->
»ady
 = 
loÿl_sock‘_»ady
;

792 
s
->
³”
->
shutdown
 = 
NULL
;

793 
s
->
³”
->
şo£
 = 
loÿl_sock‘_şo£
;

794 
s
->
³”
->³” = 
s2
;

795 
s2
->
³”
 = 
s
->peer;

796 
s
->
³”
 = 0;

797 
	`D
Ğ"SS(%d): okay\n", 
s
->
id
 );

798 
s
->
	`şo£
(s);

801 
s2
->
	`»ady
(s2);

805 ià(
s
->
Œª¥Üt
 =ğ
NULL
) {

806 
¡d
::
¡ršg
 
”rÜ_msg
 = "unknown failure";

807 
s
->
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
(
CS_ANY
, 
kT¿n¥ÜtAny
, 
NULL
, &
”rÜ_msg
);

809 ià(
s
->
Œª¥Üt
 =ğ
NULL
) {

810 
	`S’dFa
(
s
->
³”
->
fd
, 
”rÜ_msg
);

811 
ç
;

816 if(!(
s
->
Œª¥Üt
è|| (s->Œª¥Üt->
cÚÃùiÚ_¡©e
 =ğ
CS_OFFLINE
)) {

820 
	`S’dFa
(
s
->
³”
->
fd
, "device offline (x)");

821 
ç
;

830 
s
->
³”
->
»ady
 = 
loÿl_sock‘_»ady_nÙify
;

831 
s
->
³”
->
shutdown
 = 
NULL
;

832 
s
->
³”
->
şo£
 = 
loÿl_sock‘_şo£_nÙify
;

833 
s
->
³”
->peer = 0;

835 
s
->
³”
->
Œª¥Üt
 = s->transport;

837 
	`cÚÃù_to_»mÙe
(
s
->
³”
, (*è(
p
->
d©a
 + 4));

838 
s
->
³”
 = 0;

839 
s
->
	`şo£
(s);

842 
ç
:

847 
s
->
	`şo£
(s);

849 
	}
}

851 
	$sm¬t_sock‘_»ady
(
asock‘
 *
s
)

853 
	`D
("SS(%d):„—dy\n", 
s
->
id
);

854 
	}
}

856 
	$sm¬t_sock‘_şo£
(
asock‘
 *
s
)

858 
	`D
("SS(%d): clo£d\n", 
s
->
id
);

859 if(
s
->
pkt_fœ¡
){

860 
	`put_­ack‘
(
s
->
pkt_fœ¡
);

862 if(
s
->
³”
) {

863 
s
->
³”
->peer = 0;

864 
s
->
³”
->
	`şo£
(s->peer);

865 
s
->
³”
 = 0;

867 
	`ä“
(
s
);

868 
	}
}

870 
asock‘
 *
	$ü—‹_sm¬t_sock‘
()

872 
	`D
("Creating smart socket \n");

873 
asock‘
 *
s
 = 
»š‹½»t_ÿ¡
<asock‘*>(
	`ÿÎoc
(1, (asocket)));

874 ià(
s
 =ğ
NULL
è
	`çl
("cannot‡llocate socket");

875 
s
->
’queue
 = 
sm¬t_sock‘_’queue
;

876 
s
->
»ady
 = 
sm¬t_sock‘_»ady
;

877 
s
->
shutdown
 = 
NULL
;

878 
s
->
şo£
 = 
sm¬t_sock‘_şo£
;

880 
	`D
("SS(%d)\n", 
s
->
id
);

881  
s
;

882 
	}
}

884 
	$cÚÃù_to_sm¬tsock‘
(
asock‘
 *
s
)

886 
	`D
("Connectingo smart socket \n");

887 
asock‘
 *
ss
 = 
	`ü—‹_sm¬t_sock‘
();

888 
s
->
³”
 = 
ss
;

889 
ss
->
³”
 = 
s
;

890 
s
->
	`»ady
(s);

891 
	}
}

893 
size_t
 
	gasock‘
::
	$g‘_max_·ylßd
() const {

894 
size_t
 
max_·ylßd
 = 
MAX_PAYLOAD
;

895 ià(
Œª¥Üt
) {

896 
max_·ylßd
 = 
¡d
::
	`mš
(max_·ylßd, 
Œª¥Üt
->
	`g‘_max_·ylßd
());

898 ià(
³”
 &&…“r->
Œª¥Üt
) {

899 
max_·ylßd
 = 
¡d
::
	`mš
(max_·ylßd, 
³”
->
Œª¥Üt
->
	`g‘_max_·ylßd
());

901  
max_·ylßd
;

902 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/sysdeps.h

20 #iâdeà
_ADB_SYSDEPS_H


21 
	#_ADB_SYSDEPS_H


	)

23 #ifdeà
__CYGWIN__


24 #undeà
_WIN32


32 #iâdeà
TEMP_FAILURE_RETRY


34 
	#TEMP_FAILURE_RETRY
(
exp
) ({ \

35 
	`ty³of
 (
exp
è
_rc
; \

37 
_rc
 = (
exp
); \

38 } 
_rc
 =ğ-1 && 
”ºo
 =ğ
EINTR
); \

39 
_rc
; })

	)

42 #ifdeà
_WIN32


44 
	~<ùy³.h
>

45 
	~<dœeù.h
>

46 
	~<”ºo.h
>

47 
	~<fú.h
>

48 
	~<io.h
>

49 
	~<´oûss.h
>

50 
	~<sys/¡©.h
>

51 
	~<wšsock2.h
>

52 
	~<wšdows.h
>

53 
	~<ws2tı.h
>

55 
	~"fdev’t.h
"

57 
	#OS_PATH_SEPARATOR
 '\\'

	)

58 
	#OS_PATH_SEPARATOR_STR
 "\\"

	)

59 
	#ENV_PATH_SEPARATOR_STR
 ";"

	)

61 
CRITICAL_SECTION
 
	tadb_mu‹x_t
;

63 
	#ADB_MUTEX_DEFINE
(
x
è
adb_mu‹x_t
 
	)
x

67 
	#ADB_MUTEX
(
x
è
adb_mu‹x_t
 x;

	)

68 
	~"mu‹x_li¡.h
"

70 
adb_sysd•s_š™
();

72 
__šlše__
 
	$adb_mu‹x_lock
Ğ
adb_mu‹x_t
* 
lock
 )

74 
	`EÁ”Cr™iÿlSeùiÚ
Ğ
lock
 );

75 
	}
}

77 
__šlše__
 
	$adb_mu‹x_uÆock
Ğ
adb_mu‹x_t
* 
lock
 )

79 
	`L—veCr™iÿlSeùiÚ
Ğ
lock
 );

80 
	}
}

82 ¡ruù { 
	mtid
; } 
	tadb_th»ad_t
;

84 * (*
	tadb_th»ad_func_t
)(* 
	t¬g
);

86 (*
	twš_th»ad_func_t
)(* 
	t¬g
);

88 
__šlše__
 
	$adb_th»ad_ü—‹
Ğ
adb_th»ad_t
 *
th»ad
, 
adb_th»ad_func_t
 
func
, * 
¬g
)

90 
th»ad
->
tid
 = 
	`_begšth»ad
Ğ(
wš_th»ad_func_t
)
func
, 0, 
¬g
 );

91 ià(
th»ad
->
tid
 == ()-1L) {

95 
	}
}

97 
__šlše__
 
	$adb_th»ad_id
()

99  
	`G‘Cu¼’tTh»adId
();

100 
	}
}

102 
__šlše__
 
	$şo£_Ú_exec
(
fd
)

105 
	}
}

107 
	#l¡©
 
¡©


	)

109 
	#S_ISLNK
(
m
è0

	)

111 
__šlše__
 
	$adb_uÆšk
(cÚ¡ * 
·th
)

113 
rc
 = 
	`uÆšk
(
·th
);

115 ià(
rc
 =ğ-1 && 
”ºo
 =ğ
EACCES
) {

118 
rc
 = 
	`chmod
(
·th
, 
_S_IREAD
|
_S_IWRITE
 );

119 ià(
rc
 == 0)

120 
rc
 = 
	`uÆšk
(
·th
);

122  
rc
;

123 
	}
}

124 #undeà
uÆšk


125 
	#uÆšk
 
___xxx_uÆšk


	)

127 
__šlše__
 
	$adb_mkdœ
(cÚ¡ * 
·th
, 
mode
)

129  
	`_mkdœ
(
·th
);

130 
	}
}

131 #undeà
mkdœ


132 
	#mkdœ
 
___xxx_mkdœ


	)

134 
adb_İ’
(cÚ¡ * 
·th
, 
İtiÚs
);

135 
adb_ü—t
(cÚ¡ * 
·th
, 
mode
);

136 
adb_»ad
(
fd
, * 
buf
, 
Ën
);

137 
adb_wr™e
(
fd
, cÚ¡ * 
buf
, 
Ën
);

138 
adb_l£ek
(
fd
, 
pos
, 
wh”e
);

139 
adb_shutdown
(
fd
);

140 
adb_şo£
(
fd
);

142 
__šlše__
 
	$unix_şo£
(
fd
)

144  
	`şo£
(
fd
);

145 
	}
}

146 #undeà
şo£


147 
	#şo£
 
____xxx_şo£


	)

149 
unix_»ad
(
fd
, * 
buf
, 
size_t
 
Ën
);

151 #undeà
»ad


152 
	#»ad
 
___xxx_»ad


	)

154 
__šlše__
 
	$unix_wr™e
(
fd
, cÚ¡ * 
buf
, 
size_t
 
Ën
)

156  
	`wr™e
(
fd
, 
buf
, 
Ën
);

157 
	}
}

158 #undeà
wr™e


159 
	#wr™e
 
___xxx_wr™e


	)

161 
__šlše__
 
	$adb_İ’_mode
(cÚ¡ * 
·th
, 
İtiÚs
, 
mode
)

163  
	`adb_İ’
(
·th
, 
İtiÚs
);

164 
	}
}

166 
__šlše__
 
	$unix_İ’
(cÚ¡ * 
·th
, 
İtiÚs
,...)

168 ià((
İtiÚs
 & 
O_CREAT
) == 0)

170  
	`İ’
(
·th
, 
İtiÚs
);

174 
mode
;

175 
va_li¡
 
¬gs
;

176 
	`va_¡¬t
Ğ
¬gs
, 
İtiÚs
 );

177 
mode
 = 
	`va_¬g
Ğ
¬gs
, );

178 
	`va_’d
Ğ
¬gs
 );

179  
	`İ’
(
·th
, 
İtiÚs
, 
mode
);

181 
	}
}

182 
	#İ’
 
___xxx_unix_İ’


	)

186 * 
lßd_fe
(cÚ¡ * 
·thÇme
, * 
psize
);

189 
sock‘_loİback_ş›Á
(
pÜt
, 
ty³
);

190 
sock‘_ÃtwÜk_ş›Á
(cÚ¡ *
ho¡
, 
pÜt
, 
ty³
);

191 
sock‘_ÃtwÜk_ş›Á_timeout
(cÚ¡ *
ho¡
, 
pÜt
, 
ty³
,

192 
timeout
);

193 
sock‘_loİback_£rv”
(
pÜt
, 
ty³
);

194 
sock‘_šaddr_ªy_£rv”
(
pÜt
, 
ty³
);

198 
	#FDE_READ
 0x0001

	)

199 
	#FDE_WRITE
 0x0002

	)

200 
	#FDE_ERROR
 0x0004

	)

201 
	#FDE_DONT_CLOSE
 0x0080

	)

203 (*
	tfd_func
)(
	tfd
, 
	tev’ts
, *
	tu£rd©a
);

205 
fdev’t
 *
	`fdev’t_ü—‹
(
fd
, 
fd_func
 
func
, *
¬g
);

206 
	`fdev’t_de¡roy
(
fdev’t
 *
fde
);

207 
	`fdev’t_š¡®l
(
fdev’t
 *
fde
, 
fd
, 
fd_func
 
func
, *
¬g
);

208 
	`fdev’t_»move
(
fdev’t
 *
™em
);

209 
	`fdev’t_£t
(
fdev’t
 *
fde
, 
ev’ts
);

210 
	`fdev’t_add
(
fdev’t
 *
fde
, 
ev’ts
);

211 
	`fdev’t_d–
(
fdev’t
 *
fde
, 
ev’ts
);

212 
	`fdev’t_loİ
();

214 
__šlše__
 
	$adb_¦“p_ms
Ğ
m£cÚds
 )

216 
	`SË•
Ğ
m£cÚds
 );

217 
	}
}

219 
adb_sock‘_acû±
(
£rv”fd
, 
sockaddr
* 
addr
, 
sockËn_t
 *
add¾’
);

221 #undeà
acû±


222 
	#acû±
 
___xxx_acû±


	)

224 
adb_£tsockİt
(
fd
, 
Ëv–
, 
İŠame
, cÚ¡ * 
İtv®
, 
sockËn_t
 
İ’
);

226 #undeà
£tsockİt


227 
	#£tsockİt
 
___xxx_£tsockİt


	)

229 
__šlše__
 
	$adb_sock‘_£tbufsize
Ğ
fd
, 
bufsize
 )

231 
İt
 = 
bufsize
;

232  
	`adb_£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, (cÚ¡ *)&
İt
, (opt));

233 
	}
}

235 
__šlše__
 
	$di§bË_tı_ÇgË
Ğ
fd
 )

237 
Ú
 = 1;

238 
	`adb_£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (cÚ¡ *)&
Ú
, (on));

239 
	}
}

241 
adb_sock‘·œ
Ğ
sv
[2] );

243 
__šlše__
 * 
	$adb_dœ¡¬t
ĞcÚ¡ * 
·th
 )

245 * 
p
 = 
	`¡rchr
(
·th
, '/');

246 * 
p2
 = 
	`¡rchr
(
·th
, '\\');

248 iàĞ!
p
 )

249 
p
 = 
p2
;

250 iàĞ
p2
 &&…2 > 
p
 )

251 
p
 = 
p2
;

253  
p
;

254 
	}
}

256 
__šlše__
 * 
	$adb_dœ¡İ
ĞcÚ¡ * 
·th
 )

258 * 
p
 = 
	`¡¼chr
(
·th
, '/');

259 * 
p2
 = 
	`¡¼chr
(
·th
, '\\');

261 iàĞ!
p
 )

262 
p
 = 
p2
;

263 iàĞ
p2
 &&…2 > 
p
 )

264 
p
 = 
p2
;

266  
p
;

267 
	}
}

269 
__šlše__
 
	$adb_is_absŞu‹_ho¡_·th
ĞcÚ¡ * 
·th
 )

271  
	`i§Íha
(
·th
[0]) &&…ath[1] == ':' &&…ath[2] == '\\';

272 
	}
}

276 
	~"fdev’t.h
"

277 
	~<cuts/sock‘s.h
>

278 
	~<cuts/misc.h
>

279 
	~<sigÇl.h
>

280 
	~<sys/wa™.h
>

281 
	~<sys/¡©.h
>

282 
	~<fú.h
>

284 
	~<±h»ad.h
>

285 
	~<uni¡d.h
>

286 
	~<fú.h
>

287 
	~<¡d¬g.h
>

288 
	~<Ãtš‘/š.h
>

289 
	~<Ãtš‘/tı.h
>

290 
	~<¡ršg.h
>

291 
	~<uni¡d.h
>

293 
	#OS_PATH_SEPARATOR
 '/'

	)

294 
	#OS_PATH_SEPARATOR_STR
 "/"

	)

295 
	#ENV_PATH_SEPARATOR_STR
 ":"

	)

297 
±h»ad_mu‹x_t
 
	tadb_mu‹x_t
;

299 
	#ADB_MUTEX_INITIALIZER
 
PTHREAD_MUTEX_INITIALIZER


	)

300 
	#adb_mu‹x_š™
 
±h»ad_mu‹x_š™


	)

301 
	#adb_mu‹x_lock
 
±h»ad_mu‹x_lock


	)

302 
	#adb_mu‹x_uÆock
 
±h»ad_mu‹x_uÆock


	)

303 
	#adb_mu‹x_de¡roy
 
±h»ad_mu‹x_de¡roy


	)

305 
	#ADB_MUTEX_DEFINE
(
m
è
adb_mu‹x_t
 m = 
PTHREAD_MUTEX_INITIALIZER


	)

307 
	#adb_cÚd_t
 
±h»ad_cÚd_t


	)

308 
	#adb_cÚd_š™
 
±h»ad_cÚd_š™


	)

309 
	#adb_cÚd_wa™
 
±h»ad_cÚd_wa™


	)

310 
	#adb_cÚd_brßdÿ¡
 
±h»ad_cÚd_brßdÿ¡


	)

311 
	#adb_cÚd_sigÇl
 
±h»ad_cÚd_sigÇl


	)

312 
	#adb_cÚd_de¡roy
 
±h»ad_cÚd_de¡roy


	)

315 
	#ADB_MUTEX
(
x
è
adb_mu‹x_t
 x;

	)

316 
	~"mu‹x_li¡.h
"

318 
__šlše__
 
	$şo£_Ú_exec
(
fd
)

320 
	`fú
Ğ
fd
, 
F_SETFD
, 
FD_CLOEXEC
 );

321 
	}
}

323 
__šlše__
 
	$unix_İ’
(cÚ¡ * 
·th
, 
İtiÚs
,...)

325 ià((
İtiÚs
 & 
O_CREAT
) == 0)

327  
	`TEMP_FAILURE_RETRY
Ğ
	`İ’
(
·th
, 
İtiÚs
) );

331 
mode
;

332 
va_li¡
 
¬gs
;

333 
	`va_¡¬t
Ğ
¬gs
, 
İtiÚs
 );

334 
mode
 = 
	`va_¬g
Ğ
¬gs
, );

335 
	`va_’d
Ğ
¬gs
 );

336  
	`TEMP_FAILURE_RETRY
Ğ
	`İ’
Ğ
·th
, 
İtiÚs
, 
mode
 ) );

338 
	}
}

340 
__šlše__
 
	$adb_İ’_mode
ĞcÚ¡ * 
·thÇme
, 
İtiÚs
, 
mode
 )

342  
	`TEMP_FAILURE_RETRY
Ğ
	`İ’
Ğ
·thÇme
, 
İtiÚs
, 
mode
 ) );

343 
	}
}

346 
__šlše__
 
	$adb_İ’
ĞcÚ¡ * 
·thÇme
, 
İtiÚs
 )

348 
fd
 = 
	`TEMP_FAILURE_RETRY
Ğ
	`İ’
Ğ
·thÇme
, 
İtiÚs
 ) );

349 ià(
fd
 < 0)

351 
	`şo£_Ú_exec
Ğ
fd
 );

352  
fd
;

353 
	}
}

354 #undeà
İ’


355 
	#İ’
 
___xxx_İ’


	)

357 
__šlše__
 
	$adb_shutdown
(
fd
)

359  
	`shutdown
(
fd
, 
SHUT_RDWR
);

360 
	}
}

361 #undeà
shutdown


362 
	#shutdown
 
____xxx_shutdown


	)

364 
__šlše__
 
	$adb_şo£
(
fd
)

366  
	`şo£
(
fd
);

367 
	}
}

368 #undeà
şo£


369 
	#şo£
 
____xxx_şo£


	)

372 
__šlše__
 
	$adb_»ad
(
fd
, * 
buf
, 
size_t
 
Ën
)

374  
	`TEMP_FAILURE_RETRY
Ğ
	`»ad
Ğ
fd
, 
buf
, 
Ën
 ) );

375 
	}
}

377 #undeà
»ad


378 
	#»ad
 
___xxx_»ad


	)

380 
__šlše__
 
	$adb_wr™e
(
fd
, cÚ¡ * 
buf
, 
size_t
 
Ën
)

382  
	`TEMP_FAILURE_RETRY
Ğ
	`wr™e
Ğ
fd
, 
buf
, 
Ën
 ) );

383 
	}
}

384 #undeà
wr™e


385 
	#wr™e
 
___xxx_wr™e


	)

387 
__šlše__
 
	$adb_l£ek
(
fd
, 
pos
, 
wh”e
)

389  
	`l£ek
(
fd
, 
pos
, 
wh”e
);

390 
	}
}

391 #undeà
l£ek


392 
	#l£ek
 
___xxx_l£ek


	)

394 
__šlše__
 
	$adb_uÆšk
(cÚ¡ * 
·th
)

396  
	`uÆšk
(
·th
);

397 
	}
}

398 #undeà
uÆšk


399 
	#uÆšk
 
___xxx_uÆšk


	)

401 
__šlše__
 
	$adb_ü—t
(cÚ¡ * 
·th
, 
mode
)

403 
fd
 = 
	`TEMP_FAILURE_RETRY
Ğ
	`ü—t
Ğ
·th
, 
mode
 ) );

405 iàĞ
fd
 < 0 )

408 
	`şo£_Ú_exec
(
fd
);

409  
fd
;

410 
	}
}

411 #undeà
ü—t


412 
	#ü—t
 
___xxx_ü—t


	)

414 
__šlše__
 
	$adb_sock‘_acû±
(
£rv”fd
, 
sockaddr
* 
addr
, 
sockËn_t
 *
add¾’
)

416 
fd
;

418 
fd
 = 
	`TEMP_FAILURE_RETRY
Ğ
	`acû±
Ğ
£rv”fd
, 
addr
, 
add¾’
 ) );

419 ià(
fd
 >= 0)

420 
	`şo£_Ú_exec
(
fd
);

422  
fd
;

423 
	}
}

425 #undeà
acû±


426 
	#acû±
 
___xxx_acû±


	)

428 
	#unix_»ad
 
adb_»ad


	)

429 
	#unix_wr™e
 
adb_wr™e


	)

430 
	#unix_şo£
 
adb_şo£


	)

432 
±h»ad_t
 
	tadb_th»ad_t
;

434 * (*
	tadb_th»ad_func_t
)Ğ* 
	t¬g
 );

436 
__šlše__
 
	$adb_th»ad_ü—‹
Ğ
adb_th»ad_t
 *
±h»ad
, 
adb_th»ad_func_t
 
¡¬t
, * 
¬g
 )

438 
±h»ad_©Œ_t
 
©Œ
;

440 
	`±h»ad_©Œ_š™
 (&
©Œ
);

441 
	`±h»ad_©Œ_£td‘ach¡©e
 (&
©Œ
, 
PTHREAD_CREATE_DETACHED
);

443  
	`±h»ad_ü—‹
Ğ
±h»ad
, &
©Œ
, 
¡¬t
, 
¬g
 );

444 
	}
}

446 
__šlše__
 
	$adb_sock‘_£tbufsize
Ğ
fd
, 
bufsize
 )

448 
İt
 = 
bufsize
;

449  
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
İt
, (opt));

450 
	}
}

452 
__šlše__
 
	$di§bË_tı_ÇgË
(
fd
)

454 
Ú
 = 1;

455 
	`£tsockİt
Ğ
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
Ú
, (on) );

456 
	}
}

458 
__šlše__
 
	$adb_£tsockİt
Ğ
fd
, 
Ëv–
, 
İŠame
, cÚ¡ * 
İtv®
, 
sockËn_t
 
İ’
 )

460  
	`£tsockİt
Ğ
fd
, 
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
 );

461 
	}
}

463 #undeà
£tsockİt


464 
	#£tsockİt
 
___xxx_£tsockİt


	)

466 
__šlše__
 
	$unix_sock‘·œ
Ğ
d
, 
ty³
, 
´ÙocŞ
, 
sv
[2] )

468  
	`sock‘·œ
Ğ
d
, 
ty³
, 
´ÙocŞ
, 
sv
 );

469 
	}
}

471 
__šlše__
 
	$adb_sock‘·œ
Ğ
sv
[2] )

473 
rc
;

475 
rc
 = 
	`unix_sock‘·œ
Ğ
AF_UNIX
, 
SOCK_STREAM
, 0, 
sv
 );

476 ià(
rc
 < 0)

479 
	`şo£_Ú_exec
Ğ
sv
[0] );

480 
	`şo£_Ú_exec
Ğ
sv
[1] );

482 
	}
}

484 #undeà
sock‘·œ


485 
	#sock‘·œ
 
___xxx_sock‘·œ


	)

487 
__šlše__
 
	$adb_¦“p_ms
Ğ
m£cÚds
 )

489 
	`u¦“p
Ğ
m£cÚds
*1000 );

490 
	}
}

492 
__šlše__
 
	$adb_mkdœ
(cÚ¡ * 
·th
, 
mode
)

494  
	`mkdœ
(
·th
, 
mode
);

495 
	}
}

496 #undeà
mkdœ


497 
	#mkdœ
 
___xxx_mkdœ


	)

499 
__šlše__
 
	$adb_sysd•s_š™
()

501 
	}
}

503 
__šlše__
 * 
	$adb_dœ¡¬t
(cÚ¡ * 
·th
)

505  
	`¡rchr
(
·th
, '/');

506 
	}
}

508 
__šlše__
 * 
	$adb_dœ¡İ
(cÚ¡ * 
·th
)

510  
	`¡¼chr
(
·th
, '/');

511 
	}
}

513 
__šlše__
 
	$adb_is_absŞu‹_ho¡_·th
ĞcÚ¡ * 
·th
 )

515  
·th
[0] == '/';

516 
	}
}

518 
__šlše__
 
	$adb_th»ad_id
()

520  ()
	`±h»ad_£lf
();

521 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/sysdeps/mutex.h

1 #´agm¨
Úû


19 #ià
defšed
(
_WIN32
)

21 
	~<wšdows.h
>

23 
	~<ªdroid-ba£/maüos.h
>

25 
	~"adb.h
"

32 
	~<mu‹x
>

33 
Çme¥aû
 
	g¡d
 {

36 şas 
	c»cursive_mu‹x
 {

37 
	gpublic
:

38 
»cursive_mu‹x
() {

39 
In™ŸlizeCr™iÿlSeùiÚ
(&
mu‹x_
);

42 ~
»cursive_mu‹x
() {

43 
D–‘eCr™iÿlSeùiÚ
(&
mu‹x_
);

46 
lock
() {

47 
EÁ”Cr™iÿlSeùiÚ
(&
mu‹x_
);

50 
boŞ
 
Œy_lock
() {

51  
TryEÁ”Cr™iÿlSeùiÚ
(&
mu‹x_
);

54 
uÆock
() {

55 
L—veCr™iÿlSeùiÚ
(&
mu‹x_
);

58 
	g´iv©e
:

59 
CRITICAL_SECTION
 
mu‹x_
;

61 
DISALLOW_COPY_AND_ASSIGN
(
»cursive_mu‹x
);

64 şas 
	cmu‹x
 {

65 
	gpublic
:

66 
mu‹x
() {

69 ~
mu‹x
() {

72 
lock
() {

73 
mu‹x_
.
lock
();

74 ià(++
	glock_couÁ_
 != 1) {

75 
çl
("non-recursive mutex†ocked„eentrantly");

79 
uÆock
() {

80 ià(--
	glock_couÁ_
 != 0) {

81 
çl
("nÚ-»cursivmu‹x uÆock„esuÉed iÀuÃx³ùed†ock couÁ: %d", 
lock_couÁ_
);

83 
	gmu‹x_
.
uÆock
();

86 
boŞ
 
Œy_lock
() {

87 ià(!
	gmu‹x_
.
Œy_lock
()) {

88  
	gçl£
;

91 ià(
	glock_couÁ_
 != 0) {

92 
mu‹x_
.
uÆock
();

93  
	gçl£
;

96 ++
	glock_couÁ_
;

97  
	gŒue
;

100 
	g´iv©e
:

101 
»cursive_mu‹x
 
mu‹x_
;

102 
size_t
 
	glock_couÁ_
 = 0;

107 #–ià
defšed
(
__BIONIC__
)

112 
	~<±h»ad.h
>

113 
	~<mu‹x
>

115 
	~<ba£/maüos.h
>

117 şas 
	c»cursive_mu‹x
 {

118 
	mpublic
:

119 
	$»cursive_mu‹x
() {

122 ~
	$»cursive_mu‹x
() {

123 
	}
}

125 
	$lock
() {

126 
	`±h»ad_mu‹x_lock
(&
mu‹x_
);

127 
	}
}

129 
boŞ
 
	$Œy_lock
() {

130  
	`±h»ad_mu‹x_Œylock
(&
mu‹x_
);

131 
	}
}

133 
	$uÆock
() {

134 
	`±h»ad_mu‹x_uÆock
(&
mu‹x_
);

135 
	}
}

137 
	g´iv©e
:

138 
±h»ad_mu‹x_t
 
mu‹x_
 = 
PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
;

140 
DISALLOW_COPY_AND_ASSIGN
(
»cursive_mu‹x
);

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/sysdeps_win32.cpp

17 
	#TRACE_TAG
 
TRACE_SYSDEPS


	)

19 
	~"sysd•s.h
"

21 
	~<wšsock2.h
>

22 
	~<wšdows.h
>

24 
	~<”ºo.h
>

25 
	~<¡dio.h
>

26 
	~<¡dlib.h
>

28 
	~"adb.h
"

30 
çl
(cÚ¡ *
fmt
, ...);

34 cÚ¡ 
	tFHCÏssRec_
* 
	tFHCÏss
;

35 
FHRec_
* 
	tFH
;

36 
Ev’tHookRec_
* 
	tEv’tHook
;

38 
	sFHCÏssRec_
 {

39 (*
	m_fh_š™
)(
	mFH
);

40 (*
	m_fh_şo£
)(
	mFH
);

41 (*
	m_fh_l£ek
)(
	mFH
, , );

42 (*
	m_fh_»ad
)(
	mFH
, *, );

43 (*
	m_fh_wr™e
)(
	mFH
, const *, );

44 (*
	m_fh_hook
)(
	mFH
, , 
	mEv’tHook
);

45 } 
	tFHCÏssRec
;

47 
_fh_fe_š™
(
FH
);

48 
_fh_fe_şo£
(
FH
);

49 
_fh_fe_l£ek
(
FH
, , );

50 
_fh_fe_»ad
(
FH
, *, );

51 
_fh_fe_wr™e
(
FH
, const *, );

52 
_fh_fe_hook
(
FH
, , 
Ev’tHook
);

54 cÚ¡ 
FHCÏssRec
 
	g_fh_fe_şass
 = {

55 
_fh_fe_š™
,

56 
_fh_fe_şo£
,

57 
_fh_fe_l£ek
,

58 
_fh_fe_»ad
,

59 
_fh_fe_wr™e
,

60 
_fh_fe_hook


63 
_fh_sock‘_š™
(
FH
);

64 
_fh_sock‘_şo£
(
FH
);

65 
_fh_sock‘_l£ek
(
FH
, , );

66 
_fh_sock‘_»ad
(
FH
, *, );

67 
_fh_sock‘_wr™e
(
FH
, const *, );

68 
_fh_sock‘_hook
(
FH
, , 
Ev’tHook
);

70 cÚ¡ 
FHCÏssRec
 
	g_fh_sock‘_şass
 = {

71 
_fh_sock‘_š™
,

72 
_fh_sock‘_şo£
,

73 
_fh_sock‘_l£ek
,

74 
_fh_sock‘_»ad
,

75 
_fh_sock‘_wr™e
,

76 
_fh_sock‘_hook


79 
	#as£¹
(
cÚd
èdØ{ ià(!(cÚd)è
	`çl
Ğ"as£¹iÚ faed '%s' oÀ%s:%ld\n", #cÚd, 
__FILE__
, 
__LINE__
 ); } 0)

	)

89 *
	$lßd_fe
(cÚ¡ *
â
, *
_sz
)

91 
HANDLE
 
fe
;

92 *
d©a
;

93 
DWORD
 
fe_size
;

95 
fe
 = 
	`C»©eFe
Ğ
â
,

96 
GENERIC_READ
,

97 
FILE_SHARE_READ
,

98 
NULL
,

99 
OPEN_EXISTING
,

101 
NULL
 );

103 ià(
fe
 =ğ
INVALID_HANDLE_VALUE
)

104  
NULL
;

106 
fe_size
 = 
	`G‘FeSize
Ğ
fe
, 
NULL
 );

107 
d©a
 = 
NULL
;

109 ià(
fe_size
 > 0) {

110 
d©a
 = (*è
	`m®loc
Ğ
fe_size
 + 1 );

111 ià(
d©a
 =ğ
NULL
) {

112 
	`D
("lßd_fe: could‚Ù‡Îoÿ‹ %ld by‹s\n", 
fe_size
 );

113 
fe_size
 = 0;

115 
DWORD
 
out_by‹s
;

117 iàĞ!
	`R—dFe
Ğ
fe
, 
d©a
, 
fe_size
, &
out_by‹s
, 
NULL
 ) ||

118 
out_by‹s
 !ğ
fe_size
 )

120 
	`D
("lßd_fe: could‚Ù„—d %ld by‹ äom '%s'\n", 
fe_size
, 
â
);

121 
	`ä“
(
d©a
);

122 
d©a
 = 
NULL
;

123 
fe_size
 = 0;

127 
	`Clo£HªdË
Ğ
fe
 );

129 *
_sz
 = (è
fe_size
;

130  
d©a
;

131 
	}
}

142 
Sock‘PaœRec_
* 
	tSock‘Paœ
;

144 
	sFHRec_


146 
FHCÏss
 
	mşazz
;

147 
	mu£d
;

148 
	meof
;

150 
HANDLE
 
	mhªdË
;

151 
SOCKET
 
	msock‘
;

152 
Sock‘Paœ
 
	m·œ
;

153 } 
	mu
;

155 
HANDLE
 
	mev’t
;

156 
	mmask
;

158 
	mÇme
[32];

160 } 
	tFHRec
;

162 
	#fh_hªdË
 
u
.
hªdË


	)

163 
	#fh_sock‘
 
u
.
sock‘


	)

164 
	#fh_·œ
 
u
.
·œ


	)

166 
	#WIN32_FH_BASE
 100

	)

168 
	#WIN32_MAX_FHS
 128

	)

170 
adb_mu‹x_t
 
	g_wš32_lock
;

171 
FHRec
 
	g_wš32_fhs
[ 
WIN32_MAX_FHS
 ];

172 
	g_wš32_fh_couÁ
;

174 
FH


175 
	$_fh_äom_št
Ğ
fd
 )

177 
FH
 
f
;

179 
fd
 -ğ
WIN32_FH_BASE
;

181 ià(
fd
 < 0 || fd >ğ
_wš32_fh_couÁ
) {

182 
	`D
Ğ"_fh_äom_št: inv®id fd %d\n", 
fd
 + 
WIN32_FH_BASE
 );

183 
”ºo
 = 
EBADF
;

184  
NULL
;

187 
f
 = &
_wš32_fhs
[
fd
];

189 ià(
f
->
u£d
 == 0) {

190 
	`D
Ğ"_fh_äom_št: inv®id fd %d\n", 
fd
 + 
WIN32_FH_BASE
 );

191 
”ºo
 = 
EBADF
;

192  
NULL
;

195  
f
;

196 
	}
}

200 
	$_fh_to_št
Ğ
FH
 
f
 )

202 ià(
f
 && f->
u£d
 && f >ğ
_wš32_fhs
 && f < _wš32_fh + 
WIN32_MAX_FHS
)

203  ()(
f
 - 
_wš32_fhs
è+ 
WIN32_FH_BASE
;

206 
	}
}

208 
FH


209 
	$_fh_®loc
Ğ
FHCÏss
 
şazz
 )

211 
Â
;

212 
FH
 
f
 = 
NULL
;

214 
	`adb_mu‹x_lock
Ğ&
_wš32_lock
 );

216 ià(
_wš32_fh_couÁ
 < 
WIN32_MAX_FHS
) {

217 
f
 = &
_wš32_fhs
[ 
_wš32_fh_couÁ
++ ];

218 
Ex™
;

221 
Â
 = 0;‚À< 
WIN32_MAX_FHS
;‚n++) {

222 iàĞ
_wš32_fhs
[
Â
].
şazz
 =ğ
NULL
) {

223 
f
 = &
_wš32_fhs
[
Â
];

224 
Ex™
;

227 
	`D
( "_fh_alloc:‚o more free file descriptors\n" );

228 
Ex™
:

229 ià(
f
) {

230 
f
->
şazz
 = clazz;

231 
f
->
u£d
 = 1;

232 
f
->
eof
 = 0;

233 
şazz
->
	`_fh_š™
(
f
);

235 
	`adb_mu‹x_uÆock
Ğ&
_wš32_lock
 );

236  
f
;

237 
	}
}

241 
	$_fh_şo£
Ğ
FH
 
f
 )

243 iàĞ
f
->
u£d
 ) {

244 
f
->
şazz
->
	`_fh_şo£
( f );

245 
f
->
u£d
 = 0;

246 
f
->
eof
 = 0;

247 
f
->
şazz
 = 
NULL
;

250 
	}
}

260 
	$_fh_fe_š™
Ğ
FH
 
f
 ) {

261 
f
->
fh_hªdË
 = 
INVALID_HANDLE_VALUE
;

262 
	}
}

264 
	$_fh_fe_şo£
Ğ
FH
 
f
 ) {

265 
	`Clo£HªdË
Ğ
f
->
fh_hªdË
 );

266 
f
->
fh_hªdË
 = 
INVALID_HANDLE_VALUE
;

268 
	}
}

270 
	$_fh_fe_»ad
Ğ
FH
 
f
, * 
buf
, 
Ën
 ) {

271 
DWORD
 
»ad_by‹s
;

273 iàĞ!
	`R—dFe
Ğ
f
->
fh_hªdË
, 
buf
, (
DWORD
)
Ën
, &
»ad_by‹s
, 
NULL
 ) ) {

274 
	`D
Ğ"adb_»ad: could‚Ù„—d %d by‹ äom %s\n", 
Ën
, 
f
->
Çme
 );

275 
”ºo
 = 
EIO
;

277 } ià(
»ad_by‹s
 < (
DWORD
)
Ën
) {

278 
f
->
eof
 = 1;

280  ()
»ad_by‹s
;

281 
	}
}

283 
	$_fh_fe_wr™e
Ğ
FH
 
f
, cÚ¡ * 
buf
, 
Ën
 ) {

284 
DWORD
 
wrÙe_by‹s
;

286 iàĞ!
	`Wr™eFe
Ğ
f
->
fh_hªdË
, 
buf
, (
DWORD
)
Ën
, &
wrÙe_by‹s
, 
NULL
 ) ) {

287 
	`D
Ğ"adb_fe_wr™e: could‚Ù wr™%d by‹ äom %s\n", 
Ën
, 
f
->
Çme
 );

288 
”ºo
 = 
EIO
;

290 } ià(
wrÙe_by‹s
 < (
DWORD
)
Ën
) {

291 
f
->
eof
 = 1;

293  ()
wrÙe_by‹s
;

294 
	}
}

296 
	$_fh_fe_l£ek
Ğ
FH
 
f
, 
pos
, 
Üigš
 ) {

297 
DWORD
 
m‘hod
;

298 
DWORD
 
»suÉ
;

300 
Üigš
)

302 
SEEK_SET
: 
m‘hod
 = 
FILE_BEGIN
; ;

303 
SEEK_CUR
: 
m‘hod
 = 
FILE_CURRENT
; ;

304 
SEEK_END
: 
m‘hod
 = 
FILE_END
; ;

306 
”ºo
 = 
EINVAL
;

310 
»suÉ
 = 
	`S‘FePoš‹r
Ğ
f
->
fh_hªdË
, 
pos
, 
NULL
, 
m‘hod
 );

311 ià(
»suÉ
 =ğ
INVALID_SET_FILE_POINTER
) {

312 
”ºo
 = 
EIO
;

315 
f
->
eof
 = 0;

317  ()
»suÉ
;

318 
	}
}

329 
	$adb_İ’
(cÚ¡ * 
·th
, 
İtiÚs
)

331 
FH
 
f
;

333 
DWORD
 
desœedAcûss
 = 0;

334 
DWORD
 
sh¬eMode
 = 
FILE_SHARE_READ
 | 
FILE_SHARE_WRITE
;

336 
İtiÚs
) {

337 
O_RDONLY
:

338 
desœedAcûss
 = 
GENERIC_READ
;

340 
O_WRONLY
:

341 
desœedAcûss
 = 
GENERIC_WRITE
;

343 
O_RDWR
:

344 
desœedAcûss
 = 
GENERIC_READ
 | 
GENERIC_WRITE
;

347 
	`D
("adb_İ’: inv®id o±iÚ (0x%0x)\n", 
İtiÚs
);

348 
”ºo
 = 
EINVAL
;

352 
f
 = 
	`_fh_®loc
Ğ&
_fh_fe_şass
 );

353 iàĞ!
f
 ) {

354 
”ºo
 = 
ENOMEM
;

358 
f
->
fh_hªdË
 = 
	`C»©eFe
Ğ
·th
, 
desœedAcûss
, 
sh¬eMode
, 
NULL
, 
OPEN_EXISTING
,

359 0, 
NULL
 );

361 iàĞ
f
->
fh_hªdË
 =ğ
INVALID_HANDLE_VALUE
 ) {

362 
	`_fh_şo£
(
f
);

363 
	`D
Ğ"adb_İ’: could‚Ù o³À'%s':", 
·th
 );

364 
	`G‘La¡E¼Ü
()) {

365 
ERROR_FILE_NOT_FOUND
:

366 
	`D
( "file‚ot found\n" );

367 
”ºo
 = 
ENOENT
;

370 
ERROR_PATH_NOT_FOUND
:

371 
	`D
( "path‚ot found\n" );

372 
”ºo
 = 
ENOTDIR
;

376 
	`D
( "unknownƒrror\n" );

377 
”ºo
 = 
ENOENT
;

382 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%d(%s)", 
	`_fh_to_št
(f), 
·th
 );

383 
	`D
Ğ"adb_İ’: '%s' => fd %d\n", 
·th
, 
	`_fh_to_št
(
f
) );

384  
	`_fh_to_št
(
f
);

385 
	}
}

388 
	$adb_ü—t
(cÚ¡ * 
·th
, 
mode
)

390 
FH
 
f
;

392 
f
 = 
	`_fh_®loc
Ğ&
_fh_fe_şass
 );

393 iàĞ!
f
 ) {

394 
”ºo
 = 
ENOMEM
;

398 
f
->
fh_hªdË
 = 
	`C»©eFe
Ğ
·th
, 
GENERIC_WRITE
, 
FILE_SHARE_READ
 | 
FILE_SHARE_WRITE
,

399 
NULL
, 
CREATE_ALWAYS
, 
FILE_ATTRIBUTE_NORMAL
,

400 
NULL
 );

402 iàĞ
f
->
fh_hªdË
 =ğ
INVALID_HANDLE_VALUE
 ) {

403 
	`_fh_şo£
(
f
);

404 
	`D
Ğ"adb_ü—t: could‚Ù o³À'%s':", 
·th
 );

405 
	`G‘La¡E¼Ü
()) {

406 
ERROR_FILE_NOT_FOUND
:

407 
	`D
( "file‚ot found\n" );

408 
”ºo
 = 
ENOENT
;

411 
ERROR_PATH_NOT_FOUND
:

412 
	`D
( "path‚ot found\n" );

413 
”ºo
 = 
ENOTDIR
;

417 
	`D
( "unknownƒrror\n" );

418 
”ºo
 = 
ENOENT
;

422 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%d(%s)", 
	`_fh_to_št
(f), 
·th
 );

423 
	`D
Ğ"adb_ü—t: '%s' => fd %d\n", 
·th
, 
	`_fh_to_št
(
f
) );

424  
	`_fh_to_št
(
f
);

425 
	}
}

428 
	$adb_»ad
(
fd
, * 
buf
, 
Ën
)

430 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

432 ià(
f
 =ğ
NULL
) {

436  
f
->
şazz
->
	`_fh_»ad
Ğf, 
buf
, 
Ën
 );

437 
	}
}

440 
	$adb_wr™e
(
fd
, cÚ¡ * 
buf
, 
Ën
)

442 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

444 ià(
f
 =ğ
NULL
) {

448  
f
->
şazz
->
	`_fh_wr™e
(f, 
buf
, 
Ën
);

449 
	}
}

452 
	$adb_l£ek
(
fd
, 
pos
, 
wh”e
)

454 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

456 ià(!
f
) {

460  
f
->
şazz
->
	`_fh_l£ek
(f, 
pos
, 
wh”e
);

461 
	}
}

464 
	$adb_shutdown
(
fd
)

466 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

468 ià(!
f
 || f->
şazz
 !ğ&
_fh_sock‘_şass
) {

469 
	`D
("adb_shutdown: inv®id fd %d\n", 
fd
);

473 
	`D
Ğ"adb_shutdown: %s\n", 
f
->
Çme
);

474 
	`shutdown
Ğ
f
->
fh_sock‘
, 
SD_BOTH
 );

476 
	}
}

479 
	$adb_şo£
(
fd
)

481 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

483 ià(!
f
) {

487 
	`D
Ğ"adb_şo£: %s\n", 
f
->
Çme
);

488 
	`_fh_şo£
(
f
);

490 
	}
}

500 #undeà
£tsockİt


502 
	$_sock‘_£t_”ºo
( ) {

503 
	`WSAG‘La¡E¼Ü
()) {

504 0: 
”ºo
 = 0; ;

505 
WSAEWOULDBLOCK
: 
”ºo
 = 
EAGAIN
; ;

506 
WSAEINTR
: 
”ºo
 = 
EINTR
; ;

508 
	`D
Ğ"_sock‘_£t_”ºo: unhªdËd v®u%d\n", 
	`WSAG‘La¡E¼Ü
() );

509 
”ºo
 = 
EINVAL
;

511 
	}
}

513 
	$_fh_sock‘_š™
Ğ
FH
 
f
 ) {

514 
f
->
fh_sock‘
 = 
INVALID_SOCKET
;

515 
f
->
ev’t
 = 
	`WSAC»©eEv’t
();

516 
f
->
mask
 = 0;

517 
	}
}

519 
	$_fh_sock‘_şo£
Ğ
FH
 
f
 ) {

521 
	`shutdown
Ğ
f
->
fh_sock‘
, 
SD_BOTH
 );

522 
	`şo£sock‘
Ğ
f
->
fh_sock‘
 );

523 
f
->
fh_sock‘
 = 
INVALID_SOCKET
;

524 
	`Clo£HªdË
Ğ
f
->
ev’t
 );

525 
f
->
mask
 = 0;

527 
	}
}

529 
	$_fh_sock‘_l£ek
Ğ
FH
 
f
, 
pos
, 
Üigš
 ) {

530 
”ºo
 = 
EPIPE
;

532 
	}
}

534 
	$_fh_sock‘_»ad
(
FH
 
f
, * 
buf
, 
Ën
) {

535 
»suÉ
 = 
	`»cv
(
f
->
fh_sock‘
, 
»š‹½»t_ÿ¡
<*>(
buf
), 
Ën
, 0);

536 ià(
»suÉ
 =ğ
SOCKET_ERROR
) {

537 
	`_sock‘_£t_”ºo
();

538 
»suÉ
 = -1;

540  
»suÉ
;

541 
	}
}

543 
	$_fh_sock‘_wr™e
(
FH
 
f
, cÚ¡ * 
buf
, 
Ën
) {

544 
»suÉ
 = 
	`£nd
(
f
->
fh_sock‘
, 
»š‹½»t_ÿ¡
<cÚ¡ *>(
buf
), 
Ën
, 0);

545 ià(
»suÉ
 =ğ
SOCKET_ERROR
) {

546 
	`_sock‘_£t_”ºo
();

547 
»suÉ
 = -1;

549  
»suÉ
;

550 
	}
}

560 
	~<wšsock2.h
>

562 
	g_wšsock_š™
;

565 
	$_ş—nup_wšsock
( )

567 
	`WSACËªup
();

568 
	}
}

571 
	$_š™_wšsock
( )

573 ià(!
_wšsock_š™
) {

574 
WSADATA
 
w§D©a
;

575 
rc
 = 
	`WSAS¹up
Ğ
	`MAKEWORD
(2,2), &
w§D©a
);

576 ià(
rc
 != 0) {

577 
	`çl
( "adb: could‚ot initialize Winsock\n" );

579 
	`©ex™
Ğ
_ş—nup_wšsock
 );

580 
_wšsock_š™
 = 1;

582 
	}
}

584 
	$sock‘_loİback_ş›Á
(
pÜt
, 
ty³
)

586 
FH
 
f
 = 
	`_fh_®loc
Ğ&
_fh_sock‘_şass
 );

587 
sockaddr_š
 
addr
;

588 
SOCKET
 
s
;

590 ià(!
f
)

593 ià(!
_wšsock_š™
)

594 
	`_š™_wšsock
();

596 
	`mem£t
(&
addr
, 0, (addr));

597 
addr
.
sš_çmy
 = 
AF_INET
;

598 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

599 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

601 
s
 = 
	`sock‘
(
AF_INET
, 
ty³
, 0);

602 if(
s
 =ğ
INVALID_SOCKET
) {

603 
	`D
("socket_loopback_client: could‚ot create socket\n" );

604 
	`_fh_şo£
(
f
);

608 
f
->
fh_sock‘
 = 
s
;

609 if(
	`cÚÃù
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

610 
	`D
("sock‘_loİback_ş›Á: could‚Ù cÚÃùØ%s:%d\n", 
ty³
 !ğ
SOCK_STREAM
 ? "udp" : "tı", 
pÜt
 );

611 
	`_fh_şo£
(
f
);

614 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%dÖo-ş›Á:%s%d)", 
	`_fh_to_št
(f), 
ty³
 !ğ
SOCK_STREAM
 ? "udp:" : "", 
pÜt
 );

615 
	`D
Ğ"sock‘_loİback_ş›Á:…Üˆ%dy³ % => fd %d\n", 
pÜt
, 
ty³
 !ğ
SOCK_STREAM
 ? "udp" : "tı", 
	`_fh_to_št
(
f
) );

616  
	`_fh_to_št
(
f
);

617 
	}
}

619 
	#LISTEN_BACKLOG
 4

	)

621 
	$sock‘_loİback_£rv”
(
pÜt
, 
ty³
)

623 
FH
 
f
 = 
	`_fh_®loc
Ğ&
_fh_sock‘_şass
 );

624 
sockaddr_š
 
addr
;

625 
SOCKET
 
s
;

626 
n
;

628 ià(!
f
) {

632 ià(!
_wšsock_š™
)

633 
	`_š™_wšsock
();

635 
	`mem£t
(&
addr
, 0, (addr));

636 
addr
.
sš_çmy
 = 
AF_INET
;

637 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

638 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

640 
s
 = 
	`sock‘
(
AF_INET
, 
ty³
, 0);

641 if(
s
 =ğ
INVALID_SOCKET
)  -1;

643 
f
->
fh_sock‘
 = 
s
;

645 
n
 = 1;

646 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_EXCLUSIVEADDRUSE
, (cÚ¡ *)&
n
, (n));

648 if(
	`bšd
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

649 
	`_fh_şo£
(
f
);

652 ià(
ty³
 =ğ
SOCK_STREAM
) {

653 
»t
;

655 
»t
 = 
	`li¡’
(
s
, 
LISTEN_BACKLOG
);

656 ià(
»t
 < 0) {

657 
	`_fh_şo£
(
f
);

661 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%dÖo-£rv”:%s%d)", 
	`_fh_to_št
(f), 
ty³
 !ğ
SOCK_STREAM
 ? "udp:" : "", 
pÜt
 );

662 
	`D
Ğ"sock‘_loİback_£rv”:…Üˆ%dy³ % => fd %d\n", 
pÜt
, 
ty³
 !ğ
SOCK_STREAM
 ? "udp" : "tı", 
	`_fh_to_št
(
f
) );

663  
	`_fh_to_št
(
f
);

664 
	}
}

667 
	$sock‘_ÃtwÜk_ş›Á
(cÚ¡ *
ho¡
, 
pÜt
, 
ty³
)

669 
FH
 
f
 = 
	`_fh_®loc
Ğ&
_fh_sock‘_şass
 );

670 
ho¡’t
 *
hp
;

671 
sockaddr_š
 
addr
;

672 
SOCKET
 
s
;

674 ià(!
f
)

677 ià(!
_wšsock_š™
)

678 
	`_š™_wšsock
();

680 
hp
 = 
	`g‘ho¡byÇme
(
ho¡
);

681 if(
hp
 == 0) {

682 
	`_fh_şo£
(
f
);

686 
	`mem£t
(&
addr
, 0, (addr));

687 
addr
.
sš_çmy
 = 
hp
->
h_add¹y³
;

688 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

689 
	`memıy
(&
addr
.
sš_addr
, 
hp
->
h_addr
, hp->
h_Ëngth
);

691 
s
 = 
	`sock‘
(
hp
->
h_add¹y³
, 
ty³
, 0);

692 if(
s
 =ğ
INVALID_SOCKET
) {

693 
	`_fh_şo£
(
f
);

696 
f
->
fh_sock‘
 = 
s
;

698 if(
	`cÚÃù
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

699 
	`_fh_şo£
(
f
);

703 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%dÒ‘-ş›Á:%s%d)", 
	`_fh_to_št
(f), 
ty³
 !ğ
SOCK_STREAM
 ? "udp:" : "", 
pÜt
 );

704 
	`D
Ğ"sock‘_ÃtwÜk_ş›Á: ho¡ '%s'…Üˆ%dy³ % => fd %d\n", 
ho¡
, 
pÜt
, 
ty³
 !ğ
SOCK_STREAM
 ? "udp" : "tı", 
	`_fh_to_št
(
f
) );

705  
	`_fh_to_št
(
f
);

706 
	}
}

709 
	$sock‘_ÃtwÜk_ş›Á_timeout
(cÚ¡ *
ho¡
, 
pÜt
, 
ty³
, 
timeout
)

712  
	`sock‘_ÃtwÜk_ş›Á
(
ho¡
, 
pÜt
, 
ty³
);

713 
	}
}

716 
	$sock‘_šaddr_ªy_£rv”
(
pÜt
, 
ty³
)

718 
FH
 
f
 = 
	`_fh_®loc
Ğ&
_fh_sock‘_şass
 );

719 
sockaddr_š
 
addr
;

720 
SOCKET
 
s
;

721 
n
;

723 ià(!
f
)

726 ià(!
_wšsock_š™
)

727 
	`_š™_wšsock
();

729 
	`mem£t
(&
addr
, 0, (addr));

730 
addr
.
sš_çmy
 = 
AF_INET
;

731 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

732 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

734 
s
 = 
	`sock‘
(
AF_INET
, 
ty³
, 0);

735 if(
s
 =ğ
INVALID_SOCKET
) {

736 
	`_fh_şo£
(
f
);

740 
f
->
fh_sock‘
 = 
s
;

741 
n
 = 1;

742 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_EXCLUSIVEADDRUSE
, (cÚ¡ *)&
n
, (n));

744 if(
	`bšd
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

745 
	`_fh_şo£
(
f
);

749 ià(
ty³
 =ğ
SOCK_STREAM
) {

750 
»t
;

752 
»t
 = 
	`li¡’
(
s
, 
LISTEN_BACKLOG
);

753 ià(
»t
 < 0) {

754 
	`_fh_şo£
(
f
);

758 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%d×ny-£rv”:%s%d)", 
	`_fh_to_št
(f), 
ty³
 !ğ
SOCK_STREAM
 ? "udp:" : "", 
pÜt
 );

759 
	`D
Ğ"sock‘_šaddr_£rv”:…Üˆ%dy³ % => fd %d\n", 
pÜt
, 
ty³
 !ğ
SOCK_STREAM
 ? "udp" : "tı", 
	`_fh_to_št
(
f
) );

760  
	`_fh_to_št
(
f
);

761 
	}
}

763 #undeà
acû±


764 
	$adb_sock‘_acû±
(
£rv”fd
, 
sockaddr
* 
addr
, 
sockËn_t
 *
add¾’
)

766 
FH
 
£rv”fh
 = 
	`_fh_äom_št
(
£rv”fd
);

767 
FH
 
fh
;

769 iàĞ!
£rv”fh
 || s”v”fh->
şazz
 !ğ&
_fh_sock‘_şass
 ) {

770 
	`D
Ğ"adb_sock‘_acû±: inv®id fd %d\n", 
£rv”fd
 );

774 
fh
 = 
	`_fh_®loc
Ğ&
_fh_sock‘_şass
 );

775 ià(!
fh
) {

776 
	`D
( "adb_socket_accept:‚otƒnough memoryo‡llocate‡ccepted socket descriptor\n" );

780 
fh
->
fh_sock‘
 = 
	`acû±
Ğ
£rv”fh
->fh_sock‘, 
addr
, 
add¾’
 );

781 ià(
fh
->
fh_sock‘
 =ğ
INVALID_SOCKET
) {

782 
	`_fh_şo£
Ğ
fh
 );

783 
	`D
Ğ"adb_sock‘_acû±:‡cû± oÀfd %d„‘uºƒ¼Ü %ld\n", 
£rv”fd
, 
	`G‘La¡E¼Ü
() );

787 
	`¢´štf
Ğ
fh
->
Çme
, (fh->Çme), "%d×cû±:%s)", 
	`_fh_to_št
(fh), 
£rv”fh
->name );

788 
	`D
Ğ"adb_sock‘_acû± oÀfd %d„‘uº fd %d\n", 
£rv”fd
, 
	`_fh_to_št
(
fh
) );

789  
	`_fh_to_št
(
fh
);

790 
	}
}

793 
	$adb_£tsockİt
Ğ
fd
, 
Ëv–
, 
İŠame
, cÚ¡ * 
İtv®
, 
sockËn_t
 
İ’
 )

795 
FH
 
fh
 = 
	`_fh_äom_št
(
fd
);

797 iàĞ!
fh
 || fh->
şazz
 !ğ&
_fh_sock‘_şass
 ) {

798 
	`D
("adb_£tsockİt: inv®id fd %d\n", 
fd
);

802  
	`£tsockİt
Ğ
fh
->
fh_sock‘
, 
Ëv–
, 
İŠame
, 
»š‹½»t_ÿ¡
<cÚ¡ *>(
İtv®
), 
İ’
 );

803 
	}
}

840 
	#BIP_BUFFER_SIZE
 4096

	)

843 
	~<¡dio.h
>

844 
	#BIPD
(
x
è
D
 
	)
x

845 
	#BIPDUMP
 
b_dump_hex


	)

847 
	$b_dump_hex
ĞcÚ¡ * 
±r
, 
size_t
 
Ën
 )

849 
Â
, 
Ën2
 = 
Ën
;

851 ià(
Ën2
 > 8)†en2 = 8;

853 
Â
 = 0;‚À< 
Ën2
;‚n++)

854 
	`´štf
("%02x", 
±r
[
Â
]);

855 
	`´štf
(" ");

857 
Â
 = 0;‚À< 
Ën2
;‚n++) {

858 
c
 = 
±r
[
Â
];

859 ià(
c
 < 32 || c > 127)

860 
c
 = '.';

861 
	`´štf
("%c", 
c
);

863 
	`´štf
("\n");

864 
	`fæush
(
¡dout
);

865 
	}
}

868 
	#BIPD
(
x
èdØ{} 0)

	)

869 
	#BIPDUMP
(
p
,
l
è
	`BIPD
Õ)

	)

872 
	sBBufãrRec_


874 
	ma_¡¬t
;

875 
	ma_’d
;

876 
	mb_’d
;

877 
	mfdš
;

878 
	mfdout
;

879 
	mşo£d
;

880 
	mÿn_wr™e
;

881 
HANDLE
 
	mevt_wr™e
;

882 
	mÿn_»ad
;

883 
HANDLE
 
	mevt_»ad
;

884 
CRITICAL_SECTION
 
	mlock
;

885 
	mbuff
[ 
BIP_BUFFER_SIZE
 ];

887 } 
	tBBufãrRec
, *
	tBBufãr
;

890 
	$b_bufãr_š™
Ğ
BBufãr
 
bufãr
 )

892 
	`D
Ğ"b™_bufãr_š™ %p\n", 
bufãr
 );

893 
bufãr
->
a_¡¬t
 = 0;

894 
bufãr
->
a_’d
 = 0;

895 
bufãr
->
b_’d
 = 0;

896 
bufãr
->
ÿn_wr™e
 = 1;

897 
bufãr
->
ÿn_»ad
 = 0;

898 
bufãr
->
fdš
 = 0;

899 
bufãr
->
fdout
 = 0;

900 
bufãr
->
şo£d
 = 0;

901 
bufãr
->
evt_wr™e
 = 
	`C»©eEv’t
Ğ
NULL
, 
TRUE
, TRUE, NULL );

902 
bufãr
->
evt_»ad
 = 
	`C»©eEv’t
Ğ
NULL
, 
TRUE
, 
FALSE
, NULL );

903 
	`In™ŸlizeCr™iÿlSeùiÚ
Ğ&
bufãr
->
lock
 );

904 
	}
}

907 
	$b_bufãr_şo£
Ğ
BBufãr
 
b
 )

909 
b
->
şo£d
 = 1;

911 ià(!
b
->
ÿn_»ad
) {

912 
	`S‘Ev’t
Ğ
b
->
evt_»ad
 );

914 ià(!
b
->
ÿn_wr™e
) {

915 
	`S‘Ev’t
Ğ
b
->
evt_wr™e
 );

917 
	}
}

920 
	$b_bufãr_dÚe
Ğ
BBufãr
 
b
 )

922 
	`BIPD
(Ğ"b_bufãr_dÚe: %d->%d\n", 
b
->
fdš
, b->
fdout
 ));

923 
	`Clo£HªdË
Ğ
b
->
evt_»ad
 );

924 
	`Clo£HªdË
Ğ
b
->
evt_wr™e
 );

925 
	`D–‘eCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

926 
	}
}

929 
	$b_bufãr_wr™e
Ğ
BBufãr
 
b
, cÚ¡ * 
¤c
, 
Ën
 )

931 
ava
, 
couÁ
 = 0;

933 ià(
Ën
 <= 0)

936 
	`BIPD
(Ğ"b_bufãr_wr™e:ƒÁ” %d->%d†’ %d\n", 
b
->
fdš
, b->
fdout
, 
Ën
 ));

937 
	`BIPDUMP
Ğ
¤c
, 
Ën
 );

939 
	`EÁ”Cr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

941 !
b
->
ÿn_wr™e
) {

942 
»t
;

943 
	`L—veCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

945 ià(
b
->
şo£d
) {

946 
”ºo
 = 
EPIPE
;

950 
»t
 = 
	`Wa™FÜSšgËObjeù
Ğ
b
->
evt_wr™e
, 
INFINITE
 );

951 ià(
»t
 !ğ
WAIT_OBJECT_0
) {

952 
	`D
Ğ"b_bufãr_wr™e:ƒ¼Ü %d->%d Wa™FÜSšgËObjeù„‘uºed %d,ƒ¼Ü %ld\n", 
b
->
fdš
, b->
fdout
, 
»t
, 
	`G‘La¡E¼Ü
() );

955 ià(
b
->
şo£d
) {

956 
”ºo
 = 
EPIPE
;

959 
	`EÁ”Cr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

962 
	`BIPD
(Ğ"b_bufãr_wr™e:ƒxeø%d->%d†’ %d\n", 
b
->
fdš
, b->
fdout
, 
Ën
 ));

964 
ava
 = 
BIP_BUFFER_SIZE
 - 
b
->
a_’d
;

965 ià(
ava
 > 0)

968 ià(
ava
 > 
Ën
)

969 
ava
 = 
Ën
;

971 
	`memıy
Ğ
b
->
buff
 + b->
a_’d
, 
¤c
, 
ava
 );

972 
¤c
 = (cÚ¡ *)¤ø+ 
ava
;

973 
couÁ
 +ğ
ava
;

974 
Ën
 -ğ
ava
;

976 
b
->
a_’d
 +ğ
ava
;

977 ià(
b
->
a_’d
 =ğ
BIP_BUFFER_SIZE
 && b->
a_¡¬t
 == 0) {

978 
b
->
ÿn_wr™e
 = 0;

979 
	`Re£tEv’t
Ğ
b
->
evt_wr™e
 );

980 
Ex™
;

984 ià(
Ën
 == 0)

985 
Ex™
;

987 
ava
 = 
b
->
a_¡¬t
 - b->
b_’d
;

988 
	`as£¹
Ğ
ava
 > 0 );

990 ià(
ava
 > 
Ën
)

991 
ava
 = 
Ën
;

993 
	`memıy
Ğ
b
->
buff
 + b->
b_’d
, 
¤c
, 
ava
 );

994 
couÁ
 +ğ
ava
;

995 
b
->
b_’d
 +ğ
ava
;

997 ià(
b
->
b_’d
 =ğb->
a_¡¬t
) {

998 
b
->
ÿn_wr™e
 = 0;

999 
	`Re£tEv’t
Ğ
b
->
evt_wr™e
 );

1002 
Ex™
:

1003 
	`as£¹
Ğ
couÁ
 > 0 );

1005 iàĞ!
b
->
ÿn_»ad
 ) {

1006 
b
->
ÿn_»ad
 = 1;

1007 
	`S‘Ev’t
Ğ
b
->
evt_»ad
 );

1010 
	`BIPD
(( "bip_buffer_write:ƒxit %d->%d count %d (as=%d‡e=%d be=%d cw=%d cr=%d\n",

1011 
b
->
fdš
, b->
fdout
, 
couÁ
, b->
a_¡¬t
, b->
a_’d
, b->
b_’d
, b->
ÿn_wr™e
, b->
ÿn_»ad
 ));

1012 
	`L—veCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1014  
couÁ
;

1015 
	}
}

1018 
	$b_bufãr_»ad
Ğ
BBufãr
 
b
, * 
d¡
, 
Ën
 )

1020 
ava
, 
couÁ
 = 0;

1022 ià(
Ën
 <= 0)

1025 
	`BIPD
(Ğ"b_bufãr_»ad:ƒÁ” %d->%d†’ %d\n", 
b
->
fdš
, b->
fdout
, 
Ën
 ));

1027 
	`EÁ”Cr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1028  !
b
->
ÿn_»ad
 )

1031 
	`L—veCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1032 
”ºo
 = 
EAGAIN
;

1035 
»t
;

1036 
	`L—veCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1038 ià(
b
->
şo£d
) {

1039 
”ºo
 = 
EPIPE
;

1043 
»t
 = 
	`Wa™FÜSšgËObjeù
Ğ
b
->
evt_»ad
, 
INFINITE
 );

1044 ià(
»t
 !ğ
WAIT_OBJECT_0
) {

1045 
	`D
Ğ"b_bufãr_»ad:ƒ¼Ü %d->%d Wa™FÜSšgËObjeù„‘uºed %d,ƒ¼Ü %ld\n", 
b
->
fdš
, b->
fdout
, 
»t
, 
	`G‘La¡E¼Ü
());

1048 ià(
b
->
şo£d
) {

1049 
”ºo
 = 
EPIPE
;

1052 
	`EÁ”Cr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1056 
	`BIPD
(Ğ"b_bufãr_»ad:ƒxeø%d->%d†’ %d\n", 
b
->
fdš
, b->
fdout
, 
Ën
 ));

1058 
ava
 = 
b
->
a_’d
 - b->
a_¡¬t
;

1059 
	`as£¹
Ğ
ava
 > 0 );

1061 ià(
ava
 > 
Ën
)

1062 
ava
 = 
Ën
;

1064 
	`memıy
Ğ
d¡
, 
b
->
buff
 + b->
a_¡¬t
, 
ava
 );

1065 
d¡
 = (*)d¡ + 
ava
;

1066 
couÁ
 +ğ
ava
;

1067 
Ën
 -ğ
ava
;

1069 
b
->
a_¡¬t
 +ğ
ava
;

1070 ià(
b
->
a_¡¬t
 < b->
a_’d
)

1071 
Ex™
;

1073 
b
->
a_¡¬t
 = 0;

1074 
b
->
a_’d
 = b->
b_’d
;

1075 
b
->
b_’d
 = 0;

1077 
ava
 = 
b
->
a_’d
;

1078 ià(
ava
 > 0) {

1079 ià(
ava
 > 
Ën
)

1080 
ava
 = 
Ën
;

1081 
	`memıy
Ğ
d¡
, 
b
->
buff
, 
ava
 );

1082 
couÁ
 +ğ
ava
;

1083 
b
->
a_¡¬t
 +ğ
ava
;

1085 iàĞ
b
->
a_¡¬t
 < b->
a_’d
 )

1086 
Ex™
;

1088 
b
->
a_¡¬t
 = b->
a_’d
 = 0;

1091 
b
->
ÿn_»ad
 = 0;

1092 
	`Re£tEv’t
Ğ
b
->
evt_»ad
 );

1094 
Ex™
:

1095 
	`as£¹
Ğ
couÁ
 > 0 );

1097 ià(!
b
->
ÿn_wr™e
 ) {

1098 
b
->
ÿn_wr™e
 = 1;

1099 
	`S‘Ev’t
Ğ
b
->
evt_wr™e
 );

1102 
	`BIPDUMP
Ğ(cÚ¡ *)
d¡
 - 
couÁ
, count );

1103 
	`BIPD
(( "bip_buffer_read:ƒxit %d->%d count %d (as=%d‡e=%d be=%d cw=%d cr=%d\n",

1104 
b
->
fdš
, b->
fdout
, 
couÁ
, b->
a_¡¬t
, b->
a_’d
, b->
b_’d
, b->
ÿn_wr™e
, b->
ÿn_»ad
 ));

1105 
	`L—veCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1107  
couÁ
;

1108 
	}
}

1110 
	sSock‘PaœRec_


1112 
BBufãrRec
 
	ma2b_b
;

1113 
BBufãrRec
 
	mb2a_b
;

1114 
FH
 
	ma_fd
;

1115 
	mu£d
;

1117 } 
	tSock‘PaœRec
;

1119 
	$_fh_sock‘·œ_š™
Ğ
FH
 
f
 )

1121 
f
->
fh_·œ
 = 
NULL
;

1122 
	}
}

1125 
	$_fh_sock‘·œ_şo£
Ğ
FH
 
f
 )

1127 iàĞ
f
->
fh_·œ
 ) {

1128 
Sock‘Paœ
 
·œ
 = 
f
->
fh_·œ
;

1130 iàĞ
f
 =ğ
·œ
->
a_fd
 ) {

1131 
·œ
->
a_fd
 = 
NULL
;

1134 
	`b_bufãr_şo£
Ğ&
·œ
->
b2a_b
 );

1135 
	`b_bufãr_şo£
Ğ&
·œ
->
a2b_b
 );

1137 iàĞ--
·œ
->
u£d
 == 0 ) {

1138 
	`b_bufãr_dÚe
Ğ&
·œ
->
b2a_b
 );

1139 
	`b_bufãr_dÚe
Ğ&
·œ
->
a2b_b
 );

1140 
	`ä“
Ğ
·œ
 );

1142 
f
->
fh_·œ
 = 
NULL
;

1145 
	}
}

1148 
	$_fh_sock‘·œ_l£ek
Ğ
FH
 
f
, 
pos
, 
Üigš
 )

1150 
”ºo
 = 
ESPIPE
;

1152 
	}
}

1155 
	$_fh_sock‘·œ_»ad
Ğ
FH
 
f
, * 
buf
, 
Ën
 )

1157 
Sock‘Paœ
 
·œ
 = 
f
->
fh_·œ
;

1158 
BBufãr
 
b
;

1160 ià(!
·œ
)

1163 iàĞ
f
 =ğ
·œ
->
a_fd
 )

1164 
b
 = &
·œ
->
b2a_b
;

1166 
b
 = &
·œ
->
a2b_b
;

1168  
	`b_bufãr_»ad
Ğ
b
, 
buf
, 
Ën
 );

1169 
	}
}

1172 
	$_fh_sock‘·œ_wr™e
Ğ
FH
 
f
, cÚ¡ * 
buf
, 
Ën
 )

1174 
Sock‘Paœ
 
·œ
 = 
f
->
fh_·œ
;

1175 
BBufãr
 
b
;

1177 ià(!
·œ
)

1180 iàĞ
f
 =ğ
·œ
->
a_fd
 )

1181 
b
 = &
·œ
->
a2b_b
;

1183 
b
 = &
·œ
->
b2a_b
;

1185  
	`b_bufãr_wr™e
Ğ
b
, 
buf
, 
Ën
 );

1186 
	}
}

1189 
_fh_sock‘·œ_hook
Ğ
FH
 
f
, 
ev’t
, 
Ev’tHook
 
hook
 );

1191 cÚ¡ 
FHCÏssRec
 
	g_fh_sock‘·œ_şass
 =

1193 
_fh_sock‘·œ_š™
,

1194 
_fh_sock‘·œ_şo£
,

1195 
_fh_sock‘·œ_l£ek
,

1196 
_fh_sock‘·œ_»ad
,

1197 
_fh_sock‘·œ_wr™e
,

1198 
_fh_sock‘·œ_hook


1202 
	$adb_sock‘·œ
(
sv
[2]) {

1203 
Sock‘Paœ
 
·œ
;

1205 
FH
 
ç
 = 
	`_fh_®loc
(&
_fh_sock‘·œ_şass
);

1206 
FH
 
fb
 = 
	`_fh_®loc
(&
_fh_sock‘·œ_şass
);

1208 ià(!
ç
 || !
fb
)

1209 
Fa
;

1211 
·œ
 = 
»š‹½»t_ÿ¡
<
Sock‘Paœ
>(
	`m®loc
((*pair)));

1212 ià(
·œ
 =ğ
NULL
) {

1213 
	`D
("adb_socketpair:‚otƒnough memoryo‡llocate…ipes\n" );

1214 
Fa
;

1217 
	`b_bufãr_š™
Ğ&
·œ
->
a2b_b
 );

1218 
	`b_bufãr_š™
Ğ&
·œ
->
b2a_b
 );

1220 
ç
->
fh_·œ
 = 
·œ
;

1221 
fb
->
fh_·œ
 = 
·œ
;

1222 
·œ
->
u£d
 = 2;

1223 
·œ
->
a_fd
 = 
ç
;

1225 
sv
[0] = 
	`_fh_to_št
(
ç
);

1226 
sv
[1] = 
	`_fh_to_št
(
fb
);

1228 
·œ
->
a2b_b
.
fdš
 = 
sv
[0];

1229 
·œ
->
a2b_b
.
fdout
 = 
sv
[1];

1230 
·œ
->
b2a_b
.
fdš
 = 
sv
[1];

1231 
·œ
->
b2a_b
.
fdout
 = 
sv
[0];

1233 
	`¢´štf
Ğ
ç
->
Çme
, (ç->Çme), "%dÕaœ:%d)", 
sv
[0], sv[1] );

1234 
	`¢´štf
Ğ
fb
->
Çme
, (fb->Çme), "%dÕaœ:%d)", 
sv
[1], sv[0] );

1235 
	`D
Ğ"adb_sock‘·œ:„‘uº (%d, %d)\n", 
sv
[0], sv[1] );

1238 
Fa
:

1239 
	`_fh_şo£
(
fb
);

1240 
	`_fh_şo£
(
ç
);

1242 
	}
}

1255 
	#FATAL
(
x
...è
	`çl
(
__FUNCTION__
, x)

	)

1257 #ià
DEBUG


1258 
	$dump_fde
(
fdev’t
 *
fde
, cÚ¡ *
šfo
)

1260 
	`årštf
(
¡d”r
,"FDE #%03d %c%c%ø%s\n", 
fde
->
fd
,

1261 
fde
->
¡©e
 & 
FDE_READ
 ? 'R' : ' ',

1262 
fde
->
¡©e
 & 
FDE_WRITE
 ? 'W' : ' ',

1263 
fde
->
¡©e
 & 
FDE_ERROR
 ? 'E' : ' ',

1264 
šfo
);

1265 
	}
}

1267 
	#dump_fde
(
fde
, 
šfo
èdØ{ } 0)

	)

1270 
	#FDE_EVENTMASK
 0x00ff

	)

1271 
	#FDE_STATEMASK
 0xff00

	)

1273 
	#FDE_ACTIVE
 0x0100

	)

1274 
	#FDE_PENDING
 0x0200

	)

1275 
	#FDE_CREATED
 0x0400

	)

1277 
fdev’t_¶i¡_’queue
(
fdev’t
 *
node
);

1278 
fdev’t_¶i¡_»move
(
fdev’t
 *
node
);

1279 
fdev’t
 *
fdev’t_¶i¡_dequeue
();

1281 
fdev’t
 
	gli¡_³ndšg
 = {

1282 .
Ãxt
 = &
li¡_³ndšg
,

1283 .
	g´ev
 = &
li¡_³ndšg
,

1286 
fdev’t
 **
	gfd_bË
 = 0;

1287 
	gfd_bË_max
 = 0;

1289 
Ev’tLoİ”Rec_
* 
	tEv’tLoİ”
;

1291 
	sEv’tHookRec_


1293 
Ev’tHook
 
	mÃxt
;

1294 
FH
 
	mfh
;

1295 
HANDLE
 
	mh
;

1296 
	mwª‹d
;

1297 
	m»ady
;

1298 * 
	maux
;

1299 (*
	m´•¬e
)Ğ
Ev’tHook
 
	mhook
 );

1300 (*
	m¡¬t
èĞ
Ev’tHook
 
	mhook
 );

1301 (*
	m¡İ
èĞ
Ev’tHook
 
	mhook
 );

1302 (*
	mcheck
èĞ
Ev’tHook
 
	mhook
 );

1303 (*
	m³ek
èĞ
Ev’tHook
 
	mhook
 );

1304 } 
	tEv’tHookRec
;

1306 
Ev’tHook
 
	g_ä“_hooks
;

1308 
Ev’tHook


1309 
	$ev’t_hook_®loc
(
FH
 
fh
) {

1310 
Ev’tHook
 
hook
 = 
_ä“_hooks
;

1311 ià(
hook
 !ğ
NULL
) {

1312 
_ä“_hooks
 = 
hook
->
Ãxt
;

1314 
hook
 = 
»š‹½»t_ÿ¡
<
Ev’tHook
>(
	`m®loc
((*hook)));

1315 ià(
hook
 =ğ
NULL
)

1316 
	`çl
( "could‚ot‡llocateƒvent hook\n" );

1318 
hook
->
Ãxt
 = 
NULL
;

1319 
hook
->
fh
 = fh;

1320 
hook
->
wª‹d
 = 0;

1321 
hook
->
»ady
 = 0;

1322 
hook
->
h
 = 
INVALID_HANDLE_VALUE
;

1323 
hook
->
aux
 = 
NULL
;

1325 
hook
->
´•¬e
 = 
NULL
;

1326 
hook
->
¡¬t
 = 
NULL
;

1327 
hook
->
¡İ
 = 
NULL
;

1328 
hook
->
check
 = 
NULL
;

1329 
hook
->
³ek
 = 
NULL
;

1331  
hook
;

1332 
	}
}

1335 
	$ev’t_hook_ä“
Ğ
Ev’tHook
 
hook
 )

1337 
hook
->
fh
 = 
NULL
;

1338 
hook
->
wª‹d
 = 0;

1339 
hook
->
»ady
 = 0;

1340 
hook
->
Ãxt
 = 
_ä“_hooks
;

1341 
_ä“_hooks
 = 
hook
;

1342 
	}
}

1346 
	$ev’t_hook_sigÇl
Ğ
Ev’tHook
 
hook
 )

1348 
FH
 
f
 = 
hook
->
fh
;

1349 
fd
 = 
	`_fh_to_št
(
f
);

1350 
fdev’t
* 
fde
 = 
fd_bË
[ 
fd
 - 
WIN32_FH_BASE
 ];

1352 ià(
fde
 !ğ
NULL
 && fde->
fd
 == fd) {

1353 ià((
fde
->
¡©e
 & 
FDE_PENDING
) == 0) {

1354 
fde
->
¡©e
 |ğ
FDE_PENDING
;

1355 
	`fdev’t_¶i¡_’queue
Ğ
fde
 );

1357 
fde
->
ev’ts
 |ğ
hook
->
wª‹d
;

1359 
	}
}

1362 
	#MAX_LOOPER_HANDLES
 
WIN32_MAX_FHS


	)

1364 
	sEv’tLoİ”Rec_


1366 
Ev’tHook
 
	mhooks
;

1367 
HANDLE
 
	mhb
[ 
MAX_LOOPER_HANDLES
 ];

1368 
	mhb_couÁ
;

1370 } 
	tEv’tLoİ”Rec
;

1372 
Ev’tHook
*

1373 
	$ev’t_loİ”_fšd_p
Ğ
Ev’tLoİ”
 
loİ”
, 
FH
 
fh
 )

1375 
Ev’tHook
 *
²ode
 = &
loİ”
->
hooks
;

1376 
Ev’tHook
 
node
 = *
²ode
;

1378 iàĞ
node
 =ğ
NULL
 ||‚ode->
fh
 == fh )

1380 
²ode
 = &
node
->
Ãxt
;

1381 
node
 = *
²ode
;

1383  
²ode
;

1384 
	}
}

1387 
	$ev’t_loİ”_hook
Ğ
Ev’tLoİ”
 
loİ”
, 
fd
, 
ev’ts
 )

1389 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

1390 
Ev’tHook
 *
²ode
;

1391 
Ev’tHook
 
node
;

1393 ià(
f
 =ğ
NULL
) {

1394 
	`D
("ev’t_loİ”_hook: inv®id fd=%d\n", 
fd
);

1398 
²ode
 = 
	`ev’t_loİ”_fšd_p
Ğ
loİ”
, 
f
 );

1399 
node
 = *
²ode
;

1400 iàĞ
node
 =ğ
NULL
 ) {

1401 
node
 = 
	`ev’t_hook_®loc
Ğ
f
 );

1402 
node
->
Ãxt
 = *
²ode
;

1403 *
²ode
 = 
node
;

1406 iàĞ(
node
->
wª‹d
 & 
ev’ts
) !=ƒvents ) {

1408 
	`D
("event_looper_hook: call hook for %d (new=%x, old=%x)\n",

1409 
fd
, 
node
->
wª‹d
, 
ev’ts
);

1410 
f
->
şazz
->
	`_fh_hook
Ğf, 
ev’ts
 & ~
node
->
wª‹d
,‚ode );

1411 
node
->
wª‹d
 |ğ
ev’ts
;

1413 
	`D
("event_looper_hook: ignoringƒvents %x for %d wanted=%x)\n",

1414 
ev’ts
, 
fd
, 
node
->
wª‹d
);

1416 
	}
}

1419 
	$ev’t_loİ”_unhook
Ğ
Ev’tLoİ”
 
loİ”
, 
fd
, 
ev’ts
 )

1421 
FH
 
fh
 = 
	`_fh_äom_št
(
fd
);

1422 
Ev’tHook
 *
²ode
 = 
	`ev’t_loİ”_fšd_p
Ğ
loİ”
, 
fh
 );

1423 
Ev’tHook
 
node
 = *
²ode
;

1425 ià(
node
 !ğ
NULL
) {

1426 
ev’ts2
 = 
ev’ts
 & 
node
->
wª‹d
;

1427 iàĞ
ev’ts2
 == 0 ) {

1428 
	`D
Ğ"ev’t_loİ”_unhook:ƒv’t %x‚Ù„egi¡”ed fÜ fd %d\n", 
ev’ts
, 
fd
 );

1431 
node
->
wª‹d
 &ğ~
ev’ts2
;

1432 ià(!
node
->
wª‹d
) {

1433 *
²ode
 = 
node
->
Ãxt
;

1434 
	`ev’t_hook_ä“
Ğ
node
 );

1437 
	}
}

1458 
	#WAIT_ALL_CHUNK_SIZE
 63

	)

1461 
	sWa™FÜAÎP¬am
 {

1465 
HANDLE
 
	mmaš_ev’t
;

1474 
LONG
 vŞ©*
	msigÇËd_šdex
;

1476 
HANDLE
* 
	mhªdËs
;

1478 
	mhªdËs_couÁ
;

1480 
	mfœ¡_hªdË_šdex
;

1482 
HANDLE
 
	mth»ad
;

1483 } 
	tWa™FÜAÎP¬am
;

1486 
__¡dÿÎ


1487 
	$_š_wa™”_th»ad
(* 
¬g
)

1489 
HANDLE
 
wa™_Ú
[
WAIT_ALL_CHUNK_SIZE
 + 1];

1490 
»s
;

1491 
Wa™FÜAÎP¬am
* cÚ¡ 
·¿m
 = (Wa™FÜAÎP¬am*)
¬g
;

1495 
wa™_Ú
[0] = 
·¿m
->
maš_ev’t
;

1497 
	`memıy
(
wa™_Ú
 + 1, 
·¿m
->
hªdËs
,…¬am->
hªdËs_couÁ
 * (
HANDLE
));

1499 
»s
 = 
	`Wa™FÜMuÉËObjeùs
(
·¿m
->
hªdËs_couÁ
 + 1, 
wa™_Ú
, 
FALSE
, 
INFINITE
);

1500 ià(
»s
 > 0 &&„e < (
·¿m
->
hªdËs_couÁ
 + 1)) {

1503 
	`IÁ”lockedCom·»Exchªge
(
·¿m
->
sigÇËd_šdex
,

1504 
»s
 - 1L + 
·¿m
->
fœ¡_hªdË_šdex
, -1L);

1508 
	`S‘Ev’t
(
·¿m
->
maš_ev’t
);

1510 
	`_’dth»adex
(0);

1512 
	}
}

1523 
	$_wa™_fÜ_®l
(
HANDLE
* 
hªdËs
, 
hªdËs_couÁ
)

1525 
Wa™FÜAÎP¬am
* 
th»ads
;

1526 
HANDLE
 
maš_ev’t
;

1527 
chunks
, 
chunk
, 
»mašs
;

1539 vŞ©
LONG
 
sig_šdex
 = -1;

1542 
chunks
 = 
hªdËs_couÁ
 / 
WAIT_ALL_CHUNK_SIZE
;

1543 
»mašs
 = 
hªdËs_couÁ
 % 
WAIT_ALL_CHUNK_SIZE
;

1544 
th»ads
 = (
Wa™FÜAÎP¬am
*)
	`m®loc
((
chunks
 + (
»mašs
 ? 1 : 0)) *

1545 (
Wa™FÜAÎP¬am
));

1546 ià(
th»ads
 =ğ
NULL
) {

1547 
	`D
("UÇbËØ®loÿ‹h»ad‡¼ay fÜ %d hªdËs.", 
hªdËs_couÁ
);

1548  ()
WAIT_FAILED
;

1553 
maš_ev’t
 = 
	`C»©eEv’t
(
NULL
, 
TRUE
, 
FALSE
, NULL);

1554 ià(
maš_ev’t
 =ğ
NULL
) {

1555 
	`D
("UÇbËØü—‹ mašƒv’t. E¼Ü: %d", ()
	`G‘La¡E¼Ü
());

1556 
	`ä“
(
th»ads
);

1557  ()
WAIT_FAILED
;

1564 
chunk
 = 0; chunk < 
chunks
; chunk++) {

1565 
th»ads
[
chunk
].
maš_ev’t
 = main_event;

1566 
th»ads
[
chunk
].
sigÇËd_šdex
 = &
sig_šdex
;

1567 
th»ads
[
chunk
].
fœ¡_hªdË_šdex
 = 
WAIT_ALL_CHUNK_SIZE
 * chunk;

1568 
th»ads
[
chunk
].
hªdËs
 = hªdË +h»ads[chunk].
fœ¡_hªdË_šdex
;

1569 
th»ads
[
chunk
].
hªdËs_couÁ
 = 
WAIT_ALL_CHUNK_SIZE
;

1571 ià(
»mašs
) {

1572 
th»ads
[
chunk
].
maš_ev’t
 = main_event;

1573 
th»ads
[
chunk
].
sigÇËd_šdex
 = &
sig_šdex
;

1574 
th»ads
[
chunk
].
fœ¡_hªdË_šdex
 = 
WAIT_ALL_CHUNK_SIZE
 * chunk;

1575 
th»ads
[
chunk
].
hªdËs
 = hªdË +h»ads[chunk].
fœ¡_hªdË_šdex
;

1576 
th»ads
[
chunk
].
hªdËs_couÁ
 = 
»mašs
;

1577 
chunks
++;

1581 
chunk
 = 0; chunk < 
chunks
; chunk++) {

1584 
th»ads
[
chunk
].
th»ad
 = (
HANDLE
)
	`_begšth»adex
(
NULL
, 0, 
_š_wa™”_th»ad
,

1585 &
th»ads
[
chunk
], 0, 
NULL
);

1586 ià(
th»ads
[
chunk
].
th»ad
 =ğ
NULL
) {

1588 
	`D
("Unableo create‡ waitinghread %d of %d.ƒrrno=%d",

1589 
chunk
, 
chunks
, 
”ºo
);

1590 
chunks
 = 
chunk
;

1591 
	`S‘Ev’t
(
maš_ev’t
);

1597 
	`Wa™FÜSšgËObjeù
(
maš_ev’t
, 
INFINITE
);

1600 
chunk
 = 0; chunk < 
chunks
; chunk++) {

1601 
	`Wa™FÜSšgËObjeù
(
th»ads
[
chunk
].
th»ad
, 
INFINITE
);

1602 
	`Clo£HªdË
(
th»ads
[
chunk
].
th»ad
);

1605 
	`Clo£HªdË
(
maš_ev’t
);

1606 
	`ä“
(
th»ads
);

1609 cÚ¡ 
»t
 = ()
	`IÁ”lockedCom·»Exchªge
(&
sig_šdex
, -1, -1);

1610  (
»t
 >ğ0è?„‘ : ()
WAIT_FAILED
;

1611 
	}
}

1613 
Ev’tLoİ”Rec
 
	gwš32_loİ”
;

1615 
	$fdev’t_š™
()

1617 
wš32_loİ”
.
hb_couÁ
 = 0;

1618 
wš32_loİ”
.
hooks
 = 
NULL
;

1619 
	}
}

1621 
	$fdev’t_cÚÃù
(
fdev’t
 *
fde
)

1623 
Ev’tLoİ”
 
loİ”
 = &
wš32_loİ”
;

1624 
ev’ts
 = 
fde
->
¡©e
 & 
FDE_EVENTMASK
;

1626 ià(
ev’ts
 != 0)

1627 
	`ev’t_loİ”_hook
Ğ
loİ”
, 
fde
->
fd
, 
ev’ts
 );

1628 
	}
}

1630 
	$fdev’t_discÚÃù
(
fdev’t
 *
fde
)

1632 
Ev’tLoİ”
 
loİ”
 = &
wš32_loİ”
;

1633 
ev’ts
 = 
fde
->
¡©e
 & 
FDE_EVENTMASK
;

1635 ià(
ev’ts
 != 0)

1636 
	`ev’t_loİ”_unhook
Ğ
loİ”
, 
fde
->
fd
, 
ev’ts
 );

1637 
	}
}

1639 
	$fdev’t_upd©e
(
fdev’t
 *
fde
, 
ev’ts
)

1641 
Ev’tLoİ”
 
loİ”
 = &
wš32_loİ”
;

1642 
ev’ts0
 = 
fde
->
¡©e
 & 
FDE_EVENTMASK
;

1644 ià(
ev’ts
 !ğ
ev’ts0
) {

1645 
»moves
 = 
ev’ts0
 & ~
ev’ts
;

1646 
adds
 = 
ev’ts
 & ~
ev’ts0
;

1647 ià(
»moves
) {

1648 
	`D
("fdev’t_upd©e:„emov%x from %d\n", 
»moves
, 
fde
->
fd
);

1649 
	`ev’t_loİ”_unhook
Ğ
loİ”
, 
fde
->
fd
, 
»moves
 );

1651 ià(
adds
) {

1652 
	`D
("fdev’t_upd©e:‡dd %xØ%d\n", 
adds
, 
fde
->
fd
);

1653 
	`ev’t_loİ”_hook
 ( 
loİ”
, 
fde
->
fd
, 
adds
 );

1656 
	}
}

1658 
	$fdev’t_´oûss
()

1660 
Ev’tLoİ”
 
loİ”
 = &
wš32_loİ”
;

1661 
Ev’tHook
 
hook
;

1662 
gÙÚe
 = 0;

1665 
hook
 = 
loİ”
->
hooks
; hook; hook = hook->
Ãxt
) {

1666 
hook
->
»ady
 = 0;

1667 ià(
hook
->
´•¬e
) {

1668 
hook
->
	`´•¬e
(hook);

1669 ià(
hook
->
»ady
 != 0) {

1670 
	`ev’t_hook_sigÇl
Ğ
hook
 );

1671 
gÙÚe
 = 1;

1677 ià(!
gÙÚe
)

1679 
loİ”
->
hb_couÁ
 = 0;

1681 
hook
 = 
loİ”
->
hooks
; hook; hook = hook->
Ãxt
)

1683 ià(
hook
->
¡¬t
 && !hook->
	`¡¬t
(hook)) {

1684 
	`D
( "fdevent_process:ƒrror when starting‡ hook\n" );

1687 ià(
hook
->
h
 !ğ
INVALID_HANDLE_VALUE
) {

1688 
Â
;

1690 
Â
 = 0;‚À< 
loİ”
->
hb_couÁ
;‚n++)

1692 iàĞ
loİ”
->
hb
[
Â
] =ğ
hook
->
h
 )

1693 
DÚtAdd
;

1695 
loİ”
->
hb
[†oİ”->
hb_couÁ
++ ] = 
hook
->
h
;

1696 
DÚtAdd
:

1701 ià(
loİ”
->
hb_couÁ
 == 0) {

1702 
	`D
( "fdevent_process:‚othingo wait for !!\n" );

1708 
wa™_»t
;

1710 
	`D
Ğ"adb_wš32: wa™šg fÜ %dƒv’ts\n", 
loİ”
->
hb_couÁ
 );

1711 ià(
loİ”
->
hb_couÁ
 > 
MAXIMUM_WAIT_OBJECTS
) {

1712 
	`D
("hªdË couÁ %dƒxûed MAXIMUM_WAIT_OBJECTS.\n", 
loİ”
->
hb_couÁ
);

1713 
wa™_»t
 = 
	`_wa™_fÜ_®l
(
loİ”
->
hb
,†oİ”->
hb_couÁ
);

1715 
wa™_»t
 = 
	`Wa™FÜMuÉËObjeùs
Ğ
loİ”
->
hb_couÁ
,†oİ”->
hb
, 
FALSE
, 
INFINITE
 );

1717 ià(
wa™_»t
 =ğ()
WAIT_FAILED
) {

1718 
	`D
Ğ"adb_wš32: wa™ faed,ƒ¼Ü %ld\n", 
	`G‘La¡E¼Ü
() );

1720 
	`D
Ğ"adb_wš32: gÙ oÃ (šdex %d)\n", 
wa™_»t
 );

1725 ià(()
wa™_»t
 < ()
loİ”
->
hb_couÁ
)

1727 
hook
 = 
loİ”
->
hooks
; hook; hook = hook->
Ãxt
)

1729 iàĞ
loİ”
->
hb
[
wa™_»t
] =ğ
hook
->
h
 &&

1730 (!
hook
->
check
 || hook->
	`check
(hook)) )

1732 
	`D
Ğ"adb_wš32: sigÇlšg % fÜ %x\n", 
hook
->
fh
->
Çme
, hook->
»ady
 );

1733 
	`ev’t_hook_sigÇl
Ğ
hook
 );

1734 
gÙÚe
 = 1;

1741 !
gÙÚe
);

1743 
hook
 = 
loİ”
->
hooks
; hook; hook = hook->
Ãxt
) {

1744 ià(
hook
->
¡İ
)

1745 
hook
->
	`¡İ
( hook );

1749 
hook
 = 
loİ”
->
hooks
; hook; hook = hook->
Ãxt
) {

1750 ià(
hook
->
³ek
 && hook->
	`³ek
(hook))

1751 
	`ev’t_hook_sigÇl
Ğ
hook
 );

1753 
	}
}

1756 
	$fdev’t_»gi¡”
(
fdev’t
 *
fde
)

1758 
fd
 = 
fde
->fd - 
WIN32_FH_BASE
;

1760 if(
fd
 < 0) {

1761 
	`FATAL
("bogu Ãg©ivfd (%d)\n", 
fde
->
fd
);

1764 if(
fd
 >ğ
fd_bË_max
) {

1765 
Şdmax
 = 
fd_bË_max
;

1766 if(
fde
->
fd
 > 32000) {

1767 
	`FATAL
("bogu huuuugfd (%d)\n", 
fde
->
fd
);

1769 if(
fd_bË_max
 == 0) {

1770 
	`fdev’t_š™
();

1771 
fd_bË_max
 = 256;

1773 
fd_bË_max
 <ğ
fd
) {

1774 
fd_bË_max
 *= 2;

1776 
fd_bË
 = 
»š‹½»t_ÿ¡
<
fdev’t
**>(
	`»®loc
(fd_bË, (fdev’t*è* 
fd_bË_max
));

1777 if(
fd_bË
 == 0) {

1778 
	`FATAL
("could‚Ùƒx·nd fd_bËØ%dƒÁr›s\n", 
fd_bË_max
);

1780 
	`mem£t
(
fd_bË
 + 
Şdmax
, 0, (è* (
fd_bË_max
 - oldmax));

1783 
fd_bË
[
fd
] = 
fde
;

1784 
	}
}

1786 
	$fdev’t_uÄegi¡”
(
fdev’t
 *
fde
)

1788 
fd
 = 
fde
->fd - 
WIN32_FH_BASE
;

1790 if((
fd
 < 0è|| (fd >ğ
fd_bË_max
)) {

1791 
	`FATAL
("fd ouˆoà¿ng(%d)\n", 
fde
->
fd
);

1794 if(
fd_bË
[
fd
] !ğ
fde
) {

1795 
	`FATAL
("fd_table out of sync");

1798 
fd_bË
[
fd
] = 0;

1800 if(!(
fde
->
¡©e
 & 
FDE_DONT_CLOSE
)) {

1801 
	`dump_fde
(
fde
, "close");

1802 
	`adb_şo£
(
fde
->
fd
);

1804 
	}
}

1806 
	$fdev’t_¶i¡_’queue
(
fdev’t
 *
node
)

1808 
fdev’t
 *
li¡
 = &
li¡_³ndšg
;

1810 
node
->
Ãxt
 = 
li¡
;

1811 
node
->
´ev
 = 
li¡
->prev;

1812 
node
->
´ev
->
Ãxt
 =‚ode;

1813 
li¡
->
´ev
 = 
node
;

1814 
	}
}

1816 
	$fdev’t_¶i¡_»move
(
fdev’t
 *
node
)

1818 
node
->
´ev
->
Ãxt
 =‚ode->next;

1819 
node
->
Ãxt
->
´ev
 =‚ode->prev;

1820 
node
->
Ãxt
 = 0;

1821 
node
->
´ev
 = 0;

1822 
	}
}

1824 
fdev’t
 *
	$fdev’t_¶i¡_dequeue
()

1826 
fdev’t
 *
li¡
 = &
li¡_³ndšg
;

1827 
fdev’t
 *
node
 = 
li¡
->
Ãxt
;

1829 if(
node
 =ğ
li¡
)  0;

1831 
li¡
->
Ãxt
 = 
node
->next;

1832 
li¡
->
Ãxt
->
´ev
 =†ist;

1833 
node
->
Ãxt
 = 0;

1834 
node
->
´ev
 = 0;

1836  
node
;

1837 
	}
}

1839 
fdev’t
 *
	$fdev’t_ü—‹
(
fd
, 
fd_func
 
func
, *
¬g
)

1841 
fdev’t
 *
fde
 = (fdev’t*è
	`m®loc
((fdevent));

1842 if(
fde
 == 0)  0;

1843 
	`fdev’t_š¡®l
(
fde
, 
fd
, 
func
, 
¬g
);

1844 
fde
->
¡©e
 |ğ
FDE_CREATED
;

1845  
fde
;

1846 
	}
}

1848 
	$fdev’t_de¡roy
(
fdev’t
 *
fde
)

1850 if(
fde
 == 0) ;

1851 if(!(
fde
->
¡©e
 & 
FDE_CREATED
)) {

1852 
	`FATAL
("fd%°nÙ c»©ed by fdev’t_ü—‹()\n", 
fde
);

1854 
	`fdev’t_»move
(
fde
);

1855 
	}
}

1857 
	$fdev’t_š¡®l
(
fdev’t
 *
fde
, 
fd
, 
fd_func
 
func
, *
¬g
)

1859 
	`mem£t
(
fde
, 0, (
fdev’t
));

1860 
fde
->
¡©e
 = 
FDE_ACTIVE
;

1861 
fde
->
fd
 = fd;

1862 
fde
->
func
 = func;

1863 
fde
->
¬g
 =‡rg;

1865 
	`fdev’t_»gi¡”
(
fde
);

1866 
	`dump_fde
(
fde
, "connect");

1867 
	`fdev’t_cÚÃù
(
fde
);

1868 
fde
->
¡©e
 |ğ
FDE_ACTIVE
;

1869 
	}
}

1871 
	$fdev’t_»move
(
fdev’t
 *
fde
)

1873 if(
fde
->
¡©e
 & 
FDE_PENDING
) {

1874 
	`fdev’t_¶i¡_»move
(
fde
);

1877 if(
fde
->
¡©e
 & 
FDE_ACTIVE
) {

1878 
	`fdev’t_discÚÃù
(
fde
);

1879 
	`dump_fde
(
fde
, "disconnect");

1880 
	`fdev’t_uÄegi¡”
(
fde
);

1883 
fde
->
¡©e
 = 0;

1884 
fde
->
ev’ts
 = 0;

1885 
	}
}

1888 
	$fdev’t_£t
(
fdev’t
 *
fde
, 
ev’ts
)

1890 
ev’ts
 &ğ
FDE_EVENTMASK
;

1892 if((
fde
->
¡©e
 & 
FDE_EVENTMASK
è=ğ()
ev’ts
) ;

1894 if(
fde
->
¡©e
 & 
FDE_ACTIVE
) {

1895 
	`fdev’t_upd©e
(
fde
, 
ev’ts
);

1896 
	`dump_fde
(
fde
, "update");

1899 
fde
->
¡©e
 = (fde->¡©& 
FDE_STATEMASK
è| 
ev’ts
;

1901 if(
fde
->
¡©e
 & 
FDE_PENDING
) {

1906 
fde
->
ev’ts
 &= (~events);

1907 if(
fde
->
ev’ts
 == 0) {

1908 
	`fdev’t_¶i¡_»move
(
fde
);

1909 
fde
->
¡©e
 &ğ(~
FDE_PENDING
);

1912 
	}
}

1914 
	$fdev’t_add
(
fdev’t
 *
fde
, 
ev’ts
)

1916 
	`fdev’t_£t
(

1917 
fde
, (fde->
¡©e
 & 
FDE_EVENTMASK
è| (
ev’ts
 & FDE_EVENTMASK));

1918 
	}
}

1920 
	$fdev’t_d–
(
fdev’t
 *
fde
, 
ev’ts
)

1922 
	`fdev’t_£t
(

1923 
fde
, (fde->
¡©e
 & 
FDE_EVENTMASK
è& (~(
ev’ts
 & FDE_EVENTMASK)));

1924 
	}
}

1926 
	$fdev’t_loİ
()

1928 
fdev’t
 *
fde
;

1931 #ià
DEBUG


1932 
	`årštf
(
¡d”r
,"--- ---- waiting forƒvents\n");

1934 
	`fdev’t_´oûss
();

1936 (
fde
 = 
	`fdev’t_¶i¡_dequeue
())) {

1937 
ev’ts
 = 
fde
->events;

1938 
fde
->
ev’ts
 = 0;

1939 
fde
->
¡©e
 &ğ(~
FDE_PENDING
);

1940 
	`dump_fde
(
fde
, "callback");

1941 
fde
->
	`func
(fde->
fd
, 
ev’ts
, fde->
¬g
);

1944 
	}
}

1949 
	$_ev’t_fe_´•¬e
Ğ
Ev’tHook
 
hook
 )

1951 ià(
hook
->
wª‹d
 & (
FDE_READ
|
FDE_WRITE
)) {

1953 
hook
->
»ady
 |ğhook->
wª‹d
 & (
FDE_READ
|
FDE_WRITE
);

1955 
	}
}

1957 
	$_ev’t_fe_³ek
Ğ
Ev’tHook
 
hook
 )

1959  (
hook
->
wª‹d
 & (
FDE_READ
|
FDE_WRITE
));

1960 
	}
}

1962 
	$_fh_fe_hook
Ğ
FH
 
f
, 
ev’ts
, 
Ev’tHook
 
hook
 )

1964 
hook
->
h
 = 
f
->
fh_hªdË
;

1965 
hook
->
´•¬e
 = 
_ev’t_fe_´•¬e
;

1966 
hook
->
³ek
 = 
_ev’t_fe_³ek
;

1967 
	}
}

1972 
	$_ev’t_sock‘_v”ify
Ğ
Ev’tHook
 
hook
, 
WSANETWORKEVENTS
* 
evts
 )

1974 iàĞ
evts
->
lN‘wÜkEv’ts
 & (
FD_READ
|
FD_ACCEPT
|
FD_CLOSE
) ) {

1975 ià(
hook
->
wª‹d
 & 
FDE_READ
)

1976 
hook
->
»ady
 |ğ
FDE_READ
;

1977 ià((
evts
->
iE¼ÜCode
[
FD_READ
] !ğ0è&& 
hook
->
wª‹d
 & 
FDE_ERROR
)

1978 
hook
->
»ady
 |ğ
FDE_ERROR
;

1980 iàĞ
evts
->
lN‘wÜkEv’ts
 & (
FD_WRITE
|
FD_CONNECT
|
FD_CLOSE
) ) {

1981 ià(
hook
->
wª‹d
 & 
FDE_WRITE
)

1982 
hook
->
»ady
 |ğ
FDE_WRITE
;

1983 ià((
evts
->
iE¼ÜCode
[
FD_WRITE
] !ğ0è&& 
hook
->
wª‹d
 & 
FDE_ERROR
)

1984 
hook
->
»ady
 |ğ
FDE_ERROR
;

1986 iàĞ
evts
->
lN‘wÜkEv’ts
 & 
FD_OOB
 ) {

1987 ià(
hook
->
wª‹d
 & 
FDE_ERROR
)

1988 
hook
->
»ady
 |ğ
FDE_ERROR
;

1990 
	}
}

1992 
	$_ev’t_sock‘_´•¬e
Ğ
Ev’tHook
 
hook
 )

1994 
WSANETWORKEVENTS
 
evts
;

1997 ià(!
	`WSAEnumN‘wÜkEv’ts
Ğ
hook
->
fh
->
fh_sock‘
, 
NULL
, &
evts
 ))

1998 
	`_ev’t_sock‘_v”ify
Ğ
hook
, &
evts
 );

1999 
	}
}

2001 
	$_sock‘_wª‹d_to_æags
Ğ
wª‹d
 )

2003 
æags
 = 0;

2004 ià(
wª‹d
 & 
FDE_READ
)

2005 
æags
 |ğ
FD_READ
 | 
FD_ACCEPT
 | 
FD_CLOSE
;

2007 ià(
wª‹d
 & 
FDE_WRITE
)

2008 
æags
 |ğ
FD_WRITE
 | 
FD_CONNECT
 | 
FD_CLOSE
;

2010 ià(
wª‹d
 & 
FDE_ERROR
)

2011 
æags
 |ğ
FD_OOB
;

2013  
æags
;

2014 
	}
}

2016 
	$_ev’t_sock‘_¡¬t
Ğ
Ev’tHook
 
hook
 )

2019 
FH
 
fh
 = 
hook
->fh;

2020 
æags
 = 
	`_sock‘_wª‹d_to_æags
Ğ
hook
->
wª‹d
 );

2022 
hook
->
h
 = 
fh
->
ev’t
;

2023 ià(
hook
->
h
 =ğ
INVALID_HANDLE_VALUE
) {

2024 
	`D
Ğ"_ev’t_sock‘_¡¬t:‚Øev’ˆfÜ %s\n", 
fh
->
Çme
 );

2028 iàĞ
æags
 !ğ
fh
->
mask
 ) {

2029 
	`D
Ğ"_ev’t_sock‘_¡¬t: hookšg % fÜ %x (æag %ld)\n", 
hook
->
fh
->
Çme
, hook->
wª‹d
, 
æags
 );

2030 iàĞ
	`WSAEv’tS–eù
Ğ
fh
->
fh_sock‘
, 
hook
->
h
, 
æags
 ) ) {

2031 
	`D
Ğ"_ev’t_sock‘_¡¬t: WSAEv’tS–eù(èfÜ % çed,ƒ¼Ü %d\n", 
hook
->
fh
->
Çme
, 
	`WSAG‘La¡E¼Ü
() );

2032 
	`Clo£HªdË
Ğ
hook
->
h
 );

2033 
hook
->
h
 = 
INVALID_HANDLE_VALUE
;

2034 
	`ex™
(1);

2037 
fh
->
mask
 = 
æags
;

2040 
	}
}

2042 
	$_ev’t_sock‘_¡İ
Ğ
Ev’tHook
 
hook
 )

2044 
hook
->
h
 = 
INVALID_HANDLE_VALUE
;

2045 
	}
}

2047 
	$_ev’t_sock‘_check
Ğ
Ev’tHook
 
hook
 )

2049 
»suÉ
 = 0;

2050 
FH
 
fh
 = 
hook
->fh;

2051 
WSANETWORKEVENTS
 
evts
;

2053 ià(!
	`WSAEnumN‘wÜkEv’ts
Ğ
fh
->
fh_sock‘
, 
hook
->
h
, &
evts
 ) ) {

2054 
	`_ev’t_sock‘_v”ify
Ğ
hook
, &
evts
 );

2055 
»suÉ
 = (
hook
->
»ady
 != 0);

2056 ià(
»suÉ
) {

2057 
	`Re£tEv’t
Ğ
hook
->
h
 );

2060 
	`D
Ğ"_ev’t_sock‘_check % »tuº %d\n", 
fh
->
Çme
, 
»suÉ
 );

2061  
»suÉ
;

2062 
	}
}

2064 
	$_ev’t_sock‘_³ek
Ğ
Ev’tHook
 
hook
 )

2066 
WSANETWORKEVENTS
 
evts
;

2067 
FH
 
fh
 = 
hook
->fh;

2070 ià(!
	`WSAEnumN‘wÜkEv’ts
Ğ
fh
->
fh_sock‘
, 
NULL
, &
evts
 )) {

2071 
	`_ev’t_sock‘_v”ify
Ğ
hook
, &
evts
 );

2072 ià(
hook
->
»ady
)

2073 
	`Re£tEv’t
Ğ
hook
->
h
 );

2076  
hook
->
»ady
 != 0;

2077 
	}
}

2081 
	$_fh_sock‘_hook
Ğ
FH
 
f
, 
ev’ts
, 
Ev’tHook
 
hook
 )

2083 
hook
->
´•¬e
 = 
_ev’t_sock‘_´•¬e
;

2084 
hook
->
¡¬t
 = 
_ev’t_sock‘_¡¬t
;

2085 
hook
->
¡İ
 = 
_ev’t_sock‘_¡İ
;

2086 
hook
->
check
 = 
_ev’t_sock‘_check
;

2087 
hook
->
³ek
 = 
_ev’t_sock‘_³ek
;

2089 
	`_ev’t_sock‘_¡¬t
Ğ
hook
 );

2090 
	}
}

2095 
	$_ev’t_sock‘·œ_´•¬e
Ğ
Ev’tHook
 
hook
 )

2097 
FH
 
fh
 = 
hook
->fh;

2098 
Sock‘Paœ
 
·œ
 = 
fh
->
fh_·œ
;

2099 
BBufãr
 
rb
 = (
·œ
->
a_fd
 =ğ
fh
è? &·œ->
b2a_b
 : &·œ->
a2b_b
;

2100 
BBufãr
 
wb
 = (
·œ
->
a_fd
 =ğ
fh
è? &·œ->
a2b_b
 : &·œ->
b2a_b
;

2102 ià(
hook
->
wª‹d
 & 
FDE_READ
 && 
rb
->
ÿn_»ad
)

2103 
hook
->
»ady
 |ğ
FDE_READ
;

2105 ià(
hook
->
wª‹d
 & 
FDE_WRITE
 && 
wb
->
ÿn_wr™e
)

2106 
hook
->
»ady
 |ğ
FDE_WRITE
;

2107 
	}
}

2109 
	$_ev’t_sock‘·œ_¡¬t
Ğ
Ev’tHook
 
hook
 )

2111 
FH
 
fh
 = 
hook
->fh;

2112 
Sock‘Paœ
 
·œ
 = 
fh
->
fh_·œ
;

2113 
BBufãr
 
rb
 = (
·œ
->
a_fd
 =ğ
fh
è? &·œ->
b2a_b
 : &·œ->
a2b_b
;

2114 
BBufãr
 
wb
 = (
·œ
->
a_fd
 =ğ
fh
è? &·œ->
a2b_b
 : &·œ->
b2a_b
;

2116 ià(
hook
->
wª‹d
 =ğ
FDE_READ
)

2117 
hook
->
h
 = 
rb
->
evt_»ad
;

2119 ià(
hook
->
wª‹d
 =ğ
FDE_WRITE
)

2120 
hook
->
h
 = 
wb
->
evt_wr™e
;

2123 
	`D
("_event_socketpair_start: can't handle FDE_READ+FDE_WRITE\n" );

2126 
	`D
( "_event_socketpair_start: hook %s for %x wanted=%x\n",

2127 
hook
->
fh
->
Çme
, 
	`_fh_to_št
(fh), hook->
wª‹d
);

2129 
	}
}

2131 
	$_ev’t_sock‘·œ_³ek
Ğ
Ev’tHook
 
hook
 )

2133 
	`_ev’t_sock‘·œ_´•¬e
Ğ
hook
 );

2134  
hook
->
»ady
 != 0;

2135 
	}
}

2137 
	$_fh_sock‘·œ_hook
Ğ
FH
 
fh
, 
ev’ts
, 
Ev’tHook
 
hook
 )

2139 
hook
->
´•¬e
 = 
_ev’t_sock‘·œ_´•¬e
;

2140 
hook
->
¡¬t
 = 
_ev’t_sock‘·œ_¡¬t
;

2141 
hook
->
³ek
 = 
_ev’t_sock‘·œ_³ek
;

2142 
	}
}

2146 
	$adb_sysd•s_š™
( )

2148 
	#ADB_MUTEX
(
x
è
	`In™ŸlizeCr™iÿlSeùiÚ
Ğ& x );

	)

2149 
	~"mu‹x_li¡.h
"

2150 
	`In™ŸlizeCr™iÿlSeùiÚ
Ğ&
_wš32_lock
 );

2151 
	}
}

2189 
boŞ
 
	$_g‘_š‹»¡šg_šput_»cÜd_unÿched
(cÚ¡ 
HANDLE
 
cÚsŞe
,

2190 
INPUT_RECORD
* cÚ¡ 
šput_»cÜd
) {

2192 
DWORD
 
»ad_couÁ
 = 0;

2193 
	`mem£t
(
šput_»cÜd
, 0, (*input_record));

2194 ià(!
	`R—dCÚsŞeIÅutA
(
cÚsŞe
, 
šput_»cÜd
, 1, &
»ad_couÁ
)) {

2195 
	`D
("_get_interesting_input_record_uncached: ReadConsoleInputA() "

2196 "çu»,ƒ¼Ü %ld\n", 
	`G‘La¡E¼Ü
());

2197 
”ºo
 = 
EIO
;

2198  
çl£
;

2201 ià(
»ad_couÁ
 == 0) {

2202 
	`çl
("ReadConsoleInputA„eturned 0");

2205 ià(
»ad_couÁ
 != 1) {

2206 
	`çl
("ReadConsoleInputA did‚ot„eturn one input„ecord");

2209 ià((
šput_»cÜd
->
Ev’tTy³
 =ğ
KEY_EVENT
) &&

2210 (
šput_»cÜd
->
Ev’t
.
KeyEv’t
.
bKeyDown
)) {

2211 ià(
šput_»cÜd
->
Ev’t
.
KeyEv’t
.
wR•—tCouÁ
 == 0) {

2212 
	`çl
("ReadConsoleInputA„eturned‡ keyƒvent with zero„epeat"

2217  
Œue
;

2220 
	}
}

2225 
INPUT_RECORD
 
	g_wš32_šput_»cÜd
;

2228 
KEY_EVENT_RECORD
* 
	$_g‘_key_ev’t_»cÜd
(cÚ¡ 
HANDLE
 
cÚsŞe
) {

2231 ià(
_wš32_šput_»cÜd
.
Ev’t
.
KeyEv’t
.
wR•—tCouÁ
 == 0) {

2232 ià(!
	`_g‘_š‹»¡šg_šput_»cÜd_unÿched
(
cÚsŞe
,

2233 &
_wš32_šput_»cÜd
)) {

2236 
_wš32_šput_»cÜd
.
Ev’t
.
KeyEv’t
.
wR•—tCouÁ
 = 0;

2237  
NULL
;

2241  &
_wš32_šput_»cÜd
.
Ev’t
.
KeyEv’t
;

2242 
	}
}

2244 
__šlše__
 
boŞ
 
	$_is_shiá_´es£d
(cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
) {

2245  (
cÚŒŞ_key_¡©e
 & 
SHIFT_PRESSED
) != 0;

2246 
	}
}

2248 
__šlše__
 
boŞ
 
	$_is_ù¾_´es£d
(cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
) {

2249  (
cÚŒŞ_key_¡©e
 & (
LEFT_CTRL_PRESSED
 | 
RIGHT_CTRL_PRESSED
)) != 0;

2250 
	}
}

2252 
__šlše__
 
boŞ
 
	$_is_®t_´es£d
(cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
) {

2253  (
cÚŒŞ_key_¡©e
 & (
LEFT_ALT_PRESSED
 | 
RIGHT_ALT_PRESSED
)) != 0;

2254 
	}
}

2256 
__šlše__
 
boŞ
 
	$_is_numlock_Ú
(cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
) {

2257  (
cÚŒŞ_key_¡©e
 & 
NUMLOCK_ON
) != 0;

2258 
	}
}

2260 
__šlše__
 
boŞ
 
	$_is_ÿp¦ock_Ú
(cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
) {

2261  (
cÚŒŞ_key_¡©e
 & 
CAPSLOCK_ON
) != 0;

2262 
	}
}

2264 
__šlše__
 
boŞ
 
	$_is_’hªûd_key
(cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
) {

2265  (
cÚŒŞ_key_¡©e
 & 
ENHANCED_KEY
) != 0;

2266 
	}
}

2269 cÚ¡ 
BYTE
 
	gTOASCII_KEY_OFF
 = 0x00;

2270 cÚ¡ 
BYTE
 
	gTOASCII_KEY_DOWN
 = 0x80;

2271 cÚ¡ 
BYTE
 
	gTOASCII_KEY_TOGGLED_ON
 = 0x01;

2276 
size_t
 
	$_g‘_ch¬_ignÜšg_modif›r
(* cÚ¡ 
ch
,

2277 cÚ¡ 
KEY_EVENT_RECORD
* cÚ¡ 
key_ev’t
, cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
,

2278 cÚ¡ 
WORD
 
modif›r
) {

2282 ià(
key_ev’t
->
uCh¬
.
AsciiCh¬
 == '\0') {

2285 ià(((
modif›r
 =ğ
VK_SHIFT
) &&

2286 
	`_is_shiá_´es£d
(
cÚŒŞ_key_¡©e
)) ||

2287 ((
modif›r
 =ğ
VK_CONTROL
) &&

2288 
	`_is_ù¾_´es£d
(
cÚŒŞ_key_¡©e
)) ||

2289 ((
modif›r
 =ğ
VK_MENU
è&& 
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
))) {

2291 
BYTE
 
key_¡©e
[256] = {0};

2292 
key_¡©e
[
VK_SHIFT
] = 
	`_is_shiá_´es£d
(
cÚŒŞ_key_¡©e
) ?

2293 
TOASCII_KEY_DOWN
 : 
TOASCII_KEY_OFF
;

2294 
key_¡©e
[
VK_CONTROL
] = 
	`_is_ù¾_´es£d
(
cÚŒŞ_key_¡©e
) ?

2295 
TOASCII_KEY_DOWN
 : 
TOASCII_KEY_OFF
;

2296 
key_¡©e
[
VK_MENU
] = 
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
) ?

2297 
TOASCII_KEY_DOWN
 : 
TOASCII_KEY_OFF
;

2298 
key_¡©e
[
VK_CAPITAL
] = 
	`_is_ÿp¦ock_Ú
(
cÚŒŞ_key_¡©e
) ?

2299 
TOASCII_KEY_TOGGLED_ON
 : 
TOASCII_KEY_OFF
;

2302 
key_¡©e
[
modif›r
] = 
TOASCII_KEY_OFF
;

2304 
WORD
 
Œª¦©ed
 = 0;

2305 ià(
	`ToAscii
(
key_ev’t
->
wVœtu®KeyCode
,

2306 
key_ev’t
->
wVœtu®SÿnCode
, 
key_¡©e
, &
Œª¦©ed
, 0) == 1) {

2308 *
ch
 = (
CHAR
)
Œª¦©ed
;

2315 *
ch
 = 
key_ev’t
->
uCh¬
.
AsciiCh¬
;

2318  (*
ch
 == '\0') ? 0 : 1;

2319 
	}
}

2329 
__šlše__
 
size_t
 
	$_g‘_nÚ_cÚŒŞ_ch¬
(* cÚ¡ 
ch
,

2330 cÚ¡ 
KEY_EVENT_RECORD
* cÚ¡ 
key_ev’t
, cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
) {

2331  
	`_g‘_ch¬_ignÜšg_modif›r
(
ch
, 
key_ev’t
, 
cÚŒŞ_key_¡©e
,

2332 
VK_CONTROL
);

2333 
	}
}

2336 
__šlše__
 
size_t
 
	$_g‘_nÚ_®t_ch¬
(* cÚ¡ 
ch
,

2337 cÚ¡ 
KEY_EVENT_RECORD
* cÚ¡ 
key_ev’t
, cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
) {

2338  
	`_g‘_ch¬_ignÜšg_modif›r
(
ch
, 
key_ev’t
, 
cÚŒŞ_key_¡©e
,

2339 
VK_MENU
);

2340 
	}
}

2345 
size_t
 
	$_g‘_cÚŒŞ_ch¬aù”
(* cÚ¡ 
pch
,

2346 cÚ¡ 
KEY_EVENT_RECORD
* cÚ¡ 
key_ev’t
, cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
) {

2347 cÚ¡ 
size_t
 
Ën
 = 
	`_g‘_nÚ_cÚŒŞ_ch¬
(
pch
, 
key_ev’t
,

2348 
cÚŒŞ_key_¡©e
);

2350 ià((
Ën
 =ğ1è&& 
	`_is_ù¾_´es£d
(
cÚŒŞ_key_¡©e
)) {

2351 
ch
 = *
pch
;

2352 
ch
) {

2356 
ch
 = '\0';

2361 
ch
 = '\x1b';

2366 
ch
 = '\x1c';

2371 
ch
 = '\x1d';

2376 
ch
 = '\x1e';

2381 
ch
 = '\x1f';

2384 
ch
 = '\x7f';

2387 ià(!
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
)) {

2388 
ch
 = '\x1f';

2392 ià(!
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
)) {

2393 
ch
 = '\x7f';

2397 *
pch
 = 
ch
;

2400  
Ën
;

2401 
	}
}

2403 
DWORD
 
	$_nÜm®ize_®tgr_cÚŒŞ_key_¡©e
(

2404 cÚ¡ 
KEY_EVENT_RECORD
* cÚ¡ 
key_ev’t
) {

2405 
DWORD
 
cÚŒŞ_key_¡©e
 = 
key_ev’t
->
dwCÚŒŞKeyS‹
;

2416 ià(
	`_is_ù¾_´es£d
(
cÚŒŞ_key_¡©e
) &&

2417 
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
)

2418 && (
key_ev’t
->
uCh¬
.
AsciiCh¬
 != '\0')) {

2422 ià((
cÚŒŞ_key_¡©e
 & 
RIGHT_ALT_PRESSED
) != 0) {

2424 
cÚŒŞ_key_¡©e
 &ğ~
RIGHT_ALT_PRESSED
;

2429 
cÚŒŞ_key_¡©e
 &ğ~
LEFT_CTRL_PRESSED
;

2430 } ià((
cÚŒŞ_key_¡©e
 & 
LEFT_ALT_PRESSED
) != 0) {

2432 
cÚŒŞ_key_¡©e
 &ğ~
LEFT_ALT_PRESSED
;

2436 ià((
cÚŒŞ_key_¡©e
 & 
LEFT_CTRL_PRESSED
) != 0) {

2438 
cÚŒŞ_key_¡©e
 &ğ~
LEFT_CTRL_PRESSED
;

2439 } ià((
cÚŒŞ_key_¡©e
 & 
RIGHT_CTRL_PRESSED
) != 0) {

2441 
cÚŒŞ_key_¡©e
 &ğ~
RIGHT_CTRL_PRESSED
;

2451  
cÚŒŞ_key_¡©e
;

2452 
	}
}

2458 
DWORD
 
	$_nÜm®ize_key·d_cÚŒŞ_key_¡©e
(cÚ¡ 
WORD
 
vk
,

2459 cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
) {

2460 ià(!
	`_is_numlock_Ú
(
cÚŒŞ_key_¡©e
)) {

2461  
cÚŒŞ_key_¡©e
;

2463 ià(!
	`_is_’hªûd_key
(
cÚŒŞ_key_¡©e
)) {

2464 
vk
) {

2465 
VK_INSERT
:

2466 
VK_DELETE
:

2467 
VK_END
:

2468 
VK_DOWN
:

2469 
VK_NEXT
:

2470 
VK_LEFT
:

2471 
VK_CLEAR
:

2472 
VK_RIGHT
:

2473 
VK_HOME
:

2474 
VK_UP
:

2475 
VK_PRIOR
:

2476  
cÚŒŞ_key_¡©e
 | 
SHIFT_PRESSED
;

2480  
cÚŒŞ_key_¡©e
;

2481 
	}
}

2483 cÚ¡ * 
	$_g‘_key·d_£qu’û
(cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
,

2484 cÚ¡ * cÚ¡ 
nÜm®
, cÚ¡ * cÚ¡ 
shiáed
) {

2485 ià(
	`_is_shiá_´es£d
(
cÚŒŞ_key_¡©e
)) {

2487  
shiáed
;

2493  
nÜm®
;

2498 
	}
}

2501 
size_t
 
	$_g‘_modif›r_£qu’û
(* cÚ¡ 
buf
, cÚ¡ 
WORD
 
vk
,

2502 
DWORD
 
cÚŒŞ_key_¡©e
, cÚ¡ * cÚ¡ 
nÜm®
) {

2504 cÚ¡ 
size_t
 
Ën
 = 
	`¡¾’
(
nÜm®
);

2505 
	`memıy
(
buf
, 
nÜm®
, 
Ën
);

2507 
code
 = 0;

2509 
cÚŒŞ_key_¡©e
 = 
	`_nÜm®ize_key·d_cÚŒŞ_key_¡©e
(
vk
,

2510 
cÚŒŞ_key_¡©e
);

2512 ià(
	`_is_shiá_´es£d
(
cÚŒŞ_key_¡©e
)) {

2513 
code
 |= 0x1;

2515 ià(
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
)) {

2516 
code
 |= 0x2;

2518 ià(
	`_is_ù¾_´es£d
(
cÚŒŞ_key_¡©e
)) {

2519 
code
 |= 0x4;

2522 ià(
code
 != 0) {

2523 ià(
Ën
 == 0) {

2528 
size_t
 
šdex
 = 
Ën
 - 1;

2529 cÚ¡ 
Ï¡Ch¬
 = 
buf
[
šdex
];

2530 ià(
Ï¡Ch¬
 != '~') {

2531 
buf
[
šdex
++] = '1';

2533 
buf
[
šdex
++] = ';';

2536 
buf
[
šdex
++] = '1' + 
code
;

2537 
buf
[
šdex
++] = 
Ï¡Ch¬
;

2538  
šdex
;

2540  
Ën
;

2541 
	}
}

2544 
size_t
 
	$_g‘_modif›r_key·d_£qu’û
(* cÚ¡ 
buf
, cÚ¡ 
WORD
 
vk
,

2545 cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
, cÚ¡ * cÚ¡ 
nÜm®
,

2546 cÚ¡ 
shiáed
) {

2547 ià(
	`_is_shiá_´es£d
(
cÚŒŞ_key_¡©e
)) {

2549 ià(
shiáed
 != '\0') {

2550 
buf
[0] = 
shiáed
;

2551  (
buf
[0]);

2560  
	`_g‘_modif›r_£qu’û
(
buf
, 
vk
, 
cÚŒŞ_key_¡©e
, 
nÜm®
);

2565 
	}
}

2570 
	$_g‘_decim®_ch¬
() {

2571  ()
	`M­Vœtu®KeyA
(
VK_DECIMAL
, 
MAPVK_VK_TO_CHAR
);

2572 
	}
}

2576 
size_t
 
	$_esÿ³_´efix
(* cÚ¡ 
buf
, cÚ¡ 
size_t
 
Ën
) {

2579 ià(
Ën
 == 0) {

2583 
	`memmove
(&
buf
[1], buf, 
Ën
);

2584 
buf
[0] = '\x1b';

2585  
Ën
 + 1;

2586 
	}
}

2591 
	$_cÚsŞe_»ad
(cÚ¡ 
HANDLE
 
cÚsŞe
, * 
buf
, 
size_t
 
Ën
) {

2593 
KEY_EVENT_RECORD
* cÚ¡ 
key_ev’t
 = 
	`_g‘_key_ev’t_»cÜd
(
cÚsŞe
);

2594 ià(
key_ev’t
 =ğ
NULL
) {

2598 cÚ¡ 
WORD
 
vk
 = 
key_ev’t
->
wVœtu®KeyCode
;

2599 cÚ¡ 
CHAR
 
ch
 = 
key_ev’t
->
uCh¬
.
AsciiCh¬
;

2600 cÚ¡ 
DWORD
 
cÚŒŞ_key_¡©e
 = 
	`_nÜm®ize_®tgr_cÚŒŞ_key_¡©e
(

2601 
key_ev’t
);

2605 cÚ¡ * 
£q¡r
 = 
NULL
;

2608 
£qbuf
[16];

2609 
size_t
 
£qbuæ’
 = 0;

2611 
	#MATCH
(
vk
, 
nÜm®
) \

2612 (
vk
): \

2614 
£q¡r
 = (
nÜm®
); \

2616 ;

	)

2619 
	#MATCH_MODIFIER
(
vk
, 
nÜm®
) \

2620 (
vk
): \

2622 
£qbuæ’
 = 
	`_g‘_modif›r_£qu’û
(
£qbuf
, (
vk
), \

2623 
cÚŒŞ_key_¡©e
, (
nÜm®
)); \

2625 ;

	)

2628 
	#MATCH_KEYPAD
(
vk
, 
nÜm®
, 
shiáed
) \

2629 (
vk
): \

2631 
£q¡r
 = 
	`_g‘_key·d_£qu’û
(
cÚŒŞ_key_¡©e
, (
nÜm®
), \

2632 (
shiáed
)); \

2634 ;

	)

2638 
	#MATCH_MODIFIER_KEYPAD
(
vk
, 
nÜm®
, 
shiáed
) \

2639 (
vk
): \

2641 
£qbuæ’
 = 
	`_g‘_modif›r_key·d_£qu’û
(
£qbuf
, (
vk
), \

2642 
cÚŒŞ_key_¡©e
, (
nÜm®
), (
shiáed
)); \

2644 ;

	)

2646 
	#ESC
 "\x1b"

	)

2647 
	#CSI
 
ESC
 "["

	)

2648 
	#SS3
 
ESC
 "O"

	)

2658 ià(
	`_is_’hªûd_key
(
cÚŒŞ_key_¡©e
)) {

2659 
vk
) {

2660 
VK_RETURN
:

2661 ià(
	`_is_ù¾_´es£d
(
cÚŒŞ_key_¡©e
)) {

2662 
£q¡r
 = "\n";

2664 
£q¡r
 = "\r";

2668 
	`MATCH_MODIFIER
(
VK_PRIOR
, 
CSI
 "5~");

2669 
	`MATCH_MODIFIER
(
VK_NEXT
, 
CSI
 "6~");

2674 
	`MATCH
(
VK_END
, 
CSI
 "F");

2675 
	`MATCH
(
VK_HOME
, 
CSI
 "H");

2677 
	`MATCH_MODIFIER
(
VK_LEFT
, 
CSI
 "D");

2678 
	`MATCH_MODIFIER
(
VK_UP
, 
CSI
 "A");

2679 
	`MATCH_MODIFIER
(
VK_RIGHT
, 
CSI
 "C");

2680 
	`MATCH_MODIFIER
(
VK_DOWN
, 
CSI
 "B");

2682 
	`MATCH_MODIFIER
(
VK_INSERT
, 
CSI
 "2~");

2683 
	`MATCH_MODIFIER
(
VK_DELETE
, 
CSI
 "3~");

2685 
	`MATCH
(
VK_DIVIDE
, "/");

2688 
vk
) {

2689 
VK_BACK
:

2690 ià(
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
)) {

2691 
£q¡r
 = 
ESC
 "\x7f";

2693 
£q¡r
 = "\x7f";

2697 
VK_TAB
:

2698 ià(
	`_is_shiá_´es£d
(
cÚŒŞ_key_¡©e
)) {

2699 
£q¡r
 = 
CSI
 "Z";

2701 
£q¡r
 = "\t";

2707 
	`MATCH_KEYPAD
(
VK_CLEAR
, 
CSI
 "E", "5");

2709 
VK_RETURN
:

2710 ià(
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
)) {

2711 
£q¡r
 = 
ESC
 "\n";

2712 } ià(
	`_is_ù¾_´es£d
(
cÚŒŞ_key_¡©e
)) {

2713 
£q¡r
 = "\n";

2715 
£q¡r
 = "\r";

2724 
VK_SPACE
:

2725 ià(
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
)) {

2726 
£q¡r
 = 
ESC
 " ";

2727 } ià(
	`_is_ù¾_´es£d
(
cÚŒŞ_key_¡©e
)) {

2728 
£qbuf
[0] = '\0';

2729 
£qbuæ’
 = 1;

2731 
£q¡r
 = " ";

2735 
	`MATCH_MODIFIER_KEYPAD
(
VK_PRIOR
, 
CSI
 "5~", '9');

2736 
	`MATCH_MODIFIER_KEYPAD
(
VK_NEXT
, 
CSI
 "6~", '3');

2738 
	`MATCH_KEYPAD
(
VK_END
, 
CSI
 "4~", "1");

2739 
	`MATCH_KEYPAD
(
VK_HOME
, 
CSI
 "1~", "7");

2741 
	`MATCH_MODIFIER_KEYPAD
(
VK_LEFT
, 
CSI
 "D", '4');

2742 
	`MATCH_MODIFIER_KEYPAD
(
VK_UP
, 
CSI
 "A", '8');

2743 
	`MATCH_MODIFIER_KEYPAD
(
VK_RIGHT
, 
CSI
 "C", '6');

2744 
	`MATCH_MODIFIER_KEYPAD
(
VK_DOWN
, 
CSI
 "B", '2');

2746 
	`MATCH_MODIFIER_KEYPAD
(
VK_INSERT
, 
CSI
 "2~", '0');

2747 
	`MATCH_MODIFIER_KEYPAD
(
VK_DELETE
, 
CSI
 "3~",

2748 
	`_g‘_decim®_ch¬
());

2753 
VK_OEM_1
:

2754 
VK_OEM_PLUS
:

2755 
VK_OEM_COMMA
:

2756 
VK_OEM_PERIOD
:

2757 
VK_OEM_7
:

2758 
VK_OEM_102
:

2759 
VK_OEM_2
:

2760 
VK_OEM_3
:

2761 
VK_OEM_4
:

2762 
VK_OEM_5
:

2763 
VK_OEM_6
:

2765 
£qbuæ’
 = 
	`_g‘_cÚŒŞ_ch¬aù”
(
£qbuf
, 
key_ev’t
,

2766 
cÚŒŞ_key_¡©e
);

2768 ià(
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
)) {

2769 
£qbuæ’
 = 
	`_esÿ³_´efix
(
£qbuf
, seqbuflen);

2776 
VK_OEM_MINUS
:

2778 
£qbuæ’
 = 
	`_g‘_cÚŒŞ_ch¬aù”
(
£qbuf
, 
key_ev’t
,

2779 
cÚŒŞ_key_¡©e
);

2783 ià(
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
) &&

2784 !(
	`_is_ù¾_´es£d
(
cÚŒŞ_key_¡©e
) &&

2785 !
	`_is_shiá_´es£d
(
cÚŒŞ_key_¡©e
))) {

2786 
£qbuæ’
 = 
	`_esÿ³_´efix
(
£qbuf
, seqbuflen);

2797 
£qbuæ’
 = 
	`_g‘_cÚŒŞ_ch¬aù”
(
£qbuf
, 
key_ev’t
,

2798 
cÚŒŞ_key_¡©e
);

2802 ià(
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
) &&

2803 !(
	`_is_ù¾_´es£d
(
cÚŒŞ_key_¡©e
) &&

2804 !
	`_is_shiá_´es£d
(
cÚŒŞ_key_¡©e
))) {

2805 
£qbuæ’
 = 
	`_esÿ³_´efix
(
£qbuf
, seqbuflen);

2837 
£qbuæ’
 = 
	`_g‘_nÚ_®t_ch¬
(
£qbuf
, 
key_ev’t
,

2838 
cÚŒŞ_key_¡©e
);

2841 ià(
	`_is_®t_´es£d
(
cÚŒŞ_key_¡©e
)) {

2842 
£qbuæ’
 = 
	`_esÿ³_´efix
(
£qbuf
, seqbuflen);

2849 
	`MATCH
(
VK_NUMPAD0
, "0");

2850 
	`MATCH
(
VK_NUMPAD1
, "1");

2851 
	`MATCH
(
VK_NUMPAD2
, "2");

2852 
	`MATCH
(
VK_NUMPAD3
, "3");

2853 
	`MATCH
(
VK_NUMPAD4
, "4");

2854 
	`MATCH
(
VK_NUMPAD5
, "5");

2855 
	`MATCH
(
VK_NUMPAD6
, "6");

2856 
	`MATCH
(
VK_NUMPAD7
, "7");

2857 
	`MATCH
(
VK_NUMPAD8
, "8");

2858 
	`MATCH
(
VK_NUMPAD9
, "9");

2860 
	`MATCH
(
VK_MULTIPLY
, "*");

2861 
	`MATCH
(
VK_ADD
, "+");

2862 
	`MATCH
(
VK_SUBTRACT
, "-");

2867 
VK_DECIMAL
:

2869 
£qbuæ’
 = 
	`_g‘_nÚ_cÚŒŞ_ch¬
(
£qbuf
, 
key_ev’t
,

2870 
cÚŒŞ_key_¡©e
);

2873 
	`MATCH_MODIFIER
(
VK_F1
, 
SS3
 "P");

2874 
	`MATCH_MODIFIER
(
VK_F2
, 
SS3
 "Q");

2875 
	`MATCH_MODIFIER
(
VK_F3
, 
SS3
 "R");

2876 
	`MATCH_MODIFIER
(
VK_F4
, 
SS3
 "S");

2877 
	`MATCH_MODIFIER
(
VK_F5
, 
CSI
 "15~");

2878 
	`MATCH_MODIFIER
(
VK_F6
, 
CSI
 "17~");

2879 
	`MATCH_MODIFIER
(
VK_F7
, 
CSI
 "18~");

2880 
	`MATCH_MODIFIER
(
VK_F8
, 
CSI
 "19~");

2881 
	`MATCH_MODIFIER
(
VK_F9
, 
CSI
 "20~");

2882 
	`MATCH_MODIFIER
(
VK_F10
, 
CSI
 "21~");

2883 
	`MATCH_MODIFIER
(
VK_F11
, 
CSI
 "23~");

2884 
	`MATCH_MODIFIER
(
VK_F12
, 
CSI
 "24~");

2886 
	`MATCH_MODIFIER
(
VK_F13
, 
CSI
 "25~");

2887 
	`MATCH_MODIFIER
(
VK_F14
, 
CSI
 "26~");

2888 
	`MATCH_MODIFIER
(
VK_F15
, 
CSI
 "28~");

2889 
	`MATCH_MODIFIER
(
VK_F16
, 
CSI
 "29~");

2890 
	`MATCH_MODIFIER
(
VK_F17
, 
CSI
 "31~");

2891 
	`MATCH_MODIFIER
(
VK_F18
, 
CSI
 "32~");

2892 
	`MATCH_MODIFIER
(
VK_F19
, 
CSI
 "33~");

2893 
	`MATCH_MODIFIER
(
VK_F20
, 
CSI
 "34~");

2902 #undeà
MATCH


2903 #undeà
MATCH_MODIFIER


2904 #undeà
MATCH_KEYPAD


2905 #undeà
MATCH_MODIFIER_KEYPAD


2906 #undeà
ESC


2907 #undeà
CSI


2908 #undeà
SS3


2910 cÚ¡ * 
out
;

2911 
size_t
 
ou’
;

2917 ià(
£q¡r
 !ğ
NULL
) {

2918 
out
 = 
£q¡r
;

2919 
ou’
 = 
	`¡¾’
(
£q¡r
);

2920 } ià(
£qbuæ’
 > 0) {

2921 
out
 = 
£qbuf
;

2922 
ou’
 = 
£qbuæ’
;

2923 } ià(
ch
 != '\0') {

2925 
£qbuf
[0] = 
ch
;

2926 
£qbuæ’
 = 1;

2927 
out
 = 
£qbuf
;

2928 
ou’
 = 
£qbuæ’
;

2936 
	`D
("_console_read: unknown virtual key code: %d,ƒnhanced: %s\n",

2937 
vk
, 
	`_is_’hªûd_key
(
cÚŒŞ_key_¡©e
) ? "true" : "false");

2938 
key_ev’t
->
wR•—tCouÁ
 = 0;

2942 
by‹sR—d
 = 0;

2945 
key_ev’t
->
wR•—tCouÁ
 > 0) {

2946 ià(
Ën
 >ğ
ou’
) {

2948 
	`memıy
(
buf
, 
out
, 
ou’
);

2949 
buf
 = (*)((*)buà+ 
ou’
);

2950 
Ën
 -ğ
ou’
;

2951 
by‹sR—d
 +ğ
ou’
;

2954 --
key_ev’t
->
wR•—tCouÁ
;

2958 ià(
by‹sR—d
 == 0) {

2964 
	`D
("_console_read:‚o buffer spaceo write one sequence; "

2965 "bufãr: %ld, sequ’û: %ld\n", ()
Ën
,

2966 ()
ou’
);

2967 
”ºo
 = 
ENOMEM
;

2977  
by‹sR—d
;

2979 
	}
}

2981 
DWORD
 
	g_Şd_cÚsŞe_mode
;

2982 
HANDLE
 
	g_cÚsŞe_hªdË
;

2984 
	$¡dš_¿w_š™
(cÚ¡ 
fd
) {

2985 ià(
STDIN_FILENO
 =ğ
fd
) {

2986 cÚ¡ 
HANDLE
 
š
 = 
	`G‘StdHªdË
(
STD_INPUT_HANDLE
);

2987 ià((
š
 =ğ
INVALID_HANDLE_VALUE
è|| (š =ğ
NULL
)) {

2991 ià(
	`G‘FeTy³
(
š
è!ğ
FILE_TYPE_CHAR
) {

2996 ià(!
	`G‘CÚsŞeMode
(
š
, &
_Şd_cÚsŞe_mode
)) {

3007 ià(!
	`S‘CÚsŞeMode
(
š
, 
_Şd_cÚsŞe_mode
 & ~(
ENABLE_PROCESSED_INPUT
 |

3008 
ENABLE_LINE_INPUT
 | 
ENABLE_ECHO_INPUT
))) {

3010 
	`D
("stdin_raw_init: SetConsoleMode() failure,ƒrror %ld\n",

3011 
	`G‘La¡E¼Ü
());

3016 
_cÚsŞe_hªdË
 = 
š
;

3022 
	}
}

3024 
	$¡dš_¿w_»¡Üe
(cÚ¡ 
fd
) {

3025 ià(
STDIN_FILENO
 =ğ
fd
) {

3026 ià(
_cÚsŞe_hªdË
 !ğ
NULL
) {

3027 cÚ¡ 
HANDLE
 
š
 = 
_cÚsŞe_hªdË
;

3028 
_cÚsŞe_hªdË
 = 
NULL
;

3030 ià(!
	`S‘CÚsŞeMode
(
š
, 
_Şd_cÚsŞe_mode
)) {

3032 
	`D
("stdin_raw_restore: SetConsoleMode() failure,ƒrror %ld\n",

3033 
	`G‘La¡E¼Ü
());

3037 
	}
}

3040 
	$unix_»ad
(
fd
, * 
buf
, 
size_t
 
Ën
) {

3041 ià((
fd
 =ğ
STDIN_FILENO
è&& (
_cÚsŞe_hªdË
 !ğ
NULL
)) {

3046  
	`_cÚsŞe_»ad
(
_cÚsŞe_hªdË
, 
buf
, 
Ën
);

3050 #undeà
»ad


3051  
	`»ad
(
fd
, 
buf
, 
Ën
);

3053 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/test_track_devices.cpp

4 
	~<Ãtdb.h
>

5 
	~<sys/sock‘.h
>

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

8 
	~<”ºo.h
>

9 
	~<memÜy.h
>

11 
	~<ba£/fe.h
>

14 
	$·nic
ĞcÚ¡ * 
msg
 )

16 
	`årštf
(
¡d”r
, "PANIC: %s: %s\n", 
msg
, 
	`¡»¼Ü
(
”ºo
));

17 
	`ex™
(1);

18 
	}
}

20 
	$maš
(
¬gc
, * 
¬gv
[]) {

21 cÚ¡ * 
»que¡
 = "host:track-devices";

23 ià(
¬gv
[1] && 
	`¡rcmp
(argv[1], "--jdwp") == 0) {

24 
»que¡
 = "track-jdwp";

27 
»t
;

28 
sockaddr_š
 
£rv”
;

29 
bufãr
[1024];

31 
	`mem£t
Ğ&
£rv”
, 0, (server) );

32 
£rv”
.
sš_çmy
 = 
AF_INET
;

33 
£rv”
.
sš_pÜt
 = 
	`htÚs
(5037);

34 
£rv”
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

36 
s
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_STREAM
, 0 );

37 
»t
 = 
	`cÚÃù
Ğ
s
, (
sockaddr
*è&
£rv”
, (server) );

38 ià(
»t
 < 0è
	`·nic
( "could‚ot connecto server" );

41 
Ën
 = 
	`¢´štf
(
bufãr
, (bufãr), "%04zx%s", 
	`¡¾’
(
»que¡
),„equest);

42 ià(!
ªdroid
::
ba£
::
	`Wr™eFuÎy
(
s
, 
bufãr
, 
Ën
))

43 
	`·nic
( "could‚ot send„equest" );

46 ià(!
ªdroid
::
ba£
::
	`R—dFuÎy
(
s
, 
bufãr
, 4))

47 
	`·nic
( "could‚ot„ead„equest" );

49 
	`´štf
Ğ"£rv”‡nsw”: %.*s\n", 4, 
bufãr
 );

52 
Œue
) {

53 
h—d
[5] = "0000";

55 ià(!
ªdroid
::
ba£
::
	`R—dFuÎy
(
s
, 
h—d
, 4))

56 
	`·nic
("could‚ot„ead†ength");

58 
Ën
;

59 ià(
	`ssÿnf
(
h—d
, "%04x", &
Ën
) != 1 )

60 
	`·nic
("could‚ot decode†ength");

62 ià(!
ªdroid
::
ba£
::
	`R—dFuÎy
(
s
, 
bufãr
, 
Ën
))

63 
	`·nic
("could‚ot„ead data");

65 
	`´štf
Ğ"»ûived h—d” %.* (%d by‹s):\n%.*s", 4, 
h—d
, 
Ën
,†’, 
bufãr
 );

67 
	`şo£
(
s
);

68 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/transport.cpp

17 
	#TRACE_TAG
 
TRACE_TRANSPORT


	)

19 
	~"sysd•s.h
"

20 
	~"Œª¥Üt.h
"

22 
	~<ùy³.h
>

23 
	~<”ºo.h
>

24 
	~<¡dio.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

27 
	~<uni¡d.h
>

29 
	~<ba£/¡ršg´štf.h
>

31 
	~"adb.h
"

32 
	~"adb_uts.h
"

34 
Œª¥Üt_uÄef
(
©¿n¥Üt
 *
t
);

36 
©¿n¥Üt
 
	gŒª¥Üt_li¡
 = {

37 .
Ãxt
 = &
Œª¥Üt_li¡
,

38 .
	g´ev
 = &
Œª¥Üt_li¡
,

41 
©¿n¥Üt
 
	g³ndšg_li¡
 = {

42 .
Ãxt
 = &
³ndšg_li¡
,

43 .
	g´ev
 = &
³ndšg_li¡
,

46 
ADB_MUTEX_DEFINE
Ğ
Œª¥Üt_lock
 );

48 
	$kick_Œª¥Üt
(
©¿n¥Üt
* 
t
)

50 ià(
t
 && !t->
kicked
)

52 
kicked
;

54 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

55 
kicked
 = 
t
->kicked;

56 ià(!
kicked
)

57 
t
->
kicked
 = 1;

58 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

60 ià(!
kicked
)

61 
t
->
	`kick
(t);

63 
	}
}

83 
	$run_Œª¥Üt_discÚÃùs
(
©¿n¥Üt
* 
t
)

85 
adiscÚÃù
* 
dis
 = 
t
->
discÚÃùs
.
Ãxt
;

87 
	`D
("%s:„un_Œª¥Üt_discÚÃùs\n", 
t
->
£rŸl
);

88 
dis
 !ğ&
t
->
discÚÃùs
) {

89 
adiscÚÃù
* 
Ãxt
 = 
dis
->next;

90 
dis
->
	`func
Ğdis->
İaque
, 
t
 );

91 
dis
 = 
Ãxt
;

93 
	}
}

95 
	$dump_·ck‘
(cÚ¡ * 
Çme
, cÚ¡ * 
func
, 
­ack‘
* 
p
) {

96 
commªd
 = 
p
->
msg
.command;

97 
Ën
 = 
p
->
msg
.
d©a_Ëngth
;

98 
cmd
[9];

99 
¬g0
[12], 
¬g1
[12];

100 
n
;

102 
n
 = 0;‚ < 4;‚++) {

103 
b
 = (
commªd
 >> (
n
*8)) & 255;

104 ià(
b
 < 32 || b >= 127)

106 
cmd
[
n
] = ()
b
;

108 ià(
n
 == 4) {

109 
cmd
[4] = 0;

113 
	`¢´štf
(
cmd
,  cmd, "%08x", 
commªd
);

116 ià(
p
->
msg
.
¬g0
 < 256U)

117 
	`¢´štf
(
¬g0
, ‡rg0, "%d", 
p
->
msg
.arg0);

119 
	`¢´štf
(
¬g0
, ‡rg0, "0x%x", 
p
->
msg
.arg0);

121 ià(
p
->
msg
.
¬g1
 < 256U)

122 
	`¢´štf
(
¬g1
, ‡rg1, "%d", 
p
->
msg
.arg1);

124 
	`¢´štf
(
¬g1
, ‡rg1, "0x%x", 
p
->
msg
.arg1);

126 
	`D
("%s: %s: [%s]‡rg0=%s‡rg1=%s (len=%d) ",

127 
Çme
, 
func
, 
cmd
, 
¬g0
, 
¬g1
, 
Ën
);

128 
	`dump_hex
(
p
->
d©a
, 
Ën
);

129 
	}
}

132 
	$»ad_·ck‘
(
fd
, cÚ¡ * 
Çme
, 
­ack‘
** 
µack‘
)

134 *
p
 = (*)
µack‘
;

135 
r
;

136 
Ën
 = (*
µack‘
);

137 
buff
[8];

138 ià(!
Çme
) {

139 
	`¢´štf
(
buff
,  buff, "fd=%d", 
fd
);

140 
Çme
 = 
buff
;

142 
Ën
 > 0) {

143 
r
 = 
	`adb_»ad
(
fd
, 
p
, 
Ën
);

144 if(
r
 > 0) {

145 
Ën
 -ğ
r
;

146 
p
 +ğ
r
;

148 
	`D
("%s:„—d_·ck‘ (fd=%d),ƒ¼Ü„‘=%dƒ¼no=%d: %s\n", 
Çme
, 
fd
, 
r
, 
”ºo
, 
	`¡»¼Ü
(errno));

149 if((
r
 < 0è&& (
”ºo
 =ğ
EINTR
)) ;

154 ià(
ADB_TRACING
) {

155 
	`dump_·ck‘
(
Çme
, "äom„emÙe", *
µack‘
);

158 
	}
}

161 
	$wr™e_·ck‘
(
fd
, cÚ¡ * 
Çme
, 
­ack‘
** 
µack‘
)

163 *
p
 = (*è
µack‘
;

164 
r
, 
Ën
 = (
µack‘
);

165 
buff
[8];

166 ià(!
Çme
) {

167 
	`¢´štf
(
buff
,  buff, "fd=%d", 
fd
);

168 
Çme
 = 
buff
;

171 ià(
ADB_TRACING
) {

172 
	`dump_·ck‘
(
Çme
, "tØ»mÙe", *
µack‘
);

174 
Ën
 = (
µack‘
);

175 
Ën
 > 0) {

176 
r
 = 
	`adb_wr™e
(
fd
, 
p
, 
Ën
);

177 if(
r
 > 0) {

178 
Ën
 -ğ
r
;

179 
p
 +ğ
r
;

181 
	`D
("%s: wr™e_·ck‘ (fd=%dè”rÜ„‘=%dƒ¼no=%d: %s\n", 
Çme
, 
fd
, 
r
, 
”ºo
, 
	`¡»¼Ü
(errno));

182 if((
r
 < 0è&& (
”ºo
 =ğ
EINTR
)) ;

187 
	}
}

189 
	$Œª¥Üt_sock‘_ev’ts
(
fd
, 
ev’ts
, *
_t
)

191 
©¿n¥Üt
 *
t
 = 
»š‹½»t_ÿ¡
<©¿n¥Üt*>(
_t
);

192 
	`D
("Œª¥Üt_sock‘_ev’ts(fd=%d,ƒv’ts=%04x,...)\n", 
fd
, 
ev’ts
);

193 if(
ev’ts
 & 
FDE_READ
){

194 
­ack‘
 *
p
 = 0;

195 if(
	`»ad_·ck‘
(
fd
, 
t
->
£rŸl
, &
p
)){

196 
	`D
("%s: faedØ»ad…ack‘ from¿n¥Üˆsock‘ oÀfd %d\n", 
t
->
£rŸl
, 
fd
);

198 
	`hªdË_·ck‘
(
p
, (
©¿n¥Üt
 *è
_t
);

201 
	}
}

203 
	$£nd_·ck‘
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

205 *
x
;

206 
sum
;

207 
couÁ
;

209 
p
->
msg
.
magic
 =…->msg.
commªd
 ^ 0xffffffff;

211 
couÁ
 = 
p
->
msg
.
d©a_Ëngth
;

212 
x
 = (*è
p
->
d©a
;

213 
sum
 = 0;

214 
couÁ
-- > 0){

215 
sum
 +ğ*
x
++;

217 
p
->
msg
.
d©a_check
 = 
sum
;

219 
	`´št_·ck‘
("£nd", 
p
);

221 ià(
t
 =ğ
NULL
) {

222 
	`D
("Transport is‚ull \n");

224 
”ºo
 = 0;

225 
	`çl_”ºo
("Transport is‚ull");

228 if(
	`wr™e_·ck‘
(
t
->
Œª¥Üt_sock‘
,->
£rŸl
, &
p
)){

229 
	`çl_”ºo
("cannotƒnqueue…acket onransport socket");

231 
	}
}

246 *
	$ouut_th»ad
(*
_t
)

248 
©¿n¥Üt
 *
t
 = 
»š‹½»t_ÿ¡
<©¿n¥Üt*>(
_t
);

249 
­ack‘
 *
p
;

251 
	`D
("%s: startingransport outputhread on fd %d, SYNC online (%d)\n",

252 
t
->
£rŸl
,->
fd
,->
sync_tok’
 + 1);

253 
p
 = 
	`g‘_­ack‘
();

254 
p
->
msg
.
commªd
 = 
A_SYNC
;

255 
p
->
msg
.
¬g0
 = 1;

256 
p
->
msg
.
¬g1
 = ++(
t
->
sync_tok’
);

257 
p
->
msg
.
magic
 = 
A_SYNC
 ^ 0xffffffff;

258 if(
	`wr™e_·ck‘
(
t
->
fd
,->
£rŸl
, &
p
)) {

259 
	`put_­ack‘
(
p
);

260 
	`D
("%s: faedØwr™SYNC…ack‘\n", 
t
->
£rŸl
);

261 
oİs
;

264 
	`D
("%s: d©¨pum°¡¬‹d\n", 
t
->
£rŸl
);

266 
p
 = 
	`g‘_­ack‘
();

268 if(
t
->
	`»ad_äom_»mÙe
(
p
,) == 0){

269 
	`D
("%s:„eceived„emote…acket, sendingoransport\n",

270 
t
->
£rŸl
);

271 if(
	`wr™e_·ck‘
(
t
->
fd
,->
£rŸl
, &
p
)){

272 
	`put_­ack‘
(
p
);

273 
	`D
("%s: faedØwr™­ack‘ØŒª¥Üt\n", 
t
->
£rŸl
);

274 
oİs
;

277 
	`D
("%s:„emÙ»ad faed fÜ¿n¥Üt\n", 
t
->
£rŸl
);

278 
	`put_­ack‘
(
p
);

283 
	`D
("%s: SYNC ofæšfÜ¿n¥Üt\n", 
t
->
£rŸl
);

284 
p
 = 
	`g‘_­ack‘
();

285 
p
->
msg
.
commªd
 = 
A_SYNC
;

286 
p
->
msg
.
¬g0
 = 0;

287 
p
->
msg
.
¬g1
 = 0;

288 
p
->
msg
.
magic
 = 
A_SYNC
 ^ 0xffffffff;

289 if(
	`wr™e_·ck‘
(
t
->
fd
,->
£rŸl
, &
p
)) {

290 
	`put_­ack‘
(
p
);

291 
	`D
("%s: faedØwr™SYNC‡·ck‘ØŒª¥Üt", 
t
->
£rŸl
);

294 
oİs
:

295 
	`D
("%s:¿n¥Üˆouuˆth»ad i ex™šg\n", 
t
->
£rŸl
);

296 
	`kick_Œª¥Üt
(
t
);

297 
	`Œª¥Üt_uÄef
(
t
);

299 
	}
}

301 *
	$šput_th»ad
(*
_t
)

303 
©¿n¥Üt
 *
t
 = 
»š‹½»t_ÿ¡
<©¿n¥Üt*>(
_t
);

304 
­ack‘
 *
p
;

305 
aùive
 = 0;

307 
	`D
("%s: startingransport inputhread,„eading from fd %d\n",

308 
t
->
£rŸl
,->
fd
);

311 if(
	`»ad_·ck‘
(
t
->
fd
,->
£rŸl
, &
p
)) {

312 
	`D
("%s: failedo„ead‡packet fromransport on fd %d\n",

313 
t
->
£rŸl
,->
fd
 );

316 if(
p
->
msg
.
commªd
 =ğ
A_SYNC
){

317 if(
p
->
msg
.
¬g0
 == 0) {

318 
	`D
("%s:¿n¥ÜˆSYNC ofæše\n", 
t
->
£rŸl
);

319 
	`put_­ack‘
(
p
);

322 if(
p
->
msg
.
¬g1
 =ğ
t
->
sync_tok’
) {

323 
	`D
("%s:¿n¥ÜˆSYNC oÆše\n", 
t
->
£rŸl
);

324 
aùive
 = 1;

326 
	`D
("%s:ransport ignoring SYNC %d != %d\n",

327 
t
->
£rŸl
, 
p
->
msg
.
¬g1
,->
sync_tok’
);

331 if(
aùive
) {

332 
	`D
("%s:¿n¥ÜˆgÙ…ack‘, s’dšgØ»mÙe\n", 
t
->
£rŸl
);

333 
t
->
	`wr™e_to_»mÙe
(
p
,);

335 
	`D
("%s:¿n¥ÜˆignÜšg…ack‘ whofæše\n", 
t
->
£rŸl
);

339 
	`put_­ack‘
(
p
);

344 
	`şo£_®l_sock‘s
(
t
);

346 
	`D
("%s:¿n¥Üˆšpuˆth»ad i ex™šg, fd %d\n", 
t
->
£rŸl
,->
fd
);

347 
	`kick_Œª¥Üt
(
t
);

348 
	`Œª¥Üt_uÄef
(
t
);

350 
	}
}

353 
	gŒª¥Üt_»gi¡¿tiÚ_£nd
 = -1;

354 
	gŒª¥Üt_»gi¡¿tiÚ_»cv
 = -1;

355 
fdev’t
 
	gŒª¥Üt_»gi¡¿tiÚ_fde
;

358 #ià
ADB_HOST


365 
	sdeviû_Œack”
 {

366 
asock‘
 
	msock‘
;

367 
	mupd©e_Ãeded
;

368 
deviû_Œack”
* 
	mÃxt
;

372 
deviû_Œack”
* 
	gdeviû_Œack”_li¡
;

375 
	$deviû_Œack”_»move
Ğ
deviû_Œack”
* 
Œack”
 )

377 
deviû_Œack”
** 
²ode
 = &
deviû_Œack”_li¡
;

378 
deviû_Œack”
* 
node
 = *
²ode
;

380 
	`adb_mu‹x_lock
Ğ&
Œª¥Üt_lock
 );

381 
node
) {

382 ià(
node
 =ğ
Œack”
) {

383 *
²ode
 = 
node
->
Ãxt
;

386 
²ode
 = &
node
->
Ãxt
;

387 
node
 = *
²ode
;

389 
	`adb_mu‹x_uÆock
Ğ&
Œª¥Üt_lock
 );

390 
	}
}

393 
	$deviû_Œack”_şo£
Ğ
asock‘
* 
sock‘
 )

395 
deviû_Œack”
* 
Œack”
 = (deviû_Œack”*è
sock‘
;

396 
asock‘
* 
³”
 = 
sock‘
->peer;

398 
	`D
Ğ"deviû¿ck” %°»moved\n", 
Œack”
);

399 ià(
³”
) {

400 
³”
->³” = 
NULL
;

401 
³”
->
	`şo£
(peer);

403 
	`deviû_Œack”_»move
(
Œack”
);

404 
	`ä“
(
Œack”
);

405 
	}
}

408 
	$deviû_Œack”_’queue
Ğ
asock‘
* 
sock‘
, 
­ack‘
* 
p
 )

411 
	`put_­ack‘
(
p
);

412 
	`deviû_Œack”_şo£
(
sock‘
);

414 
	}
}

416 
	$deviû_Œack”_£nd
(
deviû_Œack”
* 
Œack”
, cÚ¡ 
¡d
::
¡ršg
& string) {

417 
­ack‘
* 
p
 = 
	`g‘_­ack‘
();

418 
asock‘
* 
³”
 = 
Œack”
->
sock‘
.peer;

420 
	`¢´štf
(
»š‹½»t_ÿ¡
<*>(
p
->
d©a
), 5, "%04x", 
¡©ic_ÿ¡
<>(
¡ršg
.
	`size
()));

421 
	`memıy
(&
p
->
d©a
[4], 
¡ršg
.
	`d©a
(), sŒšg.
	`size
());

422 
p
->
Ën
 = 4 + 
¡ršg
.
	`size
();

423  
³”
->
	`’queue
Õ“r, 
p
);

424 
	}
}

426 
	$deviû_Œack”_»ady
(
asock‘
* 
sock‘
) {

427 
deviû_Œack”
* 
Œack”
 = 
»š‹½»t_ÿ¡
<deviû_Œack”*>(
sock‘
);

431 ià(
Œack”
->
upd©e_Ãeded
 > 0) {

432 
Œack”
->
upd©e_Ãeded
 = 0;

434 
¡d
::
¡ršg
 
Œª¥Üts
 = 
	`li¡_Œª¥Üts
(
çl£
);

435 
	`deviû_Œack”_£nd
(
Œack”
, 
Œª¥Üts
);

437 
	}
}

439 
asock‘
*

440 
	$ü—‹_deviû_Œack”
()

442 
deviû_Œack”
* 
Œack”
 = 
»š‹½»t_ÿ¡
<deviû_Œack”*>(
	`ÿÎoc
(1, (*tracker)));

443 ià(
Œack”
 =ğ
nuÎ±r
è
	`çl
("cannot‡llocate deviceracker");

445 
	`D
Ğ"deviû¿ck” %°ü—‹d\n", 
Œack”
);

447 
Œack”
->
sock‘
.
’queue
 = 
deviû_Œack”_’queue
;

448 
Œack”
->
sock‘
.
»ady
 = 
deviû_Œack”_»ady
;

449 
Œack”
->
sock‘
.
şo£
 = 
deviû_Œack”_şo£
;

450 
Œack”
->
upd©e_Ãeded
 = 1;

452 
Œack”
->
Ãxt
 = 
deviû_Œack”_li¡
;

453 
deviû_Œack”_li¡
 = 
Œack”
;

455  &
Œack”
->
sock‘
;

456 
	}
}

460 
	$upd©e_Œª¥Üts
() {

461 
¡d
::
¡ršg
 
Œª¥Üts
 = 
	`li¡_Œª¥Üts
(
çl£
);

463 
deviû_Œack”
* 
Œack”
 = 
deviû_Œack”_li¡
;

464 
Œack”
 !ğ
nuÎ±r
) {

465 
deviû_Œack”
* 
Ãxt
 = 
Œack”
->next;

467 
	`deviû_Œack”_£nd
(
Œack”
, 
Œª¥Üts
);

468 
Œack”
 = 
Ãxt
;

470 
	}
}

474 
	$upd©e_Œª¥Üts
() {

476 
	}
}

480 
	stmsg


482 
©¿n¥Üt
 *
	mŒª¥Üt
;

483 
	maùiÚ
;

487 
	$Œª¥Üt_»ad_aùiÚ
(
fd
, 
tmsg
* 
m
)

489 *
p
 = (*)
m
;

490 
Ën
 = (*
m
);

491 
r
;

493 
Ën
 > 0) {

494 
r
 = 
	`adb_»ad
(
fd
, 
p
, 
Ën
);

495 if(
r
 > 0) {

496 
Ën
 -ğ
r
;

497 
p
 +ğ
r
;

499 if((
r
 < 0è&& (
”ºo
 =ğ
EINTR
)) ;

500 
	`D
("transport_read_action: on fd %d,ƒrror %d: %s\n",

501 
fd
, 
”ºo
, 
	`¡»¼Ü
(errno));

506 
	}
}

509 
	$Œª¥Üt_wr™e_aùiÚ
(
fd
, 
tmsg
* 
m
)

511 *
p
 = (*)
m
;

512 
Ën
 = (*
m
);

513 
r
;

515 
Ën
 > 0) {

516 
r
 = 
	`adb_wr™e
(
fd
, 
p
, 
Ën
);

517 if(
r
 > 0) {

518 
Ën
 -ğ
r
;

519 
p
 +ğ
r
;

521 if((
r
 < 0è&& (
”ºo
 =ğ
EINTR
)) ;

522 
	`D
("transport_write_action: on fd %d,ƒrror %d: %s\n",

523 
fd
, 
”ºo
, 
	`¡»¼Ü
(errno));

528 
	}
}

530 
	$Œª¥Üt_»gi¡¿tiÚ_func
(
_fd
, 
ev
, *
d©a
)

532 
tmsg
 
m
;

533 
adb_th»ad_t
 
ouut_th»ad_±r
;

534 
adb_th»ad_t
 
šput_th»ad_±r
;

535 
s
[2];

536 
©¿n¥Üt
 *
t
;

538 if(!(
ev
 & 
FDE_READ
)) {

542 if(
	`Œª¥Üt_»ad_aùiÚ
(
_fd
, &
m
)) {

543 
	`çl_”ºo
("cannot„eadransport„egistration socket");

546 
t
 = 
m
.
Œª¥Üt
;

548 if(
m
.
aùiÚ
 == 0){

549 
	`D
("Œª¥Üt: % »movšg‡nd f»e'šg %d\n", 
t
->
£rŸl
,->
Œª¥Üt_sock‘
);

554 
	`fdev’t_»move
(&(
t
->
Œª¥Üt_fde
));

555 
	`adb_şo£
(
t
->
fd
);

557 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

558 
t
->
Ãxt
->
´ev
 =->prev;

559 
t
->
´ev
->
Ãxt
 =->next;

560 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

562 
	`run_Œª¥Üt_discÚÃùs
(
t
);

564 ià(
t
->
´oduù
)

565 
	`ä“
(
t
->
´oduù
);

566 ià(
t
->
£rŸl
)

567 
	`ä“
(
t
->
£rŸl
);

568 ià(
t
->
mod–
)

569 
	`ä“
(
t
->
mod–
);

570 ià(
t
->
deviû
)

571 
	`ä“
(
t
->
deviû
);

572 ià(
t
->
dev·th
)

573 
	`ä“
(
t
->
dev·th
);

575 
	`mem£t
(
t
,0x“,(
©¿n¥Üt
));

576 
	`ä“
(
t
);

578 
	`upd©e_Œª¥Üts
();

583 ià(
t
->
cÚÃùiÚ_¡©e
 !ğ
CS_NOPERM
) {

585 
t
->
»f_couÁ
 = 2;

587 if(
	`adb_sock‘·œ
(
s
)) {

588 
	`çl_”ºo
("cannot openransport socketpair");

591 
	`D
("Œª¥Üt: % sock‘·œ: (%d,%dè¡¬tšg", 
t
->
£rŸl
, 
s
[0], s[1]);

593 
t
->
Œª¥Üt_sock‘
 = 
s
[0];

594 
t
->
fd
 = 
s
[1];

596 
	`fdev’t_š¡®l
(&(
t
->
Œª¥Üt_fde
),

597 
t
->
Œª¥Üt_sock‘
,

598 
Œª¥Üt_sock‘_ev’ts
,

599 
t
);

601 
	`fdev’t_£t
(&(
t
->
Œª¥Üt_fde
), 
FDE_READ
);

603 if(
	`adb_th»ad_ü—‹
(&
šput_th»ad_±r
, 
šput_th»ad
, 
t
)){

604 
	`çl_”ºo
("cannot create inputhread");

607 if(
	`adb_th»ad_ü—‹
(&
ouut_th»ad_±r
, 
ouut_th»ad
, 
t
)){

608 
	`çl_”ºo
("cannot create outputhread");

612 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

614 
t
->
Ãxt
->
´ev
 =->prev;

615 
t
->
´ev
->
Ãxt
 =->next;

617 
t
->
Ãxt
 = &
Œª¥Üt_li¡
;

618 
t
->
´ev
 = 
Œª¥Üt_li¡
.prev;

619 
t
->
Ãxt
->
´ev
 =;

620 
t
->
´ev
->
Ãxt
 =;

621 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

623 
t
->
discÚÃùs
.
Ãxt
 =->discÚÃùs.
´ev
 = &t->disconnects;

625 
	`upd©e_Œª¥Üts
();

626 
	}
}

628 
	$š™_Œª¥Üt_»gi¡¿tiÚ
()

630 
s
[2];

632 if(
	`adb_sock‘·œ
(
s
)){

633 
	`çl_”ºo
("cannot openransport„egistration socketpair");

635 
	`D
("sock‘·œ: (%d,%d)", 
s
[0], s[1]);

637 
Œª¥Üt_»gi¡¿tiÚ_£nd
 = 
s
[0];

638 
Œª¥Üt_»gi¡¿tiÚ_»cv
 = 
s
[1];

640 
	`fdev’t_š¡®l
(&
Œª¥Üt_»gi¡¿tiÚ_fde
,

641 
Œª¥Üt_»gi¡¿tiÚ_»cv
,

642 
Œª¥Üt_»gi¡¿tiÚ_func
,

645 
	`fdev’t_£t
(&
Œª¥Üt_»gi¡¿tiÚ_fde
, 
FDE_READ
);

646 
	}
}

649 
	$»gi¡”_Œª¥Üt
(
©¿n¥Üt
 *
Œª¥Üt
)

651 
tmsg
 
m
;

652 
m
.
Œª¥Üt
 =ransport;

653 
m
.
aùiÚ
 = 1;

654 
	`D
("Œª¥Üt: % »gi¡”ed\n", 
Œª¥Üt
->
£rŸl
);

655 if(
	`Œª¥Üt_wr™e_aùiÚ
(
Œª¥Üt_»gi¡¿tiÚ_£nd
, &
m
)) {

656 
	`çl_”ºo
("cannot writeransport„egistration socket\n");

658 
	}
}

660 
	$»move_Œª¥Üt
(
©¿n¥Üt
 *
Œª¥Üt
)

662 
tmsg
 
m
;

663 
m
.
Œª¥Üt
 =ransport;

664 
m
.
aùiÚ
 = 0;

665 
	`D
("Œª¥Üt: % »moved\n", 
Œª¥Üt
->
£rŸl
);

666 if(
	`Œª¥Üt_wr™e_aùiÚ
(
Œª¥Üt_»gi¡¿tiÚ_£nd
, &
m
)) {

667 
	`çl_”ºo
("cannot writeransport„egistration socket\n");

669 
	}
}

672 
	$Œª¥Üt_uÄef_locked
(
©¿n¥Üt
 *
t
)

674 
t
->
»f_couÁ
--;

675 ià(
t
->
»f_couÁ
 == 0) {

676 
	`D
("Œª¥Üt: % uÄeà(kickšg‡nd closšg)\n", 
t
->
£rŸl
);

677 ià(!
t
->
kicked
) {

678 
t
->
kicked
 = 1;

679 
t
->
	`kick
(t);

681 
t
->
	`şo£
(t);

682 
	`»move_Œª¥Üt
(
t
);

684 
	`D
("Œª¥Üt: % uÄeà(couÁ=%d)\n", 
t
->
£rŸl
,->
»f_couÁ
);

686 
	}
}

688 
	$Œª¥Üt_uÄef
(
©¿n¥Üt
 *
t
)

690 ià(
t
) {

691 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

692 
	`Œª¥Üt_uÄef_locked
(
t
);

693 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

695 
	}
}

697 
	$add_Œª¥Üt_discÚÃù
(
©¿n¥Üt
* 
t
, 
adiscÚÃù
* 
dis
)

699 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

700 
dis
->
Ãxt
 = &
t
->
discÚÃùs
;

701 
dis
->
´ev
 = dis->
Ãxt
->prev;

702 
dis
->
´ev
->
Ãxt
 = dis;

703 
dis
->
Ãxt
->
´ev
 = dis;

704 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

705 
	}
}

707 
	$»move_Œª¥Üt_discÚÃù
(
©¿n¥Üt
* 
t
, 
adiscÚÃù
* 
dis
)

709 
dis
->
´ev
->
Ãxt
 = dis->next;

710 
dis
->
Ãxt
->
´ev
 = dis->prev;

711 
dis
->
Ãxt
 = dis->
´ev
 = dis;

712 
	}
}

714 
	$qu®_m©ch
(cÚ¡ *
to_‹¡
,

715 cÚ¡ *
´efix
, cÚ¡ *
qu®
, 
boŞ
 
§n™ize_qu®
)

717 ià(!
to_‹¡
 || !*to_test)

719  !
qu®
 || !*qual;

721 ià(!
qu®
)

724 ià(
´efix
) {

725 *
´efix
) {

726 ià(*
´efix
++ !ğ*
to_‹¡
++)

731 *
qu®
) {

732 
ch
 = *
qu®
++;

733 ià(
§n™ize_qu®
 && !
	`i§Êum
(
ch
))

734 
ch
 = '_';

735 ià(
ch
 !ğ*
to_‹¡
++)

740  !*
to_‹¡
;

741 
	}
}

743 
©¿n¥Üt
* 
	$acquœe_Úe_Œª¥Üt
(
¡©e
, 
Œª¥Üt_ty³
 
‰y³
,

744 cÚ¡ * 
£rŸl
, 
¡d
::
¡ršg
* 
”rÜ_out
)

746 
©¿n¥Üt
 *
t
;

747 
©¿n¥Üt
 *
»suÉ
 = 
NULL
;

748 
ambiguous
 = 0;

750 
»Œy
:

751 ià(
”rÜ_out
è*”rÜ_ouˆğ
ªdroid
::
ba£
::
	`SŒšgPrštf
("deviû '%s'‚Ù found", 
£rŸl
);

753 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

754 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =->next) {

755 ià(
t
->
cÚÃùiÚ_¡©e
 =ğ
CS_NOPERM
) {

756 ià(
”rÜ_out
) *error_out = "insufficient…ermissions for device";

761 ià(
£rŸl
) {

762 ià((
t
->
£rŸl
 && !
	`¡rcmp
(serial,->serial)) ||

763 (
t
->
dev·th
 && !
	`¡rcmp
(
£rŸl
,->devpath)) ||

764 
	`qu®_m©ch
(
£rŸl
, "´oduù:", 
t
->
´oduù
, 
çl£
) ||

765 
	`qu®_m©ch
(
£rŸl
, "mod–:", 
t
->
mod–
, 
Œue
) ||

766 
	`qu®_m©ch
(
£rŸl
, "deviû:", 
t
->
deviû
, 
çl£
)) {

767 ià(
»suÉ
) {

768 ià(
”rÜ_out
) *error_out = "morehan one device";

769 
ambiguous
 = 1;

770 
»suÉ
 = 
NULL
;

773 
»suÉ
 = 
t
;

776 ià(
‰y³
 =ğ
kT¿n¥ÜtUsb
 && 
t
->
ty³
 == kTransportUsb) {

777 ià(
»suÉ
) {

778 ià(
”rÜ_out
) *error_out = "morehan one device";

779 
ambiguous
 = 1;

780 
»suÉ
 = 
NULL
;

783 
»suÉ
 = 
t
;

784 } ià(
‰y³
 =ğ
kT¿n¥ÜtLoÿl
 && 
t
->
ty³
 == kTransportLocal) {

785 ià(
»suÉ
) {

786 ià(
”rÜ_out
) *error_out = "morehan oneƒmulator";

787 
ambiguous
 = 1;

788 
»suÉ
 = 
NULL
;

791 
»suÉ
 = 
t
;

792 } ià(
‰y³
 =ğ
kT¿n¥ÜtAny
) {

793 ià(
»suÉ
) {

794 ià(
”rÜ_out
) *error_out = "morehan one device/emulator";

795 
ambiguous
 = 1;

796 
»suÉ
 = 
NULL
;

799 
»suÉ
 = 
t
;

803 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

805 ià(
»suÉ
) {

806 ià(
»suÉ
->
cÚÃùiÚ_¡©e
 =ğ
CS_UNAUTHORIZED
) {

807 ià(
”rÜ_out
) {

808 *
”rÜ_out
 = "device unauthorized.\n";

809 * 
ADB_VENDOR_KEYS
 = 
	`g‘’v
("ADB_VENDOR_KEYS");

810 *
”rÜ_out
 += "This‡dbd's $ADB_VENDOR_KEYS is ";

811 *
”rÜ_out
 +ğ
ADB_VENDOR_KEYS
 ? ADB_VENDOR_KEYS : "not set";

812 *
”rÜ_out
 += ";ry 'adb kill-server' ifhat seems wrong.\n";

813 *
”rÜ_out
 += "Otherwise check for‡ confirmation dialog on your device.";

815 
»suÉ
 = 
NULL
;

819 ià(
»suÉ
 &&„esuÉ->
cÚÃùiÚ_¡©e
 =ğ
CS_OFFLINE
) {

820 ià(
”rÜ_out
) *error_out = "device offline";

821 
»suÉ
 = 
NULL
;

825 ià(
»suÉ
 && 
¡©e
 !ğ
CS_ANY
 &&„esuÉ->
cÚÃùiÚ_¡©e
 != state) {

826 ià(
”rÜ_out
) *error_out = "invalid device state";

827 
»suÉ
 = 
NULL
;

831 ià(
»suÉ
) {

833 ià(
”rÜ_out
) *error_out = "success";

834 } ià(
¡©e
 !ğ
CS_ANY
 && (
£rŸl
 || !
ambiguous
)) {

835 
	`adb_¦“p_ms
(1000);

836 
»Œy
;

839  
»suÉ
;

840 
	}
}

842 cÚ¡ * 
	g©¿n¥Üt
::
	$cÚÃùiÚ_¡©e_Çme
() const {

843 
cÚÃùiÚ_¡©e
) {

844 
CS_OFFLINE
:  "offline";

845 
CS_BOOTLOADER
:  "bootloader";

846 
CS_DEVICE
:  "device";

847 
CS_HOST
:  "host";

848 
CS_RECOVERY
:  "recovery";

849 
CS_NOPERM
:  "no…ermissions";

850 
CS_SIDELOAD
:  "sideload";

851 
CS_UNAUTHORIZED
:  "unauthorized";

854 
	}
}

856 
	g©¿n¥Üt
::
	$upd©e_v”siÚ
(
v”siÚ
, 
size_t
 
·ylßd
) {

857 
´ÙocŞ_v”siÚ
 = 
¡d
::
	`mš
(
v”siÚ
, 
A_VERSION
);

858 
max_·ylßd
 = 
¡d
::
	`mš
(
·ylßd
, 
MAX_PAYLOAD
);

859 
	}
}

861 
	g©¿n¥Üt
::
	$g‘_´ÙocŞ_v”siÚ
() const {

862  
´ÙocŞ_v”siÚ
;

863 
	}
}

865 
size_t
 
	g©¿n¥Üt
::
	$g‘_max_·ylßd
() const {

866  
max_·ylßd
;

867 
	}
}

869 #ià
ADB_HOST


871 
	$­³nd_Œª¥Üt_šfo
(
¡d
::
¡ršg
* 
»suÉ
, cÚ¡ * 
key
,

872 cÚ¡ * 
v®ue
, 
boŞ
 
§n™ize
) {

873 ià(
v®ue
 =ğ
nuÎ±r
 || *value == '\0') {

877 *
»suÉ
 += ' ';

878 *
»suÉ
 +ğ
key
;

880 cÚ¡ * 
p
 = 
v®ue
; *p; ++p) {

881 
»suÉ
->
	`push_back
((!
§n™ize
 || 
	`i§Êum
(*
p
)) ? *p : '_');

883 
	}
}

885 
	$­³nd_Œª¥Üt
(
©¿n¥Üt
* 
t
, 
¡d
::
¡ršg
* 
»suÉ
, 
boŞ
 
lÚg_li¡šg
) {

886 cÚ¡ * 
£rŸl
 = 
t
->serial;

887 ià(!
£rŸl
 || !serial[0]) {

888 
£rŸl
 = "(no serial‚umber)";

891 ià(!
lÚg_li¡šg
) {

892 *
»suÉ
 +ğ
£rŸl
;

893 *
»suÉ
 += '\t';

894 *
»suÉ
 +ğ
t
->
	`cÚÃùiÚ_¡©e_Çme
();

896 
ªdroid
::
ba£
::
	`SŒšgAµ’dF
(
»suÉ
, "%-22 %s", 
£rŸl
, 
t
->
	`cÚÃùiÚ_¡©e_Çme
());

898 
	`­³nd_Œª¥Üt_šfo
(
»suÉ
, "", 
t
->
dev·th
, 
çl£
);

899 
	`­³nd_Œª¥Üt_šfo
(
»suÉ
, "´oduù:", 
t
->
´oduù
, 
çl£
);

900 
	`­³nd_Œª¥Üt_šfo
(
»suÉ
, "mod–:", 
t
->
mod–
, 
Œue
);

901 
	`­³nd_Œª¥Üt_šfo
(
»suÉ
, "deviû:", 
t
->
deviû
, 
çl£
);

903 *
»suÉ
 += '\n';

904 
	}
}

906 
	g¡d
::
¡ršg
 
	$li¡_Œª¥Üts
(
boŞ
 
lÚg_li¡šg
) {

907 
¡d
::
¡ršg
 
»suÉ
;

908 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

909 
©¿n¥Üt
* 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =->next) {

910 
	`­³nd_Œª¥Üt
(
t
, &
»suÉ
, 
lÚg_li¡šg
);

912 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

913  
»suÉ
;

914 
	}
}

917 
	$şo£_usb_deviûs
()

919 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

920 
©¿n¥Üt
* 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =->next) {

921 iàĞ!
t
->
kicked
 ) {

922 
t
->
kicked
 = 1;

923 
t
->
	`kick
(t);

926 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

927 
	}
}

930 
	$»gi¡”_sock‘_Œª¥Üt
(
s
, cÚ¡ *
£rŸl
, 
pÜt
, 
loÿl
)

932 
©¿n¥Üt
 *
t
 = 
»š‹½»t_ÿ¡
<©¿n¥Üt*>(
	`ÿÎoc
(1, (atransport)));

933 ià(
t
 =ğ
nuÎ±r
) {

937 
©¿n¥Üt
 *
n
;

938 
buff
[32];

940 ià(!
£rŸl
) {

941 
	`¢´štf
(
buff
,  buff, "T-%p", 
t
);

942 
£rŸl
 = 
buff
;

944 
	`D
("Œª¥Üt: % š™'šg fÜ sock‘ %d, oÀpÜˆ%d\n", 
£rŸl
, 
s
, 
pÜt
);

945 ià(
	`š™_sock‘_Œª¥Üt
(
t
, 
s
, 
pÜt
, 
loÿl
) < 0) {

946 
	`ä“
(
t
);

950 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

951 
n
 = 
³ndšg_li¡
.
Ãxt
;‚ != &pending_list;‚ =‚->next) {

952 ià(
n
->
£rŸl
 && !
	`¡rcmp
(serial,‚->serial)) {

953 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

954 
	`ä“
(
t
);

959 
n
 = 
Œª¥Üt_li¡
.
Ãxt
;‚ != &transport_list;‚ =‚->next) {

960 ià(
n
->
£rŸl
 && !
	`¡rcmp
(serial,‚->serial)) {

961 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

962 
	`ä“
(
t
);

967 
t
->
Ãxt
 = &
³ndšg_li¡
;

968 
t
->
´ev
 = 
³ndšg_li¡
.prev;

969 
t
->
Ãxt
->
´ev
 =;

970 
t
->
´ev
->
Ãxt
 =;

971 
t
->
£rŸl
 = 
	`¡rdup
(serial);

972 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

974 
	`»gi¡”_Œª¥Üt
(
t
);

976 
	}
}

978 #ià
ADB_HOST


979 
©¿n¥Üt
 *
	$fšd_Œª¥Üt
(cÚ¡ *
£rŸl
)

981 
©¿n¥Üt
 *
t
;

983 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

984 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =->next) {

985 ià(
t
->
£rŸl
 && !
	`¡rcmp
(serial,->serial)) {

989 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

991 ià(
t
 !ğ&
Œª¥Üt_li¡
)

992  
t
;

995 
	}
}

997 
	$uÄegi¡”_Œª¥Üt
(
©¿n¥Üt
 *
t
)

999 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

1000 
t
->
Ãxt
->
´ev
 =->prev;

1001 
t
->
´ev
->
Ãxt
 =->next;

1002 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

1004 
	`kick_Œª¥Üt
(
t
);

1005 
	`Œª¥Üt_uÄef
(
t
);

1006 
	}
}

1009 
	$uÄegi¡”_®l_tı_Œª¥Üts
()

1011 
©¿n¥Üt
 *
t
, *
Ãxt
;

1012 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

1013 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =‚ext) {

1014 
Ãxt
 = 
t
->next;

1015 ià(
t
->
ty³
 =ğ
kT¿n¥ÜtLoÿl
 &&->
adb_pÜt
 == 0) {

1016 
t
->
Ãxt
->
´ev
 =->prev;

1017 
t
->
´ev
->
Ãxt
 =‚ext;

1019 ià(!
t
->
kicked
)

1021 
t
->
kicked
 = 1;

1022 
t
->
	`kick
(t);

1024 
	`Œª¥Üt_uÄef_locked
(
t
);

1028 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

1029 
	}
}

1033 
	$»gi¡”_usb_Œª¥Üt
(
usb_hªdË
 *
usb
, cÚ¡ *
£rŸl
, cÚ¡ *
dev·th
, 
wr™—bË
)

1035 
©¿n¥Üt
 *
t
 = 
»š‹½»t_ÿ¡
<©¿n¥Üt*>(
	`ÿÎoc
(1, (atransport)));

1036 ià(
t
 =ğ
nuÎ±r
è
	`çl
("cannot‡llocate USB‡transport");

1037 
	`D
("Œª¥Üt: %°š™'šg fÜ usb_hªdË %°(¢='%s')\n", 
t
, 
usb
,

1038 
£rŸl
 ? serial : "");

1039 
	`š™_usb_Œª¥Üt
(
t
, 
usb
, (
wr™—bË
 ? 
CS_OFFLINE
 : 
CS_NOPERM
));

1040 if(
£rŸl
) {

1041 
t
->
£rŸl
 = 
	`¡rdup
(serial);

1043 if(
dev·th
) {

1044 
t
->
dev·th
 = 
	`¡rdup
(devpath);

1047 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

1048 
t
->
Ãxt
 = &
³ndšg_li¡
;

1049 
t
->
´ev
 = 
³ndšg_li¡
.prev;

1050 
t
->
Ãxt
->
´ev
 =;

1051 
t
->
´ev
->
Ãxt
 =;

1052 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

1054 
	`»gi¡”_Œª¥Üt
(
t
);

1055 
	}
}

1058 
	$uÄegi¡”_usb_Œª¥Üt
(
usb_hªdË
 *
usb
)

1060 
©¿n¥Üt
 *
t
;

1061 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

1062 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =->next) {

1063 ià(
t
->
usb
 =ğusb &&->
cÚÃùiÚ_¡©e
 =ğ
CS_NOPERM
) {

1064 
t
->
Ãxt
->
´ev
 =->prev;

1065 
t
->
´ev
->
Ãxt
 =->next;

1069 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

1070 
	}
}

1072 #undeà
TRACE_TAG


1073 
	#TRACE_TAG
 
TRACE_RWX


	)

1075 
	$check_h—d”
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

1077 if(
p
->
msg
.
magic
 !ğÕ->msg.
commªd
 ^ 0xffffffff)) {

1078 
	`D
("check_header(): invalid magic\n");

1082 if(
p
->
msg
.
d©a_Ëngth
 > 
t
->
	`g‘_max_·ylßd
()) {

1083 
	`D
("check_header(): %u >‡transport::max_payload = %zu\n",

1084 
p
->
msg
.
d©a_Ëngth
, 
t
->
	`g‘_max_·ylßd
());

1089 
	}
}

1091 
	$check_d©a
(
­ack‘
 *
p
)

1093 
couÁ
, 
sum
;

1094 *
x
;

1096 
couÁ
 = 
p
->
msg
.
d©a_Ëngth
;

1097 
x
 = 
p
->
d©a
;

1098 
sum
 = 0;

1099 
couÁ
-- > 0) {

1100 
sum
 +ğ*
x
++;

1103 if(
sum
 !ğ
p
->
msg
.
d©a_check
) {

1108 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/transport.h

17 #iâdeà
__TRANSPORT_H


18 
	#__TRANSPORT_H


	)

20 
	~<sys/ty³s.h
>

22 
	~<¡ršg
>

24 
	~"adb.h
"

32 
©¿n¥Üt
* 
acquœe_Úe_Œª¥Üt
(
¡©e
, 
Œª¥Üt_ty³
 
‰y³
,

33 cÚ¡ * 
£rŸl
, 
¡d
::
¡ršg
* 
”rÜ_out
);

34 
add_Œª¥Üt_discÚÃù
(
©¿n¥Üt
* 
t
, 
adiscÚÃù
* 
dis
);

35 
»move_Œª¥Üt_discÚÃù
(
©¿n¥Üt
* 
t
, 
adiscÚÃù
* 
dis
);

36 
kick_Œª¥Üt
(
©¿n¥Üt
* 
t
);

37 
run_Œª¥Üt_discÚÃùs
(
©¿n¥Üt
* 
t
);

38 
upd©e_Œª¥Üts
();

43 
š™_Œª¥Üt_»gi¡¿tiÚ
();

44 
	g¡d
::
¡ršg
 
li¡_Œª¥Üts
(
boŞ
 
lÚg_li¡šg
);

45 
©¿n¥Üt
* 
fšd_Œª¥Üt
(cÚ¡ * 
£rŸl
);

47 
»gi¡”_usb_Œª¥Üt
(
usb_hªdË
* 
h
, cÚ¡ * 
£rŸl
,

48 cÚ¡ * 
dev·th
, 
wr™—bË
);

51 
»gi¡”_sock‘_Œª¥Üt
(
s
, cÚ¡ * 
£rŸl
, 
pÜt
, 
loÿl
);

54 
uÄegi¡”_usb_Œª¥Üt
(
usb_hªdË
* 
usb
);

57 
uÄegi¡”_Œª¥Üt
(
©¿n¥Üt
* 
t
);

58 
uÄegi¡”_®l_tı_Œª¥Üts
();

60 
check_h—d”
(
­ack‘
* 
p
, 
©¿n¥Üt
* 
t
);

61 
check_d©a
(
­ack‘
* 
p
);

64 
şo£_usb_deviûs
();

66 
£nd_·ck‘
(
­ack‘
* 
p
, 
©¿n¥Üt
* 
t
);

68 
asock‘
* 
ü—‹_deviû_Œack”
();

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/transport_local.cpp

17 
	#TRACE_TAG
 
TRACE_TRANSPORT


	)

19 
	~"sysd•s.h
"

20 
	~"Œª¥Üt.h
"

22 
	~<”ºo.h
>

23 
	~<¡dio.h
>

24 
	~<¡dlib.h
>

25 
	~<¡ršg.h
>

26 
	~<sys/ty³s.h
>

28 
	~<ba£/¡ršg´štf.h
>

30 #ià!
ADB_HOST


31 
	~"cuts/´İ”t›s.h
"

34 
	~"adb.h
"

35 
	~"adb_io.h
"

37 #ià
ADB_HOST


42 
	#ADB_LOCAL_TRANSPORT_MAX
 64

	)

44 
ADB_MUTEX_DEFINE
Ğ
loÿl_Œª¥Üts_lock
 );

46 
©¿n¥Üt
* 
	gloÿl_Œª¥Üts
[ 
ADB_LOCAL_TRANSPORT_MAX
 ];

49 
	$»mÙe_»ad
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

51 if(!
	`R—dFdExaùly
(
t
->
sfd
, &
p
->
msg
, (
ames§ge
))){

52 
	`D
("remote†ocal:„eaderminated (message)\n");

56 if(
	`check_h—d”
(
p
, 
t
)) {

57 
	`D
("bad header:erminated (data)\n");

61 if(!
	`R—dFdExaùly
(
t
->
sfd
, 
p
->
d©a
,…->
msg
.
d©a_Ëngth
)){

62 
	`D
("remote†ocal:erminated (data)\n");

66 if(
	`check_d©a
(
p
)) {

67 
	`D
("bad data:erminated (data)\n");

72 
	}
}

74 
	$»mÙe_wr™e
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

76 
Ëngth
 = 
p
->
msg
.
d©a_Ëngth
;

78 if(!
	`Wr™eFdExaùly
(
t
->
sfd
, &
p
->
msg
, (
ames§ge
è+ 
Ëngth
)) {

79 
	`D
("remote†ocal: writeerminated\n");

84 
	}
}

87 
	$loÿl_cÚÃù
(
pÜt
) {

88  
	`loÿl_cÚÃù_¬b™¿ry_pÜts
(
pÜt
-1,…ort);

89 
	}
}

91 
	$loÿl_cÚÃù_¬b™¿ry_pÜts
(
cÚsŞe_pÜt
, 
adb_pÜt
)

93 
fd
 = -1;

95 #ià
ADB_HOST


96 cÚ¡ *
ho¡
 = 
	`g‘’v
("ADBHOST");

97 ià(
ho¡
) {

98 
fd
 = 
	`sock‘_ÃtwÜk_ş›Á
(
ho¡
, 
adb_pÜt
, 
SOCK_STREAM
);

101 ià(
fd
 < 0) {

102 
fd
 = 
	`sock‘_loİback_ş›Á
(
adb_pÜt
, 
SOCK_STREAM
);

105 ià(
fd
 >= 0) {

106 
	`D
("ş›Á: cÚÃùed oÀ»mÙÚ fd %d\n", 
fd
);

107 
	`şo£_Ú_exec
(
fd
);

108 
	`di§bË_tı_ÇgË
(
fd
);

109 
¡d
::
¡ršg
 
£rŸl
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
("emuÏtÜ-%d", 
cÚsŞe_pÜt
);

110 
	`»gi¡”_sock‘_Œª¥Üt
(
fd
, 
£rŸl
.
	`c_¡r
(), 
adb_pÜt
, 1);

114 
	}
}

117 *
	$ş›Á_sock‘_th»ad
(*
x
)

119 #ià
ADB_HOST


120 
pÜt
 = 
DEFAULT_ADB_LOCAL_TRANSPORT_PORT
;

121 
couÁ
 = 
ADB_LOCAL_TRANSPORT_MAX
;

123 
	`D
("transport: client_socket_thread() starting\n");

128  ; 
couÁ
 > 0; couÁ--, 
pÜt
 += 2 ) {

129 (è
	`loÿl_cÚÃù
(
pÜt
);

133 
	}
}

135 *
	$£rv”_sock‘_th»ad
(* 
¬g
)

137 
£rv”fd
, 
fd
;

138 
sockaddr
 
addr
;

139 
sockËn_t
 
®’
;

140 
pÜt
 = (è(
ušŒ_t
è
¬g
;

142 
	`D
("transport: server_socket_thread() starting\n");

143 
£rv”fd
 = -1;

145 if(
£rv”fd
 == -1) {

146 
£rv”fd
 = 
	`sock‘_šaddr_ªy_£rv”
(
pÜt
, 
SOCK_STREAM
);

147 if(
£rv”fd
 < 0) {

148 
	`D
("£rv”: cªnÙ bšd sock‘ y‘: %s\n", 
	`¡»¼Ü
(
”ºo
));

149 
	`adb_¦“p_ms
(1000);

152 
	`şo£_Ú_exec
(
£rv”fd
);

155 
®’
 = (
addr
);

156 
	`D
("£rv”:ryšgØg‘‚ew cÚÃùiÚ from %d\n", 
pÜt
);

157 
fd
 = 
	`adb_sock‘_acû±
(
£rv”fd
, &
addr
, &
®’
);

158 if(
fd
 >= 0) {

159 
	`D
("£rv”:‚ew cÚÃùiÚ oÀfd %d\n", 
fd
);

160 
	`şo£_Ú_exec
(
fd
);

161 
	`di§bË_tı_ÇgË
(
fd
);

162 
	`»gi¡”_sock‘_Œª¥Üt
(
fd
, "ho¡", 
pÜt
, 1);

165 
	`D
("transport: server_socket_thread()ƒxiting\n");

167 
	}
}

170 #ià!
ADB_HOST


175 #undeà
İ’


176 #undeà
wr™e


177 
	#İ’
 
adb_İ’


	)

178 
	#wr™e
 
adb_wr™e


	)

179 
	~<h¬dw¬e/qemu_pe.h
>

180 #undeà
İ’


181 #undeà
wr™e


182 
	#İ’
 
___xxx_İ’


	)

183 
	#wr™e
 
___xxx_wr™e


	)

213 *
	$qemu_sock‘_th»ad
(* 
¬g
)

216 cÚ¡ 
_acû±_»q
[] = "accept";

218 cÚ¡ 
_¡¬t_»q
[] = "start";

220 cÚ¡ 
_ok_»¥
[] = "ok";

222 cÚ¡ 
pÜt
 = (è(
ušŒ_t
è
¬g
;

223 
»s
, 
fd
;

224 
tmp
[256];

225 
cÚ_Çme
[32];

227 
	`D
("transport: qemu_socket_thread() starting\n");

230 
	`¢´štf
(
cÚ_Çme
, (cÚ_Çme), "qemud:adb:%d", 
pÜt
);

233 
fd
 = 
	`qemu_pe_İ’
(
cÚ_Çme
);

234 ià(
fd
 < 0) {

237 
adb_th»ad_t
 
thr
;

238 
	`D
("adb service is‚ot‡vailable. Falling backo TCP socket.\n");

239 
	`adb_th»ad_ü—‹
(&
thr
, 
£rv”_sock‘_th»ad
, 
¬g
);

249 
»s
 = 
	`adb_wr™e
(
fd
, 
_acû±_»q
, 
	`¡¾’
(_accept_req));

250 ià((
size_t
)
»s
 =ğ
	`¡¾’
(
_acû±_»q
)) {

253 
»s
 = 
	`adb_»ad
(
fd
, 
tmp
, (tmp));

254 ià(
»s
 !ğ2 || 
	`memcmp
(
tmp
, 
_ok_»¥
, 2)) {

255 
	`D
("Accepting ADB host connection has failed.\n");

256 
	`adb_şo£
(
fd
);

260 
	`»gi¡”_sock‘_Œª¥Üt
(
fd
, "ho¡", 
pÜt
, 1);

261 
	`adb_wr™e
(
fd
, 
_¡¬t_»q
, 
	`¡¾’
(_start_req));

265 
fd
 = 
	`qemu_pe_İ’
(
cÚ_Çme
);

266 ià(
fd
 < 0) {

267 
	`D
("adb service become unavailable.\n");

271 
	`D
("UÇbËØ£ndh'%s'„eque¡ØADB s”viû.\n", 
_acû±_»q
);

275 
	`D
("transport: qemu_socket_thread()ƒxiting\n");

277 
	}
}

280 
	$loÿl_š™
(
pÜt
)

282 
adb_th»ad_t
 
thr
;

283 * (*
func
)(*);

285 if(
HOST
) {

286 
func
 = 
ş›Á_sock‘_th»ad
;

288 #ià
ADB_HOST


289 
func
 = 
£rv”_sock‘_th»ad
;

293 
is_qemu
[
PROPERTY_VALUE_MAX
];

294 
	`´İ”ty_g‘
("ro.k”Ãl.qemu", 
is_qemu
, "");

295 ià(!
	`¡rcmp
(
is_qemu
, "1")) {

297 
func
 = 
qemu_sock‘_th»ad
;

300 
func
 = 
£rv”_sock‘_th»ad
;

305 
	`D
("Œª¥Üt:†oÿÈ% š™\n", 
HOST
 ? "client" : "server");

307 if(
	`adb_th»ad_ü—‹
(&
thr
, 
func
, (*è(
ušŒ_t
è
pÜt
)) {

308 
	`çl_”ºo
("cannot create†ocal socket %shread",

309 
HOST
 ? "client" : "server");

311 
	}
}

313 
	$»mÙe_kick
(
©¿n¥Üt
 *
t
)

315 
fd
 = 
t
->
sfd
;

316 
t
->
sfd
 = -1;

317 
	`adb_shutdown
(
fd
);

318 
	`adb_şo£
(
fd
);

320 #ià
ADB_HOST


321 if(
HOST
) {

322 
Â
;

323 
	`adb_mu‹x_lock
Ğ&
loÿl_Œª¥Üts_lock
 );

324 
Â
 = 0;‚À< 
ADB_LOCAL_TRANSPORT_MAX
;‚n++) {

325 ià(
loÿl_Œª¥Üts
[
Â
] =ğ
t
) {

326 
loÿl_Œª¥Üts
[
Â
] = 
NULL
;

330 
	`adb_mu‹x_uÆock
Ğ&
loÿl_Œª¥Üts_lock
 );

333 
	}
}

335 
	$»mÙe_şo£
(
©¿n¥Üt
 *
t
)

337 
	`adb_şo£
(
t
->
fd
);

338 
	}
}

341 #ià
ADB_HOST


343 
©¿n¥Üt
* 
	$fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt_locked
(
adb_pÜt
)

345 
i
;

346 
i
 = 0; i < 
ADB_LOCAL_TRANSPORT_MAX
; i++) {

347 ià(
loÿl_Œª¥Üts
[
i
] &&†oÿl_Œª¥Üts[i]->
adb_pÜt
 ==‡db_port) {

348  
loÿl_Œª¥Üts
[
i
];

351  
NULL
;

352 
	}
}

354 
©¿n¥Üt
* 
	$fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt
(
adb_pÜt
)

356 
	`adb_mu‹x_lock
Ğ&
loÿl_Œª¥Üts_lock
 );

357 
©¿n¥Üt
* 
»suÉ
 = 
	`fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt_locked
(
adb_pÜt
);

358 
	`adb_mu‹x_uÆock
Ğ&
loÿl_Œª¥Üts_lock
 );

359  
»suÉ
;

360 
	}
}

363 
	$g‘_avaabË_loÿl_Œª¥Üt_šdex_locked
()

365 
i
;

366 
i
 = 0; i < 
ADB_LOCAL_TRANSPORT_MAX
; i++) {

367 ià(
loÿl_Œª¥Üts
[
i
] =ğ
NULL
) {

368  
i
;

372 
	}
}

374 
	$g‘_avaabË_loÿl_Œª¥Üt_šdex
()

376 
	`adb_mu‹x_lock
Ğ&
loÿl_Œª¥Üts_lock
 );

377 
»suÉ
 = 
	`g‘_avaabË_loÿl_Œª¥Üt_šdex_locked
();

378 
	`adb_mu‹x_uÆock
Ğ&
loÿl_Œª¥Üts_lock
 );

379  
»suÉ
;

380 
	}
}

383 
	$š™_sock‘_Œª¥Üt
(
©¿n¥Üt
 *
t
, 
s
, 
adb_pÜt
, 
loÿl
)

385 
ç
 = 0;

387 
t
->
kick
 = 
»mÙe_kick
;

388 
t
->
şo£
 = 
»mÙe_şo£
;

389 
t
->
»ad_äom_»mÙe
 = 
»mÙe_»ad
;

390 
t
->
wr™e_to_»mÙe
 = 
»mÙe_wr™e
;

391 
t
->
sfd
 = 
s
;

392 
t
->
sync_tok’
 = 1;

393 
t
->
cÚÃùiÚ_¡©e
 = 
CS_OFFLINE
;

394 
t
->
ty³
 = 
kT¿n¥ÜtLoÿl
;

395 
t
->
adb_pÜt
 = 0;

397 #ià
ADB_HOST


398 ià(
HOST
 && 
loÿl
) {

399 
	`adb_mu‹x_lock
Ğ&
loÿl_Œª¥Üts_lock
 );

401 
t
->
adb_pÜt
 =‡db_port;

402 
©¿n¥Üt
* 
exi¡šg_Œª¥Üt
 =

403 
	`fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt_locked
(
adb_pÜt
);

404 
šdex
 = 
	`g‘_avaabË_loÿl_Œª¥Üt_šdex_locked
();

405 ià(
exi¡šg_Œª¥Üt
 !ğ
NULL
) {

406 
	`D
("localransport for…ort %d‡lready„egistered (%p)?\n",

407 
adb_pÜt
, 
exi¡šg_Œª¥Üt
);

408 
ç
 = -1;

409 } ià(
šdex
 < 0) {

411 
	`D
("cannot„egister moreƒmulators. Maximum is %d\n",

412 
ADB_LOCAL_TRANSPORT_MAX
);

413 
ç
 = -1;

415 
loÿl_Œª¥Üts
[
šdex
] = 
t
;

418 
	`adb_mu‹x_uÆock
Ğ&
loÿl_Œª¥Üts_lock
 );

421  
ç
;

422 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/transport_test.cpp

17 
	~"Œª¥Üt.h
"

19 
	~<g‹¡/g‹¡.h
>

21 
	~"adb.h
"

23 
	$TEST
(
Œª¥Üt
, 
kick_Œª¥Üt
) {

24 
©¿n¥Üt
 
t
 = {};

26 
t
.
kick
 = [](
©¿n¥Üt
* 
Œªs
è{¿ns->
fd
 = 42; };

27 
©¿n¥Üt
 
ex³ùed
 = 
t
;

28 
ex³ùed
.
fd
 = 42;

29 
ex³ùed
.
kicked
 = 1;

30 
	`kick_Œª¥Üt
(&
t
);

31 
	`ASSERT_EQ
(42, 
t
.
fd
);

32 
	`ASSERT_EQ
(1, 
t
.
kicked
);

33 
	`ASSERT_EQ
(0, 
	`memcmp
(&
ex³ùed
, &
t
, (
©¿n¥Üt
)));

34 
	}
}

36 
	$TEST
(
Œª¥Üt
, 
kick_Œª¥Üt_®»ady_kicked
) {

39 
©¿n¥Üt
 
t
 = {};

40 
t
.
kicked
 = 1;

41 
t
.
kick
 = [](
©¿n¥Üt
*è{ 
	`FAIL
() << "Kick should‚ot have been called"; };

42 
©¿n¥Üt
 
ex³ùed
 = 
t
;

43 
	`kick_Œª¥Üt
(&
t
);

44 
	`ASSERT_EQ
(0, 
	`memcmp
(&
ex³ùed
, &
t
, (
©¿n¥Üt
)));

45 
	}
}

50 
	$TEST
(
Œª¥Üt
, 
DISABLED_run_Œª¥Üt_discÚÃùs_z”Ûd_©¿n¥Üt
) {

51 
©¿n¥Üt
 
t
 = {};

52 
	`run_Œª¥Üt_discÚÃùs
(&
t
);

53 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/transport_usb.cpp

17 
	#TRACE_TAG
 
TRACE_TRANSPORT


	)

19 
	~"sysd•s.h
"

20 
	~"Œª¥Üt.h
"

22 
	~<¡dio.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

26 
	~"adb.h
"

28 
	$»mÙe_»ad
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

30 if(
	`usb_»ad
(
t
->
usb
, &
p
->
msg
, (
ames§ge
))){

31 
	`D
("remote usb:„eaderminated (message)\n");

35 if(
	`check_h—d”
(
p
, 
t
)) {

36 
	`D
("remote usb: check_header failed\n");

40 if(
p
->
msg
.
d©a_Ëngth
) {

41 if(
	`usb_»ad
(
t
->
usb
, 
p
->
d©a
,…->
msg
.
d©a_Ëngth
)){

42 
	`D
("remote usb:erminated (data)\n");

47 if(
	`check_d©a
(
p
)) {

48 
	`D
("remote usb: check_data failed\n");

53 
	}
}

55 
	$»mÙe_wr™e
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

57 
size
 = 
p
->
msg
.
d©a_Ëngth
;

59 if(
	`usb_wr™e
(
t
->
usb
, &
p
->
msg
, (
ames§ge
))) {

60 
	`D
("remote usb: 1 - writeerminated\n");

63 if(
p
->
msg
.
d©a_Ëngth
 == 0)  0;

64 if(
	`usb_wr™e
(
t
->
usb
, &
p
->
d©a
, 
size
)) {

65 
	`D
("remote usb: 2 - writeerminated\n");

70 
	}
}

72 
	$»mÙe_şo£
(
©¿n¥Üt
 *
t
)

74 
	`usb_şo£
(
t
->
usb
);

75 
t
->
usb
 = 0;

76 
	}
}

78 
	$»mÙe_kick
(
©¿n¥Üt
 *
t
)

80 
	`usb_kick
(
t
->
usb
);

81 
	}
}

83 
	$š™_usb_Œª¥Üt
(
©¿n¥Üt
 *
t
, 
usb_hªdË
 *
h
, 
¡©e
)

85 
	`D
("transport: usb\n");

86 
t
->
şo£
 = 
»mÙe_şo£
;

87 
t
->
kick
 = 
»mÙe_kick
;

88 
t
->
»ad_äom_»mÙe
 = 
»mÙe_»ad
;

89 
t
->
wr™e_to_»mÙe
 = 
»mÙe_wr™e
;

90 
t
->
sync_tok’
 = 1;

91 
t
->
cÚÃùiÚ_¡©e
 = 
¡©e
;

92 
t
->
ty³
 = 
kT¿n¥ÜtUsb
;

93 
t
->
usb
 = 
h
;

95 #ià
ADB_HOST


96 
HOST
 = 1;

98 
HOST
 = 0;

100 
	}
}

102 #ià
ADB_HOST


103 
	$is_adb_š‹rçû
(
vid
, 
pid
, 
usb_şass
, 
usb_subşass
, 
usb_´ÙocŞ
)

105 #ià
USE_KEDACOM_ADB_TOOLS


106  (
usb_şass
 =ğ
KDB_CLASS
 && 
usb_subşass
 =ğ
KDB_SUBCLASS
 && 
usb_´ÙocŞ
 =ğ
KDB_PROTOCOL
);

108  (
usb_şass
 =ğ
ADB_CLASS
 && 
usb_subşass
 =ğ
ADB_SUBCLASS
 && 
usb_´ÙocŞ
 =ğ
ADB_PROTOCOL
);

110 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/usb_linux.cpp

17 
	#TRACE_TAG
 
TRACE_USB


	)

19 
	~"sysd•s.h
"

21 
	~<ùy³.h
>

22 
	~<dœ’t.h
>

23 
	~<”ºo.h
>

24 
	~<fú.h
>

25 
	~<lšux/usbdeviû_fs.h
>

26 
	~<lšux/v”siÚ.h
>

27 
	~<¡dio.h
>

28 
	~<¡dlib.h
>

29 
	~<¡ršg.h
>

30 
	~<sys/ioùl.h
>

31 
	~<sys/time.h
>

32 
	~<sys/ty³s.h
>

33 
	~<uni¡d.h
>

34 
	~<lšux/usb/ch9.h
>

36 
	~<ba£/fe.h
>

37 
	~<ba£/¡ršg´štf.h
>

38 
	~<ba£/¡ršgs.h
>

40 
	~"adb.h
"

41 
	~"Œª¥Üt.h
"

44 
	#DBGX
(
x
...)

	)

46 
ADB_MUTEX_DEFINE
Ğ
usb_lock
 );

48 
	susb_hªdË


50 
usb_hªdË
 *
	m´ev
;

51 
usb_hªdË
 *
	mÃxt
;

53 
	mâame
[64];

54 
	mdesc
;

55 
	m•_š
;

56 
	m•_out
;

58 
	mz”o_mask
;

59 
	mwr™—bË
;

61 
usbdevfs_urb
 
	murb_š
;

62 
usbdevfs_urb
 
	murb_out
;

64 
	murb_š_busy
;

65 
	murb_out_busy
;

66 
	md—d
;

68 
adb_cÚd_t
 
	mnÙify
;

69 
adb_mu‹x_t
 
	mlock
;

72 
	mm¬k
;

75 
±h»ad_t
 
	m»­”_th»ad
;

78 
usb_hªdË
 
	ghªdË_li¡
 = {

79 .
´ev
 = &
hªdË_li¡
,

80 .
	gÃxt
 = &
hªdË_li¡
,

83 
	$known_deviû
(cÚ¡ *
dev_Çme
)

85 
usb_hªdË
 *
usb
;

87 
	`adb_mu‹x_lock
(&
usb_lock
);

88 
usb
 = 
hªdË_li¡
.
Ãxt
; usb != &handle_list; usb = usb->next){

89 if(!
	`¡rcmp
(
usb
->
âame
, 
dev_Çme
)) {

91 
usb
->
m¬k
 = 1;

92 
	`adb_mu‹x_uÆock
(&
usb_lock
);

96 
	`adb_mu‹x_uÆock
(&
usb_lock
);

98 
	}
}

100 
	$kick_discÚÃùed_deviûs
()

102 
usb_hªdË
 *
usb
;

104 
	`adb_mu‹x_lock
(&
usb_lock
);

106 
usb
 = 
hªdË_li¡
.
Ãxt
; usb != &handle_list; usb = usb->next){

107 ià(
usb
->
m¬k
 == 0) {

108 
	`usb_kick
(
usb
);

110 
usb
->
m¬k
 = 0;

113 
	`adb_mu‹x_uÆock
(&
usb_lock
);

115 
	}
}

117 
šlše
 
	$badÇme
(cÚ¡ *
Çme
)

119 *
Çme
) {

120 if(!
	`isdig™
(*
Çme
++))  1;

123 
	}
}

125 
fšd_usb_deviû
(cÚ¡ *
ba£
,

126 (*
»gi¡”_deviû_ÿÎback
)

129 
bu¢ame
[32], 
devÇme
[32];

130 
loÿl_•_š
, 
loÿl_•_out
;

131 
DIR
 *
busdœ
 , *
devdœ
 ;

132 
dœ’t
 *
de
;

133 
fd
 ;

135 
busdœ
 = 
	`İ’dœ
(
ba£
);

136 if(
busdœ
 == 0) ;

138 (
de
 = 
	`»addœ
(
busdœ
)) != 0) {

139 if(
	`badÇme
(
de
->
d_Çme
)) ;

141 
	`¢´štf
(
bu¢ame
,  bu¢ame, "%s/%s", 
ba£
, 
de
->
d_Çme
);

142 
devdœ
 = 
	`İ’dœ
(
bu¢ame
);

143 if(
devdœ
 == 0) ;

146 (
de
 = 
	`»addœ
(
devdœ
))) {

147 
devdesc
[4096];

148 * 
buåŒ
 = 
devdesc
;

149 * 
buãnd
;

150 
usb_deviû_desütÜ
* 
deviû
;

151 
usb_cÚfig_desütÜ
* 
cÚfig
;

152 
usb_š‹rçû_desütÜ
* 
š‹rçû
;

153 
usb_’dpošt_desütÜ
 *
•1
, *
•2
;

154 
z”o_mask
 = 0;

155 
vid
, 
pid
;

156 
size_t
 
desş’gth
;

158 if(
	`badÇme
(
de
->
d_Çme
)) ;

159 
	`¢´štf
(
devÇme
,  devÇme, "%s/%s", 
bu¢ame
, 
de
->
d_Çme
);

161 if(
	`known_deviû
(
devÇme
)) {

162 
	`DBGX
("skpšg %s\n", 
devÇme
);

167 if((
fd
 = 
	`unix_İ’
(
devÇme
, 
O_RDONLY
 | 
O_CLOEXEC
)) < 0) {

171 
desş’gth
 = 
	`adb_»ad
(
fd
, 
devdesc
, (devdesc));

172 
buãnd
 = 
buåŒ
 + 
desş’gth
;

175 ià(
desş’gth
 < 
USB_DT_DEVICE_SIZE
 + 
USB_DT_CONFIG_SIZE
) {

176 
	`D
("desş’gth %zu i toØsm®l\n", 
desş’gth
);

177 
	`adb_şo£
(
fd
);

181 
deviû
 = (
usb_deviû_desütÜ
*)
buåŒ
;

182 
buåŒ
 +ğ
USB_DT_DEVICE_SIZE
;

184 if((
deviû
->
bL’gth
 !ğ
USB_DT_DEVICE_SIZE
è|| (deviû->
bDesütÜTy³
 !ğ
USB_DT_DEVICE
)) {

185 
	`adb_şo£
(
fd
);

189 
vid
 = 
deviû
->
idV’dÜ
;

190 
pid
 = 
deviû
->
idProduù
;

191 
	`DBGX
("[ % i V:%04x P:%04x ]\n", 
devÇme
, 
vid
, 
pid
);

194 
cÚfig
 = (
usb_cÚfig_desütÜ
 *)
buåŒ
;

195 
buåŒ
 +ğ
USB_DT_CONFIG_SIZE
;

196 ià(
cÚfig
->
bL’gth
 !ğ
USB_DT_CONFIG_SIZE
 || cÚfig->
bDesütÜTy³
 !ğ
USB_DT_CONFIG
) {

197 
	`D
("usb_config_descriptor‚ot found\n");

198 
	`adb_şo£
(
fd
);

203 
buåŒ
 < 
buãnd
) {

204 
Ëngth
 = 
buåŒ
[0];

205 
ty³
 = 
buåŒ
[1];

207 ià(
ty³
 =ğ
USB_DT_INTERFACE
) {

208 
š‹rçû
 = (
usb_š‹rçû_desütÜ
 *)
buåŒ
;

209 
buåŒ
 +ğ
Ëngth
;

211 ià(
Ëngth
 !ğ
USB_DT_INTERFACE_SIZE
) {

212 
	`D
("interface descriptor has wrong size\n");

216 
	`DBGX
("bInterfaceClass: %d, bInterfaceSubClass: %d,"

218 
š‹rçû
->
bIÁ”çûCÏss
, iÁ”çû->
bIÁ”çûSubCÏss
,

219 
š‹rçû
->
bIÁ”çûPrÙocŞ
, iÁ”çû->
bNumEndpošts
);

221 ià(
š‹rçû
->
bNumEndpošts
 == 2 &&

222 
	`is_adb_š‹rçû
(
vid
, 
pid
, 
š‹rçû
->
bIÁ”çûCÏss
,

223 
š‹rçû
->
bIÁ”çûSubCÏss
, iÁ”çû->
bIÁ”çûPrÙocŞ
)) {

225 
¡©
 
¡
;

226 
·thbuf
[128];

227 
lšk
[256];

228 *
dev·th
 = 
NULL
;

230 
	`DBGX
("looking for bulkƒndpoints\n");

232 
•1
 = (
usb_’dpošt_desütÜ
 *)
buåŒ
;

233 
buåŒ
 +ğ
USB_DT_ENDPOINT_SIZE
;

236 ià(
buåŒ
+2 <ğ
devdesc
 + 
desş’gth
 &&

237 
buåŒ
[0] =ğ
USB_DT_SS_EP_COMP_SIZE
 &&

238 
buåŒ
[1] =ğ
USB_DT_SS_ENDPOINT_COMP
) {

239 
buåŒ
 +ğ
USB_DT_SS_EP_COMP_SIZE
;

241 
•2
 = (
usb_’dpošt_desütÜ
 *)
buåŒ
;

242 
buåŒ
 +ğ
USB_DT_ENDPOINT_SIZE
;

243 ià(
buåŒ
+2 <ğ
devdesc
 + 
desş’gth
 &&

244 
buåŒ
[0] =ğ
USB_DT_SS_EP_COMP_SIZE
 &&

245 
buåŒ
[1] =ğ
USB_DT_SS_ENDPOINT_COMP
) {

246 
buåŒ
 +ğ
USB_DT_SS_EP_COMP_SIZE
;

249 ià(
buåŒ
 > 
devdesc
 + 
desş’gth
 ||

250 
•1
->
bL’gth
 !ğ
USB_DT_ENDPOINT_SIZE
 ||

251 
•1
->
bDesütÜTy³
 !ğ
USB_DT_ENDPOINT
 ||

252 
•2
->
bL’gth
 !ğ
USB_DT_ENDPOINT_SIZE
 ||

253 
•2
->
bDesütÜTy³
 !ğ
USB_DT_ENDPOINT
) {

254 
	`D
("endpoints‚ot found\n");

259 ià(
•1
->
bmA‰ribu‹s
 !ğ
USB_ENDPOINT_XFER_BULK
 ||

260 
•2
->
bmA‰ribu‹s
 !ğ
USB_ENDPOINT_XFER_BULK
) {

261 
	`D
("bulkƒndpoints‚ot found\n");

265 if(
š‹rçû
->
bIÁ”çûPrÙocŞ
 == 0x01) {

266 
z”o_mask
 = 
•1
->
wMaxPack‘Size
 - 1;

270 ià(
•1
->
bEndpoštAdd»ss
 & 
USB_ENDPOINT_DIR_MASK
) {

271 
loÿl_•_š
 = 
•1
->
bEndpoštAdd»ss
;

272 
loÿl_•_out
 = 
•2
->
bEndpoštAdd»ss
;

274 
loÿl_•_š
 = 
•2
->
bEndpoštAdd»ss
;

275 
loÿl_•_out
 = 
•1
->
bEndpoštAdd»ss
;

279 ià(!
	`f¡©
(
fd
, &
¡
è&& 
	`S_ISCHR
(¡.
¡_mode
)) {

280 *
¦ash
;

281 
ssize_t
 
lšk_Ën
;

282 
	`¢´štf
(
·thbuf
, (pathbuf), "/sys/dev/char/%d:%d",

283 
	`majÜ
(
¡
.
¡_rdev
), 
	`mšÜ
(st.st_rdev));

284 
lšk_Ën
 = 
	`»adlšk
(
·thbuf
, 
lšk
, (link) - 1);

285 ià(
lšk_Ën
 > 0) {

286 
lšk
[
lšk_Ën
] = '\0';

287 
¦ash
 = 
	`¡¼chr
(
lšk
, '/');

288 ià(
¦ash
) {

289 
	`¢´štf
(
·thbuf
, (pathbuf),

290 "usb:%s", 
¦ash
 + 1);

291 
dev·th
 = 
·thbuf
;

296 
	`»gi¡”_deviû_ÿÎback
(
devÇme
, 
dev·th
,

297 
loÿl_•_š
, 
loÿl_•_out
,

298 
š‹rçû
->
bIÁ”çûNumb”
, 
deviû
->
iS”ŸlNumb”
, 
z”o_mask
);

302 
buåŒ
 +ğ
Ëngth
;

306 
	`adb_şo£
(
fd
);

308 
	`şo£dœ
(
devdœ
);

310 
	`şo£dœ
(
busdœ
);

311 
	}
}

313 
	$usb_ş—nup
()

315 
	}
}

317 
	$usb_bulk_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
d©a
, 
Ën
)

319 
usbdevfs_urb
 *
urb
 = &
h
->
urb_out
;

320 
»s
;

321 
timev®
 
tv
;

322 
time¥ec
 
ts
;

324 
	`mem£t
(
urb
, 0, (*urb));

325 
urb
->
ty³
 = 
USBDEVFS_URB_TYPE_BULK
;

326 
urb
->
’dpošt
 = 
h
->
•_out
;

327 
urb
->
¡©us
 = -1;

328 
urb
->
bufãr
 = (*è
d©a
;

329 
urb
->
bufãr_Ëngth
 = 
Ën
;

331 
	`D
("++ write ++\n");

333 
	`adb_mu‹x_lock
(&
h
->
lock
);

334 if(
h
->
d—d
) {

335 
»s
 = -1;

336 
ç
;

339 
»s
 = 
	`ioùl
(
h
->
desc
, 
USBDEVFS_SUBMITURB
, 
urb
);

340 } (
»s
 < 0è&& (
”ºo
 =ğ
EINTR
));

342 if(
»s
 < 0) {

343 
ç
;

346 
»s
 = -1;

347 
h
->
urb_out_busy
 = 1;

350 
	`g‘timeofday
(&
tv
, 
NULL
);

351 
ts
.
tv_£c
 = 
tv
.tv_sec + 5;

352 
ts
.
tv_n£c
 = 
tv
.
tv_u£c
 * 1000L;

353 
»s
 = 
	`±h»ad_cÚd_timedwa™
(&
h
->
nÙify
, &h->
lock
, &
ts
);

354 if(
»s
 < 0 || 
h
->
d—d
) {

357 if(
h
->
urb_out_busy
 == 0) {

358 if(
urb
->
¡©us
 == 0) {

359 
»s
 = 
urb
->
aùu®_Ëngth
;

364 
ç
:

365 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

366 
	`D
("-- write --\n");

367  
»s
;

368 
	}
}

370 
	$usb_bulk_»ad
(
usb_hªdË
 *
h
, *
d©a
, 
Ën
)

372 
usbdevfs_urb
 *
urb
 = &
h
->
urb_š
;

373 
usbdevfs_urb
 *
out
 = 
NULL
;

374 
»s
;

376 
	`D
("++ usb_bulk_read ++\n");

377 
	`mem£t
(
urb
, 0, (*urb));

378 
urb
->
ty³
 = 
USBDEVFS_URB_TYPE_BULK
;

379 
urb
->
’dpošt
 = 
h
->
•_š
;

380 
urb
->
¡©us
 = -1;

381 
urb
->
bufãr
 = 
d©a
;

382 
urb
->
bufãr_Ëngth
 = 
Ën
;

385 
	`adb_mu‹x_lock
(&
h
->
lock
);

386 if(
h
->
d—d
) {

387 
»s
 = -1;

388 
ç
;

391 
»s
 = 
	`ioùl
(
h
->
desc
, 
USBDEVFS_SUBMITURB
, 
urb
);

392 } (
»s
 < 0è&& (
”ºo
 =ğ
EINTR
));

394 if(
»s
 < 0) {

395 
ç
;

398 
h
->
urb_š_busy
 = 1;

400 
	`D
("[„eap urb - wait ]\n");

401 
h
->
»­”_th»ad
 = 
	`±h»ad_£lf
();

402 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

403 
»s
 = 
	`ioùl
(
h
->
desc
, 
USBDEVFS_REAPURB
, &
out
);

404 
§ved_”ºo
 = 
”ºo
;

405 
	`adb_mu‹x_lock
(&
h
->
lock
);

406 
h
->
»­”_th»ad
 = 0;

407 if(
h
->
d—d
) {

408 
»s
 = -1;

411 if(
»s
 < 0) {

412 if(
§ved_”ºo
 =ğ
EINTR
) {

415 
	`D
("[„eap urb -ƒrror ]\n");

418 
	`D
("[ urb @%p status = %d,‡ctual = %d ]\n",

419 
out
, out->
¡©us
, out->
aùu®_Ëngth
);

421 if(
out
 =ğ&
h
->
urb_š
) {

422 
	`D
("[„eap urb - IN complete ]\n");

423 
h
->
urb_š_busy
 = 0;

424 if(
urb
->
¡©us
 == 0) {

425 
»s
 = 
urb
->
aùu®_Ëngth
;

427 
»s
 = -1;

431 if(
out
 =ğ&
h
->
urb_out
) {

432 
	`D
("[„eap urb - OUT compelete ]\n");

433 
h
->
urb_out_busy
 = 0;

434 
	`adb_cÚd_brßdÿ¡
(&
h
->
nÙify
);

437 
ç
:

438 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

439 
	`D
("-- usb_bulk_read --\n");

440  
»s
;

441 
	}
}

444 
	$usb_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
_d©a
, 
Ën
)

446 
	`D
("++ usb_write ++\n");

447 *
d©a
 = (*è
_d©a
;

448 
n
 = 
	`usb_bulk_wr™e
(
h
, 
d©a
, 
Ën
);

449 if(
n
 !ğ
Ën
) {

450 
	`D
("ERROR:‚ = %d,ƒrrno = %d (%s)\n",

451 
n
, 
”ºo
, 
	`¡»¼Ü
(errno));

455 if(
h
->
z”o_mask
 && !(
Ën
 & h->zero_mask)) {

460 
n
 = 
	`usb_bulk_wr™e
(
h
, 
_d©a
, 0);

461  
n
;

464 
	`D
("-- usb_write --\n");

466 
	}
}

468 
	$usb_»ad
(
usb_hªdË
 *
h
, *
_d©a
, 
Ën
)

470 *
d©a
 = (*è
_d©a
;

471 
n
;

473 
	`D
("++ usb_read ++\n");

474 
Ën
 > 0) {

475 
xãr
 = 
Ën
;

477 
	`D
("[ usb„—d %d fd = %d], fÇme=%s\n", 
xãr
, 
h
->
desc
, h->
âame
);

478 
n
 = 
	`usb_bulk_»ad
(
h
, 
d©a
, 
xãr
);

479 
	`D
("[ usb„—d %d ] = %d, fÇme=%s\n", 
xãr
, 
n
, 
h
->
âame
);

480 if(
n
 !ğ
xãr
) {

481 if((
”ºo
 =ğ
ETIMEDOUT
è&& (
h
->
desc
 != -1)) {

482 
	`D
("[imeout ]\n");

483 if(
n
 > 0){

484 
d©a
 +ğ
n
;

485 
Ën
 -ğ
n
;

489 
	`D
("ERROR:‚ = %d,ƒrrno = %d (%s)\n",

490 
n
, 
”ºo
, 
	`¡»¼Ü
(errno));

494 
Ën
 -ğ
xãr
;

495 
d©a
 +ğ
xãr
;

498 
	`D
("-- usb_read --\n");

500 
	}
}

502 
	$usb_kick
(
usb_hªdË
 *
h
)

504 
	`D
("[ kickšg %°(fd = %dè]\n", 
h
, h->
desc
);

505 
	`adb_mu‹x_lock
(&
h
->
lock
);

506 if(
h
->
d—d
 == 0) {

507 
h
->
d—d
 = 1;

509 ià(
h
->
wr™—bË
) {

514 ià(
h
->
»­”_th»ad
) {

515 
	`±h»ad_kl
(
h
->
»­”_th»ad
, 
SIGALRM
);

523 
	`ioùl
(
h
->
desc
, 
USBDEVFS_DISCARDURB
, &h->
urb_š
);

524 
	`ioùl
(
h
->
desc
, 
USBDEVFS_DISCARDURB
, &h->
urb_out
);

525 
h
->
urb_š
.
¡©us
 = -
ENODEV
;

526 
h
->
urb_out
.
¡©us
 = -
ENODEV
;

527 
h
->
urb_š_busy
 = 0;

528 
h
->
urb_out_busy
 = 0;

529 
	`adb_cÚd_brßdÿ¡
(&
h
->
nÙify
);

531 
	`uÄegi¡”_usb_Œª¥Üt
(
h
);

534 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

535 
	}
}

537 
	$usb_şo£
(
usb_hªdË
 *
h
)

539 
	`D
("++ usb close ++\n");

540 
	`adb_mu‹x_lock
(&
usb_lock
);

541 
h
->
Ãxt
->
´ev
 = h->prev;

542 
h
->
´ev
->
Ãxt
 = h->next;

543 
h
->
´ev
 = 0;

544 
h
->
Ãxt
 = 0;

546 
	`adb_şo£
(
h
->
desc
);

547 
	`D
("-- usb clo£d %°(fd = %dè--\n", 
h
, h->
desc
);

548 
	`adb_mu‹x_uÆock
(&
usb_lock
);

550 
	`ä“
(
h
);

552 
	}
}

554 
	$»gi¡”_deviû
(cÚ¡ * 
dev_Çme
, cÚ¡ * 
dev_·th
,

555 
•_š
, 
•_out
,

556 
š‹rçû
, 
£rŸl_šdex
,

557 
z”o_mask
) {

565 
	`adb_mu‹x_lock
(&
usb_lock
);

566 
usb_hªdË
* 
usb
 = 
hªdË_li¡
.
Ãxt
; usb != &handle_list; usb = usb->next) {

567 ià(!
	`¡rcmp
(
usb
->
âame
, 
dev_Çme
)) {

568 
	`adb_mu‹x_uÆock
(&
usb_lock
);

572 
	`adb_mu‹x_uÆock
(&
usb_lock
);

574 
	`D
("[ usb†oÿ‹d‚ew deviû % (%d/%d/%dè]\n", 
dev_Çme
, 
•_š
, 
•_out
, 
š‹rçû
);

575 
usb_hªdË
* 
usb
 = 
»š‹½»t_ÿ¡
<usb_hªdË*>(
	`ÿÎoc
(1, (usb_handle)));

576 ià(
usb
 =ğ
nuÎ±r
è
	`çl
("couldn't‡llocate usb_handle");

577 
	`¡rıy
(
usb
->
âame
, 
dev_Çme
);

578 
usb
->
•_š
 =ƒp_in;

579 
usb
->
•_out
 =ƒp_out;

580 
usb
->
z”o_mask
 = zero_mask;

581 
usb
->
wr™—bË
 = 1;

583 
	`adb_cÚd_š™
(&
usb
->
nÙify
, 0);

584 
	`adb_mu‹x_š™
(&
usb
->
lock
, 0);

587 
usb
->
m¬k
 = 1;

588 
usb
->
»­”_th»ad
 = 0;

590 
usb
->
desc
 = 
	`unix_İ’
(usb->
âame
, 
O_RDWR
 | 
O_CLOEXEC
);

591 ià(
usb
->
desc
 == -1) {

593 
usb
->
desc
 = 
	`unix_İ’
(usb->
âame
, 
O_RDONLY
 | 
O_CLOEXEC
);

594 ià(
usb
->
desc
 == -1) {

595 
	`D
("[ usb o³À% çed: %s]\n", 
usb
->
âame
, 
	`¡»¼Ü
(
”ºo
));

596 
	`ä“
(
usb
);

599 
usb
->
wr™—bË
 = 0;

602 
	`D
("[ usb o³Ãd %s%s, fd=%d]\n", 
usb
->
âame
,

603 (
usb
->
wr™—bË
 ? "" : " (»ad-Úly)"), usb->
desc
);

605 ià(
usb
->
wr™—bË
) {

606 ià(
	`ioùl
(
usb
->
desc
, 
USBDEVFS_CLAIMINTERFACE
, &
š‹rçû
) != 0) {

607 
	`D
("[ usb ioctl(%d, USBDEVFS_CLAIMINTERFACE) failed: %s]\n",

608 
usb
->
desc
, 
	`¡»¼Ü
(
”ºo
));

609 
	`adb_şo£
(
usb
->
desc
);

610 
	`ä“
(
usb
);

616 
¡d
::
¡ršg
 
£rŸl_·th
 = 
ªdroid
::
ba£
::
	`SŒšgPrštf
(

617 "/sys/bus/usb/deviûs/%s/£rŸl", 
dev_·th
 + 4);

618 
¡d
::
¡ršg
 
£rŸl
;

619 ià(!
ªdroid
::
ba£
::
	`R—dFeToSŒšg
(
£rŸl_·th
, &
£rŸl
)) {

620 
	`D
("[ usb„—d % çed: % ]\n", 
£rŸl_·th
.
	`c_¡r
(), 
	`¡»¼Ü
(
”ºo
));

624 
£rŸl
 = "";

626 
£rŸl
 = 
ªdroid
::
ba£
::
	`Trim
(serial);

629 
	`adb_mu‹x_lock
(&
usb_lock
);

630 
usb
->
Ãxt
 = &
hªdË_li¡
;

631 
usb
->
´ev
 = 
hªdË_li¡
.prev;

632 
usb
->
´ev
->
Ãxt
 = usb;

633 
usb
->
Ãxt
->
´ev
 = usb;

634 
	`adb_mu‹x_uÆock
(&
usb_lock
);

636 
	`»gi¡”_usb_Œª¥Üt
(
usb
, 
£rŸl
.
	`c_¡r
(), 
dev_·th
, usb->
wr™—bË
);

637 
	}
}

639 * 
	$deviû_pŞl_th»ad
(* 
unu£d
) {

640 
	`D
("Created devicehread\n");

641 
Œue
) {

643 
	`fšd_usb_deviû
("/dev/bus/usb", 
»gi¡”_deviû
);

644 
	`kick_discÚÃùed_deviûs
();

645 
	`¦“p
(1);

647  
nuÎ±r
;

648 
	}
}

650 
	$sig®rm_hªdËr
(
signo
) {

652 
	}
}

654 
	$usb_š™
()

656 
adb_th»ad_t
 
tid
;

657 
sigaùiÚ
 
aùiÚs
;

659 
	`mem£t
(&
aùiÚs
, 0, (actions));

660 
	`sigem±y£t
(&
aùiÚs
.
§_mask
);

661 
aùiÚs
.
§_æags
 = 0;

662 
aùiÚs
.
§_hªdËr
 = 
sig®rm_hªdËr
;

663 
	`sigaùiÚ
(
SIGALRM
,& 
aùiÚs
, 
NULL
);

665 if(
	`adb_th»ad_ü—‹
(&
tid
, 
deviû_pŞl_th»ad
, 
NULL
)){

666 
	`çl_”ºo
("cannot create inputhread");

668 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/usb_linux_client.cpp

17 
	#TRACE_TAG
 
TRACE_USB


	)

19 
	~"sysd•s.h
"

21 
	~<cuts/´İ”t›s.h
>

22 
	~<dœ’t.h
>

23 
	~<”ºo.h
>

24 
	~<lšux/usb/ch9.h
>

25 
	~<lšux/usb/funùiÚfs.h
>

26 
	~<¡dio.h
>

27 
	~<¡dlib.h
>

28 
	~<¡ršg.h
>

29 
	~<sys/ioùl.h
>

30 
	~<sys/ty³s.h
>

31 
	~<uni¡d.h
>

33 
	~"adb.h
"

34 
	~"Œª¥Üt.h
"

36 
	#MAX_PACKET_SIZE_FS
 64

	)

37 
	#MAX_PACKET_SIZE_HS
 512

	)

38 
	#MAX_PACKET_SIZE_SS
 1024

	)

40 
	#ıu_to_Ë16
(
x
è
	`htŞe16
(x)

	)

41 
	#ıu_to_Ë32
(
x
è
	`htŞe32
(x)

	)

43 
	susb_hªdË


45 
adb_cÚd_t
 
	mnÙify
;

46 
adb_mu‹x_t
 
	mlock
;

48 (*
	mwr™e
)(
usb_hªdË
 *
	mh
, cÚ¡ *
	md©a
, 
	mËn
);

49 (*
	m»ad
)(
usb_hªdË
 *
	mh
, *
	md©a
, 
	mËn
);

50 (*
	mkick
)(
usb_hªdË
 *
	mh
);

53 
	mfd
;

56 
	mcÚŒŞ
;

57 
	mbulk_out
;

58 
	mbulk_š
;

61 
	sfunc_desc
 {

62 
usb_š‹rçû_desütÜ
 
	mštf
;

63 
usb_’dpošt_desütÜ_no_audio
 
	msourû
;

64 
usb_’dpošt_desütÜ_no_audio
 
	msšk
;

65 } 
__©Œibu‹__
((
·cked
));

67 
	sss_func_desc
 {

68 
usb_š‹rçû_desütÜ
 
	mštf
;

69 
usb_’dpošt_desütÜ_no_audio
 
	msourû
;

70 
usb_ss_•_comp_desütÜ
 
	msourû_comp
;

71 
usb_’dpošt_desütÜ_no_audio
 
	msšk
;

72 
usb_ss_•_comp_desütÜ
 
	msšk_comp
;

73 } 
__©Œibu‹__
((
·cked
));

75 
	sdesc_v1
 {

76 
	susb_funùiÚfs_descs_h—d_v1
 {

77 
__Ë32
 
	mmagic
;

78 
__Ë32
 
	mËngth
;

79 
__Ë32
 
	mfs_couÁ
;

80 
__Ë32
 
	mhs_couÁ
;

81 } 
__©Œibu‹__
((
·cked
)è
	mh—d”
;

82 
func_desc
 
	mfs_descs
, 
	mhs_descs
;

83 } 
__©Œibu‹__
((
·cked
));

85 
	sdesc_v2
 {

86 
usb_funùiÚfs_descs_h—d_v2
 
	mh—d”
;

88 
__Ë32
 
	mfs_couÁ
;

89 
__Ë32
 
	mhs_couÁ
;

90 
__Ë32
 
	mss_couÁ
;

91 
func_desc
 
	mfs_descs
, 
	mhs_descs
;

92 
ss_func_desc
 
	mss_descs
;

93 } 
__©Œibu‹__
((
·cked
));

95 
func_desc
 
	gfs_desütÜs
 = {

96 .
štf
 = {

97 .
bL’gth
 = (
fs_desütÜs
.
štf
),

98 .
	gbDesütÜTy³
 = 
USB_DT_INTERFACE
,

99 .
	gbIÁ”çûNumb”
 = 0,

100 .
	gbNumEndpošts
 = 2,

101 .
	gbIÁ”çûCÏss
 = 
ADB_CLASS
,

102 .
	gbIÁ”çûSubCÏss
 = 
ADB_SUBCLASS
,

103 .
	gbIÁ”çûPrÙocŞ
 = 
ADB_PROTOCOL
,

104 .
	giIÁ”çû
 = 1,

106 .
	gsourû
 = {

107 .
bL’gth
 = (
fs_desütÜs
.
sourû
),

108 .
	gbDesütÜTy³
 = 
USB_DT_ENDPOINT
,

109 .
	gbEndpoštAdd»ss
 = 1 | 
USB_DIR_OUT
,

110 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

111 .
	gwMaxPack‘Size
 = 
MAX_PACKET_SIZE_FS
,

113 .
	gsšk
 = {

114 .
bL’gth
 = (
fs_desütÜs
.
sšk
),

115 .
	gbDesütÜTy³
 = 
USB_DT_ENDPOINT
,

116 .
	gbEndpoštAdd»ss
 = 2 | 
USB_DIR_IN
,

117 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

118 .
	gwMaxPack‘Size
 = 
MAX_PACKET_SIZE_FS
,

122 
func_desc
 
	ghs_desütÜs
 = {

123 .
štf
 = {

124 .
bL’gth
 = (
hs_desütÜs
.
štf
),

125 .
	gbDesütÜTy³
 = 
USB_DT_INTERFACE
,

126 .
	gbIÁ”çûNumb”
 = 0,

127 .
	gbNumEndpošts
 = 2,

128 .
	gbIÁ”çûCÏss
 = 
ADB_CLASS
,

129 .
	gbIÁ”çûSubCÏss
 = 
ADB_SUBCLASS
,

130 .
	gbIÁ”çûPrÙocŞ
 = 
ADB_PROTOCOL
,

131 .
	giIÁ”çû
 = 1,

133 .
	gsourû
 = {

134 .
bL’gth
 = (
hs_desütÜs
.
sourû
),

135 .
	gbDesütÜTy³
 = 
USB_DT_ENDPOINT
,

136 .
	gbEndpoštAdd»ss
 = 1 | 
USB_DIR_OUT
,

137 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

138 .
	gwMaxPack‘Size
 = 
MAX_PACKET_SIZE_HS
,

140 .
	gsšk
 = {

141 .
bL’gth
 = (
hs_desütÜs
.
sšk
),

142 .
	gbDesütÜTy³
 = 
USB_DT_ENDPOINT
,

143 .
	gbEndpoštAdd»ss
 = 2 | 
USB_DIR_IN
,

144 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

145 .
	gwMaxPack‘Size
 = 
MAX_PACKET_SIZE_HS
,

149 
ss_func_desc
 
	gss_desütÜs
 = {

150 .
štf
 = {

151 .
bL’gth
 = (
ss_desütÜs
.
štf
),

152 .
	gbDesütÜTy³
 = 
USB_DT_INTERFACE
,

153 .
	gbIÁ”çûNumb”
 = 0,

154 .
	gbNumEndpošts
 = 2,

155 .
	gbIÁ”çûCÏss
 = 
ADB_CLASS
,

156 .
	gbIÁ”çûSubCÏss
 = 
ADB_SUBCLASS
,

157 .
	gbIÁ”çûPrÙocŞ
 = 
ADB_PROTOCOL
,

158 .
	giIÁ”çû
 = 1,

160 .
	gsourû
 = {

161 .
bL’gth
 = (
ss_desütÜs
.
sourû
),

162 .
	gbDesütÜTy³
 = 
USB_DT_ENDPOINT
,

163 .
	gbEndpoštAdd»ss
 = 1 | 
USB_DIR_OUT
,

164 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

165 .
	gwMaxPack‘Size
 = 
MAX_PACKET_SIZE_SS
,

167 .
	gsourû_comp
 = {

168 .
bL’gth
 = (
ss_desütÜs
.
sourû_comp
),

169 .
	gbDesütÜTy³
 = 
USB_DT_SS_ENDPOINT_COMP
,

171 .
	gsšk
 = {

172 .
bL’gth
 = (
ss_desütÜs
.
sšk
),

173 .
	gbDesütÜTy³
 = 
USB_DT_ENDPOINT
,

174 .
	gbEndpoštAdd»ss
 = 2 | 
USB_DIR_IN
,

175 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

176 .
	gwMaxPack‘Size
 = 
MAX_PACKET_SIZE_SS
,

178 .
	gsšk_comp
 = {

179 .
bL’gth
 = (
ss_desütÜs
.
sšk_comp
),

180 .
	gbDesütÜTy³
 = 
USB_DT_SS_ENDPOINT_COMP
,

184 
	#STR_INTERFACE_
 "ADB IÁ”çû"

	)

187 
usb_funùiÚfs_¡ršgs_h—d
 
	mh—d”
;

189 
__Ë16
 
	mcode
;

190 cÚ¡ 
	m¡r1
[(
STR_INTERFACE_
)];

191 } 
__©Œibu‹__
((
·cked
)è
	mÏng0
;

192 } 
__©Œibu‹__
((
·cked
)è
	g¡ršgs
 = {

193 .
h—d”
 = {

194 .
magic
 = 
ıu_to_Ë32
(
FUNCTIONFS_STRINGS_MAGIC
),

195 .
	gËngth
 = 
ıu_to_Ë32
((
¡ršgs
)),

196 .
	g¡r_couÁ
 = 
ıu_to_Ë32
(1),

197 .
	gÏng_couÁ
 = 
ıu_to_Ë32
(1),

199 .
	gÏng0
 = {

200 
ıu_to_Ë16
(0x0409),

201 
STR_INTERFACE_
,

207 *
	$usb_adb_İ’_th»ad
(*
x
)

209 
usb_hªdË
 *
usb
 = (usb_hªdË *)
x
;

210 
fd
;

212 
Œue
) {

214 
	`adb_mu‹x_lock
(&
usb
->
lock
);

215 
usb
->
fd
 != -1)

216 
	`adb_cÚd_wa™
(&
usb
->
nÙify
, &usb->
lock
);

217 
	`adb_mu‹x_uÆock
(&
usb
->
lock
);

219 
	`D
("[ usb_thread - opening device ]\n");

222 
fd
 = 
	`unix_İ’
("/dev/ªdroid_adb", 
O_RDWR
);

223 ià(
fd
 < 0) {

225 
fd
 = 
	`unix_İ’
("/dev/ªdroid", 
O_RDWR
);

227 ià(
fd
 < 0) {

228 
	`adb_¦“p_ms
(1000);

230 } 
fd
 < 0);

231 
	`D
("[ opening device succeeded ]\n");

233 
	`şo£_Ú_exec
(
fd
);

234 
usb
->
fd
 = fd;

236 
	`D
("[ usb_thread -„egistering device ]\n");

237 
	`»gi¡”_usb_Œª¥Üt
(
usb
, 0, 0, 1);

242 
	}
}

244 
	$usb_adb_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
d©a
, 
Ën
)

246 
n
;

248 
	`D
("abouˆtØwr™(fd=%d,†’=%d)\n", 
h
->
fd
, 
Ën
);

249 
n
 = 
	`adb_wr™e
(
h
->
fd
, 
d©a
, 
Ën
);

250 if(
n
 !ğ
Ën
) {

251 
	`D
("ERROR: fd = %d,‚ = %d,ƒrrno = %d (%s)\n",

252 
h
->
fd
, 
n
, 
”ºo
, 
	`¡»¼Ü
(errno));

255 
	`D
("[ dÚfd=%d ]\n", 
h
->
fd
);

257 
	}
}

259 
	$usb_adb_»ad
(
usb_hªdË
 *
h
, *
d©a
, 
Ën
)

261 
	`D
("abouˆtØ»ad (fd=%d,†’=%d)\n", 
h
->
fd
, 
Ën
);

268 
Ën
 > 0) {

272 
by‹s_to_»ad
 = 
Ën
 < 4096 ?†en : 4096;

273 
n
 = 
	`adb_»ad
(
h
->
fd
, 
d©a
, 
by‹s_to_»ad
);

274 ià(
n
 !ğ
by‹s_to_»ad
) {

275 
	`D
("ERROR: fd = %d,‚ = %d,ƒrrno = %d (%s)\n",

276 
h
->
fd
, 
n
, 
”ºo
, 
	`¡»¼Ü
(errno));

279 
Ën
 -ğ
n
;

280 
d©a
 = ((*)d©aè+ 
n
;

282 
	`D
("[ dÚfd=%d ]\n", 
h
->
fd
);

284 
	}
}

286 
	$usb_adb_kick
(
usb_hªdË
 *
h
)

288 
	`D
("usb_kick\n");

289 
	`adb_mu‹x_lock
(&
h
->
lock
);

290 
	`adb_şo£
(
h
->
fd
);

291 
h
->
fd
 = -1;

294 
	`adb_cÚd_sigÇl
(&
h
->
nÙify
);

295 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

296 
	}
}

298 
	$usb_adb_š™
()

300 
usb_hªdË
* 
h
 = 
»š‹½»t_ÿ¡
<usb_hªdË*>(
	`ÿÎoc
(1, (usb_handle)));

301 ià(
h
 =ğ
nuÎ±r
è
	`çl
("couldn't‡llocate usb_handle");

303 
h
->
wr™e
 = 
usb_adb_wr™e
;

304 
h
->
»ad
 = 
usb_adb_»ad
;

305 
h
->
kick
 = 
usb_adb_kick
;

306 
h
->
fd
 = -1;

308 
	`adb_cÚd_š™
(&
h
->
nÙify
, 0);

309 
	`adb_mu‹x_š™
(&
h
->
lock
, 0);

316 
fd
 = 
	`unix_İ’
("/dev/ªdroid_adb_’abË", 
O_RDWR
);

317 ià(
fd
 < 0) {

318 
	`D
("failedo open /dev/android_adb_enable\n");

320 
	`şo£_Ú_exec
(
fd
);

323 
	`D
("[ usb_init - startinghread ]\n");

324 
adb_th»ad_t
 
tid
;

325 if(
	`adb_th»ad_ü—‹
(&
tid
, 
usb_adb_İ’_th»ad
, 
h
)){

326 
	`çl_”ºo
("cannot create usbhread");

328 
	}
}

331 
	$š™_funùiÚfs
(
usb_hªdË
 *
h
)

333 
ssize_t
 
»t
;

334 
desc_v1
 
v1_desütÜ
;

335 
desc_v2
 
v2_desütÜ
;

337 #ià
USE_KEDACOM_ADB_TOOLS


338 
v®ue
[
PROPERTY_VALUE_MAX
];

339 
boŞ
 
is_kdb
 = 
çl£
;

340 
	`´İ”ty_g‘
("³rsi¡.adb.kdb", 
v®ue
, "1");

341 ià(
	`¡rcmp
(
v®ue
, "1") == 0) {

342 
is_kdb
 = 
Œue
;

344 ià(
is_kdb
) {

345 
fs_desütÜs
.
štf
.
bIÁ”çûCÏss
 = 
KDB_CLASS
;

346 
fs_desütÜs
.
štf
.
bIÁ”çûSubCÏss
 = 
KDB_SUBCLASS
;

347 
fs_desütÜs
.
štf
.
bIÁ”çûPrÙocŞ
 = 
KDB_PROTOCOL
;

348 
hs_desütÜs
.
štf
.
bIÁ”çûCÏss
 = 
KDB_CLASS
;

349 
hs_desütÜs
.
štf
.
bIÁ”çûSubCÏss
 = 
KDB_SUBCLASS
;

350 
hs_desütÜs
.
štf
.
bIÁ”çûPrÙocŞ
 = 
KDB_PROTOCOL
;

351 
ss_desütÜs
.
štf
.
bIÁ”çûCÏss
 = 
KDB_CLASS
;

352 
ss_desütÜs
.
štf
.
bIÁ”çûSubCÏss
 = 
KDB_SUBCLASS
;

353 
ss_desütÜs
.
štf
.
bIÁ”çûPrÙocŞ
 = 
KDB_PROTOCOL
;

354 
	`D
("[adbd] set usb classo kdb");

356 
	`D
("[adbd] set usb classo‡db");

360 
v2_desütÜ
.
h—d”
.
magic
 = 
	`ıu_to_Ë32
(
FUNCTIONFS_DESCRIPTORS_MAGIC_V2
);

361 
v2_desütÜ
.
h—d”
.
Ëngth
 = 
	`ıu_to_Ë32
((v2_descriptor));

362 
v2_desütÜ
.
h—d”
.
æags
 = 
FUNCTIONFS_HAS_FS_DESC
 | 
FUNCTIONFS_HAS_HS_DESC
 |

363 
FUNCTIONFS_HAS_SS_DESC
;

364 
v2_desütÜ
.
fs_couÁ
 = 3;

365 
v2_desütÜ
.
hs_couÁ
 = 3;

366 
v2_desütÜ
.
ss_couÁ
 = 5;

367 
v2_desütÜ
.
fs_descs
 = 
fs_desütÜs
;

368 
v2_desütÜ
.
hs_descs
 = 
hs_desütÜs
;

369 
v2_desütÜ
.
ss_descs
 = 
ss_desütÜs
;

371 
	`D
("OPENING %s\n", 
USB_FFS_ADB_EP0
);

372 
h
->
cÚŒŞ
 = 
	`adb_İ’
(
USB_FFS_ADB_EP0
, 
O_RDWR
);

373 ià(
h
->
cÚŒŞ
 < 0) {

374 
	`D
("[ %s: cªnÙ o³ÀcÚŒŞƒndpošt:ƒ¼no=%d]\n", 
USB_FFS_ADB_EP0
, 
”ºo
);

375 
”r
;

378 
»t
 = 
	`adb_wr™e
(
h
->
cÚŒŞ
, &
v2_desütÜ
, (v2_descriptor));

379 ià(
»t
 < 0) {

380 
v1_desütÜ
.
h—d”
.
magic
 = 
	`ıu_to_Ë32
(
FUNCTIONFS_DESCRIPTORS_MAGIC
);

381 
v1_desütÜ
.
h—d”
.
Ëngth
 = 
	`ıu_to_Ë32
((v1_descriptor));

382 
v1_desütÜ
.
h—d”
.
fs_couÁ
 = 3;

383 
v1_desütÜ
.
h—d”
.
hs_couÁ
 = 3;

384 
v1_desütÜ
.
fs_descs
 = 
fs_desütÜs
;

385 
v1_desütÜ
.
hs_descs
 = 
hs_desütÜs
;

386 
	`D
("[ %s: Sw™chšgØV1_desütÜ fÜm©ƒ¼no=%d ]\n", 
USB_FFS_ADB_EP0
, 
”ºo
);

387 
»t
 = 
	`adb_wr™e
(
h
->
cÚŒŞ
, &
v1_desütÜ
, (v1_descriptor));

388 ià(
»t
 < 0) {

389 
	`D
("[ %s: wr™desütÜ çed:ƒ¼no=%d ]\n", 
USB_FFS_ADB_EP0
, 
”ºo
);

390 
”r
;

394 
»t
 = 
	`adb_wr™e
(
h
->
cÚŒŞ
, &
¡ršgs
, (strings));

395 ià(
»t
 < 0) {

396 
	`D
("[ %s: wr™šg sŒšg çed:ƒ¼no=%d]\n", 
USB_FFS_ADB_EP0
, 
”ºo
);

397 
”r
;

400 
h
->
bulk_out
 = 
	`adb_İ’
(
USB_FFS_ADB_OUT
, 
O_RDWR
);

401 ià(
h
->
bulk_out
 < 0) {

402 
	`D
("[ %s: cªnÙ o³Àbulk-ouˆ•:ƒ¼no=%d ]\n", 
USB_FFS_ADB_OUT
, 
”ºo
);

403 
”r
;

406 
h
->
bulk_š
 = 
	`adb_İ’
(
USB_FFS_ADB_IN
, 
O_RDWR
);

407 ià(
h
->
bulk_š
 < 0) {

408 
	`D
("[ %s: cªnÙ o³Àbulk-šƒp:ƒ¼no=%d ]\n", 
USB_FFS_ADB_IN
, 
”ºo
);

409 
”r
;

414 
”r
:

415 ià(
h
->
bulk_š
 > 0) {

416 
	`adb_şo£
(
h
->
bulk_š
);

417 
h
->
bulk_š
 = -1;

419 ià(
h
->
bulk_out
 > 0) {

420 
	`adb_şo£
(
h
->
bulk_out
);

421 
h
->
bulk_out
 = -1;

423 ià(
h
->
cÚŒŞ
 > 0) {

424 
	`adb_şo£
(
h
->
cÚŒŞ
);

425 
h
->
cÚŒŞ
 = -1;

428 
	}
}

430 *
	$usb_ffs_İ’_th»ad
(*
x
)

432 
usb_hªdË
 *
usb
 = (usb_hªdË *)
x
;

434 
Œue
) {

436 
	`adb_mu‹x_lock
(&
usb
->
lock
);

437 
usb
->
cÚŒŞ
 != -1)

438 
	`adb_cÚd_wa™
(&
usb
->
nÙify
, &usb->
lock
);

439 
	`adb_mu‹x_uÆock
(&
usb
->
lock
);

441 
Œue
) {

442 
	`š™_funùiÚfs
(
usb
);

444 ià(
usb
->
cÚŒŞ
 >= 0)

447 
	`adb_¦“p_ms
(1000);

449 
	`´İ”ty_£t
("sys.usb.ffs.ready", "1");

451 
	`D
("[ usb_thread -„egistering device ]\n");

452 
	`»gi¡”_usb_Œª¥Üt
(
usb
, 0, 0, 1);

457 
	}
}

459 
	$bulk_wr™e
(
bulk_š
, cÚ¡ 
ušt8_t
* 
buf
, 
size_t
 
Ëngth
)

461 
size_t
 
couÁ
 = 0;

462 
»t
;

465 
»t
 = 
	`adb_wr™e
(
bulk_š
, 
buf
 + 
couÁ
, 
Ëngth
 - count);

466 ià(
»t
 < 0) {

467 ià(
”ºo
 !ğ
EINTR
)

468  
»t
;

470 
couÁ
 +ğ
»t
;

472 } 
couÁ
 < 
Ëngth
);

474 
	`D
("[ bulk_wr™dÚfd=%d ]\n", 
bulk_š
);

475  
couÁ
;

476 
	}
}

478 
	$usb_ffs_wr™e
(
usb_hªdË
* 
h
, cÚ¡ * 
d©a
, 
Ën
)

480 
	`D
("abouˆtØwr™(fd=%d,†’=%d)\n", 
h
->
bulk_š
, 
Ën
);

481 
n
 = 
	`bulk_wr™e
(
h
->
bulk_š
, 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>(
d©a
), 
Ën
);

482 ià(
n
 !ğ
Ën
) {

483 
	`D
("ERROR: fd = %d,‚ = %d: %s\n", 
h
->
bulk_š
, 
n
, 
	`¡»¼Ü
(
”ºo
));

486 
	`D
("[ dÚfd=%d ]\n", 
h
->
bulk_š
);

488 
	}
}

490 
	$bulk_»ad
(
bulk_out
, 
ušt8_t
* 
buf
, 
size_t
 
Ëngth
)

492 
size_t
 
couÁ
 = 0;

493 
»t
;

496 
»t
 = 
	`adb_»ad
(
bulk_out
, 
buf
 + 
couÁ
, 
Ëngth
 - count);

497 ià(
»t
 < 0) {

498 ià(
”ºo
 !ğ
EINTR
) {

499 
	`D
("[ bulk_read failed fd=%d†ength=%zu count=%zu ]\n",

500 
bulk_out
, 
Ëngth
, 
couÁ
);

501  
»t
;

504 
couÁ
 +ğ
»t
;

506 } 
couÁ
 < 
Ëngth
);

508  
couÁ
;

509 
	}
}

511 
	$usb_ffs_»ad
(
usb_hªdË
* 
h
, * 
d©a
, 
Ën
)

513 
	`D
("abouˆtØ»ad (fd=%d,†’=%d)\n", 
h
->
bulk_out
, 
Ën
);

514 
n
 = 
	`bulk_»ad
(
h
->
bulk_out
, 
»š‹½»t_ÿ¡
<
ušt8_t
*>(
d©a
), 
Ën
);

515 ià(
n
 !ğ
Ën
) {

516 
	`D
("ERROR: fd = %d,‚ = %d: %s\n", 
h
->
bulk_out
, 
n
, 
	`¡»¼Ü
(
”ºo
));

519 
	`D
("[ dÚfd=%d ]\n", 
h
->
bulk_out
);

521 
	}
}

523 
	$usb_ffs_kick
(
usb_hªdË
 *
h
)

525 
”r
;

527 
”r
 = 
	`ioùl
(
h
->
bulk_š
, 
FUNCTIONFS_CLEAR_HALT
);

528 ià(
”r
 < 0)

529 
	`D
("[ kick: sourû (fd=%dèş—¸h®ˆçed (%dè]", 
h
->
bulk_š
, 
”ºo
);

531 
”r
 = 
	`ioùl
(
h
->
bulk_out
, 
FUNCTIONFS_CLEAR_HALT
);

532 ià(
”r
 < 0)

533 
	`D
("[ kick: sšk (fd=%dèş—¸h®ˆçed (%dè]", 
h
->
bulk_out
, 
”ºo
);

535 
	`adb_mu‹x_lock
(&
h
->
lock
);

536 
	`adb_şo£
(
h
->
cÚŒŞ
);

537 
	`adb_şo£
(
h
->
bulk_out
);

538 
	`adb_şo£
(
h
->
bulk_š
);

539 
h
->
cÚŒŞ
 = h->
bulk_out
 = h->
bulk_š
 = -1;

542 
	`adb_cÚd_sigÇl
(&
h
->
nÙify
);

543 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

544 
	}
}

546 
	$usb_ffs_š™
()

548 
	`D
("[ usb_init - using FunctionFS ]\n");

550 
usb_hªdË
* 
h
 = 
»š‹½»t_ÿ¡
<usb_hªdË*>(
	`ÿÎoc
(1, (usb_handle)));

551 ià(
h
 =ğ
nuÎ±r
è
	`çl
("couldn't‡llocate usb_handle");

553 
h
->
wr™e
 = 
usb_ffs_wr™e
;

554 
h
->
»ad
 = 
usb_ffs_»ad
;

555 
h
->
kick
 = 
usb_ffs_kick
;

556 
h
->
cÚŒŞ
 = -1;

557 
h
->
bulk_out
 = -1;

558 
h
->
bulk_out
 = -1;

560 
	`adb_cÚd_š™
(&
h
->
nÙify
, 0);

561 
	`adb_mu‹x_š™
(&
h
->
lock
, 0);

563 
	`D
("[ usb_init - startinghread ]\n");

564 
adb_th»ad_t
 
tid
;

565 ià(
	`adb_th»ad_ü—‹
(&
tid
, 
usb_ffs_İ’_th»ad
, 
h
)){

566 
	`çl_”ºo
("[ cannot create usbhread ]\n");

568 
	}
}

570 
	$usb_š™
()

572 ià(
	`acûss
(
USB_FFS_ADB_EP0
, 
F_OK
) == 0)

573 
	`usb_ffs_š™
();

575 
	`usb_adb_š™
();

576 
	}
}

578 
	$usb_ş—nup
()

580 
	}
}

582 
	$usb_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
d©a
, 
Ën
)

584  
h
->
	`wr™e
(h, 
d©a
, 
Ën
);

585 
	}
}

587 
	$usb_»ad
(
usb_hªdË
 *
h
, *
d©a
, 
Ën
)

589  
h
->
	`»ad
(h, 
d©a
, 
Ën
);

590 
	}
}

591 
	$usb_şo£
(
usb_hªdË
 *
h
)

594 
	}
}

596 
	$usb_kick
(
usb_hªdË
 *
h
)

598 
h
->
	`kick
(h);

599 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/usb_osx.cpp

17 
	#TRACE_TAG
 
TRACE_USB


	)

19 
	~"sysd•s.h
"

21 
	~<CÜeFound©iÚ/CÜeFound©iÚ.h
>

23 
	~<IOK™/IOK™Lib.h
>

24 
	~<IOK™/IOCFPlugIn.h
>

25 
	~<IOK™/usb/IOUSBLib.h
>

26 
	~<IOK™/IOMes§ge.h
>

27 
	~<mach/mach_pÜt.h
>

29 
	~<š‰y³s.h
>

30 
	~<¡dio.h
>

32 
	~"adb.h
"

33 
	~"Œª¥Üt.h
"

35 
	#DBG
 
D


	)

37 
IONÙifiÿtiÚPÜtRef
 
	gnÙifiÿtiÚPÜt
 = 0;

38 
io_™”©Ü_t
 
	gnÙifiÿtiÚI‹¿tÜ
;

40 
	susb_hªdË


42 
UIÁ8
 
	mbulkIn
;

43 
UIÁ8
 
	mbulkOut
;

44 
IOUSBIÁ”çûIÁ”çû
 **
	mš‹rçû
;

45 
io_objeù_t
 
	musbNÙifiÿtiÚ
;

46 
	mz”o_mask
;

49 
CFRunLoİRef
 
	gcu¼’tRunLoİ
 = 0;

50 
±h»ad_mu‹x_t
 
	g¡¬t_lock
;

51 
±h»ad_cÚd_t
 
	g¡¬t_cÚd
;

54 
AndroidIÁ”çûAdded
(*
»fCÚ
, 
io_™”©Ü_t
 
™”©Ü
);

55 
AndroidIÁ”çûNÙify
(*
»fCÚ
, 
io_™”©Ü_t
 
™”©Ü
,

56 
Çtu¿l_t
 
mes§geTy³
,

57 *
mes§geArgum’t
);

58 
usb_hªdË
* 
CheckIÁ”çû
(
IOUSBIÁ”çûIÁ”çû
 **
içû
,

59 
UIÁ16
 
v’dÜ
, UIÁ16 
´oduù
);

62 
	$In™USB
()

64 
CFMubËDiùiÚ¬yRef
 
m©chšgDiù
;

65 
CFRunLoİSourûRef
 
runLoİSourû
;

69 
nÙifiÿtiÚPÜt
 = 
	`IONÙifiÿtiÚPÜtC»©e
(
kIOMa¡”PÜtDeçuÉ
);

70 
runLoİSourû
 = 
	`IONÙifiÿtiÚPÜtG‘RunLoİSourû
(
nÙifiÿtiÚPÜt
);

71 
	`CFRunLoİAddSourû
(
	`CFRunLoİG‘Cu¼’t
(), 
runLoİSourû
, 
kCFRunLoİDeçuÉMode
);

77 
m©chšgDiù
 = 
	`IOS”viûM©chšg
(
kIOUSBIÁ”çûCÏssName
);

79 ià(!
m©chšgDiù
) {

80 
	`DBG
("ERR: Couldn't create USB matching dictionary.\n");

88 
	`IOS”viûAddM©chšgNÙifiÿtiÚ
(

89 
nÙifiÿtiÚPÜt
,

90 
kIOFœ¡M©chNÙifiÿtiÚ
,

91 
m©chšgDiù
,

92 
AndroidIÁ”çûAdded
,

93 
NULL
,

94 &
nÙifiÿtiÚI‹¿tÜ
);

98 
	`AndroidIÁ”çûAdded
(
NULL
, 
nÙifiÿtiÚI‹¿tÜ
);

101 
	}
}

104 
	$AndroidIÁ”çûAdded
(*
»fCÚ
, 
io_™”©Ü_t
 
™”©Ü
)

106 
k”n_»tuº_t
 
kr
;

107 
io_£rviû_t
 
usbDeviû
;

108 
io_£rviû_t
 
usbIÁ”çû
;

109 
IOCFPlugInIÁ”çû
 **
¶ugInIÁ”çû
 = 
NULL
;

110 
IOUSBIÁ”çûIÁ”çû220
 **
içû
 = 
NULL
;

111 
IOUSBDeviûIÁ”çû197
 **
dev
 = 
NULL
;

112 
HRESULT
 
»suÉ
;

113 
SIÁ32
 
scÜe
;

114 
UIÁ32
 
loÿtiÚId
;

115 
UIÁ8
 
if_şass
, 
subşass
, 
´ÙocŞ
;

116 
UIÁ16
 
v’dÜ
;

117 
UIÁ16
 
´oduù
;

118 
UIÁ8
 
£rŸlIndex
;

119 
£rŸl
[256];

120 
dev·thBuf
[64];

121 *
dev·th
 = 
NULL
;

123 (
usbIÁ”çû
 = 
	`IOI‹¿tÜNext
(
™”©Ü
))) {

125 
kr
 = 
	`IOC»©ePlugInIÁ”çûFÜS”viû
(
usbIÁ”çû
,

126 
kIOUSBIÁ”çûU£rCl›ÁTy³ID
,

127 
kIOCFPlugInIÁ”çûID
,

128 &
¶ugInIÁ”çû
, &
scÜe
);

129 
	`IOObjeùR–—£
(
usbIÁ”çû
);

130 ià((
kIOR‘uºSucûss
 !ğ
kr
è|| (!
¶ugInIÁ”çû
)) {

131 
	`DBG
("ERR: UÇbËØü—‹‡Àš‹rçû…lug-š (%08x)\n", 
kr
);

136 
»suÉ
 = (*
¶ugInIÁ”çû
)->
	`Qu”yIÁ”çû
(

137 
¶ugInIÁ”çû
,

138 
	`CFUUIDG‘UUIDBy‹s
(
kIOUSBIÁ”çûIÁ”çûID
), (
LPVOID
*)&
içû
);

140 (*
¶ugInIÁ”çû
)->
	`R–—£
(plugInInterface);

141 ià(
»suÉ
 || !
içû
) {

142 
	`DBG
("ERR: Couldn'ˆqu”yhš‹rçû (%08x)\n", (è
»suÉ
);

146 
kr
 = (*
içû
)->
	`G‘IÁ”çûCÏss
(içû, &
if_şass
);

147 
kr
 = (*
içû
)->
	`G‘IÁ”çûSubCÏss
(içû, &
subşass
);

148 
kr
 = (*
içû
)->
	`G‘IÁ”çûPrÙocŞ
(içû, &
´ÙocŞ
);

149 if(
if_şass
 !ğ
ADB_CLASS
 || 
subşass
 !ğ
ADB_SUBCLASS
 || 
´ÙocŞ
 !ğ
ADB_PROTOCOL
) {

151 
	`DBG
("IgnÜšg iÁ”çû w™h incÜ»ù cÏss/subşass/´ÙocŞ - %d, %d, %d\n", 
if_şass
, 
subşass
, 
´ÙocŞ
);

152 (*
içû
)->
	`R–—£
(iface);

160 
kr
 = (*
içû
)->
	`G‘Deviû
(içû, &
usbDeviû
);

161 ià(
kIOR‘uºSucûss
 !ğ
kr
 || !
usbDeviû
) {

162 
	`DBG
("ERR: Couldn'ˆg¿b deviû from iÁ”çû (%08x)\n", 
kr
);

166 
¶ugInIÁ”çû
 = 
NULL
;

167 
scÜe
 = 0;

169 
kr
 = 
	`IOC»©ePlugInIÁ”çûFÜS”viû
(
usbDeviû
,

170 
kIOUSBDeviûU£rCl›ÁTy³ID
,

171 
kIOCFPlugInIÁ”çûID
,

172 &
¶ugInIÁ”çû
, &
scÜe
);

174 ()
	`IOObjeùR–—£
(
usbDeviû
);

175 ià((
kIOR‘uºSucûss
 !ğ
kr
è|| (!
¶ugInIÁ”çû
)) {

176 
	`DBG
("ERR: UÇbËØü—‹‡ deviû…lug-š (%08x)\n", 
kr
);

180 
»suÉ
 = (*
¶ugInIÁ”çû
)->
	`Qu”yIÁ”çû
(plugInInterface,

181 
	`CFUUIDG‘UUIDBy‹s
(
kIOUSBDeviûIÁ”çûID
), (
LPVOID
*)&
dev
);

183 (*
¶ugInIÁ”çû
)->
	`R–—£
(plugInInterface);

184 ià(
»suÉ
 || !
dev
) {

185 
	`DBG
("ERR: Couldn't create‡ device interface (%08x)\n",

186 (è
»suÉ
);

192 
kr
 = (*
dev
)->
	`G‘DeviûV’dÜ
(dev, &
v’dÜ
);

193 
kr
 = (*
dev
)->
	`G‘DeviûProduù
(dev, &
´oduù
);

194 
kr
 = (*
dev
)->
	`G‘LoÿtiÚID
(dev, &
loÿtiÚId
);

195 ià(
kr
 == 0) {

196 
	`¢´štf
(
dev·thBuf
, (dev·thBuf), "usb:%" 
PRIu32
 "X",

197 ()
loÿtiÚId
);

198 
dev·th
 = 
dev·thBuf
;

200 
kr
 = (*
dev
)->
	`USBG‘S”ŸlNumb”SŒšgIndex
(dev, &
£rŸlIndex
);

202 ià(
£rŸlIndex
 > 0) {

203 
IOUSBDevReque¡
 
»q
;

204 
UIÁ16
 
bufãr
[256];

205 
UIÁ16
 
Ïnguages
[128];

207 
	`mem£t
(
Ïnguages
, 0, (languages));

209 
»q
.
bmReque¡Ty³
 =

210 
	`USBmakebmReque¡Ty³
(
kUSBIn
, 
kUSBSnd¬d
, 
kUSBDeviû
);

211 
»q
.
bReque¡
 = 
kUSBRqG‘DesütÜ
;

212 
»q
.
wV®ue
 = (
kUSBSŒšgDesc
 << 8) | 0;

213 
»q
.
wIndex
 = 0;

214 
»q
.
pD©a
 = 
Ïnguages
;

215 
»q
.
wL’gth
 = (
Ïnguages
);

216 
kr
 = (*
dev
)->
	`DeviûReque¡
(dev, &
»q
);

218 ià(
kr
 =ğ
kIOR‘uºSucûss
 && 
»q
.
wL’DÚe
 > 0) {

220 
ÏngCouÁ
 = (
»q
.
wL’DÚe
 - 2è/ 2, 
Ïng
;

222 
Ïng
 = 1;†ªg <ğ
ÏngCouÁ
;†ang++) {

224 
	`mem£t
(
bufãr
, 0, (buffer));

225 
	`mem£t
(&
»q
, 0, (req));

227 
»q
.
bmReque¡Ty³
 =

228 
	`USBmakebmReque¡Ty³
(
kUSBIn
, 
kUSBSnd¬d
, 
kUSBDeviû
);

229 
»q
.
bReque¡
 = 
kUSBRqG‘DesütÜ
;

230 
»q
.
wV®ue
 = (
kUSBSŒšgDesc
 << 8è| 
£rŸlIndex
;

231 
»q
.
wIndex
 = 
Ïnguages
[
Ïng
];

232 
»q
.
pD©a
 = 
bufãr
;

233 
»q
.
wL’gth
 = (
bufãr
);

234 
kr
 = (*
dev
)->
	`DeviûReque¡
(dev, &
»q
);

236 ià(
kr
 =ğ
kIOR‘uºSucûss
 && 
»q
.
wL’DÚe
 > 0) {

237 
i
, 
couÁ
;

241 
couÁ
 = (
»q
.
wL’DÚe
 - 1) / 2;

242 
i
 = 0; i < 
couÁ
; i++)

243 
£rŸl
[
i
] = 
bufãr
[i + 1];

244 
£rŸl
[
i
] = 0;

250 (*
dev
)->
	`R–—£
(dev);

252 
	`DBG
("INFO: Found vid=%04x…id=%04x s”Ÿl=%s\n", 
v’dÜ
, 
´oduù
,

253 
£rŸl
);

255 
usb_hªdË
* 
hªdË
 = 
	`CheckIÁ”çû
((
IOUSBIÁ”çûIÁ”çû
**)
içû
,

256 
v’dÜ
, 
´oduù
);

257 ià(
hªdË
 =ğ
NULL
) {

258 
	`DBG
("ERR: Could‚Ù fšd deviû iÁ”çû: %08x\n", 
kr
);

259 (*
içû
)->
	`R–—£
(iface);

263 
	`DBG
("AndroidDeviceAdded calling„egister_usb_transport\n");

264 
	`»gi¡”_usb_Œª¥Üt
(
hªdË
, (
£rŸl
[0] ? s”ŸÈ: 
NULL
), 
dev·th
, 1);

269 
kr
 = 
	`IOS”viûAddIÁ”e¡NÙifiÿtiÚ
(
nÙifiÿtiÚPÜt
,

270 
usbIÁ”çû
,

271 
kIOG’”®IÁ”e¡
,

272 
AndroidIÁ”çûNÙify
,

273 
hªdË
,

274 &
hªdË
->
usbNÙifiÿtiÚ
);

276 ià(
kIOR‘uºSucûss
 !ğ
kr
) {

277 
	`DBG
("ERR: UÇbËØü—‹ iÁ”e¡‚ÙifiÿtiÚ (%08x)\n", 
kr
);

280 
	}
}

283 
	$AndroidIÁ”çûNÙify
(*
»fCÚ
, 
io_£rviû_t
 
£rviû
, 
Çtu¿l_t
 
mes§geTy³
, *
mes§geArgum’t
)

285 
usb_hªdË
 *
hªdË
 = (usb_hªdË *)
»fCÚ
;

287 ià(
mes§geTy³
 =ğ
kIOMes§geS”viûIsT”mš©ed
) {

288 ià(!
hªdË
) {

289 
	`DBG
("ERR: NULL handle\n");

292 
	`DBG
("AndroidInterfaceNotify\n");

293 
	`IOObjeùR–—£
(
hªdË
->
usbNÙifiÿtiÚ
);

294 
	`usb_kick
(
hªdË
);

296 
	}
}

300 
usb_hªdË
*

301 
	$CheckIÁ”çû
(
IOUSBIÁ”çûIÁ”çû
 **
š‹rçû
, 
UIÁ16
 
v’dÜ
, UIÁ16 
´oduù
)

303 
usb_hªdË
* 
hªdË
 = 
NULL
;

304 
IOR‘uº
 
kr
;

305 
UIÁ8
 
š‹rçûNumEndpošts
, 
š‹rçûCÏss
, 
š‹rçûSubCÏss
, 
š‹rçûPrÙocŞ
;

306 
UIÁ8
 
’dpošt
;

311 
kr
 = (*
š‹rçû
)->
	`USBIÁ”çûO³n
(interface);

312 ià(
kr
 !ğ
kIOR‘uºSucûss
) {

313 
	`DBG
("ERR: Could‚Ù o³Àš‹rçû: (%08x)\n", 
kr
);

314  
NULL
;

318 
kr
 = (*
š‹rçû
)->
	`G‘NumEndpošts
(š‹rçû, &
š‹rçûNumEndpošts
);

319 ià(
kr
 !ğ
kIOR‘uºSucûss
) {

320 
	`DBG
("ERR: UÇbËØg‘‚umb” oà’dpošts: (%08x)\n", 
kr
);

321 
”r_g‘_num_•
;

325 ià((*
š‹rçû
)->
	`G‘IÁ”çûCÏss
(š‹rçû, &
š‹rçûCÏss
è!ğ
kIOR‘uºSucûss
 ||

326 (*
š‹rçû
)->
	`G‘IÁ”çûSubCÏss
(š‹rçû, &
š‹rçûSubCÏss
è!ğ
kIOR‘uºSucûss
 ||

327 (*
š‹rçû
)->
	`G‘IÁ”çûPrÙocŞ
(š‹rçû, &
š‹rçûPrÙocŞ
è!ğ
kIOR‘uºSucûss
) {

328 
	`DBG
("ERR: Unableo get interface class, subclass‡nd…rotocol\n");

329 
”r_g‘_š‹rçû_şass
;

334 ià(!
	`is_adb_š‹rçû
(
v’dÜ
, 
´oduù
, 
š‹rçûCÏss
,

335 
š‹rçûSubCÏss
, 
š‹rçûPrÙocŞ
))

336 
”r_bad_adb_š‹rçû
;

338 
hªdË
 = 
»š‹½»t_ÿ¡
<
usb_hªdË
*>(
	`ÿÎoc
(1, (usb_handle)));

339 ià(
hªdË
 =ğ
nuÎ±r
è
”r_bad_adb_š‹rçû
;

343 
’dpošt
 = 0;ƒndpošˆ<ğ
š‹rçûNumEndpošts
;ƒndpoint++) {

344 
UIÁ8
 
ŒªsãrTy³
;

345 
UIÁ16
 
maxPack‘Size
;

346 
UIÁ8
 
š‹rv®
;

347 
UIÁ8
 
numb”
;

348 
UIÁ8
 
dœeùiÚ
;

350 
kr
 = (*
š‹rçû
)->
	`G‘PePrİ”t›s
(š‹rçû, 
’dpošt
, &
dœeùiÚ
,

351 &
numb”
, &
ŒªsãrTy³
, &
maxPack‘Size
, &
š‹rv®
);

353 ià(
kIOR‘uºSucûss
 =ğ
kr
) {

354 ià(
kUSBBulk
 !ğ
ŒªsãrTy³
)

357 ià(
kUSBIn
 =ğ
dœeùiÚ
)

358 
hªdË
->
bulkIn
 = 
’dpošt
;

360 ià(
kUSBOut
 =ğ
dœeùiÚ
)

361 
hªdË
->
bulkOut
 = 
’dpošt
;

363 
hªdË
->
z”o_mask
 = 
maxPack‘Size
 - 1;

365 
	`DBG
("ERR: FindDeviceInterface - could‚ot get…ipe…roperties\n");

366 
”r_g‘_pe_´İs
;

370 
hªdË
->
š‹rçû
 = interface;

371  
hªdË
;

373 
”r_g‘_pe_´İs
:

374 
	`ä“
(
hªdË
);

375 
”r_bad_adb_š‹rçû
:

376 
”r_g‘_š‹rçû_şass
:

377 
”r_g‘_num_•
:

378 (*
š‹rçû
)->
	`USBIÁ”çûClo£
(interface);

379  
NULL
;

380 
	}
}

383 * 
	$RunLoİTh»ad
(* 
unu£d
)

385 
	`In™USB
();

387 
cu¼’tRunLoİ
 = 
	`CFRunLoİG‘Cu¼’t
();

390 
	`adb_mu‹x_lock
(&
¡¬t_lock
);

391 
	`adb_cÚd_sigÇl
(&
¡¬t_cÚd
);

392 
	`adb_mu‹x_uÆock
(&
¡¬t_lock
);

394 
	`CFRunLoİRun
();

395 
cu¼’tRunLoİ
 = 0;

397 
	`IOObjeùR–—£
(
nÙifiÿtiÚI‹¿tÜ
);

398 
	`IONÙifiÿtiÚPÜtDe¡roy
(
nÙifiÿtiÚPÜt
);

400 
	`DBG
("RunLoopThread done\n");

401  
NULL
;

402 
	}
}

405 
	gš™Ÿlized
 = 0;

406 
	$usb_š™
()

408 ià(!
š™Ÿlized
)

410 
adb_th»ad_t
 
tid
;

412 
	`adb_mu‹x_š™
(&
¡¬t_lock
, 
NULL
);

413 
	`adb_cÚd_š™
(&
¡¬t_cÚd
, 
NULL
);

415 if(
	`adb_th»ad_ü—‹
(&
tid
, 
RunLoİTh»ad
, 
NULL
))

416 
	`çl_”ºo
("cannot create inputhread");

419 
	`adb_mu‹x_lock
(&
¡¬t_lock
);

420 
	`adb_cÚd_wa™
(&
¡¬t_cÚd
, &
¡¬t_lock
);

421 
	`adb_mu‹x_uÆock
(&
¡¬t_lock
);

423 
	`adb_mu‹x_de¡roy
(&
¡¬t_lock
);

424 
	`adb_cÚd_de¡roy
(&
¡¬t_cÚd
);

426 
š™Ÿlized
 = 1;

428 
	}
}

430 
	$usb_ş—nup
()

432 
	`DBG
("usb_cleanup\n");

433 
	`şo£_usb_deviûs
();

434 ià(
cu¼’tRunLoİ
)

435 
	`CFRunLoİStİ
(
cu¼’tRunLoİ
);

436 
	}
}

438 
	$usb_wr™e
(
usb_hªdË
 *
hªdË
, cÚ¡ *
buf
, 
Ën
)

440 
IOR‘uº
 
»suÉ
;

442 ià(!
Ën
)

445 ià(!
hªdË
)

448 ià(
NULL
 =ğ
hªdË
->
š‹rçû
) {

449 
	`DBG
("ERR: usb_write interface was‚ull\n");

453 ià(0 =ğ
hªdË
->
bulkOut
) {

454 
	`DBG
("ERR: bulkOutƒndpoint‚ot‡ssigned\n");

458 
»suÉ
 =

459 (*
hªdË
->
š‹rçû
)->
	`Wr™ePe
(

460 
hªdË
->
š‹rçû
, hªdË->
bulkOut
, (*)
buf
, 
Ën
);

462 ià((
»suÉ
 =ğ0è&& (
hªdË
->
z”o_mask
)) {

464 if(!(
Ën
 & 
hªdË
->
z”o_mask
)) {

465 
»suÉ
 =

466 (*
hªdË
->
š‹rçû
)->
	`Wr™ePe
(

467 
hªdË
->
š‹rçû
, hªdË->
bulkOut
, (*)
buf
, 0);

471 ià(0 =ğ
»suÉ
)

474 
	`DBG
("ERR: usb_wr™çed w™h stu %d\n", 
»suÉ
);

476 
	}
}

478 
	$usb_»ad
(
usb_hªdË
 *
hªdË
, *
buf
, 
Ën
)

480 
IOR‘uº
 
»suÉ
;

481 
UIÁ32
 
numBy‹s
 = 
Ën
;

483 ià(!
Ën
) {

487 ià(!
hªdË
) {

491 ià(
NULL
 =ğ
hªdË
->
š‹rçû
) {

492 
	`DBG
("ERR: usb_read interface was‚ull\n");

496 ià(0 =ğ
hªdË
->
bulkIn
) {

497 
	`DBG
("ERR: bulkInƒndpoint‚ot‡ssigned\n");

501 
»suÉ
 = (*
hªdË
->
š‹rçû
)->
	`R—dPe
(hªdË->š‹rçû, hªdË->
bulkIn
, 
buf
, &
numBy‹s
);

503 ià(
kIOUSBPeSÎed
 =ğ
»suÉ
) {

504 
	`DBG
(" Pipe stalled, clearing stall.\n");

505 (*
hªdË
->
š‹rçû
)->
	`CË¬PeSÎ
(hªdË->š‹rçû, hªdË->
bulkIn
);

506 
»suÉ
 = (*
hªdË
->
š‹rçû
)->
	`R—dPe
(hªdË->š‹rçû, hªdË->
bulkIn
, 
buf
, &
numBy‹s
);

509 ià(
kIOR‘uºSucûss
 =ğ
»suÉ
)

512 
	`DBG
("ERR: usb_»ad faed w™h stu %x\n", 
»suÉ
);

516 
	}
}

518 
	$usb_şo£
(
usb_hªdË
 *
hªdË
)

521 
	}
}

523 
	$usb_kick
(
usb_hªdË
 *
hªdË
)

526 ià(!
hªdË
)

529 ià(
hªdË
->
š‹rçû
)

531 (*
hªdË
->
š‹rçû
)->
	`USBIÁ”çûClo£
(handle->interface);

532 (*
hªdË
->
š‹rçû
)->
	`R–—£
(handle->interface);

533 
hªdË
->
š‹rçû
 = 0;

535 
	}
}

	@/home/zhangpengpeng/workspace/KC30S/system/core/adb/usb_windows.cpp

17 
	#TRACE_TAG
 
TRACE_USB


	)

19 
	~"sysd•s.h
"

21 
	~<wšsock2.h
>

22 
	~<adb_­i.h
>

23 
	~<”ºo.h
>

24 
	~<¡dio.h
>

25 
	~<¡dlib.h
>

26 
	~<usb100.h
>

27 
	~<wšdows.h
>

28 
	~<wš”rÜ.h
>

30 
	~"adb.h
"

31 
	~"Œª¥Üt.h
"

37 
	susb_hªdË
 {

39 
usb_hªdË
 *
	m´ev
;

42 
usb_hªdË
 *
	mÃxt
;

45 
ADBAPIHANDLE
 
	madb_š‹rçû
;

48 
ADBAPIHANDLE
 
	madb_»ad_pe
;

51 
ADBAPIHANDLE
 
	madb_wr™e_pe
;

54 * 
	mš‹rçû_Çme
;

57 
	mz”o_mask
;

61 cÚ¡ 
GUID
 
	gusb_şass_id
 = 
ANDROID_USB_CLASS_ID
;

64 
usb_hªdË
 
	ghªdË_li¡
 = {

65 .
´ev
 = &
hªdË_li¡
,

66 .
	gÃxt
 = &
hªdË_li¡
,

70 
ADB_MUTEX_DEFINE
Ğ
usb_lock
 );

73 
known_deviû
(cÚ¡ * 
dev_Çme
);

77 
known_deviû_locked
(cÚ¡ * 
dev_Çme
);

80 
»gi¡”_Ãw_deviû
(
usb_hªdË
* 
hªdË
);

83 
»cognized_deviû
(
usb_hªdË
* 
hªdË
);

87 
fšd_deviûs
();

91 * 
deviû_pŞl_th»ad
(* 
unu£d
);

94 
usb_š™
();

97 
usb_ş—nup
();

100 
usb_hªdË
* 
do_usb_İ’
(cÚ¡ 
wch¬_t
* 
š‹rçû_Çme
);

103 
usb_wr™e
(
usb_hªdË
* 
hªdË
, cÚ¡ * 
d©a
, 
Ën
);

106 
usb_»ad
(
usb_hªdË
 *
hªdË
, * 
d©a
, 
Ën
);

109 
usb_ş—nup_hªdË
(
usb_hªdË
* 
hªdË
);

112 
usb_kick
(
usb_hªdË
* 
hªdË
);

115 
usb_şo£
(
usb_hªdË
* 
hªdË
);

118 cÚ¡ *
usb_Çme
(
usb_hªdË
* 
hªdË
);

120 
	$known_deviû_locked
(cÚ¡ * 
dev_Çme
) {

121 
usb_hªdË
* 
usb
;

123 ià(
NULL
 !ğ
dev_Çme
) {

125 
usb
 = 
hªdË_li¡
.
Ãxt
; usb != &handle_list; usb = usb->next) {

127 if((
NULL
 !ğ
usb
->
š‹rçû_Çme
) &&

128 (0 =ğ
	`¡ricmp
(
usb
->
š‹rçû_Çme
, 
dev_Çme
))) {

135 
	}
}

137 
	$known_deviû
(cÚ¡ * 
dev_Çme
) {

138 
»t
 = 0;

140 ià(
NULL
 !ğ
dev_Çme
) {

141 
	`adb_mu‹x_lock
(&
usb_lock
);

142 
»t
 = 
	`known_deviû_locked
(
dev_Çme
);

143 
	`adb_mu‹x_uÆock
(&
usb_lock
);

146  
»t
;

147 
	}
}

149 
	$»gi¡”_Ãw_deviû
(
usb_hªdË
* 
hªdË
) {

150 ià(
NULL
 =ğ
hªdË
)

153 
	`adb_mu‹x_lock
(&
usb_lock
);

156 ià(
	`known_deviû_locked
(
hªdË
->
š‹rçû_Çme
)) {

157 
	`adb_mu‹x_uÆock
(&
usb_lock
);

162 
hªdË
->
Ãxt
 = &
hªdË_li¡
;

163 
hªdË
->
´ev
 = 
hªdË_li¡
.prev;

164 
hªdË
->
´ev
->
Ãxt
 = handle;

165 
hªdË
->
Ãxt
->
´ev
 = handle;

167 
	`adb_mu‹x_uÆock
(&
usb_lock
);

170 
	}
}

172 * 
	$deviû_pŞl_th»ad
(* 
unu£d
) {

173 
	`D
("Created devicehread\n");

176 
	`fšd_deviûs
();

177 
	`adb_¦“p_ms
(1000);

180  
NULL
;

181 
	}
}

183 
	$usb_š™
() {

184 
adb_th»ad_t
 
tid
;

186 if(
	`adb_th»ad_ü—‹
(&
tid
, 
deviû_pŞl_th»ad
, 
NULL
)) {

187 
	`çl_”ºo
("cannot create inputhread");

189 
	}
}

191 
	$usb_ş—nup
() {

192 
	}
}

194 
usb_hªdË
* 
	$do_usb_İ’
(cÚ¡ 
wch¬_t
* 
š‹rçû_Çme
) {

196 
usb_hªdË
* 
»t
 = (usb_hªdË*)
	`m®loc
((usb_handle));

197 ià(
NULL
 =ğ
»t
)

198  
NULL
;

201 
»t
->
Ãxt
 =„et;

202 
»t
->
´ev
 =„et;

205 
»t
->
adb_š‹rçû
 = 
	`AdbC»©eIÁ”çûByName
(
š‹rçû_Çme
);

207 ià(
NULL
 =ğ
»t
->
adb_š‹rçû
) {

208 
	`ä“
(
»t
);

209 
”ºo
 = 
	`G‘La¡E¼Ü
();

210  
NULL
;

214 
»t
->
adb_»ad_pe
 =

215 
	`AdbO³nDeçuÉBulkR—dEndpošt
(
»t
->
adb_š‹rçû
,

216 
AdbO³nAcûssTy³R—dWr™e
,

217 
AdbO³nSh¬šgModeR—dWr™e
);

218 ià(
NULL
 !ğ
»t
->
adb_»ad_pe
) {

220 
»t
->
adb_wr™e_pe
 =

221 
	`AdbO³nDeçuÉBulkWr™eEndpošt
(
»t
->
adb_š‹rçû
,

222 
AdbO³nAcûssTy³R—dWr™e
,

223 
AdbO³nSh¬šgModeR—dWr™e
);

224 ià(
NULL
 !ğ
»t
->
adb_wr™e_pe
) {

226 
Çme_Ën
 = 0;

229 
	`AdbG‘IÁ”çûName
(
»t
->
adb_š‹rçû
,

230 
NULL
,

231 &
Çme_Ën
,

232 
Œue
);

233 ià(0 !ğ
Çme_Ën
) {

234 
»t
->
š‹rçû_Çme
 = (*)
	`m®loc
(
Çme_Ën
);

236 ià(
NULL
 !ğ
»t
->
š‹rçû_Çme
) {

238 ià(
	`AdbG‘IÁ”çûName
(
»t
->
adb_š‹rçû
,

239 
»t
->
š‹rçû_Çme
,

240 &
Çme_Ën
,

241 
Œue
)) {

243  
»t
;

246 
	`S‘La¡E¼Ü
(
ERROR_OUTOFMEMORY
);

253 
§ved_”ºo
 = 
	`G‘La¡E¼Ü
();

254 
	`usb_ş—nup_hªdË
(
»t
);

255 
	`ä“
(
»t
);

256 
	`S‘La¡E¼Ü
(
§ved_”ºo
);

258  
NULL
;

259 
	}
}

261 
	$usb_wr™e
(
usb_hªdË
* 
hªdË
, cÚ¡ * 
d©a
, 
Ën
) {

262 
time_out
 = 5000;

263 
wr™‹n
 = 0;

264 
»t
;

266 
	`D
("usb_wr™%d\n", 
Ën
);

267 ià(
NULL
 !ğ
hªdË
) {

269 
»t
 = 
	`AdbWr™eEndpoštSync
(
hªdË
->
adb_wr™e_pe
,

270 (*)
d©a
,

271 ()
Ën
,

272 &
wr™‹n
,

273 
time_out
);

274 
§ved_”ºo
 = 
	`G‘La¡E¼Ü
();

276 ià(
»t
) {

278 
	`D
("usb_wr™gÙ: %ld,ƒx³ùed: %d\n", 
wr™‹n
, 
Ën
);

279 ià(
wr™‹n
 =ğ()
Ën
) {

280 if(
hªdË
->
z”o_mask
 && (
Ën
 & handle->zero_mask) == 0) {

282 
	`AdbWr™eEndpoštSync
(
hªdË
->
adb_wr™e_pe
,

283 (*)
d©a
,

285 &
wr™‹n
,

286 
time_out
);

292 ià(
§ved_”ºo
 =ğ
ERROR_INVALID_HANDLE
)

293 
	`usb_kick
(
hªdË
);

295 
”ºo
 = 
§ved_”ºo
;

297 
	`D
("usb_write NULL handle\n");

298 
	`S‘La¡E¼Ü
(
ERROR_INVALID_HANDLE
);

301 
	`D
("usb_wr™çed: %d\n", 
”ºo
);

304 
	}
}

306 
	$usb_»ad
(
usb_hªdË
 *
hªdË
, * 
d©a
, 
Ën
) {

307 
time_out
 = 0;

308 
»ad
 = 0;

309 
»t
;

311 
	`D
("usb_»ad %d\n", 
Ën
);

312 ià(
NULL
 !ğ
hªdË
) {

313 
Ën
 > 0) {

314 
xãr
 = (
Ën
 > 4096) ? 4096 :†en;

316 
»t
 = 
	`AdbR—dEndpoštSync
(
hªdË
->
adb_»ad_pe
,

317 
d©a
,

318 ()
xãr
,

319 &
»ad
,

320 
time_out
);

321 
§ved_”ºo
 = 
	`G‘La¡E¼Ü
();

322 
	`D
("usb_wr™gÙ: %ld,ƒx³ùed: %d,ƒ¼no: %d\n", 
»ad
, 
xãr
, 
§ved_”ºo
);

323 ià(
»t
) {

324 
d©a
 = (*)d©¨+ 
»ad
;

325 
Ën
 -ğ
»ad
;

327 ià(
Ën
 == 0)

331 ià(
§ved_”ºo
 =ğ
ERROR_INVALID_HANDLE
)

332 
	`usb_kick
(
hªdË
);

335 
”ºo
 = 
§ved_”ºo
;

338 
	`D
("usb_read NULL handle\n");

339 
	`S‘La¡E¼Ü
(
ERROR_INVALID_HANDLE
);

342 
	`D
("usb_»ad faed: %d\n", 
”ºo
);

345 
	}
}

347 
	$usb_ş—nup_hªdË
(
usb_hªdË
* 
hªdË
) {

348 ià(
NULL
 !ğ
hªdË
) {

349 ià(
NULL
 !ğ
hªdË
->
š‹rçû_Çme
)

350 
	`ä“
(
hªdË
->
š‹rçû_Çme
);

351 ià(
NULL
 !ğ
hªdË
->
adb_wr™e_pe
)

352 
	`AdbClo£HªdË
(
hªdË
->
adb_wr™e_pe
);

353 ià(
NULL
 !ğ
hªdË
->
adb_»ad_pe
)

354 
	`AdbClo£HªdË
(
hªdË
->
adb_»ad_pe
);

355 ià(
NULL
 !ğ
hªdË
->
adb_š‹rçû
)

356 
	`AdbClo£HªdË
(
hªdË
->
adb_š‹rçû
);

358 
hªdË
->
š‹rçû_Çme
 = 
NULL
;

359 
hªdË
->
adb_wr™e_pe
 = 
NULL
;

360 
hªdË
->
adb_»ad_pe
 = 
NULL
;

361 
hªdË
->
adb_š‹rçû
 = 
NULL
;

363 
	}
}

365 
	$usb_kick
(
usb_hªdË
* 
hªdË
) {

366 ià(
NULL
 !ğ
hªdË
) {

367 
	`adb_mu‹x_lock
(&
usb_lock
);

369 
	`usb_ş—nup_hªdË
(
hªdË
);

371 
	`adb_mu‹x_uÆock
(&
usb_lock
);

373 
	`S‘La¡E¼Ü
(
ERROR_INVALID_HANDLE
);

374 
”ºo
 = 
ERROR_INVALID_HANDLE
;

376 
	}
}

378 
	$usb_şo£
(
usb_hªdË
* 
hªdË
) {

379 
	`D
("usb_close\n");

381 ià(
NULL
 !ğ
hªdË
) {

383 
	`adb_mu‹x_lock
(&
usb_lock
);

385 ià((
hªdË
->
Ãxt
 !ğhªdËè&& (hªdË->
´ev
 != handle)) {

386 
hªdË
->
Ãxt
->
´ev
 = handle->prev;

387 
hªdË
->
´ev
->
Ãxt
 = handle->next;

388 
hªdË
->
´ev
 = handle;

389 
hªdË
->
Ãxt
 = handle;

392 
	`adb_mu‹x_uÆock
(&
usb_lock
);

395 
	`usb_ş—nup_hªdË
(
hªdË
);

396 
	`ä“
(
hªdË
);

400 
	}
}

402 cÚ¡ *
	$usb_Çme
(
usb_hªdË
* 
hªdË
) {

403 ià(
NULL
 =ğ
hªdË
) {

404 
	`S‘La¡E¼Ü
(
ERROR_INVALID_HANDLE
);

405 
”ºo
 = 
ERROR_INVALID_HANDLE
;

406  
NULL
;

409  (cÚ¡ *)
hªdË
->
š‹rçû_Çme
;

410 
	}
}

412 
	$»cognized_deviû
(
usb_hªdË
* 
hªdË
) {

413 ià(
NULL
 =ğ
hªdË
)

417 
USB_DEVICE_DESCRIPTOR
 
deviû_desc
;

419 ià(!
	`AdbG‘UsbDeviûDesütÜ
(
hªdË
->
adb_š‹rçû
,

420 &
deviû_desc
)) {

425 
USB_INTERFACE_DESCRIPTOR
 
š‹rf_desc
;

427 ià(!
	`AdbG‘UsbIÁ”çûDesütÜ
(
hªdË
->
adb_š‹rçû
,

428 &
š‹rf_desc
)) {

433 ià(2 !ğ
š‹rf_desc
.
bNumEndpošts
) {

437 ià(
	`is_adb_š‹rçû
(
deviû_desc
.
idV’dÜ
, deviû_desc.
idProduù
,

438 
š‹rf_desc
.
bIÁ”çûCÏss
, iÁ”f_desc.
bIÁ”çûSubCÏss
, iÁ”f_desc.
bIÁ”çûPrÙocŞ
)) {

440 if(
š‹rf_desc
.
bIÁ”çûPrÙocŞ
 == 0x01) {

441 
AdbEndpoštInfÜm©iÚ
 
’dpošt_šfo
;

443 ià(
	`AdbG‘EndpoštInfÜm©iÚ
(
hªdË
->
adb_š‹rçû
, 0, &
’dpošt_šfo
)) {

444 
hªdË
->
z”o_mask
 = 
’dpošt_šfo
.
max_·ck‘_size
 - 1;

452 
	}
}

454 
	$fšd_deviûs
() {

455 
usb_hªdË
* 
hªdË
 = 
NULL
;

456 
’Œy_bufãr
[2048];

457 
š‹rf_Çme
[2048];

458 
AdbIÁ”çûInfo
* 
Ãxt_š‹rçû
 = (AdbIÁ”çûInfo*)(&
’Œy_bufãr
[0]);

459 
’Œy_bufãr_size
 = (
’Œy_bufãr
);

460 * 
cİy_Çme
;

463 
ADBAPIHANDLE
 
’um_hªdË
 =

464 
	`AdbEnumIÁ”çûs
(
usb_şass_id
, 
Œue
,rue,rue);

466 ià(
NULL
 =ğ
’um_hªdË
)

469 
	`AdbNextIÁ”çû
(
’um_hªdË
, 
Ãxt_š‹rçû
, &
’Œy_bufãr_size
)) {

473 cÚ¡ 
wch¬_t
* 
wch¬_Çme
 = 
Ãxt_š‹rçû
->
deviû_Çme
;

474 
cİy_Çme
 = 
š‹rf_Çme
;

475 
L
'\0' !ğ*
wch¬_Çme
;

476 
wch¬_Çme
++, 
cİy_Çme
++) {

477 *
cİy_Çme
 = ()(*
wch¬_Çme
);

479 *
cİy_Çme
 = '\0';

482 ià(!
	`known_deviû
(
š‹rf_Çme
)) {

484 
hªdË
 = 
	`do_usb_İ’
(
Ãxt_š‹rçû
->
deviû_Çme
);

485 ià(
NULL
 !ğ
hªdË
) {

487 ià(
	`»cognized_deviû
(
hªdË
)) {

488 
	`D
("addšg‡‚ew deviû %s\n", 
š‹rf_Çme
);

489 
£rŸl_numb”
[512];

490 
£rŸl_numb”_Ën
 = (
£rŸl_numb”
);

491 ià(
	`AdbG‘S”ŸlNumb”
(
hªdË
->
adb_š‹rçû
,

492 
£rŸl_numb”
,

493 &
£rŸl_numb”_Ën
,

494 
Œue
)) {

496 ià(
	`»gi¡”_Ãw_deviû
(
hªdË
)) {

497 
	`»gi¡”_usb_Œª¥Üt
(
hªdË
, 
£rŸl_numb”
, 
NULL
, 1);

499 
	`D
("»gi¡”_Ãw_deviû faed fÜ %s\n", 
š‹rf_Çme
);

500 
	`usb_ş—nup_hªdË
(
hªdË
);

501 
	`ä“
(
hªdË
);

504 
	`D
("cannot get serial‚umber\n");

505 
	`usb_ş—nup_hªdË
(
hªdË
);

506 
	`ä“
(
hªdË
);

509 
	`usb_ş—nup_hªdË
(
hªdË
);

510 
	`ä“
(
hªdË
);

515 
’Œy_bufãr_size
 = (
’Œy_bufãr
);

518 
	`AdbClo£HªdË
(
’um_hªdË
);

519 
	}
}

	@adb.h

17 #iâdeà
__ADB_H


18 
	#__ADB_H


	)

20 
	~<lim™s.h
>

21 
	~<sys/ty³s.h
>

23 
	~"adb_Œaû.h
"

24 
	~"fdev’t.h
"

26 
cÚ¡ex´
 
size_t
 
	gMAX_PAYLOAD_V1
 = 4 * 1024;

27 
cÚ¡ex´
 
size_t
 
	gMAX_PAYLOAD_V2
 = 256 * 1024;

28 
cÚ¡ex´
 
size_t
 
	gMAX_PAYLOAD
 = 
MAX_PAYLOAD_V2
;

30 
	#A_SYNC
 0x434e5953

	)

31 
	#A_CNXN
 0x4e584e43

	)

32 
	#A_OPEN
 0x4e45504f

	)

33 
	#A_OKAY
 0x59414b4f

	)

34 
	#A_CLSE
 0x45534c43

	)

35 
	#A_WRTE
 0x45545257

	)

36 
	#A_AUTH
 0x48545541

	)

39 
	#A_VERSION
 0x01000000

	)

42 
	#ADB_VERSION_MAJOR
 1

	)

43 
	#ADB_VERSION_MINOR
 0

	)

46 
	#ADB_SERVER_VERSION
 32

	)

48 
	g©¿n¥Üt
;

49 
	gusb_hªdË
;

51 
	sames§ge
 {

52 
	mcommªd
;

53 
	m¬g0
;

54 
	m¬g1
;

55 
	md©a_Ëngth
;

56 
	md©a_check
;

57 
	mmagic
;

60 
	s­ack‘


62 
­ack‘
 *
	mÃxt
;

64 
	mËn
;

65 *
	m±r
;

67 
ames§ge
 
	mmsg
;

68 
	md©a
[
MAX_PAYLOAD
];

75 
	sasock‘
 {

79 
asock‘
 *
	mÃxt
;

80 
asock‘
 *
	m´ev
;

84 
	mid
;

89 
	mşosšg
;

94 
	mex™_Ú_şo£
;

99 
asock‘
 *
	m³”
;

105 
fdev’t
 
	mfde
;

106 
	mfd
;

110 
­ack‘
 *
	mpkt_fœ¡
;

111 
­ack‘
 *
	mpkt_Ï¡
;

119 (*
	m’queue
)(
asock‘
 *
	ms
, 
­ack‘
 *
	mpkt
);

124 (*
	m»ady
)(
asock‘
 *
	ms
);

130 (*
	mshutdown
)(
asock‘
 *
	ms
);

136 (*
	mşo£
)(
asock‘
 *
	ms
);

139 
©¿n¥Üt
 *
	mŒª¥Üt
;

141 
size_t
 
g‘_max_·ylßd
() const;

150 
	sadiscÚÃù


152 (*
	mfunc
)(* 
	mİaque
, 
©¿n¥Üt
* 
	mt
);

153 * 
	mİaque
;

154 
adiscÚÃù
* 
	mÃxt
;

155 
adiscÚÃù
* 
	m´ev
;

168 
	eŒª¥Üt_ty³
 {

169 
	mkT¿n¥ÜtUsb
,

170 
	mkT¿n¥ÜtLoÿl
,

171 
	mkT¿n¥ÜtAny
,

172 
	mkT¿n¥ÜtHo¡
,

175 
	#TOKEN_SIZE
 20

	)

177 
	s©¿n¥Üt


179 
©¿n¥Üt
 *
	mÃxt
;

180 
©¿n¥Üt
 *
	m´ev
;

182 (*
	m»ad_äom_»mÙe
)(
­ack‘
 *
	mp
, 
©¿n¥Üt
 *
	mt
);

183 (*
	mwr™e_to_»mÙe
)(
­ack‘
 *
	mp
, 
©¿n¥Üt
 *
	mt
);

184 (*
	mşo£
)(
©¿n¥Üt
 *
	mt
);

185 (*
	mkick
)(
©¿n¥Üt
 *
	mt
);

187 
	mfd
;

188 
	mŒª¥Üt_sock‘
;

189 
fdev’t
 
	mŒª¥Üt_fde
;

190 
	m»f_couÁ
;

191 
	msync_tok’
;

192 
	mcÚÃùiÚ_¡©e
;

193 
	mÚlše
;

194 
Œª¥Üt_ty³
 
	mty³
;

197 
usb_hªdË
 *
	musb
;

198 
	msfd
;

201 *
	m£rŸl
;

202 *
	m´oduù
;

203 *
	mmod–
;

204 *
	mdeviû
;

205 *
	mdev·th
;

206 
	madb_pÜt
;

209 
	mkicked
;

210 
adiscÚÃù
 
	mdiscÚÃùs
;

212 *
	mkey
;

213 
	mtok’
[
TOKEN_SIZE
];

214 
fdev’t
 
	mauth_fde
;

215 
	mçed_auth_©‹m±s
;

217 cÚ¡ * 
cÚÃùiÚ_¡©e_Çme
() const;

219 
	m´ÙocŞ_v”siÚ
;

220 
size_t
 
	mmax_·ylßd
;

221 
upd©e_v”siÚ
(
v”siÚ
, 
size_t
 
·ylßd
);

222 
g‘_´ÙocŞ_v”siÚ
() const;

223 
size_t
 
g‘_max_·ylßd
() const;

236 
	s®i¡’”


238 
®i¡’”
 *
	mÃxt
;

239 
®i¡’”
 *
	m´ev
;

241 
fdev’t
 
	mfde
;

242 
	mfd
;

244 *
	mloÿl_Çme
;

245 *
	mcÚÃù_to
;

246 
©¿n¥Üt
 *
	mŒª¥Üt
;

247 
adiscÚÃù
 
	mdiscÚÃù
;

251 
´št_·ck‘
(cÚ¡ *
Ïb–
, 
­ack‘
 *
p
);

253 
asock‘
 *
fšd_loÿl_sock‘
(
loÿl_id
, 
»mÙe_id
);

254 
š¡®l_loÿl_sock‘
(
asock‘
 *
s
);

255 
»move_sock‘
(
asock‘
 *
s
);

256 
şo£_®l_sock‘s
(
©¿n¥Üt
 *
t
);

258 
asock‘
 *
ü—‹_loÿl_sock‘
(
fd
);

259 
asock‘
 *
ü—‹_loÿl_£rviû_sock‘
(cÚ¡ *
de¡š©iÚ
);

261 
asock‘
 *
ü—‹_»mÙe_sock‘
(
id
, 
©¿n¥Üt
 *
t
);

262 
cÚÃù_to_»mÙe
(
asock‘
 *
s
, cÚ¡ *
de¡š©iÚ
);

263 
cÚÃù_to_sm¬tsock‘
(
asock‘
 *
s
);

265 
çl
(cÚ¡ *
fmt
, ...);

266 
çl_”ºo
(cÚ¡ *
fmt
, ...);

268 
hªdË_·ck‘
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
);

270 
g‘_my_·th
(*
s
, 
size_t
 
maxL’
);

271 
Ïunch_£rv”
(
£rv”_pÜt
);

272 
adb_maš
(
is_d«mÚ
, 
£rv”_pÜt
);

275 #ià
ADB_HOST


276 
g‘_avaabË_loÿl_Œª¥Üt_šdex
();

278 
š™_sock‘_Œª¥Üt
(
©¿n¥Üt
 *
t
, 
s
, 
pÜt
, 
loÿl
);

279 
š™_usb_Œª¥Üt
(
©¿n¥Üt
 *
t
, 
usb_hªdË
 *
usb
, 
¡©e
);

281 #ià
ADB_HOST


282 
©¿n¥Üt
* 
fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt
(
adb_pÜt
);

285 
£rviû_to_fd
(cÚ¡ *
Çme
);

286 #ià
ADB_HOST


287 
asock‘
 *
ho¡_£rviû_to_sock‘
(cÚ¡ * 
Çme
, cÚ¡ *
£rŸl
);

290 #ià!
ADB_HOST


291 
š™_jdwp
();

292 
asock‘
* 
ü—‹_jdwp_£rviû_sock‘
();

293 
asock‘
* 
ü—‹_jdwp_Œack”_£rviû_sock‘
();

294 
ü—‹_jdwp_cÚÃùiÚ_fd
(
jdwp_pid
);

297 
hªdË_fÜw¬d_»que¡
(cÚ¡ * 
£rviû
, 
Œª¥Üt_ty³
 
‰y³
, * 
£rŸl
, 
»¶y_fd
);

299 #ià!
ADB_HOST


300 
äamebufãr_£rviû
(
fd
, *
cook›
);

301 
£t_v”™y_’abËd_¡©e_£rviû
(
fd
, * 
cook›
);

305 
­ack‘
 *
g‘_­ack‘
();

306 
put_­ack‘
(
­ack‘
 *
p
);

309 
	#DEBUG_PACKETS
 0

	)

311 #ià!
DEBUG_PACKETS


312 
	#´št_·ck‘
(
g
,
p
èdØ{} 0)

	)

315 
	#USE_KEDACOM_ADB_TOOLS
 1

	)

317 #ià
ADB_HOST_ON_TARGET


321 
	#DEFAULT_ADB_PORT
 5038

	)

323 #ià
USE_KEDACOM_ADB_TOOLS


324 
	#DEFAULT_ADB_PORT
 50371

	)

326 
	#DEFAULT_ADB_PORT
 5037

	)

330 
	#DEFAULT_ADB_LOCAL_TRANSPORT_PORT
 5555

	)

332 #ià
USE_KEDACOM_ADB_TOOLS


334 
	#KDB_CLASS
 0x“

	)

335 
	#KDB_SUBCLASS
 0x45

	)

336 
	#KDB_PROTOCOL
 0x5

	)

339 
	#ADB_CLASS
 0xff

	)

340 
	#ADB_SUBCLASS
 0x42

	)

341 
	#ADB_PROTOCOL
 0x1

	)

344 
loÿl_š™
(
pÜt
);

345 
loÿl_cÚÃù
(
pÜt
);

346 
loÿl_cÚÃù_¬b™¿ry_pÜts
(
cÚsŞe_pÜt
, 
adb_pÜt
);

349 
usb_š™
();

350 
usb_ş—nup
();

351 
usb_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
d©a
, 
Ën
);

352 
usb_»ad
(
usb_hªdË
 *
h
, *
d©a
, 
Ën
);

353 
usb_şo£
(
usb_hªdË
 *
h
);

354 
usb_kick
(
usb_hªdË
 *
h
);

357 #ià
ADB_HOST


358 
is_adb_š‹rçû
(
vid
, 
pid
, 
usb_şass
, 
usb_subşass
, 
usb_´ÙocŞ
);

361 
adb_commªdlše
(
¬gc
, cÚ¡ **
¬gv
);

363 
cÚÃùiÚ_¡©e
(
©¿n¥Üt
 *
t
);

365 
	#CS_ANY
 -1

	)

366 
	#CS_OFFLINE
 0

	)

367 
	#CS_BOOTLOADER
 1

	)

368 
	#CS_DEVICE
 2

	)

369 
	#CS_HOST
 3

	)

370 
	#CS_RECOVERY
 4

	)

371 
	#CS_NOPERM
 5

	)

372 
	#CS_SIDELOAD
 6

	)

373 
	#CS_UNAUTHORIZED
 7

	)

375 cÚ¡ *
adb_deviû_bªÃr
;

376 
HOST
;

377 
SHELL_EXIT_NOTIFY_FD
;

379 
	esub´oc_mode
 {

380 
	mSUBPROC_PTY
 = 0,

381 
	mSUBPROC_RAW
 = 1,

384 
	#CHUNK_SIZE
 (64*1024)

	)

386 #ià!
ADB_HOST


387 
	#USB_ADB_PATH
 "/dev/ªdroid_adb"

	)

389 
	#USB_FFS_ADB_PATH
 "/dev/usb-ffs/adb/"

	)

390 
	#USB_FFS_ADB_EP
(
x
è
USB_FFS_ADB_PATH
#x

	)

392 
	#USB_FFS_ADB_EP0
 
	`USB_FFS_ADB_EP
(
•0
)

	)

393 
	#USB_FFS_ADB_OUT
 
	`USB_FFS_ADB_EP
(
•1
)

	)

394 
	#USB_FFS_ADB_IN
 
	`USB_FFS_ADB_EP
(
•2
)

	)

397 
hªdË_ho¡_»que¡
(*
£rviû
, 
Œª¥Üt_ty³
 
‰y³
, * 
£rŸl
, 
»¶y_fd
, 
asock‘
 *
s
);

399 
hªdË_Úlše
(
©¿n¥Üt
 *
t
);

400 
hªdË_ofæše
(
©¿n¥Üt
 *
t
);

402 
£nd_cÚÃù
(
©¿n¥Üt
 *
t
);

	@adb_auth.h

17 #iâdeà
__ADB_AUTH_H


18 
	#__ADB_AUTH_H


	)

20 
	~"adb.h
"

22 
boŞ
 
auth_»quœed
;

24 
adb_auth_keyg’
(cÚ¡ * 
f’ame
);

25 
adb_auth_v”if›d
(
©¿n¥Üt
 *
t
);

27 
£nd_auth_»que¡
(
©¿n¥Üt
 *
t
);

28 
£nd_auth_»¥Ú£
(
ušt8_t
 *
tok’
, 
size_t
 
tok’_size
, 
©¿n¥Üt
 *
t
);

29 
£nd_auth_publickey
(
©¿n¥Üt
 *
t
);

33 
	#ADB_AUTH_TOKEN
 1

	)

35 
	#ADB_AUTH_SIGNATURE
 2

	)

36 
	#ADB_AUTH_RSAPUBLICKEY
 3

	)

38 #ià
ADB_HOST


40 
adb_auth_š™
();

41 
adb_auth_sign
(*
key
, cÚ¡ * 
tok’
, 
size_t
 
tok’_size
,

42 * 
sig
);

43 *
adb_auth_Ãxtkey
(*
cu¼’t
);

44 
adb_auth_g‘_u£rkey
(*
d©a
, 
size_t
 
Ën
);

46 
šlše
 
	$adb_auth_g’”©e_tok’
(*
tok’
, 
size_t
 
tok’_size
è{  0; 
	}
}

47 
šlše
 
	$adb_auth_v”ify
(*
tok’
, *
sig
, 
sigËn
è{  0; 
	}
}

48 
šlše
 
	$adb_auth_cÚfœm_key
(*
d©a
, 
size_t
 
Ën
, 
©¿n¥Üt
 *
t
è{ 
	}
}

52 
šlše
 
	$adb_auth_sign
(* 
key
, cÚ¡ * 
tok’
,

53 
size_t
 
tok’_size
, * 
sig
) {

55 
	}
}

56 
šlše
 *
	$adb_auth_Ãxtkey
(*
cu¼’t
è{  
NULL
; 
	}
}

57 
šlše
 
	$adb_auth_g‘_u£rkey
(*
d©a
, 
size_t
 
Ën
è{  0; 
	}
}

59 
adbd_auth_š™
();

60 
adbd_şÛxec_auth_sock‘
();

61 
adb_auth_g’”©e_tok’
(*
tok’
, 
size_t
 
tok’_size
);

62 
adb_auth_v”ify
(
ušt8_t
* 
tok’
, ušt8_t* 
sig
, 
sigËn
);

63 
adb_auth_cÚfœm_key
(*
d©a
, 
size_t
 
Ën
, 
©¿n¥Üt
 *
t
);

	@adb_client.h

1 #iâdeà
_ADB_CLIENT_H_


2 
	#_ADB_CLIENT_H_


	)

4 
	~"adb.h
"

6 
	~<¡ršg
>

12 
adb_cÚÃù
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
”rÜ
);

13 
_adb_cÚÃù
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
”rÜ
);

18 
adb_commªd
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
”rÜ
);

22 
boŞ
 
adb_qu”y
(cÚ¡ 
¡d
::
¡ršg
& 
£rviû
, std::¡ršg* 
»suÉ
, std::¡ršg* 
”rÜ
);

26 
adb_£t_Œª¥Üt
(
Œª¥Üt_ty³
 
ty³
, cÚ¡ * 
£rŸl
);

30 
adb_£t_tı_¥ecifics
(
£rv”_pÜt
);

34 
adb_£t_tı_Çme
(cÚ¡ * 
ho¡Çme
);

40 
adb_g‘_emuÏtÜ_cÚsŞe_pÜt
();

46 
adb_£nd_emuÏtÜ_commªd
(
¬gc
, cÚ¡ ** 
¬gv
);

51 
boŞ
 
adb_¡©us
(
fd
, 
¡d
::
¡ršg
* 
”rÜ
);

	@adb_io.h

17 #iâdeà
ADB_IO_H


18 
	#ADB_IO_H


	)

20 
	~<sys/ty³s.h
>

22 
	~<¡ršg
>

25 
boŞ
 
S’dOkay
(
fd
);

28 
boŞ
 
S’dFa
(
fd
, cÚ¡ 
¡d
::
¡ršg
& 
»asÚ
);

31 
boŞ
 
S’dPrÙocŞSŒšg
(
fd
, cÚ¡ 
¡d
::
¡ršg
& 
s
);

41 
boŞ
 
R—dFdExaùly
(
fd
, *
buf
, 
size_t
 
Ën
);

50 
boŞ
 
Wr™eFdExaùly
(
fd
, cÚ¡ * 
buf
, 
size_t
 
Ën
);

53 
boŞ
 
Wr™eFdExaùly
(
fd
, cÚ¡ * 
s
);

54 
boŞ
 
Wr™eFdExaùly
(
fd
, cÚ¡ 
¡d
::
¡ršg
& 
s
);

57 
boŞ
 
	$Wr™eFdFmt
(
fd
, cÚ¡ * 
fmt
, ...è
	`__©Œibu‹__
((
	`__fÜm©__
(
__´štf__
, 2, 3)));

	@adb_listeners.h

17 #iâdeà
__ADB_LISTENERS_H


18 
	#__ADB_LISTENERS_H


	)

20 
	~"adb.h
"

22 
	~<¡ršg
>

25 
	eš¡®l_¡©us_t
 {

26 
	mINSTALL_STATUS_OK
 = 0,

27 
	mINSTALL_STATUS_INTERNAL_ERROR
 = -1,

28 
	mINSTALL_STATUS_CANNOT_BIND
 = -2,

29 
	mINSTALL_STATUS_CANNOT_REBIND
 = -3,

30 
	mINSTALL_STATUS_LISTENER_NOT_FOUND
 = -4,

33 
®i¡’”
 
li¡’”_li¡
;

35 
li¡’”_discÚÃù
(* 
_l
, 
©¿n¥Üt
* 
t
);

36 
li¡’”_ev’t_func
(
_fd
, 
ev
, *
_l
);

37 
ss_li¡’”_ev’t_func
(
_fd
, 
ev
, *
_l
);

39 
š¡®l_¡©us_t
 
š¡®l_li¡’”
(cÚ¡ 
¡d
::
¡ršg
& 
loÿl_Çme
,

40 cÚ¡ * 
cÚÃù_to
,

41 
©¿n¥Üt
* 
Œª¥Üt
,

42 
no_»bšd
);

44 
	g¡d
::
¡ršg
 
fÜm©_li¡’”s
();

46 
š¡®l_¡©us_t
 
»move_li¡’”
(cÚ¡ * 
loÿl_Çme
, 
©¿n¥Üt
* 
Œª¥Üt
);

47 
»move_®l_li¡’”s
();

	@adb_trace.h

17 #iâdeà
__ADB_TRACE_H


18 
	#__ADB_TRACE_H


	)

20 #ià!
ADB_HOST


21 
	~<ªdroid/log.h
>

23 
	~<¡dio.h
>

30 
	eAdbT¿û
 {

31 
	mTRACE_ADB
 = 0,

32 
	mTRACE_SOCKETS
,

33 
	mTRACE_PACKETS
,

34 
	mTRACE_TRANSPORT
,

35 
	mTRACE_RWX
,

36 
	mTRACE_USB
,

37 
	mTRACE_SYNC
,

38 
	mTRACE_SYSDEPS
,

39 
	mTRACE_JDWP
,

40 
	mTRACE_SERVICES
,

41 
	mTRACE_AUTH
,

42 
	mTRACE_FDEVENT
,

45 #ià!
ADB_HOST


53 
adb_qemu_Œaû
(cÚ¡ * 
fmt
, ...);

55 
	#DQ
(...è
	`adb_qemu_Œaû
(
__VA_ARGS__
)

	)

57 
	#DQ
(...è(()0)

	)

60 
adb_Œaû_mask
;

61 
adb_Œaû_ouut_couÁ
;

62 
adb_Œaû_š™
();

64 
	#ADB_TRACING
 ((
adb_Œaû_mask
 & (1 << 
TRACE_TAG
)è!ğ0)

	)

67 #ià
ADB_HOST


68 
	#D
(...) \

70 ià(
ADB_TRACING
) { \

71 
§ve_”ºo
 = 
”ºo
; \

72 
	`adb_mu‹x_lock
(&
D_lock
); \

73 
	`årštf
(
¡d”r
, "%16s: %5d:%5lu | ", \

74 
__FUNCTION__
, \

75 
	`g‘pid
(), 
	`adb_th»ad_id
()); \

76 
”ºo
 = 
§ve_”ºo
; \

77 
	`årštf
(
¡d”r
, 
__VA_ARGS__
 ); \

78 
	`fæush
(
¡d”r
); \

79 
	`adb_mu‹x_uÆock
(&
D_lock
); \

80 
”ºo
 = 
§ve_”ºo
; \

82 } 0)

	)

83 
	#DR
(...) \

85 ià(
ADB_TRACING
) { \

86 
§ve_”ºo
 = 
”ºo
; \

87 
	`adb_mu‹x_lock
(&
D_lock
); \

88 
”ºo
 = 
§ve_”ºo
; \

89 
	`årštf
(
¡d”r
, 
__VA_ARGS__
 ); \

90 
	`fæush
(
¡d”r
); \

91 
	`adb_mu‹x_uÆock
(&
D_lock
); \

92 
”ºo
 = 
§ve_”ºo
; \

94 } 0)

	)

96 
	#D
(...) \

98 ià(
ADB_TRACING
) { \

99 
	`__ªdroid_log_´št
( \

100 
ANDROID_LOG_INFO
, \

101 
__FUNCTION__
, \

102 
__VA_ARGS__
 ); \

104 } 0)

	)

105 
	#DR
(...) \

107 ià(
ADB_TRACING
) { \

108 
	`__ªdroid_log_´št
( \

109 
ANDROID_LOG_INFO
, \

110 
__FUNCTION__
, \

111 
__VA_ARGS__
 ); \

113 } 0)

	)

	@adb_utils.h

17 #iâdeà
_ADB_UTILS_H_


18 
	#_ADB_UTILS_H_


	)

20 
	~<¡ršg
>

22 
boŞ
 
g‘cwd
(
¡d
::
¡ršg
* 
cwd
);

23 
boŞ
 
dœeùÜy_exi¡s
(cÚ¡ 
¡d
::
¡ršg
& 
·th
);

25 
	g¡d
::
¡ršg
 
esÿ³_¬g
(cÚ¡ 
¡d
::¡ršg& 
s
);

27 
dump_hex
(cÚ¡ * 
±r
, 
size_t
 
by‹_couÁ
);

	@fdevent.h

17 #iâdeà
__FDEVENT_H


18 
	#__FDEVENT_H


	)

20 
	~<¡dšt.h
>

23 
	#FDE_READ
 0x0001

	)

24 
	#FDE_WRITE
 0x0002

	)

25 
	#FDE_ERROR
 0x0004

	)

26 
	#FDE_TIMEOUT
 0x0008

	)

29 
	#FDE_DONT_CLOSE
 0x0080

	)

31 
	gfdev’t
;

33 (*
	tfd_func
)(
	tfd
, 
	tev’ts
, *
	tu£rd©a
);

39 
fdev’t
 *
	`fdev’t_ü—‹
(
fd
, 
fd_func
 
func
, *
¬g
);

44 
	`fdev’t_de¡roy
(
fdev’t
 *
fde
);

48 
	`fdev’t_š¡®l
(
fdev’t
 *
fde
, 
fd
, 
fd_func
 
func
, *
¬g
);

53 
	`fdev’t_»move
(
fdev’t
 *
™em
);

57 
	`fdev’t_£t
(
fdev’t
 *
fde
, 
ev’ts
);

58 
	`fdev’t_add
(
fdev’t
 *
fde
, 
ev’ts
);

59 
	`fdev’t_d–
(
fdev’t
 *
fde
, 
ev’ts
);

61 
	`fdev’t_£t_timeout
(
fdev’t
 *
fde
, 
št64_t
 
timeout_ms
);

65 
	`fdev’t_loİ
();

67 
	sfdev’t
 {

68 
fdev’t
 *
Ãxt
;

69 
fdev’t
 *
´ev
;

71 
fd
;

72 
fÜû_eof
;

74 
ušt16_t
 
¡©e
;

75 
ušt16_t
 
ev’ts
;

77 
fd_func
 
func
;

78 *
¬g
;

	@file_sync_service.h

17 #iâdeà
_FILE_SYNC_SERVICE_H_


18 
	#_FILE_SYNC_SERVICE_H_


	)

20 
	~<¡ršg
>

22 
	#htŞl
(
x
è(x)

	)

23 
	#Éohl
(
x
è(x)

	)

25 
	#MKID
(
a
,
b
,
c
,
d
è(×è| ((bè<< 8è| ((cè<< 16è| ((dè<< 24))

	)

27 
	#ID_STAT
 
	`MKID
('S','T','A','T')

	)

28 
	#ID_LIST
 
	`MKID
('L','I','S','T')

	)

29 
	#ID_ULNK
 
	`MKID
('U','L','N','K')

	)

30 
	#ID_SEND
 
	`MKID
('S','E','N','D')

	)

31 
	#ID_RECV
 
	`MKID
('R','E','C','V')

	)

32 
	#ID_DENT
 
	`MKID
('D','E','N','T')

	)

33 
	#ID_DONE
 
	`MKID
('D','O','N','E')

	)

34 
	#ID_DATA
 
	`MKID
('D','A','T','A')

	)

35 
	#ID_OKAY
 
	`MKID
('O','K','A','Y')

	)

36 
	#ID_FAIL
 
	`MKID
('F','A','I','L')

	)

37 
	#ID_QUIT
 
	`MKID
('Q','U','I','T')

	)

39 
	usyncmsg
 {

40 
	mid
;

42 
	mid
;

43 
	mÇm–’
;

44 } 
	m»q
;

46 
	mid
;

47 
	mmode
;

48 
	msize
;

49 
	mtime
;

50 } 
	m¡©
;

52 
	mid
;

53 
	mmode
;

54 
	msize
;

55 
	mtime
;

56 
	mÇm–’
;

57 } 
	md’t
;

59 
	mid
;

60 
	msize
;

61 } 
	md©a
;

63 
	mid
;

64 
	mmsgËn
;

65 } 
	m¡©us
;

69 
fe_sync_£rviû
(
fd
, *
cook›
);

70 
do_sync_ls
(cÚ¡ *
·th
);

71 
do_sync_push
(cÚ¡ *
Í©h
, cÚ¡ *
½©h
, 
show_´og»ss
);

72 
do_sync_sync
(cÚ¡ 
¡d
::
¡ršg
& 
Í©h
, cÚ¡ std::¡ršg& 
½©h
, 
boŞ
 
li¡_Úly
);

73 
do_sync_puÎ
(cÚ¡ *
½©h
, cÚ¡ *
Í©h
, 
show_´og»ss
, 
puÎTime
);

75 
	#SYNC_DATA_MAX
 (64*1024)

	)

	@mutex_list.h

6 #iâdeà
ADB_MUTEX


7 #”rÜ 
ADB_MUTEX
 
nÙ
 
defšed
 
wh’
 
šşudšg
 
this
 
fe


9 
	$ADB_MUTEX
(
Œª¥Üt_lock
)

10 #ià
ADB_HOST


11 
	$ADB_MUTEX
(
loÿl_Œª¥Üts_lock
)

13 
	$ADB_MUTEX
(
usb_lock
)

22 
	$ADB_MUTEX
(
D_lock
)

24 #undeà
ADB_MUTEX


	@qemu_tracing.h

21 #iâdeà
__QEMU_TRACING_H


22 
	#__QEMU_TRACING_H


	)

25 
adb_qemu_Œaû_š™
();

26 
adb_qemu_Œaû
(cÚ¡ * 
fmt
, ...);

	@remount_service.h

17 #iâdeà
_REMOUNT_SERVICE_H_


18 
	#_REMOUNT_SERVICE_H_


	)

20 
	~<¡ršg
>

22 
boŞ
 
make_block_deviû_wr™abË
(cÚ¡ 
¡d
::
¡ršg
&);

23 
»mouÁ_£rviû
(, *);

	@sysdeps.h

20 #iâdeà
_ADB_SYSDEPS_H


21 
	#_ADB_SYSDEPS_H


	)

23 #ifdeà
__CYGWIN__


24 #undeà
_WIN32


32 #iâdeà
TEMP_FAILURE_RETRY


34 
	#TEMP_FAILURE_RETRY
(
exp
) ({ \

35 
	`ty³of
 (
exp
è
_rc
; \

37 
_rc
 = (
exp
); \

38 } 
_rc
 =ğ-1 && 
”ºo
 =ğ
EINTR
); \

39 
_rc
; })

	)

42 #ifdeà
_WIN32


44 
	~<ùy³.h
>

45 
	~<dœeù.h
>

46 
	~<”ºo.h
>

47 
	~<fú.h
>

48 
	~<io.h
>

49 
	~<´oûss.h
>

50 
	~<sys/¡©.h
>

51 
	~<wšsock2.h
>

52 
	~<wšdows.h
>

53 
	~<ws2tı.h
>

55 
	~"fdev’t.h
"

57 
	#OS_PATH_SEPARATOR
 '\\'

	)

58 
	#OS_PATH_SEPARATOR_STR
 "\\"

	)

59 
	#ENV_PATH_SEPARATOR_STR
 ";"

	)

61 
CRITICAL_SECTION
 
	tadb_mu‹x_t
;

63 
	#ADB_MUTEX_DEFINE
(
x
è
adb_mu‹x_t
 
	)
x

67 
	#ADB_MUTEX
(
x
è
adb_mu‹x_t
 x;

	)

68 
	~"mu‹x_li¡.h
"

70 
adb_sysd•s_š™
();

72 
__šlše__
 
	$adb_mu‹x_lock
Ğ
adb_mu‹x_t
* 
lock
 )

74 
	`EÁ”Cr™iÿlSeùiÚ
Ğ
lock
 );

75 
	}
}

77 
__šlše__
 
	$adb_mu‹x_uÆock
Ğ
adb_mu‹x_t
* 
lock
 )

79 
	`L—veCr™iÿlSeùiÚ
Ğ
lock
 );

80 
	}
}

82 ¡ruù { 
	mtid
; } 
	tadb_th»ad_t
;

84 * (*
	tadb_th»ad_func_t
)(* 
	t¬g
);

86 (*
	twš_th»ad_func_t
)(* 
	t¬g
);

88 
__šlše__
 
	$adb_th»ad_ü—‹
Ğ
adb_th»ad_t
 *
th»ad
, 
adb_th»ad_func_t
 
func
, * 
¬g
)

90 
th»ad
->
tid
 = 
	`_begšth»ad
Ğ(
wš_th»ad_func_t
)
func
, 0, 
¬g
 );

91 ià(
th»ad
->
tid
 == ()-1L) {

95 
	}
}

97 
__šlše__
 
	$adb_th»ad_id
()

99  
	`G‘Cu¼’tTh»adId
();

100 
	}
}

102 
__šlše__
 
	$şo£_Ú_exec
(
fd
)

105 
	}
}

107 
	#l¡©
 
¡©


	)

109 
	#S_ISLNK
(
m
è0

	)

111 
__šlše__
 
	$adb_uÆšk
(cÚ¡ * 
·th
)

113 
rc
 = 
	`uÆšk
(
·th
);

115 ià(
rc
 =ğ-1 && 
”ºo
 =ğ
EACCES
) {

118 
rc
 = 
	`chmod
(
·th
, 
_S_IREAD
|
_S_IWRITE
 );

119 ià(
rc
 == 0)

120 
rc
 = 
	`uÆšk
(
·th
);

122  
rc
;

123 
	}
}

124 #undeà
uÆšk


125 
	#uÆšk
 
___xxx_uÆšk


	)

127 
__šlše__
 
	$adb_mkdœ
(cÚ¡ * 
·th
, 
mode
)

129  
	`_mkdœ
(
·th
);

130 
	}
}

131 #undeà
mkdœ


132 
	#mkdœ
 
___xxx_mkdœ


	)

134 
adb_İ’
(cÚ¡ * 
·th
, 
İtiÚs
);

135 
adb_ü—t
(cÚ¡ * 
·th
, 
mode
);

136 
adb_»ad
(
fd
, * 
buf
, 
Ën
);

137 
adb_wr™e
(
fd
, cÚ¡ * 
buf
, 
Ën
);

138 
adb_l£ek
(
fd
, 
pos
, 
wh”e
);

139 
adb_shutdown
(
fd
);

140 
adb_şo£
(
fd
);

142 
__šlše__
 
	$unix_şo£
(
fd
)

144  
	`şo£
(
fd
);

145 
	}
}

146 #undeà
şo£


147 
	#şo£
 
____xxx_şo£


	)

149 
unix_»ad
(
fd
, * 
buf
, 
size_t
 
Ën
);

151 #undeà
»ad


152 
	#»ad
 
___xxx_»ad


	)

154 
__šlše__
 
	$unix_wr™e
(
fd
, cÚ¡ * 
buf
, 
size_t
 
Ën
)

156  
	`wr™e
(
fd
, 
buf
, 
Ën
);

157 
	}
}

158 #undeà
wr™e


159 
	#wr™e
 
___xxx_wr™e


	)

161 
__šlše__
 
	$adb_İ’_mode
(cÚ¡ * 
·th
, 
İtiÚs
, 
mode
)

163  
	`adb_İ’
(
·th
, 
İtiÚs
);

164 
	}
}

166 
__šlše__
 
	$unix_İ’
(cÚ¡ * 
·th
, 
İtiÚs
,...)

168 ià((
İtiÚs
 & 
O_CREAT
) == 0)

170  
	`İ’
(
·th
, 
İtiÚs
);

174 
mode
;

175 
va_li¡
 
¬gs
;

176 
	`va_¡¬t
Ğ
¬gs
, 
İtiÚs
 );

177 
mode
 = 
	`va_¬g
Ğ
¬gs
, );

178 
	`va_’d
Ğ
¬gs
 );

179  
	`İ’
(
·th
, 
İtiÚs
, 
mode
);

181 
	}
}

182 
	#İ’
 
___xxx_unix_İ’


	)

186 * 
lßd_fe
(cÚ¡ * 
·thÇme
, * 
psize
);

189 
sock‘_loİback_ş›Á
(
pÜt
, 
ty³
);

190 
sock‘_ÃtwÜk_ş›Á
(cÚ¡ *
ho¡
, 
pÜt
, 
ty³
);

191 
sock‘_ÃtwÜk_ş›Á_timeout
(cÚ¡ *
ho¡
, 
pÜt
, 
ty³
,

192 
timeout
);

193 
sock‘_loİback_£rv”
(
pÜt
, 
ty³
);

194 
sock‘_šaddr_ªy_£rv”
(
pÜt
, 
ty³
);

198 
	#FDE_READ
 0x0001

	)

199 
	#FDE_WRITE
 0x0002

	)

200 
	#FDE_ERROR
 0x0004

	)

201 
	#FDE_DONT_CLOSE
 0x0080

	)

203 (*
	tfd_func
)(
	tfd
, 
	tev’ts
, *
	tu£rd©a
);

205 
fdev’t
 *
	`fdev’t_ü—‹
(
fd
, 
fd_func
 
func
, *
¬g
);

206 
	`fdev’t_de¡roy
(
fdev’t
 *
fde
);

207 
	`fdev’t_š¡®l
(
fdev’t
 *
fde
, 
fd
, 
fd_func
 
func
, *
¬g
);

208 
	`fdev’t_»move
(
fdev’t
 *
™em
);

209 
	`fdev’t_£t
(
fdev’t
 *
fde
, 
ev’ts
);

210 
	`fdev’t_add
(
fdev’t
 *
fde
, 
ev’ts
);

211 
	`fdev’t_d–
(
fdev’t
 *
fde
, 
ev’ts
);

212 
	`fdev’t_loİ
();

214 
__šlše__
 
	$adb_¦“p_ms
Ğ
m£cÚds
 )

216 
	`SË•
Ğ
m£cÚds
 );

217 
	}
}

219 
adb_sock‘_acû±
(
£rv”fd
, 
sockaddr
* 
addr
, 
sockËn_t
 *
add¾’
);

221 #undeà
acû±


222 
	#acû±
 
___xxx_acû±


	)

224 
adb_£tsockİt
(
fd
, 
Ëv–
, 
İŠame
, cÚ¡ * 
İtv®
, 
sockËn_t
 
İ’
);

226 #undeà
£tsockİt


227 
	#£tsockİt
 
___xxx_£tsockİt


	)

229 
__šlše__
 
	$adb_sock‘_£tbufsize
Ğ
fd
, 
bufsize
 )

231 
İt
 = 
bufsize
;

232  
	`adb_£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, (cÚ¡ *)&
İt
, (opt));

233 
	}
}

235 
__šlše__
 
	$di§bË_tı_ÇgË
Ğ
fd
 )

237 
Ú
 = 1;

238 
	`adb_£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (cÚ¡ *)&
Ú
, (on));

239 
	}
}

241 
adb_sock‘·œ
Ğ
sv
[2] );

243 
__šlše__
 * 
	$adb_dœ¡¬t
ĞcÚ¡ * 
·th
 )

245 * 
p
 = 
	`¡rchr
(
·th
, '/');

246 * 
p2
 = 
	`¡rchr
(
·th
, '\\');

248 iàĞ!
p
 )

249 
p
 = 
p2
;

250 iàĞ
p2
 &&…2 > 
p
 )

251 
p
 = 
p2
;

253  
p
;

254 
	}
}

256 
__šlše__
 * 
	$adb_dœ¡İ
ĞcÚ¡ * 
·th
 )

258 * 
p
 = 
	`¡¼chr
(
·th
, '/');

259 * 
p2
 = 
	`¡¼chr
(
·th
, '\\');

261 iàĞ!
p
 )

262 
p
 = 
p2
;

263 iàĞ
p2
 &&…2 > 
p
 )

264 
p
 = 
p2
;

266  
p
;

267 
	}
}

269 
__šlše__
 
	$adb_is_absŞu‹_ho¡_·th
ĞcÚ¡ * 
·th
 )

271  
	`i§Íha
(
·th
[0]) &&…ath[1] == ':' &&…ath[2] == '\\';

272 
	}
}

276 
	~"fdev’t.h
"

277 
	~<cuts/sock‘s.h
>

278 
	~<cuts/misc.h
>

279 
	~<sigÇl.h
>

280 
	~<sys/wa™.h
>

281 
	~<sys/¡©.h
>

282 
	~<fú.h
>

284 
	~<±h»ad.h
>

285 
	~<uni¡d.h
>

286 
	~<fú.h
>

287 
	~<¡d¬g.h
>

288 
	~<Ãtš‘/š.h
>

289 
	~<Ãtš‘/tı.h
>

290 
	~<¡ršg.h
>

291 
	~<uni¡d.h
>

293 
	#OS_PATH_SEPARATOR
 '/'

	)

294 
	#OS_PATH_SEPARATOR_STR
 "/"

	)

295 
	#ENV_PATH_SEPARATOR_STR
 ":"

	)

297 
±h»ad_mu‹x_t
 
	tadb_mu‹x_t
;

299 
	#ADB_MUTEX_INITIALIZER
 
PTHREAD_MUTEX_INITIALIZER


	)

300 
	#adb_mu‹x_š™
 
±h»ad_mu‹x_š™


	)

301 
	#adb_mu‹x_lock
 
±h»ad_mu‹x_lock


	)

302 
	#adb_mu‹x_uÆock
 
±h»ad_mu‹x_uÆock


	)

303 
	#adb_mu‹x_de¡roy
 
±h»ad_mu‹x_de¡roy


	)

305 
	#ADB_MUTEX_DEFINE
(
m
è
adb_mu‹x_t
 m = 
PTHREAD_MUTEX_INITIALIZER


	)

307 
	#adb_cÚd_t
 
±h»ad_cÚd_t


	)

308 
	#adb_cÚd_š™
 
±h»ad_cÚd_š™


	)

309 
	#adb_cÚd_wa™
 
±h»ad_cÚd_wa™


	)

310 
	#adb_cÚd_brßdÿ¡
 
±h»ad_cÚd_brßdÿ¡


	)

311 
	#adb_cÚd_sigÇl
 
±h»ad_cÚd_sigÇl


	)

312 
	#adb_cÚd_de¡roy
 
±h»ad_cÚd_de¡roy


	)

315 
	#ADB_MUTEX
(
x
è
adb_mu‹x_t
 x;

	)

316 
	~"mu‹x_li¡.h
"

318 
__šlše__
 
	$şo£_Ú_exec
(
fd
)

320 
	`fú
Ğ
fd
, 
F_SETFD
, 
FD_CLOEXEC
 );

321 
	}
}

323 
__šlše__
 
	$unix_İ’
(cÚ¡ * 
·th
, 
İtiÚs
,...)

325 ià((
İtiÚs
 & 
O_CREAT
) == 0)

327  
	`TEMP_FAILURE_RETRY
Ğ
	`İ’
(
·th
, 
İtiÚs
) );

331 
mode
;

332 
va_li¡
 
¬gs
;

333 
	`va_¡¬t
Ğ
¬gs
, 
İtiÚs
 );

334 
mode
 = 
	`va_¬g
Ğ
¬gs
, );

335 
	`va_’d
Ğ
¬gs
 );

336  
	`TEMP_FAILURE_RETRY
Ğ
	`İ’
Ğ
·th
, 
İtiÚs
, 
mode
 ) );

338 
	}
}

340 
__šlše__
 
	$adb_İ’_mode
ĞcÚ¡ * 
·thÇme
, 
İtiÚs
, 
mode
 )

342  
	`TEMP_FAILURE_RETRY
Ğ
	`İ’
Ğ
·thÇme
, 
İtiÚs
, 
mode
 ) );

343 
	}
}

346 
__šlše__
 
	$adb_İ’
ĞcÚ¡ * 
·thÇme
, 
İtiÚs
 )

348 
fd
 = 
	`TEMP_FAILURE_RETRY
Ğ
	`İ’
Ğ
·thÇme
, 
İtiÚs
 ) );

349 ià(
fd
 < 0)

351 
	`şo£_Ú_exec
Ğ
fd
 );

352  
fd
;

353 
	}
}

354 #undeà
İ’


355 
	#İ’
 
___xxx_İ’


	)

357 
__šlše__
 
	$adb_shutdown
(
fd
)

359  
	`shutdown
(
fd
, 
SHUT_RDWR
);

360 
	}
}

361 #undeà
shutdown


362 
	#shutdown
 
____xxx_shutdown


	)

364 
__šlše__
 
	$adb_şo£
(
fd
)

366  
	`şo£
(
fd
);

367 
	}
}

368 #undeà
şo£


369 
	#şo£
 
____xxx_şo£


	)

372 
__šlše__
 
	$adb_»ad
(
fd
, * 
buf
, 
size_t
 
Ën
)

374  
	`TEMP_FAILURE_RETRY
Ğ
	`»ad
Ğ
fd
, 
buf
, 
Ën
 ) );

375 
	}
}

377 #undeà
»ad


378 
	#»ad
 
___xxx_»ad


	)

380 
__šlše__
 
	$adb_wr™e
(
fd
, cÚ¡ * 
buf
, 
size_t
 
Ën
)

382  
	`TEMP_FAILURE_RETRY
Ğ
	`wr™e
Ğ
fd
, 
buf
, 
Ën
 ) );

383 
	}
}

384 #undeà
wr™e


385 
	#wr™e
 
___xxx_wr™e


	)

387 
__šlše__
 
	$adb_l£ek
(
fd
, 
pos
, 
wh”e
)

389  
	`l£ek
(
fd
, 
pos
, 
wh”e
);

390 
	}
}

391 #undeà
l£ek


392 
	#l£ek
 
___xxx_l£ek


	)

394 
__šlše__
 
	$adb_uÆšk
(cÚ¡ * 
·th
)

396  
	`uÆšk
(
·th
);

397 
	}
}

398 #undeà
uÆšk


399 
	#uÆšk
 
___xxx_uÆšk


	)

401 
__šlše__
 
	$adb_ü—t
(cÚ¡ * 
·th
, 
mode
)

403 
fd
 = 
	`TEMP_FAILURE_RETRY
Ğ
	`ü—t
Ğ
·th
, 
mode
 ) );

405 iàĞ
fd
 < 0 )

408 
	`şo£_Ú_exec
(
fd
);

409  
fd
;

410 
	}
}

411 #undeà
ü—t


412 
	#ü—t
 
___xxx_ü—t


	)

414 
__šlše__
 
	$adb_sock‘_acû±
(
£rv”fd
, 
sockaddr
* 
addr
, 
sockËn_t
 *
add¾’
)

416 
fd
;

418 
fd
 = 
	`TEMP_FAILURE_RETRY
Ğ
	`acû±
Ğ
£rv”fd
, 
addr
, 
add¾’
 ) );

419 ià(
fd
 >= 0)

420 
	`şo£_Ú_exec
(
fd
);

422  
fd
;

423 
	}
}

425 #undeà
acû±


426 
	#acû±
 
___xxx_acû±


	)

428 
	#unix_»ad
 
adb_»ad


	)

429 
	#unix_wr™e
 
adb_wr™e


	)

430 
	#unix_şo£
 
adb_şo£


	)

432 
±h»ad_t
 
	tadb_th»ad_t
;

434 * (*
	tadb_th»ad_func_t
)Ğ* 
	t¬g
 );

436 
__šlše__
 
	$adb_th»ad_ü—‹
Ğ
adb_th»ad_t
 *
±h»ad
, 
adb_th»ad_func_t
 
¡¬t
, * 
¬g
 )

438 
±h»ad_©Œ_t
 
©Œ
;

440 
	`±h»ad_©Œ_š™
 (&
©Œ
);

441 
	`±h»ad_©Œ_£td‘ach¡©e
 (&
©Œ
, 
PTHREAD_CREATE_DETACHED
);

443  
	`±h»ad_ü—‹
Ğ
±h»ad
, &
©Œ
, 
¡¬t
, 
¬g
 );

444 
	}
}

446 
__šlše__
 
	$adb_sock‘_£tbufsize
Ğ
fd
, 
bufsize
 )

448 
İt
 = 
bufsize
;

449  
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
İt
, (opt));

450 
	}
}

452 
__šlše__
 
	$di§bË_tı_ÇgË
(
fd
)

454 
Ú
 = 1;

455 
	`£tsockİt
Ğ
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
Ú
, (on) );

456 
	}
}

458 
__šlše__
 
	$adb_£tsockİt
Ğ
fd
, 
Ëv–
, 
İŠame
, cÚ¡ * 
İtv®
, 
sockËn_t
 
İ’
 )

460  
	`£tsockİt
Ğ
fd
, 
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
 );

461 
	}
}

463 #undeà
£tsockİt


464 
	#£tsockİt
 
___xxx_£tsockİt


	)

466 
__šlše__
 
	$unix_sock‘·œ
Ğ
d
, 
ty³
, 
´ÙocŞ
, 
sv
[2] )

468  
	`sock‘·œ
Ğ
d
, 
ty³
, 
´ÙocŞ
, 
sv
 );

469 
	}
}

471 
__šlše__
 
	$adb_sock‘·œ
Ğ
sv
[2] )

473 
rc
;

475 
rc
 = 
	`unix_sock‘·œ
Ğ
AF_UNIX
, 
SOCK_STREAM
, 0, 
sv
 );

476 ià(
rc
 < 0)

479 
	`şo£_Ú_exec
Ğ
sv
[0] );

480 
	`şo£_Ú_exec
Ğ
sv
[1] );

482 
	}
}

484 #undeà
sock‘·œ


485 
	#sock‘·œ
 
___xxx_sock‘·œ


	)

487 
__šlše__
 
	$adb_¦“p_ms
Ğ
m£cÚds
 )

489 
	`u¦“p
Ğ
m£cÚds
*1000 );

490 
	}
}

492 
__šlše__
 
	$adb_mkdœ
(cÚ¡ * 
·th
, 
mode
)

494  
	`mkdœ
(
·th
, 
mode
);

495 
	}
}

496 #undeà
mkdœ


497 
	#mkdœ
 
___xxx_mkdœ


	)

499 
__šlše__
 
	$adb_sysd•s_š™
()

501 
	}
}

503 
__šlše__
 * 
	$adb_dœ¡¬t
(cÚ¡ * 
·th
)

505  
	`¡rchr
(
·th
, '/');

506 
	}
}

508 
__šlše__
 * 
	$adb_dœ¡İ
(cÚ¡ * 
·th
)

510  
	`¡¼chr
(
·th
, '/');

511 
	}
}

513 
__šlše__
 
	$adb_is_absŞu‹_ho¡_·th
ĞcÚ¡ * 
·th
 )

515  
·th
[0] == '/';

516 
	}
}

518 
__šlše__
 
	$adb_th»ad_id
()

520  ()
	`±h»ad_£lf
();

521 
	}
}

	@sysdeps/mutex.h

1 #´agm¨
Úû


19 #ià
defšed
(
_WIN32
)

21 
	~<wšdows.h
>

23 
	~<ªdroid-ba£/maüos.h
>

25 
	~"adb.h
"

32 
	~<mu‹x
>

33 
Çme¥aû
 
	g¡d
 {

36 şas 
	c»cursive_mu‹x
 {

37 
	gpublic
:

38 
»cursive_mu‹x
() {

39 
In™ŸlizeCr™iÿlSeùiÚ
(&
mu‹x_
);

42 ~
»cursive_mu‹x
() {

43 
D–‘eCr™iÿlSeùiÚ
(&
mu‹x_
);

46 
lock
() {

47 
EÁ”Cr™iÿlSeùiÚ
(&
mu‹x_
);

50 
boŞ
 
Œy_lock
() {

51  
TryEÁ”Cr™iÿlSeùiÚ
(&
mu‹x_
);

54 
uÆock
() {

55 
L—veCr™iÿlSeùiÚ
(&
mu‹x_
);

58 
	g´iv©e
:

59 
CRITICAL_SECTION
 
mu‹x_
;

61 
DISALLOW_COPY_AND_ASSIGN
(
»cursive_mu‹x
);

64 şas 
	cmu‹x
 {

65 
	gpublic
:

66 
mu‹x
() {

69 ~
mu‹x
() {

72 
lock
() {

73 
mu‹x_
.
lock
();

74 ià(++
	glock_couÁ_
 != 1) {

75 
çl
("non-recursive mutex†ocked„eentrantly");

79 
uÆock
() {

80 ià(--
	glock_couÁ_
 != 0) {

81 
çl
("nÚ-»cursivmu‹x uÆock„esuÉed iÀuÃx³ùed†ock couÁ: %d", 
lock_couÁ_
);

83 
	gmu‹x_
.
uÆock
();

86 
boŞ
 
Œy_lock
() {

87 ià(!
	gmu‹x_
.
Œy_lock
()) {

88  
	gçl£
;

91 ià(
	glock_couÁ_
 != 0) {

92 
mu‹x_
.
uÆock
();

93  
	gçl£
;

96 ++
	glock_couÁ_
;

97  
	gŒue
;

100 
	g´iv©e
:

101 
»cursive_mu‹x
 
mu‹x_
;

102 
size_t
 
	glock_couÁ_
 = 0;

107 #–ià
defšed
(
__BIONIC__
)

112 
	~<±h»ad.h
>

113 
	~<mu‹x
>

115 
	~<ba£/maüos.h
>

117 şas 
	c»cursive_mu‹x
 {

118 
	mpublic
:

119 
	$»cursive_mu‹x
() {

122 ~
	$»cursive_mu‹x
() {

123 
	}
}

125 
	$lock
() {

126 
	`±h»ad_mu‹x_lock
(&
mu‹x_
);

127 
	}
}

129 
boŞ
 
	$Œy_lock
() {

130  
	`±h»ad_mu‹x_Œylock
(&
mu‹x_
);

131 
	}
}

133 
	$uÆock
() {

134 
	`±h»ad_mu‹x_uÆock
(&
mu‹x_
);

135 
	}
}

137 
	g´iv©e
:

138 
±h»ad_mu‹x_t
 
mu‹x_
 = 
PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
;

140 
DISALLOW_COPY_AND_ASSIGN
(
»cursive_mu‹x
);

	@transport.h

17 #iâdeà
__TRANSPORT_H


18 
	#__TRANSPORT_H


	)

20 
	~<sys/ty³s.h
>

22 
	~<¡ršg
>

24 
	~"adb.h
"

32 
©¿n¥Üt
* 
acquœe_Úe_Œª¥Üt
(
¡©e
, 
Œª¥Üt_ty³
 
‰y³
,

33 cÚ¡ * 
£rŸl
, 
¡d
::
¡ršg
* 
”rÜ_out
);

34 
add_Œª¥Üt_discÚÃù
(
©¿n¥Üt
* 
t
, 
adiscÚÃù
* 
dis
);

35 
»move_Œª¥Üt_discÚÃù
(
©¿n¥Üt
* 
t
, 
adiscÚÃù
* 
dis
);

36 
kick_Œª¥Üt
(
©¿n¥Üt
* 
t
);

37 
run_Œª¥Üt_discÚÃùs
(
©¿n¥Üt
* 
t
);

38 
upd©e_Œª¥Üts
();

43 
š™_Œª¥Üt_»gi¡¿tiÚ
();

44 
	g¡d
::
¡ršg
 
li¡_Œª¥Üts
(
boŞ
 
lÚg_li¡šg
);

45 
©¿n¥Üt
* 
fšd_Œª¥Üt
(cÚ¡ * 
£rŸl
);

47 
»gi¡”_usb_Œª¥Üt
(
usb_hªdË
* 
h
, cÚ¡ * 
£rŸl
,

48 cÚ¡ * 
dev·th
, 
wr™—bË
);

51 
»gi¡”_sock‘_Œª¥Üt
(
s
, cÚ¡ * 
£rŸl
, 
pÜt
, 
loÿl
);

54 
uÄegi¡”_usb_Œª¥Üt
(
usb_hªdË
* 
usb
);

57 
uÄegi¡”_Œª¥Üt
(
©¿n¥Üt
* 
t
);

58 
uÄegi¡”_®l_tı_Œª¥Üts
();

60 
check_h—d”
(
­ack‘
* 
p
, 
©¿n¥Üt
* 
t
);

61 
check_d©a
(
­ack‘
* 
p
);

64 
şo£_usb_deviûs
();

66 
£nd_·ck‘
(
­ack‘
* 
p
, 
©¿n¥Üt
* 
t
);

68 
asock‘
* 
ü—‹_deviû_Œack”
();

	@
1
.
0
66
3669
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_auth.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_auth.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_auth_client.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_auth_host.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_client.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_client.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_io.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_io.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_io_test.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_listeners.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_listeners.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_main.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_trace.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_utils.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_utils.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/adb_utils_test.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/commandline.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/console.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/fdevent.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/fdevent.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/file_sync_client.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/file_sync_service.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/file_sync_service.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/framebuffer_service.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/get_my_path_darwin.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/get_my_path_linux.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/get_my_path_windows.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/jdwp_service.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/mutex_list.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/qemu_tracing.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/qemu_tracing.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/remount_service.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/remount_service.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/services.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/set_verity_enable_state_service.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/sockets.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/sysdeps.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/sysdeps/mutex.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/sysdeps_win32.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/test_track_devices.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/transport.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/transport.h
/home/zhangpengpeng/workspace/KC30S/system/core/adb/transport_local.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/transport_test.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/transport_usb.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/usb_linux.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/usb_linux_client.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/usb_osx.cpp
/home/zhangpengpeng/workspace/KC30S/system/core/adb/usb_windows.cpp
adb.h
adb_auth.h
adb_client.h
adb_io.h
adb_listeners.h
adb_trace.h
adb_utils.h
fdevent.h
file_sync_service.h
mutex_list.h
qemu_tracing.h
remount_service.h
sysdeps.h
sysdeps/mutex.h
transport.h
